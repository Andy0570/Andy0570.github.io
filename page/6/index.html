<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
      
    
    
      
    
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">



  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/han-css@3/dist/han.min.css">













  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">







  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/panda/apple-touch-icon.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/panda/favicon-32x32.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/panda/favicon-16x16.png?v=7.1.0">


  <link rel="mask-icon" href="/images/panda/safari-pinned-tab.svg?v=7.1.0" color="#222">


  <link rel="manifest" href="/images/panda/site.webmanifest">


  <meta name="msapplication-config" content="/images/panda/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: true,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '0E2AON8EZF',
      apiKey: '22fbefd84c8343239f5c04365b9728de',
      indexName: 'MyBlogPlatform',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
<meta name="keywords" content="ç‹¬æœ¨èˆŸçš„æœ¨">
<meta property="og:type" content="website">
<meta property="og:title" content="ç‹¬æœ¨èˆŸçš„æœ¨">
<meta property="og:url" content="https://andy0570.com/page/6/index.html">
<meta property="og:site_name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
<meta property="og:description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ç‹¬æœ¨èˆŸçš„æœ¨">
<meta name="twitter:description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">



  <link rel="alternate" href="/atom.xml" title="ç‹¬æœ¨èˆŸçš„æœ¨" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://andy0570.com/page/6/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>ç‹¬æœ¨èˆŸçš„æœ¨</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8229a094facca297f211d61323fd9fde";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <a href="https://github.com/andy0570" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ç‹¬æœ¨èˆŸçš„æœ¨</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">iOS Developer</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>åˆ†ç±»<span class="badge">14</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>æ ‡ç­¾<span class="badge">37</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£<span class="badge">316</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>å…³äº</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>æœç´¢</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/andy0570" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/08/Node.jså®æˆ˜_5.Connect è‡ªå¸¦çš„ä¸­é—´ä»¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/08/Node.jså®æˆ˜_5.Connect è‡ªå¸¦çš„ä¸­é—´ä»¶/" class="post-title-link" itemprop="url">Node.jså®æˆ˜_5.Connect è‡ªå¸¦çš„ä¸­é—´ä»¶</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-08 18:42:00" itemprop="dateCreated datePublished" datetime="2018-11-08T18:42:00+08:00">2018-11-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-05-01 21:02:03" itemprop="dateModified" datetime="2019-05-01T21:02:03+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">2.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">2 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>ğŸ’¡
è¿™ä¸€ç« æ˜¯ã€ŠNode.js å®æˆ˜ã€‹ç¬”è®°ï¼Œä½†æ˜¯ä¹¦ä¸­çš„æºç å®ç°ä¸å®˜æ–¹æ–‡æ¡£æœ‰å‡ºå…¥ï¼ŒConnect â€œè‡ªå¸¦â€çš„ä¸­é—´ä»¶å¥½åƒæ˜¯éœ€è¦å•ä¸ªç‹¬ç«‹å¯¼å…¥æ‰èƒ½ä½¿ç”¨ã€‚
ä»¥ä¸‹ä»…ä½œä¸ºè®°å½•ï¼Œå®é™…é¡¹ç›®ä½¿ç”¨å¾…ç ”ç©¶éªŒè¯ã€‚</p>
</blockquote>
<h1>Connect è‡ªå¸¦çš„ä¸­é—´ä»¶</h1>
<p>Connect è‡ªå¸¦çš„ä¸­é—´ä»¶å¯ä»¥æ»¡è¶³å¸¸è§çš„Webç¨‹åºå¼€å‘éœ€æ±‚ï¼š</p>
<ul>
<li>ä¼šè¯ç®¡ç†ï¼›</li>
<li>cookie è§£æï¼›</li>
<li>è¯·æ±‚ä¸»ä½“è§£æ</li>
<li>è¯·æ±‚æ—¥å¿—</li>
<li>...</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<p>ä¸‹é¢çš„è¿™äº›ä¸­é—´ä»¶æ˜¯ç‹¬ç«‹å‘ˆç°çš„ï¼Œéœ€è¦npmå•ç‹¬å¯¼å…¥</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075908.jpg" alt="Connect ä¸­é—´ä»¶"></p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075908-1.jpg" alt="image"></p>
<h2>è§£æ cookieã€è¯·æ±‚ä¸»ä½“å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²çš„ä¸­é—´ä»¶</h2>
<h3>cookieParser()ï¼šè§£æHTTP cookie</h3>
<p>Connect çš„ cookie è§£æå™¨æ”¯æŒå¸¸è§„cookieã€ç­¾åcookieå’Œç‰¹æ®Šçš„JSON cookieã€‚
req.cookiesé»˜è®¤æ˜¯ç”¨å¸¸è§„æœªç­¾åcookieç»„è£…è€Œæˆçš„ã€‚å¦‚æœä½ æƒ³æ”¯æŒsession()ä¸­é—´ä»¶è¦æ±‚çš„ç­¾åcookieï¼Œåœ¨åˆ›å»ºcookieParser()å®ä¾‹æ—¶è¦ä¼ å…¥ä¸€ä¸ªåŠ å¯†ç”¨çš„å­—ç¬¦ä¸²ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½œä¸ºå‚æ•°ä¼ ç»™cookieParser()çš„ç§˜é’¥ç”¨æ¥å¯¹cookieç­¾åå’Œè§£ç­¾</span></span><br><span class="line"><span class="keyword">var</span> app = connect()</span><br><span class="line">    .use(connect.cookieParser(<span class="string">'tobi is a cook ferret'</span>)) </span><br><span class="line">    .use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(req.cookies);</span><br><span class="line">        <span class="built_in">console</span>.log(req.signedCookies);</span><br><span class="line">        res.end(<span class="string">'hello\n'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸å¸¦cookie</span></span><br><span class="line"><span class="comment">// curl http://localhost:3000/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¸è§„cookie</span></span><br><span class="line"><span class="comment">// curl http://localhost:3000/ -H "Cookie: foo=bar, bar=baz"</span></span><br></pre></td></tr></table></figure></p>
<h4>ç­¾åcookie</h4>
<p>ç­¾åcookieæ›´é€‚åˆæ•æ„Ÿæ•°æ®ï¼Œå› ä¸ºç”¨å®ƒå¯ä»¥éªŒè¯cookieæ•°æ®çš„å®Œæ•´æ€§ï¼Œæœ‰åŠ©äºé˜²æ­¢ä¸­é—´äººæ”»å‡»ã€‚æœ‰æ•ˆçš„ç­¾åcookieæ”¾åœ¨req.signedCookieså¯¹è±¡ä¸­ã€‚</p>
<p>å‡è®¾ä½ è®¾å®šäº†ä¸€ä¸ªé”®ä¸ºnameï¼Œå€¼ä¸ºlunaçš„ç­¾åcookieã€‚cookieParserä¼šå°†cookieç¼–ç ä¸ºluna.PQLM0wNvqOQEObZXUkWbS5m6Wlgã€‚æ¯ä¸ªè¯·æ±‚ä¸­çš„å“ˆå¸Œå€¼éƒ½ä¼šæ£€æŸ¥ï¼Œå¦‚æœcookieå®Œå¥½æ— æŸåœ°ä¼ ä¸Šæ¥ï¼Œå®ƒä¼šè¢«è§£æä¸ºreq.signedCookies.name:</p>
<h4>JSON cookie</h4>
<p>ç‰¹åˆ«çš„JSON cookieå¸¦æœ‰å‰ç¼€j:ï¼Œå‘Šè¯‰Connectå®ƒæ˜¯ä¸€ä¸ªä¸²è¡ŒåŒ–çš„JSONã€‚ JSON cookieæ—¢å¯ä»¥æ˜¯ç­¾åçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœªç­¾åçš„ã€‚</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:3000/ -H 'Cookie: foo=bar, bar=j:&#123;"foo":"bar"&#125;'</span><br></pre></td></tr></table></figure></p>
<h4>è®¾å®šå‡ºç«™cookie</h4>
<p>cookieParser() ä¸­é—´ä»¶æ²¡æœ‰æä¾›ä»»ä½•é€šè¿‡ Set-Cookie å“åº”å¤´å‘HTTPå®¢æˆ·ç«¯å†™å‡ºç«™cookieçš„åŠŸèƒ½ã€‚ä½†Connectå¯ä»¥é€šè¿‡ res.setHeader()å‡½æ•°å†™å…¥å¤šä¸ªSet-Cookieå“åº”å¤´ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = connect()</span><br><span class="line">    .use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.setHeader(<span class="string">'Set-Cookie'</span>, <span class="string">'foo=bar'</span>); <span class="comment">// è®¾å®šcookieï¼šfoo=bar</span></span><br><span class="line">        res.setHeader(<span class="string">'Set-Cookie'</span>, <span class="string">'tobi=ferret; Expires=Tue, 08 Jun 2021 10:18:14 GMT'</span>); <span class="comment">// è®¾å®šcookieæœ‰æ•ˆæœŸ</span></span><br><span class="line">        res.end();</span><br><span class="line">    &#125;).listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// curl http://localhost:3000/ --head</span></span><br></pre></td></tr></table></figure></p>
<h3>bodyParser()ï¼šè§£æè¯·æ±‚ä¸»ä½“</h3>
<p>bodyParser() ç»„ä»¶ä¸ºä½ æä¾›äº†req.body å±æ€§ï¼Œå¯ä»¥ç”¨æ¥è§£æ JSONã€x-www-form-urlencoded å’Œmultipart/form-dataè¯·æ±‚ã€‚å¦‚æœæ˜¯ multipart/form-data è¯·æ±‚ï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ï¼Œåˆ™è¿˜æœ‰req.files å¯¹è±¡ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = connect()</span><br><span class="line">    .use(connect.bodyParser())</span><br><span class="line">    .use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ...æ³¨å†Œç”¨æˆ·</span></span><br><span class="line">        res.end(<span class="string">'Registered new user: '</span> + req.body.username);</span><br><span class="line">    &#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>å› ä¸º bodyParser() æ˜¯æ ¹æ® Content-Type è§£ææ•°æ®çš„ï¼Œè¾“å…¥å½¢å¼æ˜¯æŠ½è±¡çš„ï¼Œæ‰€ä»¥ä½ çš„ç¨‹åºä¸­åªéœ€è¦å…³å¿ƒreq.bodyæ•°æ®å¯¹è±¡çš„ç»“æœã€‚</p>
<h3>limit()ï¼šè¯·æ±‚ä¸»ä½“çš„é™åˆ¶</h3>
<p>ç›®çš„ï¼šå¸®åŠ©è¿‡æ»¤å·¨å‹çš„è¯·æ±‚ã€‚</p>
<h3>query()ï¼šæŸ¥è¯¢å­—ç¬¦ä¸²è§£æ</h3>
<ul>
<li>bodyParser()ï¼šè§£æ POST è¯·æ±‚</li>
<li>query()ï¼šè§£æ GET è¯·æ±‚ã€‚</li>
</ul>
<p>queryä¸­é—´ä»¶å¯ä»¥å°†è¯·æ±‚å‘é€è¿‡æ¥çš„æŸ¥è¯¢å­—ç¬¦ä¸²ä»¥JSONæ ¼å¼ä½œä¸ºå“åº”è¿”å›å»ã€‚</p>
<h2>å®ç° Web ç¨‹åºæ ¸å¿ƒåŠŸèƒ½çš„ä¸­é—´ä»¶</h2>
<ul>
<li>logger()ï¼šæä¾›çµæ´»çš„è¯·æ±‚æ—¥å¿—;</li>
<li>favicon()ï¼šå¸®ä½ å¤„ç†/favicon.icoè¯·æ±‚ï¼ˆfavicon æ˜¯ç½‘ç«™çš„å°å›¾æ ‡ï¼‰;</li>
<li>methodOverride()ï¼šè®©æ²¡æœ‰èƒ½åŠ›çš„å®¢æˆ·ç«¯é€æ˜åœ°é‡å†™req.method;</li>
<li>vhost()ï¼šåœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè®¾ç½®å¤šä¸ªç½‘ç«™(è™šæ‹Ÿä¸»æœº);</li>
<li>session()ï¼šç®¡ç†ä¼šè¯æ•°æ®ã€‚</li>
</ul>
<h2>å¤„ç† Web ç¨‹åºå®‰å…¨çš„ä¸­é—´ä»¶</h2>
<ul>
<li>basicAuth()ï¼šä¸ºä¿æŠ¤æ•°æ®æä¾›äº†HTTPåŸºæœ¬è®¤è¯;</li>
<li>csrf()ï¼šå®ç°å¯¹è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)æ”»å‡»çš„é˜²æŠ¤;</li>
<li>errorhandler()ï¼šå¸®ä½ åœ¨å¼€å‘è¿‡ç¨‹ä¸­è¿›è¡Œè°ƒè¯•ã€‚</li>
</ul>
<h2>æä¾›é™æ€æ–‡ä»¶æœåŠ¡çš„ä¸­é—´ä»¶</h2>
<ul>
<li>static()ï¼šå°†æ–‡ä»¶ç³»ç»Ÿä¸­ç»™å®šæ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶è¿”å›ç»™å®¢æˆ·ç«¯;</li>
<li>compress()ï¼šå‹ç¼©å“åº”ï¼Œå¾ˆé€‚åˆè·Ÿstatic()ä¸€èµ·ä½¿ç”¨;</li>
<li>directory()ï¼šå½“è¯·æ±‚çš„æ˜¯ç›®å½•æ—¶ï¼Œè¿”å›é‚£ä¸ªç›®å½•çš„åˆ—è¡¨ã€‚</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/08/Node.jså®æˆ˜_4.Connect æ¡†æ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/08/Node.jså®æˆ˜_4.Connect æ¡†æ¶/" class="post-title-link" itemprop="url">Node.jså®æˆ˜_4.Connect æ¡†æ¶</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-08 17:08:00" itemprop="dateCreated datePublished" datetime="2018-11-08T17:08:00+08:00">2018-11-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-05-01 21:01:56" itemprop="dateModified" datetime="2019-05-01T21:01:56+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">8.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">8 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>Connect</h1>
<p><a href="https://www.npmjs.com/package/connect" target="_blank" rel="noopener">Connect</a>æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒä½¿ç”¨è¢«ç§°ä¸ºä¸­é—´ä»¶çš„æ¨¡å—åŒ–ç»„ä»¶ï¼Œä»¥å¯é‡ç”¨çš„æ–¹å¼å®ç°Webç¨‹åºä¸­çš„é€»è¾‘ã€‚åœ¨Connectä¸­ï¼Œä¸­é—´ä»¶ç»„ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ‹¦æˆªHTTPæœåŠ¡å™¨æä¾›çš„è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œæ‰§è¡Œé€»è¾‘ï¼Œç„¶åæˆ–è€…ç»“æŸå“åº”ï¼Œæˆ–è€…æŠŠå®ƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ç»„ä»¶ã€‚Connectç”¨åˆ†æ´¾å™¨æŠŠä¸­é—´ä»¶â€œè¿æ¥â€åœ¨ä¸€èµ·ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075928.jpg" alt="image"></p>
<p>&lt;!-- more --&gt;</p>
<h1>ä¸€ã€æ­å»ºä¸€ä¸ª Connect ç¨‹åº</h1>
<p>æœ€å°çš„connectç¨‹åºï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">var</span> app = connect();</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªè£¸ç¨‹åºæ²¡æœ‰ä¸­é—´ä»¶ï¼Œæ‰€ä»¥åˆ†æ´¾å™¨ä¼šç”¨404 Not FoundçŠ¶æ€ç å“åº”å®ƒæ”¶åˆ°çš„æ‰€æœ‰HTTPè¯·æ±‚ã€‚</p>
<p>åŸç†ï¼šConnect åˆ†æ´¾å™¨ä¼šä¾æ¬¡è°ƒç”¨æ‰€æœ‰é™„ç€çš„ä¸­é—´ä»¶ç»„ä»¶ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªå†³å®šå“åº”è¯¥è¯·æ±‚ã€‚å¦‚æœç›´åˆ°ä¸­é—´ä»¶åˆ—è¡¨æœ«å°¾è¿˜æ²¡æœ‰ç»„ä»¶å†³å®šå“åº”ï¼Œç¨‹åºä¼šç”¨404ä½œä¸ºå“åº”ã€‚</p>
<h1>äºŒã€Connect çš„å·¥ä½œæœºåˆ¶</h1>
<p>åœ¨Connectä¸­ï¼Œä¸­é—´ä»¶ç»„ä»¶æ˜¯ä¸€ä¸ªJavaScriptå‡½æ•°ï¼ŒæŒ‰æƒ¯ä¾‹ä¼šæ¥å—ä¸‰ä¸ªå‚æ•°:ä¸€ä¸ªè¯·æ±‚å¯¹è±¡ï¼Œä¸€ä¸ªå“åº”å¯¹è±¡ï¼Œè¿˜æœ‰ä¸€ä¸ªé€šå¸¸å‘½åä¸ºnextçš„å‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¡¨æ˜è¿™ä¸ªç»„ä»¶å·²ç»å®Œæˆäº†å®ƒçš„å·¥ä½œï¼Œå¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ç»„ä»¶äº†ã€‚</p>
<h3>1. è‡ªå®šä¹‰ä¸­é—´ä»¶</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">var</span> app = connect();</span><br><span class="line">app.use(logger);</span><br><span class="line">app.use(hello);</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// logger ä¸­é—´ä»¶ç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ¯ä¸ªHTTPè¯·æ±‚çš„æ–¹æ³•å’ŒURLÂ·Â·</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'%s %s'</span>, req.method, req.url);</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº” â€œHello Worldâ€ çš„ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    res.end(<span class="string">'Hello World!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>2. use() å‡½æ•°æ”¯æŒé“¾å¼è°ƒç”¨</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// logger ä¸­é—´ä»¶ç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ¯ä¸ªHTTPè¯·æ±‚çš„æ–¹æ³•å’ŒURLå¹¶è°ƒç”¨ next()</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'%s %s'</span>, req.method, req.url);</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº” â€œHello Worldâ€ çš„ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    res.end(<span class="string">'Hello World!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// use() å‡½æ•°æ”¯æŒé“¾å¼è°ƒç”¨ã€‚ </span></span><br><span class="line">connect()</span><br><span class="line">    .use(logger)</span><br><span class="line">    .use(hello)</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h2>ä¸‰ã€ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåºå¾ˆé‡è¦</h2>
<ul>
<li>å½“ä¸€ä¸ªç»„ä»¶ä¸è°ƒç”¨ <code>next()</code> æ—¶ï¼Œå‘½ä»¤é“¾ä¸­çš„åç»­ä¸­é—´ä»¶éƒ½ä¸ä¼šè¢«è°ƒç”¨ã€‚</li>
</ul>
<h3>1. ç”¨ä¸­é—´ä»¶çš„é¡ºåºæ‰§è¡Œè®¤è¯</h3>
<p>åˆ©ç”¨ä¸­é—´ä»¶çš„é¡ºåºæ‰§è¡Œæœºåˆ¶ï¼Œæ·»åŠ è®¤è¯ã€‚</p>
<p>å‡è®¾ä½ å·²ç»å†™äº†ä¸€ä¸ªå«åš restrictFileAccess çš„ä¸­é—´ä»¶ç»„ä»¶ï¼Œåªå…è®¸æœ‰æ•ˆçš„ç”¨æˆ·è®¿é—®æ–‡ä»¶ã€‚æœ‰æ•ˆç”¨æˆ·å¯ä»¥ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ç»„ä»¶ï¼Œå¦‚æœç”¨æˆ·æ— æ•ˆï¼Œåˆ™ä¸ä¼šè°ƒç”¨ <code>next()</code>ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ©ç”¨ä¸­é—´ä»¶çš„ä½æ¬¡é™åˆ¶æ–‡ä»¶è®¿é—®</span></span><br><span class="line">connect()</span><br><span class="line">    .use(logger)</span><br><span class="line">    .use(restrictFileAccess) <span class="comment">// åªæœ‰æœ‰æ•ˆç”¨æˆ·æ‰ä¼šè°ƒç”¨ next()</span></span><br><span class="line">    .use(serveStaticFiles)</span><br><span class="line">    .use(hello);</span><br></pre></td></tr></table></figure></p>
<h2>å››ã€æŒ‚è½½ä¸­é—´ä»¶å’ŒæœåŠ¡å™¨</h2>
<p>æŒ‚è½½ï¼šç»™ä¸­é—´ä»¶æˆ–æ•´ä¸ªç¨‹åºå®šä¹‰ä¸€ä¸ªè·¯å¾„å‰ç¼€ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ .use() çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œåªæœ‰ URL å‰ç¼€ä¸ä¹‹åŒ¹é…æ—¶ï¼Œconnect æ‰ä¼šè°ƒç”¨åé¢çš„ä¸­é—´ä»¶</span></span><br><span class="line"><span class="comment">// restrict ç»„ä»¶ç¡®ä¿è®¿é—®é¡µé¢çš„æ˜¯æœ‰æ•ˆç”¨æˆ·;</span></span><br><span class="line"><span class="comment">// admin ç»„ä»¶ä¼šç»™ç”¨æˆ·å‘ˆç°ç®¡ç†åŒºã€‚</span></span><br><span class="line">connect()</span><br><span class="line">    .use(logger)</span><br><span class="line">    .use(<span class="string">'/admin'</span>, restrict)</span><br><span class="line">    .use(<span class="string">'/admin'</span>, admin)</span><br><span class="line">    .use(hello)</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h3>1. è®¤è¯ä¸­é—´ä»¶</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•çš„ Basic è®¤è¯é€»è¾‘</span></span><br><span class="line"><span class="comment">// å€ŸåŠ©å¸¦ç€ Base64 ç¼–ç è®¤è¯ä¿¡æ¯çš„HTTPè¯·æ±‚å¤´ä¸­çš„authorizationå­—æ®µè¿›è¡Œè®¤è¯</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restrict</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> authorization = req.headers.authorization;</span><br><span class="line">    <span class="keyword">if</span> (!authorization) &#123;</span><br><span class="line">        <span class="comment">// ç”¨ Error å¯¹è±¡åšå‚æ•°è°ƒç”¨ next()ï¼Œç›¸å½“äºé€šçŸ¥Connectç¨‹åºä¸­å‡ºç°äº†é”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Unauthorized'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> parts = authorization.split(<span class="string">' '</span>);</span><br><span class="line">    <span class="keyword">var</span> scheme = parts[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> auth = <span class="keyword">new</span> Buffer(parts[<span class="number">1</span>], <span class="string">'base64'</span>).toString().split(<span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">var</span> user = auth[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> pass = auth[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®æ•°æ®åº“ä¸­çš„è®°å½•æ£€æŸ¥è®¤è¯ä¿¡æ¯çš„å‡½æ•°</span></span><br><span class="line">    authenticateWithDatabase(user, pass, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> next(err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¤è¯ä¿¡æ¯æœ‰æ•ˆï¼Œä¸å¸¦å‚æ•°è°ƒç”¨next()</span></span><br><span class="line">        next();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>2. æ˜¾ç¤ºç®¡ç†é¢æ¿çš„ä¸­é—´ä»¶</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·¯ç”± admin è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">admin</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (req.url) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">            res.end(<span class="string">'try /users'</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'/users'</span>:</span><br><span class="line">            res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>);</span><br><span class="line">            res.end(<span class="built_in">JSON</span>.stringify([<span class="string">'tobi'</span>, <span class="string">'loki'</span>, <span class="string">'jane'</span>]));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ’¡ğŸ’¡ğŸ’¡</span></span><br><span class="line"><span class="comment">// case ä¸­çš„å­—ç¬¦ä¸²æ˜¯ / å’Œ /usersã€‚</span></span><br><span class="line"><span class="comment">// è€Œå®é™…è¯·æ±‚çš„å­—ç¬¦ä¸²æ˜¯ /admin å’Œ /admin/usersã€‚</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯å› ä¸ºåœ¨è°ƒç”¨ä¸­é—´ä»¶ä¹‹å‰ï¼ŒConnectä»req.urlä¸­å»æ‰äº†å‰ç¼€ï¼Œå°±åƒURLæŒ‚è½½åœ¨/ä¸Šä¸€æ ·ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ä¸¤ä¸ªä¸åŒçš„æŒ‚è½½ç‚¹æŒ‚è½½blogç¨‹åº</span></span><br><span class="line">connect()</span><br><span class="line">    .use(logger)</span><br><span class="line">    .use(<span class="string">'/blog'</span>, blog)</span><br><span class="line">    .use(<span class="string">'/posts'</span>, blog)</span><br><span class="line">    .use(hello)</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h2>äº”ã€åˆ›å»ºå¯é…ç½®ä¸­é—´ä»¶</h2>
<p>åˆ›å»ºæ›´é€šç”¨ã€å¯é‡ç”¨çš„ä¸­é—´ä»¶ã€‚</p>
<p>ä¸ºäº†å‘å¼€å‘äººå‘˜æä¾›å¯é…ç½®çš„èƒ½åŠ›ï¼Œä¸­é—´ä»¶é€šå¸¸ä¼šéµå¾ªä¸€ä¸ªç®€å•çš„æƒ¯ä¾‹ï¼š<strong>ç”¨å‡½æ•°è¿”å›å¦ä¸€ä¸ªå‡½æ•°</strong>(è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„JavaScriptç‰¹æ€§ï¼Œé€šå¸¸ç§°ä¸ºé—­åŒ…)ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®é€»è¾‘</span></span><br><span class="line">    <span class="comment">// è½½è¿™é‡Œåšä¸­é—´ä»¶çš„åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ä¸­é—´ä»¶é€»è¾‘</span></span><br><span class="line">        <span class="comment">// å³ä½¿è¢«å¤–éƒ¨å‡½æ•°è¿”å›äº†ï¼Œä»ç„¶å¯ä»¥è®¿é—®options</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å¦‚ä¸‹</span></span><br><span class="line">app.use(setup(&#123;<span class="attr">some</span>: <span class="string">'options'</span>&#125;));</span><br></pre></td></tr></table></figure></p>
<h3>1. å¯é…ç½®çš„loggerä¸­é—´ä»¶ç»„ä»¶</h3>
<p>å¯é…ç½®çš„ä¸­é—´ä»¶å¯ä»¥ä¼ å…¥é¢å¤–çš„å‚æ•°æ¥æ”¹å˜ä»–çš„è¡Œä¸º</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯é…ç½®çš„Connectä¸­é—´ä»¶ç»„ä»¶</span></span><br><span class="line"><span class="comment">// setup å‡½æ•°å¯ä»¥ç”¨ä¸åŒçš„é…ç½®è°ƒç”¨å¤šæ¬¡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params">format</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// logger ç»„ä»¶ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¯·æ±‚å±æ€§</span></span><br><span class="line">    <span class="keyword">var</span> regexp = <span class="regexp">/:(\w+)/g</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">req, res, next</span>) </span>&#123; <span class="comment">// Connectä½¿ç”¨çš„çœŸå®loggerç»„ä»¶</span></span><br><span class="line">        <span class="comment">// ç”¨æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼åŒ–è¯·æ±‚çš„æ—¥å¿—æ¡ç›®</span></span><br><span class="line">        <span class="keyword">var</span> str = format.replace(regexp, <span class="function"><span class="keyword">function</span> (<span class="params">match, property</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> req[property];</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">console</span>.log(str);<span class="comment">// è¾“å‡ºæ—¥å¿—æ¡ç›®åˆ°æ§åˆ¶å°</span></span><br><span class="line">        next(); <span class="comment">// å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ç»„ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = setup; <span class="comment">// å¯¼å‡º logger çš„ setup å‡½æ•°</span></span><br></pre></td></tr></table></figure></p>
<h3>2. æ„å»ºè·¯ç”±ä¸­é—´ä»¶ç»„ä»¶</h3>
<p>è·¯ç”±ï¼šæŠŠè¯·æ±‚URLæ˜ å°„åˆ°å®ç°ä¸šåŠ¡é€»è¾‘çš„å‡½æ•°ä¸Šã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ router ä¸­é—´ä»¶ç»„ä»¶</span></span><br><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./middleware/router'</span>); <span class="comment">// è·¯ç”±å™¨ç»„ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰è·¯ç”±çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">var</span> routers = &#123;</span><br><span class="line">    GET: &#123;</span><br><span class="line">        <span class="comment">// å…¶ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯å¯¹è¯·æ±‚URLçš„æ˜ å°„ï¼Œå¹¶åŒ…å«è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="string">'/users'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">            res.end(<span class="string">'tobi, loki, ferret'</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'/user/:id'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res, id</span>) </span>&#123;</span><br><span class="line">            res.end(<span class="string">'users: '</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    DELETE: &#123;</span><br><span class="line">        <span class="string">'/user/:id'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">req, res, id</span>) </span>&#123;</span><br><span class="line">            res.end(<span class="string">'delete user '</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">connect()</span><br><span class="line">    .use(router(routers)) <span class="comment">// å°†è·¯ç”±å¯¹è±¡ä¼ ç»™è·¯ç”±å™¨çš„ setup å‡½æ•°</span></span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>è·¯ç”±å™¨ç»„ä»¶çš„å¤ç”¨ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./middleware/router'</span>); <span class="comment">// è·¯ç”±å™¨ç»„ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠä¸ç”¨æˆ·ç›¸å…³è·¯ç”±ã€ç®¡ç†å‘˜ç›¸å…³è·¯ç”±åˆ†åˆ°ä¸åŒçš„æ¨¡å—ä¸­ï¼Œç„¶ååœ¨è·¯ç”±å™¨ç»„ä»¶ä¸­åˆ†åˆ«å¼•å…¥</span></span><br><span class="line">connect()</span><br><span class="line">    .use(router(<span class="built_in">require</span>(<span class="string">'./routes/user'</span>)))</span><br><span class="line">    .use(router(<span class="built_in">require</span>(<span class="string">'./routes/admin'</span>)))</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075929.jpg" alt="Jietu20181108-111120"></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•çš„è·¯ç”±ä¸­é—´ä»¶</span></span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">'url'</span>).parse;</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>  <span class="title">route</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ä»¥ç¡®ä¿req.methodå®šä¹‰äº†</span></span><br><span class="line">        <span class="comment">// å¦‚æœæœªå®šä¹‰ï¼Œè°ƒç”¨next()ï¼Œå¹¶åœæ­¢ä¸€åˆ‡åç»­æ“ä½œ</span></span><br><span class="line">        <span class="comment">// ç¨‹åºä¸­è‡ªå®šä¹‰çš„æ•°ç»„ä¸­çš„æ–¹æ³•ï¼šobj[req.method]</span></span><br><span class="line">        <span class="keyword">if</span> (!obj[req.method] )&#123;</span><br><span class="line">            next();</span><br><span class="line">            <span class="keyword">return</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> routes = obj[req.method]; <span class="comment">// æŸ¥æ‰¾req.methodå¯¹åº”çš„è·¯å¾„ ï¼ˆæ•°ç»„å¯¹è±¡ï¼‰</span></span><br><span class="line">        <span class="keyword">var</span> url = parse(req.url); <span class="comment">// è§£æ URLï¼Œä»¥ä¾¿è·Ÿ pathname åŒ¹é…</span></span><br><span class="line">        <span class="keyword">var</span> paths = <span class="built_in">Object</span>.keys(routes); <span class="comment">// å°†req.methodå¯¹åº”çš„è·¯å¾„å­˜æ”¾åˆ°æ•°ç»„ä¸­</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paths.length; i++) &#123; <span class="comment">// éå†è·¯å¾„</span></span><br><span class="line">           <span class="keyword">var</span> path = paths[i];</span><br><span class="line">           <span class="keyword">var</span> fn = routes[path];</span><br><span class="line">           path = path.replace(<span class="regexp">/\//g</span>, <span class="string">'\\/'</span>).replace(<span class="regexp">/:(\w+)/g</span>, <span class="string">'([^\\/]+) '</span>);</span><br><span class="line">           <span class="keyword">var</span> re = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'^'</span> + path + <span class="string">'$'</span>); <span class="comment">// æ„é€ æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">           <span class="keyword">var</span> captures = url.pathname.match(re);</span><br><span class="line">           <span class="keyword">if</span> (captures) &#123;</span><br><span class="line">               <span class="comment">// ä¼ é€’è¢«æ•è·çš„åˆ†ç»„</span></span><br><span class="line">               <span class="keyword">var</span> args = [req, res].concat(captures.slice(<span class="number">1</span>));</span><br><span class="line">               fn.apply(<span class="literal">null</span>, args);</span><br><span class="line">               <span class="keyword">return</span>; <span class="comment">// å½“æœ‰ç›¸åŒ¹é…çš„å‡½æ•°æ—¶ï¼Œè¿”å›ï¼Œä»¥é˜²æ­¢åç»­çš„next()è°ƒç”¨ã€‚</span></span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>é¦–å…ˆæ£€æŸ¥å½“å‰çš„req.methodåœ¨routesæ˜ å°„ä¸­æ˜¯å¦æœ‰å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™åœæ­¢è¿›ä¸€æ­¥å¤„ç†(å³è°ƒç”¨next())ã€‚</li>
<li>ä¹‹åå®ƒä¼šå¾ªç¯éå†å·²å®šä¹‰çš„è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è·Ÿå½“å‰çš„req.urlç›¸åŒ¹é…çš„è·¯å¾„ã€‚</li>
<li>å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™è°ƒç”¨åŒ¹é…é¡¹çš„å›è°ƒå‡½æ•°ï¼ŒæœŸæœ›å®Œæˆå¯¹HTTPè¯·æ±‚çš„å¤„ç†ã€‚</li>
</ol>
<h3>æ„å»ºä¸€ä¸ªé‡å†™URLçš„ä¸­é—´ä»¶ç»„ä»¶</h3>
<p>é‡å†™URLåŠŸèƒ½ï¼ŒæœåŠ¡ç«¯æ¥æ”¶çš„æ˜¯ /blog/posts/my-post-title çš„è¯·æ±‚ï¼ŒåŸºäºè¿™ä¸ªURLæœ€åçš„æ–‡ç« æ ‡é¢˜æŸ¥æ‰¾æ–‡ç« çš„IDï¼Œç„¶åå°†URLè½¬æ¢ä¸º  /blog/posts/idã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = connect().use(rewrite).use(showPost).listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäºç¼©ç•¥åé‡å†™è¯·æ±‚URLçš„ä¸­é—´ä»¶</span></span><br><span class="line"><span class="keyword">var</span> path = url.parse(req.url).pathname;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rewrite</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> match = path.match(<span class="regexp">/^\/blog\/posts\/(.+)/</span>);</span><br><span class="line">    <span class="comment">// åªé’ˆå¯¹ /blog/posts è¯·æ±‚æ‰§è¡ŒæŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">        findPostIdBySlug(match[<span class="number">1</span>], <span class="function"><span class="keyword">function</span> (<span class="params">err, id</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="keyword">return</span> next(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">                <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'User not found'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            req.url = <span class="string">'/blog/posts/'</span> + id; <span class="comment">// é‡å†™req.urlå±æ€§ï¼Œä»¥ä¾¿åç»­ä¸­é—´ä»¶å¯ä»¥ä½¿ç”¨çœŸå®çš„ID</span></span><br><span class="line">            next();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2>å…­ã€ä½¿ç”¨é”™è¯¯å¤„ç†ä¸­é—´ä»¶</h2>
<p>Connectåˆ»æ„å°†é”™è¯¯å¤„ç†åšåˆ°æœ€ç®€ï¼Œè®©å¼€å‘äººå‘˜æŒ‡æ˜åº”è¯¥å¦‚ä½•å¤„ç†é”™è¯¯ã€‚</p>
<h3>1. Connect çš„é»˜è®¤é”™è¯¯å¤„ç†å™¨</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"></span><br><span class="line">connect().use(<span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    foo(); <span class="comment">// ---&gt; ReferrenceError</span></span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    res.end(<span class="string">'hello world'</span>);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 500, 'Internal Server Error'</span></span><br></pre></td></tr></table></figure></p>
<h3>2. è‡ªè¡Œå¤„ç†ç¨‹åºé”™è¯¯</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Connect ä¸­çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">errorHandler</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”™è¯¯å¤„ç†ä¸­é—´ä»¶å®šä¹‰å››ä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">        res.statusCode = <span class="number">500</span>;</span><br><span class="line">        <span class="keyword">switch</span> (env) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'development'</span>:</span><br><span class="line">                res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>);</span><br><span class="line">                res.end(<span class="built_in">JSON</span>.stringify(err));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                res.end(<span class="string">'Server error'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é”™è¯¯å¤„ç†</span></span><br><span class="line">connect()</span><br><span class="line">    .use(router(<span class="built_in">require</span>(<span class="string">'./routes/user'</span>))) <span class="comment">// æœ‰é”™è¯¯ä¼šè·³è¿‡</span></span><br><span class="line">    .use(router(<span class="built_in">require</span>(<span class="string">'./routes/admin'</span>))) <span class="comment">// æœ‰é”™è¯¯ä¼šè·³è¿‡</span></span><br><span class="line">    .use(errorHandler())</span><br><span class="line">    .listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>ç”¨ <strong>NODE_ENV</strong> è®¾å®šç¨‹åºçš„æ¨¡å¼ï¼šConnect é€šå¸¸æ˜¯ç”¨ç¯å¢ƒå˜é‡ NODE_ENVï¼ˆprocess.env.NODE_ENVï¼‰åœ¨ä¸åŒçš„æœåŠ¡å™¨ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œæ¯”å¦‚ç”Ÿäº§å’Œå¼€å‘ç¯å¢ƒã€‚</p>
<h3>3. ä½¿ç”¨å¤šä¸ªé”™è¯¯å¤„ç†ä¸­é—´ä»¶ç»„ä»¶</h3>
<p>ç”¨ä¸­é—´ä»¶çš„å˜ä½“åšé”™è¯¯å¤„ç†å¯¹äºå°†é”™è¯¯å¤„ç†é—®é¢˜åˆ†ç¦»å‡ºæ¥å¾ˆæœ‰å¸®åŠ©ã€‚</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/02/Node.jså®æˆ˜_3.å­˜å‚¨ Node ç¨‹åºä¸­çš„æ•°æ®/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/02/Node.jså®æˆ˜_3.å­˜å‚¨ Node ç¨‹åºä¸­çš„æ•°æ®/" class="post-title-link" itemprop="url">Node.jså®æˆ˜_3.å­˜å‚¨ Node ç¨‹åºä¸­çš„æ•°æ®</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-02 15:15:00" itemprop="dateCreated datePublished" datetime="2018-11-02T15:15:00+08:00">2018-11-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">1.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">1 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>é€‰æ‹©åˆé€‚çš„å­˜å‚¨æœºåˆ¶çš„å› ç´ ï¼š</p>
<ul>
<li>å­˜å‚¨æ•°æ®ç±»å‹ï¼›</li>
<li>æ€§èƒ½è¦æ±‚ï¼Œæ•°æ®çš„è¯»å–å’Œå†™å…¥é€Ÿåº¦ï¼›</li>
<li>å­˜å‚¨æ•°æ®é‡ï¼›</li>
<li>æ•°æ®æŸ¥è¯¢æ–¹å¼ï¼›</li>
<li>æ•°æ®æŒä¹…åŒ–ã€å¯é æ€§è¦æ±‚ï¼›</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075547.jpg" alt="æ•°æ®å­˜å‚¨æ–¹æ¡ˆ"></p>
<h1>ä¸€ã€æ— æœåŠ¡å™¨çš„æ•°æ®å­˜å‚¨</h1>
<p>ä»ç³»ç»Ÿç®¡ç†çš„è§’åº¦æ¥çœ‹ï¼Œæœ€æ–¹ä¾¿çš„å­˜å‚¨æœºåˆ¶æ˜¯é‚£äº›ä¸ç”¨ç»´æŠ¤DBMSçš„å­˜å‚¨ï¼š</p>
<ul>
<li>å†…å­˜å­˜å‚¨ï¼›</li>
<li>åŸºäºæ–‡ä»¶çš„å­˜å‚¨ï¼›</li>
</ul>
<h2>1. å†…å­˜å­˜å‚¨</h2>
<p>å†…å­˜å­˜å‚¨ç”¨å˜é‡å­˜æ”¾æ•°æ®ã€‚</p>
<p>ç‰¹ç‚¹ï¼šæ•°æ®è¯»å–å†™å…¥å¿«ã€æœåŠ¡å™¨å’Œç¨‹åºé‡å¯åæ•°æ®ä¸¢å¤±ã€‚</p>
<p>ç†æƒ³ç”¨é€”ï¼šå­˜æ”¾å°‘é‡ç»å¸¸ä½¿ç”¨çš„æ•°æ®ã€‚</p>
<p>åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼šè·Ÿè¸ªè®°å½•æœ€è¿‘ä¸€æ¬¡é‡å¯æœåŠ¡å™¨åé¡µé¢è®¿é—®æ¬¡æ•°çš„è®¡æ•°å™¨ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    counter ++;</span><br><span class="line">    res.write(<span class="string">'I have been accessed'</span> + counter + <span class="string">' times.'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure></p>
<h2>2. åŸºäºæ–‡ä»¶çš„å­˜å‚¨</h2>
<p>åŸºäºæ–‡ä»¶çš„å­˜å‚¨ï¼Œç”¨æ–‡ä»¶ç³»ç»Ÿå­˜æ”¾æ•°æ®ã€‚</p>
<p>ç¼ºç‚¹ï¼šå­˜åœ¨å¤šç”¨æˆ·çš„å¹¶å‘é—®é¢˜ã€‚</p>
<h1>äºŒã€å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</h1>
<p>å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(RDBMS)å¯ä»¥å­˜å‚¨å¤æ‚çš„ä¿¡æ¯ï¼Œå¹¶ä¸”æŸ¥è¯¢èµ·æ¥å¾ˆå®¹æ˜“ã€‚</p>
<h2>1. MySQL</h2>
<p>MySQLæ˜¯æœ€æµè¡Œçš„SQLæ•°æ®åº“ã€‚</p>
<p>npm æ¨¡å—ï¼š</p>
<ul>
<li><a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener">mysql</a></li>
<li><a href="https://www.npmjs.com/package/sequelize" target="_blank" rel="noopener">sequelize</a> â€”â€” (ä¼ è¯´ä¸­çš„ ORM æŠ€æœ¯ï¼šObject-Relational Mappingï¼Œèƒ½æŠŠå…³ç³»æ•°æ®åº“çš„è¡¨ç»“æ„æ˜ å°„åˆ°å¯¹è±¡ä¸Š) å¯¹æ•°æ®åº“è¿›è¡Œç®€å•çš„å¢åˆ å‡æŸ¥ã€‚</li>
<li><a href="https://www.npmjs.com/package/egg-mysql" target="_blank" rel="noopener">egg-mysql</a></li>
</ul>
<h2>2. PostgreSQL</h2>
<ul>
<li>PostgreSQLå› å…¶ä¸æ ‡å‡†çš„å…¼å®¹æ€§å’Œå¥å£®æ€§å—åˆ°è®¤å¯ã€‚</li>
<li>PostgreSQLæ”¯æŒé€’å½’æŸ¥è¯¢å’Œå¾ˆå¤šç‰¹æ®Šçš„æ•°æ®ç±»å‹ã€‚</li>
<li>PostgreSQL è¿˜èƒ½ä½¿ç”¨ä¸€äº›æ ‡å‡†çš„è®¤è¯æ–¹æ³•ï¼Œæ¯”å¦‚è½»é‡ç›®å½•è®¿é—®åè®®ï¼ˆLDAPï¼‰å’Œé€šç”¨å®‰å…¨æœåŠ¡åº”ç”¨ç¨‹åºæ¥å£ ï¼ˆGSSAPIï¼‰ã€‚</li>
<li>PostgreSQLæ”¯æŒåŒæ­¥å¤åˆ¶ï¼Œè¿™ç§å¤åˆ¶å½¢æ€ä¼šåœ¨æ¯æ¬¡æ•°æ®æ“ä½œåå¯¹å¤åˆ¶è¿›è¡ŒéªŒè¯ï¼Œä»è€Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚</li>
</ul>
<p>npm æ¨¡å—ï¼š<a href="https://github.com/brianc/node-postgres" target="_blank" rel="noopener">node-postgres</a></p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install pg</span></span><br></pre></td></tr></table></figure></p>
<h1>ä¸‰ã€NoSQL æ•°æ®åº“</h1>
<p>NoSQL æ•°æ®åº“ï¼Œå³â€œNo SQLâ€ æˆ–â€œNot Only SQLâ€ã€‚</p>
<p>NoSQL æ•°æ®åº“æŠŠæ€§èƒ½æ”¾åœ¨äº†ç¬¬ä¸€ä½ã€‚å› æ­¤ï¼Œå¯¹äºå®æ—¶åˆ†ææˆ–æ¶ˆæ¯ä¼ é€’è€Œè¨€ï¼ŒNoSQLæ•°æ®åº“å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p>
<p><a href="https://www.npmjs.com/package/mongoose" target="_blank" rel="noopener">mongoose</a> æ˜¯ä¸€ä¸ªå¾ˆå—æ¬¢è¿çš„ MongoDB è®¿é—®å±‚APIã€‚</p>
<h2>1. Redis</h2>
<ul>
<li>Redis éå¸¸é€‚åˆå¤„ç†é‚£äº›ä¸éœ€è¦é•¿æœŸè®¿é—®çš„ç®€å•æ•°æ®å­˜å‚¨ï¼Œæ¯”å¦‚çŸ­ä¿¡å’Œæ¸¸æˆä¸­çš„æ•°æ®ã€‚</li>
<li>Redis æ“…é•¿å¤„ç†å˜åŒ–é¢‘ç¹ï¼Œç›¸å¯¹æ¯”è¾ƒç®€å•çš„æ•°æ®ã€‚</li>
<li>Redis æŠŠæ•°æ®å­˜åœ¨RAMä¸­ï¼Œå¹¶åœ¨ç£ç›˜ä¸­è®°å½•æ•°æ®çš„å˜åŒ–ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯å®ƒçš„å­˜å‚¨ç©ºé—´æœ‰é™ï¼Œä½†å¥½å¤„
æ˜¯æ•°æ®æ“ä½œéå¸¸å¿«ã€‚</li>
</ul>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075548.jpg" alt="image"></p>
<p>æ•™ç¨‹ï¼š<a href="http://try.redis.io/" target="_blank" rel="noopener">å°è¯• Redis</a></p>
<p>npm æ¨¡å—ï¼š<a href="https://www.npmjs.com/package/redis" target="_blank" rel="noopener">redis</a></p>
<h2>2. MongoDB</h2>
<p>MongoDB æ˜¯ä¸€ä¸ªé€šç”¨çš„éå…³ç³»å‹æ•°æ®åº“ã€‚</p>
<p>MongoDB æ•°æ®åº“æŠŠæ–‡æ¡£å­˜åœ¨é›†åˆï¼ˆcollectionï¼‰ä¸­ï¼Œé›†åˆä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½å¯ä»¥æœ‰ä¸åŒçš„schemaã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075549.jpg" alt="MongoDB ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½å¯èƒ½æœ‰ä¸€ä¸ªå®Œå…¨ä¸åŒçš„schema"></p>
<p>npm æ¨¡å—ï¼š</p>
<ul>
<li><a href="https://www.npmjs.com/package/mongodb" target="_blank" rel="noopener">node-mongodb-native</a></li>
</ul>
<h2>3. Mongoose</h2>
<p>Mongoose çš„æ¨¡å‹ï¼ˆæ¨¡å‹â€”è§†å›¾â€”æ§åˆ¶å™¨ä¸­çš„è¯´æ³•ï¼‰æä¾›äº†ä¸€ä¸ªåˆ° MongoDB é›†åˆæ¥å£ï¼Œä»¥åŠä¸€äº›å®ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚schema å±‚æ¬¡ç»“æ„ï¼Œä¸­é—´ä»¶ä»¥åŠæ•°æ®æ ¡éªŒã€‚</p>
<ul>
<li>schema å±‚æ¬¡ç»“æ„å¯ä»¥è®©ä¸€ä¸ªæ¨¡å‹è·Ÿå…¶ä»–æ¨¡å‹å…³è”ã€‚</li>
<li>ä¸­é—´ä»¶å¯ä»¥è½¬æ¢æ•°æ®ï¼Œæˆ–åœ¨æ“ä½œæ¨¡å‹æ•°æ®çš„è¿‡ç¨‹ä¸­è§¦å‘é€»è¾‘ï¼Œè®©åˆ é™¤çˆ¶æ•°æ®æ—¶å¯¹å­æ•°æ®çš„ä¿®å‰ªè¿™æ ·çš„ä»»åŠ¡å˜æˆè‡ªåŠ¨åŒ–çš„ã€‚</li>
<li>Mongoose çš„æ ¡éªŒæ”¯æŒè®©ä½ å¯ä»¥åœ¨ schema å±‚é¢å†³å®šä»€ä¹ˆæ ·çš„æ•°æ®æ˜¯å¯æ¥å—çš„ï¼Œè€Œä¸æ˜¯å¿…é¡»æ‰‹å·¥å¤„ç†å®ƒã€‚</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/02/Node.jså®æˆ˜_2.æ„å»º Node Web ç¨‹åº/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/02/Node.jså®æˆ˜_2.æ„å»º Node Web ç¨‹åº/" class="post-title-link" itemprop="url">Node.jså®æˆ˜_2.æ„å»º Node Web ç¨‹åº</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-02 13:55:00" itemprop="dateCreated datePublished" datetime="2018-11-02T13:55:00+08:00">2018-11-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-05-01 21:01:43" itemprop="dateModified" datetime="2019-05-01T21:01:43+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">14k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">13 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2>ä¸€ã€HTTP æœåŠ¡å™¨çš„åŸºç¡€çŸ¥è¯†</h2>
<p>Node çš„ http æ¨¡å—ï¼šCç¼–å†™ã€åº•å±‚ã€ç®€å•ã€çµæ´»ã€é«˜æ•ˆã€‚
Nodeçš„ç­–ç•¥æ˜¯æä¾›å°è€Œå¼ºçš„ç½‘ç»œAPIï¼Œåƒä¼šè¯ï¼ˆSessionï¼‰è¿™ç§é«˜çº§æ¦‚å¿µä»¥åŠ HTTP cookies è¿™æ ·çš„åŸºç¡€ç»„ä»¶éƒ½æ²¡æœ‰åŒ…æ‹¬åœ¨Nodeçš„å†…æ ¸ä¹‹ä¸­ã€‚é‚£äº›éƒ½è¦ç”±ç¬¬ä¸‰æ–¹æ¨¡å—æä¾›ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075052.jpg" alt="Node Webç¨‹åºåˆ†å±‚æ¦‚è§ˆ"></p>
<p>&lt;!-- more --&gt;</p>
<h3>1. Node å¦‚ä½•å‘å¼€å‘è€…å‘ˆç°HTTPè¯·æ±‚</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075053.jpg" alt="image"></p>
<p>Node æœåŠ¡å™¨æ”¶åˆ°HTTPè¯·æ±‚ä¹‹åï¼š</p>
<ol>
<li>è§£æHTTPè¯·æ±‚å¤´ï¼ˆHTTP Headï¼‰ï¼›</li>
<li>è§¦å‘å›è°ƒå‡½æ•°ï¼ˆfunction(req, res) {...} ï¼‰ï¼›</li>
<li>è§£æHTTPè¯·æ±‚ä½“ï¼ˆHTTP Bodyï¼‰ï¼›</li>
<li>æ‰§è¡Œåº”ç”¨é€»è¾‘ï¼›</li>
<li>è°ƒç”¨ <code>res.end()</code> ç»“æŸå“åº”ï¼›</li>
</ol>
<h3>2. ä¸€ä¸ªç”¨â€œHello Worldâ€åšå“åº”çš„HTTPæœåŠ¡å™¨</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http æ¨¡å—æä¾›äº†HTTPæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ¥å£ã€‚</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http.createServer()ï¼šåˆ›å»ºHTTPæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°HTTPè¯·æ±‚åéƒ½ä¼šè°ƒç”¨å®ƒçš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// res.write():å°†å“åº”æ•°æ®å†™åˆ°socketä¸­</span></span><br><span class="line">    res.write(<span class="string">'Hello World'</span>);</span><br><span class="line">    <span class="comment">// res.end():ç»“æŸå“åº”</span></span><br><span class="line">    res.end(); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// res.write() å’Œ res.end() å¯ä»¥åˆå¹¶ç¼©å†™ï¼š</span></span><br><span class="line">    <span class="comment">// res.end('Hello World');</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»‘å®šç›‘å¬ç«¯å£</span></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h3>3. è¯»å–ã€è®¾å®šå“åº”å¤´</h3>
<p>Node ä¸­ä¿®æ”¹HTTPå“åº”å¤´çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>res.setHeader(field, value)</code></li>
<li><code>res.getHeader(field, value)</code></li>
<li><code>res.removeHeader(field)</code></li>
</ul>
<p>æ·»åŠ å’Œç§»é™¤å“åº”å¤´çš„é¡ºåºå¯ä»¥éšæ„ï¼Œä½†ä¸€å®šè¦åœ¨è°ƒç”¨ <code>res.write()</code> æˆ–<code>res.end()</code> ä¹‹å‰ã€‚</p>
<p>ç¤ºä¾‹ï¼Œä½¿ç”¨ <code>res.setHeader()</code>ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> body = <span class="string">'Hello World'</span>;</span><br><span class="line">res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(body));</span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">res.end(body);</span><br></pre></td></tr></table></figure></p>
<h3>4. è®¾å®šHTTPå“åº”çš„çŠ¶æ€ç </h3>
<p>å“åº”çŠ¶æ€ç éœ€è¦è®¾å®š <code>res.statusCode</code> å±æ€§ã€‚åœ¨ç¨‹åºå“åº”æœŸé—´å¯ä»¥éšæ—¶ç»™è¿™ä¸ªå±æ€§èµ‹å€¼ï¼Œåªè¦æ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>res.write()</code>æˆ–<code>res.end()</code>ä¹‹å‰å°±è¡Œã€‚</p>
<p><code>res.statusCode</code> é»˜è®¤çš„å“åº”çŠ¶æ€ç æ˜¯200 OKã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> body = <span class="string">'Hello World'</span>;</span><br><span class="line">res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(body));</span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">res.statusCode = <span class="number">302</span>;</span><br><span class="line">res.end(body); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸Šå¯ä»¥ç®€å†™å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="keyword">const</span> body = <span class="string">'Hello World'</span>;</span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">    <span class="string">'Content-Length'</span>: Buffer.byteLength(body),</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">&#125;);</span><br><span class="line">res.end();</span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒï¼š<a href="https://www.wikiwand.com/zh-hans/HTTP%E7%8A%B6%E6%80%81%E7%A0%81" target="_blank" rel="noopener">Wikiwandï¼šHTTP çŠ¶æ€ç </a></p>
<table>
<thead>
<tr>
<th>HTTPçŠ¶æ€ç </th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>1xx</td>
<td>æ¶ˆæ¯</td>
</tr>
<tr>
<td>2xx</td>
<td>æˆåŠŸ</td>
</tr>
<tr>
<td>3xx</td>
<td>é‡å®šå‘</td>
</tr>
<tr>
<td>4xx</td>
<td>å®¢æˆ·ç«¯é”™è¯¯</td>
</tr>
<tr>
<td>5xx</td>
<td>æœåŠ¡å™¨é”™è¯¯</td>
</tr>
</tbody>
</table>
<h2>äºŒã€æ„å»º RESTful Web æœåŠ¡</h2>
<p>åˆ›å»ºæ ‡å‡†çš„RESTæœåŠ¡å™¨éœ€è¦å®ç°å››ä¸ªHTTPè°“è¯ï¼Œæ¯ä¸ªè°“è¯ä¼šè¦†ç›–ä¸€ä¸ªå¾…åŠäº‹é¡¹æ¸…å•çš„æ“ä½œä»»åŠ¡:</p>
<table>
<thead>
<tr>
<th>HTTP Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>å¢ï¼Œå‘å¾…åŠäº‹é¡¹æ¸…å•ä¸­æ·»åŠ äº‹é¡¹</td>
</tr>
<tr>
<td>GET</td>
<td>æŸ¥ï¼Œæ˜¾ç¤ºå½“å‰äº‹é¡¹åˆ—è¡¨ï¼Œæˆ–è€…æ˜¾ç¤ºæŸä¸€äº‹é¡¹çš„è¯¦æƒ…;</td>
</tr>
<tr>
<td>DELETE</td>
<td>åˆ ï¼Œä»å¾…åŠäº‹é¡¹æ¸…å•ä¸­ç§»é™¤äº‹é¡¹;</td>
</tr>
<tr>
<td>PUT</td>
<td>æ”¹ï¼Œä¿®æ”¹å·²æœ‰äº‹é¡¹</td>
</tr>
</tbody>
</table>
<h3>1. ç”¨ POST è¯·æ±‚åˆ›å»ºèµ„æº</h3>
<p>å½“ Node çš„ HTTP è§£æå™¨è¯»å…¥å¹¶è§£æè¯·æ±‚æ•°æ®æ—¶ï¼Œå®ƒä¼šå°†æ•°æ®åšæˆ data äº‹ä»¶çš„å½¢å¼ï¼ŒæŠŠè§£æå¥½çš„æ•°æ®å—æ”¾å…¥å…¶ä¸­ï¼Œç­‰å¾…ç¨‹åºå¤„ç†ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ•°æ®å—é»˜è®¤æ˜¯ Buffer å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// å°†æµç¼–ç è®¾å®šä¸ºutf8ï¼Œè¿™æ ·dataäº‹ä»¶ä¼šç»™å‡ºå­—ç¬¦ä¸²</span></span><br><span class="line">    req.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    <span class="comment">// 1. åªè¦è¯»å…¥äº†æ–°çš„æ•°æ®å—ï¼Œå°±ä¼šè§¦å‘ data äº‹ä»¶ã€‚</span></span><br><span class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'parsed'</span>, chunk); </span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 2. æ•°æ®å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œè§¦å‘ end äº‹ä»¶ã€‚</span></span><br><span class="line">    req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'done parsing'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>åœ¨Nodeä¸­ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ <code>req.method</code> å±æ€§æŸ¥çœ‹ç”¨çš„æ˜¯å“ªä¸ªHTTPæ–¹æ³•(è°“è¯)ã€‚</p>
<p>ç¤ºä¾‹ï¼šPOSTè¯·æ±‚å­—ç¬¦ä¸²ç¼“å­˜ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> items = []; <span class="comment">// ç”¨ä¸€ä¸ªJSæ•°ç»„å­˜æ”¾æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (req.method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">            <span class="keyword">var</span> item = <span class="string">''</span>; <span class="comment">// è¿›æ¥çš„å­—ç¬¦ä¸²ç¼“å­˜</span></span><br><span class="line">            req.setEncoding(<span class="string">'utf8'</span>); <span class="comment">// å°†è¿›æ¥çš„ data äº‹ä»¶ç¼–ç ä¸º utf8</span></span><br><span class="line">            req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                item += chunk;</span><br><span class="line">            &#125;);</span><br><span class="line">            req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                items.push(item); <span class="comment">// å°†å®Œæ•´çš„äº‹é¡¹å‹å…¥æ•°ç»„</span></span><br><span class="line">                res.end(<span class="string">'OK\n'</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h3>2. ç”¨ GET è¯·æ±‚è·å–èµ„æº</h3>
<p>switch ä¸­æ·»åŠ å¦‚ä¸‹åˆ†æ”¯ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">    items.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item, i</span>) </span>&#123;</span><br><span class="line">        res.write(i + <span class="string">') '</span> + item + <span class="string">'\n'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    res.end;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>æµ‹è¯•ï¼š</p>
<p><a href="https://curl.haxx.se/download.html" target="_blank" rel="noopener">cURL</a>æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤è¡ŒHTTPå®¢æˆ·ç«¯ï¼Œå¯ä»¥ç”¨æ¥å‘ç›®æ ‡æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -d è¡¨ç¤ºè¯·æ±‚æ–¹æ³•ä¸º POST</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -d <span class="string">'buy groceries'</span> http://localhost:3000</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -d <span class="string">'buy node in action'</span> http://localhost:3000</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> GET æ˜¯é»˜è®¤çš„æ–¹æ³•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost:3000</span></span><br><span class="line">0) buy groceries</span><br><span class="line">1) buy node in action</span><br></pre></td></tr></table></figure></p>
<h4>è®¾å®š Content-Length å¤´</h4>
<p>åœ¨å“åº”ä¸­è®¾ç½® <strong>Content-Length</strong> å¯ä»¥æé«˜å“åº”é€Ÿåº¦ã€‚</p>
<p>è®¾å®š <strong>Content-Length</strong> åŸŸä¼šéšå«ç¦ç”¨Nodeçš„å—ç¼–ç ï¼Œå› ä¸ºè¦ä¼ è¾“çš„æ•°æ®æ›´å°‘ï¼Œæ‰€ä»¥èƒ½æå‡æ€§èƒ½ã€‚</p>
<p>ç»è¿‡ä¼˜åŒ–çš„ GET å¤„ç†å¦‚ä¸‹ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">    <span class="keyword">var</span> body = items.map(<span class="function"><span class="keyword">function</span> (<span class="params">item, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i + <span class="string">') '</span> + item;</span><br><span class="line">    &#125;).join(<span class="string">'\n'</span>);</span><br><span class="line">    res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(body)); <span class="comment">// âš ï¸</span></span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain; charset="utf-8"'</span>);</span><br><span class="line">    res.end(body);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>âš ï¸</p>
<p><strong>Buffer.byteLength()</strong></p>
<p>ä½ å¯èƒ½æƒ³ç”¨ <code>body.length</code> çš„å€¼è®¾å®š <strong>Content-Length</strong>ï¼Œä½† <strong>Content-Length</strong> çš„å€¼åº”è¯¥æ˜¯å­—èŠ‚é•¿åº¦ï¼Œä¸æ˜¯å­—ç¬¦é•¿åº¦ï¼Œå¹¶ä¸”å¦‚æœå­—ç¬¦ä¸²ä¸­æœ‰å¤šå­—èŠ‚å­—ç¬¦ï¼Œä¸¤è€…çš„é•¿åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ï¼ŒNodeæä¾›äº†ä¸€ä¸ª<code>Buffer.byteLength()</code> æ–¹æ³•ã€‚</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># Node REPL æµ‹è¯•</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> â˜  ~ [master] âš¡  node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> &gt; <span class="string">'etcå¼ ä¸‰'</span>.length</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 5</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> &gt; Buffer.byteLength(<span class="string">'etcå¼ ä¸‰'</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 9</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4>Node REPL ç¯å¢ƒ</h4>
<blockquote>
<p>Nodeè·Ÿå¾ˆå¤šå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œæä¾›äº†ä¸€ä¸ªREPL(è¯»å–-è®¡ç®—-è¾“å‡º-å¾ªç¯)ç¯å¢ƒï¼Œåœ¨å‘½ä»¤è¡Œä¸­ä¸å¸¦ä»»ä½•å‚æ•°è¿è¡Œnodeå°±å¯ä»¥è¿›å…¥è¿™ä¸ªç¯å¢ƒã€‚ç”¨REPLå¯ä»¥ç¼–å†™ä»£ç ç‰‡æ®µï¼Œæ¯æ¡è¯­å¥å†™å¥½å¹¶æ‰§è¡Œåé©¬ä¸Šå°±èƒ½å¾—åˆ°ç»“æœã€‚å¯¹äºå­¦ä¹ ç¼–ç¨‹è¯­è¨€ã€è¿è¡Œç®€å•çš„æµ‹è¯•ï¼Œç”šè‡³æ˜¯è°ƒè¯•éƒ½å¾ˆæœ‰å¸®åŠ©ã€‚</p>
</blockquote>
<h3>3. ç”¨ DELETE è¯·æ±‚ç§»é™¤èµ„æº</h3>
<p><code>req.url</code> å±æ€§ä¸­åŒ…å«äº†å®¢æˆ·ç«¯è¯·æ±‚çš„URLï¼Œæ ¹æ®è¯·æ±‚çš„ä¸åŒï¼Œå…¶ä¸­å¯èƒ½åŒ…å«å‡ ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> require(<span class="string">'url'</span>).parse(<span class="string">'http://localhost:3000/v1?key=value'</span>)</span></span><br><span class="line">Url &#123;</span><br><span class="line">  protocol: 'http:',</span><br><span class="line">  slashes: true,</span><br><span class="line">  auth: null,</span><br><span class="line">  host: 'localhost:3000',</span><br><span class="line">  port: '3000',</span><br><span class="line">  hostname: 'localhost',</span><br><span class="line">  hash: null,</span><br><span class="line">  search: '?key=value',</span><br><span class="line">  query: 'key=value',</span><br><span class="line">  pathname: '/v1',</span><br><span class="line">  path: '/v1?key=value', # è¯·æ±‚è·¯å¾„</span><br><span class="line">  href: 'http://localhost:3000/v1?key=value' &#125;</span><br></pre></td></tr></table></figure></p>
<p>DELETE è¯·æ±‚å¤„ç†ä»£ç ç‰‡æ®µï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">    <span class="keyword">var</span> path = url.parse(req.url).pathname;</span><br><span class="line">    <span class="comment">// pathnameæ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—</span></span><br><span class="line">    <span class="comment">// String.slice(),æå–å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="comment">// parseInt(),JavaScript çš„å…¨å±€å‡½æ•°ï¼Œè§£æä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›æ•´æ•°ã€‚</span></span><br><span class="line">    <span class="comment">// 10 è¡¨ç¤ºå­—ç¬¦ä¸²åŸºæ•°ï¼Œåè¿›åˆ¶ã€‚</span></span><br><span class="line">    <span class="keyword">var</span> i = <span class="built_in">parseInt</span>(path.slice(<span class="number">1</span>), <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(i)) &#123; <span class="comment">// æ£€æŸ¥æ•°å­—æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        res.statusCode = <span class="number">400</span>;</span><br><span class="line">        res.end(<span class="string">'Invalid item id'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!items[i]) &#123; <span class="comment">// ç¡®ä¿è¯·æ±‚çš„ç´¢å¼•å­˜åœ¨</span></span><br><span class="line">        res.statusCode = <span class="number">400</span>;</span><br><span class="line">        res.end(<span class="string">'Item not found'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        items.splice(i, <span class="number">1</span>); <span class="comment">// åˆ é™¤è¯·æ±‚çš„äº‹é¡¹</span></span><br><span class="line">        res.end(<span class="string">'OK\n'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<h2>ä¸‰ã€æä¾›é™æ€æ–‡ä»¶æœåŠ¡</h2>
<p>é™æ€æ–‡ä»¶ï¼ˆCSSã€JavaScriptã€å›¾ç‰‡ï¼‰æœåŠ¡å™¨ã€‚</p>
<p>fsï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰æ¨¡å—ï¼Œæ˜¯æä¾›é™æ€æœåŠ¡çš„å¿…å¤‡æ¨¡å—ã€‚</p>
<h3>1. åˆ›å»ºä¸€ä¸ªé™æ€æ–‡ä»¶æœåŠ¡å™¨</h3>
<p>æ¯ä¸ªé™æ€æ–‡ä»¶æœåŠ¡å™¨éƒ½æœ‰ä¸ªæ ¹ç›®å½•ï¼Œä¹Ÿå°±æ˜¯æä¾›æ–‡ä»¶æœåŠ¡çš„åŸºç¡€ç›®å½•ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">'url'</span>).parse;</span><br><span class="line"><span class="keyword">const</span> join = <span class="built_in">require</span>(<span class="string">'path'</span>).join;</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> root = __dirname; <span class="comment">// é™æ€æ–‡ä»¶æœåŠ¡å™¨çš„æ ¹ç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * url.pathname = /index.html</span></span><br><span class="line"><span class="comment"> * root = /var/www/example.com/public</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * path.join() =&gt; /var/www/example.com/public/index.html</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = parse(req.url);</span><br><span class="line">    <span class="keyword">var</span> path = join(root, url.pathname); <span class="comment">// æ„é€ ç»å¯¹è·¯å¾„</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> stream = fs.createReadStream(path); <span class="comment">// fs.ReadStream</span></span><br><span class="line">    stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123; </span><br><span class="line">        res.write(chunk); <span class="comment">// å°†æ–‡ä»¶æ•°æ®å†™å…¥åˆ°å“åº”ä¸­</span></span><br><span class="line">    &#125;)</span><br><span class="line">    stream.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        res.end(); <span class="comment">// æ–‡ä»¶å†™å®Œåç»“æŸå“åº”</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>âš ï¸</p>
<p><strong>ç›®å½•éå†æ”»å‡»</strong></p>
<p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥å…¨é¢åœ°æ£€æŸ¥è¾“å…¥çš„æœ‰æ•ˆæ€§ï¼Œä»¥é˜²ç”¨æˆ·é€šè¿‡ç›®å½•éå†æ”»å‡»è®¿é—®åˆ°ä½ æœ¬æ¥ä¸æƒ³å¼€æ”¾ç»™ä»–ä»¬çš„é‚£éƒ¨åˆ†å†…å®¹ã€‚</p>
</blockquote>
<h4>ç”¨ Stream.pipe() ä¼˜åŒ–æ•°æ®ä¼ è¾“</h4>
<blockquote>
<p><strong>ç®¡é“å’Œæ°´ç®¡</strong></p>
<p>ç®¡é“å¯ä»¥è®©æ¥è‡ªæºå¤´ï¼ˆå³ReadableStreamï¼‰çš„æ•°æ®ï¼Œæµåˆ°æŸä¸ªç›®çš„åœ°ï¼ˆå³WritableStreamï¼‰ã€‚</p>
<p>ç”¨ <code>pipe()</code> æ–¹æ³•è¿æ¥ç®¡é“ã€‚</p>
<p>ReadableStream.pipe(WritableStream);</p>
<p>è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼ˆReadableStreamï¼‰å¹¶æŠŠå…¶ä¸­çš„å†…å®¹å†™åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆWritableStreamï¼‰ç”¨çš„å°±æ˜¯ç®¡é“:</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> readStream = fs.createReadStream(<span class="string">'./original.txt'</span>);</span><br><span class="line">&gt; <span class="keyword">var</span> writeStream = fs. createWriteStream(<span class="string">'./copy.txt'</span>);</span><br><span class="line">&gt; readStream.pipe(writeStream);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>æ‰€æœ‰ReadableStreaméƒ½èƒ½æ¥å…¥ä»»ä½•ä¸€ä¸ªWritableStreamã€‚æ¯”å¦‚HTTPè¯·æ±‚(req)å¯¹è±¡å°±æ˜¯ReadableStreamï¼Œä½ å¯ä»¥è®©å…¶ä¸­çš„å†…å®¹æµåŠ¨åˆ°æ–‡ä»¶ä¸­:</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; req.pipe(fs.createWriteStream(<span class="string">'./req-body.txt'</span>));</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>ç”¨ pipe() ç®€åŒ–æœåŠ¡å™¨ç«¯ä»£ç ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = parse(req.url);</span><br><span class="line">    <span class="keyword">var</span> path = join(root, url.pathname); <span class="comment">// æ„é€ ç»å¯¹è·¯å¾„</span></span><br><span class="line">    <span class="keyword">var</span> stream = fs.createReadStream(path); <span class="comment">// fs.ReadStream</span></span><br><span class="line">    stream.pipe(res); <span class="comment">// res.end() ä¼šåœ¨ stream.pipe() å†…éƒ¨è°ƒç”¨</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3>2. å¤„ç†æœåŠ¡å™¨é”™è¯¯</h3>
<p>å¦‚ä½•è®©NodeæœåŠ¡å™¨æ›´åŠ å¥å£®ï¼Ÿ</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ç›‘å¬å™¨ï¼Œerroräº‹ä»¶ä¼šè¢«æŠ›å‡ºã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ ä¸ç›‘å¬è¿™äº›é”™è¯¯ï¼Œé‚£å®ƒä»¬å°±ä¼šæå®ä½ çš„æœåŠ¡å™¨ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   ...</span><br><span class="line">stream.pipe(res);</span><br><span class="line">   stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123; <span class="comment">// æ³¨å†Œerroräº‹ä»¶å¤„ç†å™¨</span></span><br><span class="line">       res.statusCode = <span class="number">500</span>;</span><br><span class="line">       res.end(<span class="string">'Internal Server Error'</span>);</span><br><span class="line">   &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h3>3. ç”¨ fs.stat() å®ç°å…ˆå‘åˆ¶äººçš„é”™è¯¯å¤„ç†</h3>
<p><code>fs.stat()</code> ç”¨äºè·å–æ–‡ä»¶ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åœ¨å“åº”ä¸­æä¾›Content-Length</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = parse(req.url);</span><br><span class="line">    <span class="keyword">var</span> path = join(root, url.pathname); <span class="comment">// æ„é€ ç»å¯¹è·¯å¾„</span></span><br><span class="line">    fs.stat(path, <span class="function"><span class="keyword">function</span> (<span class="params">err, stat</span>) </span>&#123; <span class="comment">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'ENOENT'</span> == err.code) &#123;</span><br><span class="line">                res.statusCode = <span class="number">404</span>;</span><br><span class="line">                res.end(<span class="string">'Not Found'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// å…¶ä»–é”™è¯¯</span></span><br><span class="line">                res.statusCode = <span class="number">500</span>;</span><br><span class="line">                res.end(<span class="string">'Internal Server Error'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç”¨ stat å¯¹è±¡çš„å±æ€§è®¾ç½® Content-Length</span></span><br><span class="line">            res.setHeader(<span class="string">'Content-Length'</span>, stat.size); </span><br><span class="line">            <span class="keyword">var</span> stream = fs.createReadStream(path); <span class="comment">// fs.ReadStream</span></span><br><span class="line">            stream.pipe(res); <span class="comment">// res.end() ä¼šåœ¨ stream.pipe() å†…éƒ¨è°ƒç”¨</span></span><br><span class="line">            stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">                res.statusCode = <span class="number">500</span>;</span><br><span class="line">                res.end(<span class="string">'Internal Server Error'</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ğŸ’¡ğŸ’¡ğŸ’¡</p>
<p>ä¸æ¨èåœ¨è°ƒç”¨<code>fs.open()</code>, <code>fs.readFile()</code> or <code>fs.writeFile()</code> å‰é€šè¿‡ä½¿ç”¨ <code>fs.stat()</code> æ¥æ£€æŸ¥æŸä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¼€å‘è€…åº”å½“é€šè¿‡ç›´æ¥ open/read/write æ–‡ä»¶å¹¶æ£€æµ‹äº§ç”Ÿçš„å¼‚å¸¸æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯ç”¨ã€‚</p>
<p>å¦‚æœä¸éœ€è¦æ“ä½œæ–‡ä»¶åªæ˜¯æƒ³è·å–æ–‡ä»¶æ˜¯å¦å¯ç”¨ï¼Œæ¨èä½¿ç”¨ <a href="http://nodejs.cn/s/NCPsM3" target="_blank" rel="noopener"><code>fs.access()</code></a>ã€‚</p>
</blockquote>
<h2>å››ã€ä»è¡¨å•ä¸­æ¥å—ç”¨æˆ·è¾“å…¥</h2>
<p>Node ä¸ä¼šå¸®ä½ æ‰¿æ‹…å¤„ç†è¡¨å•çš„å·¥ä½œ(æ¯”å¦‚éªŒè¯æˆ–æ–‡ä»¶ä¸Šä¼ )ï¼Œå®ƒåªèƒ½æŠŠè¯·æ±‚bodyæ•°æ®äº¤ç»™ä½ ã€‚å°½ç®¡è¿™çœ‹èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œä½†Nodeä¸€è´¯çš„å®—æ—¨æ˜¯æä¾›ç®€å•é«˜æ•ˆçš„åº•å±‚APIï¼ŒæŠŠå…¶ä»–æœºä¼šç•™ç»™äº†ç¬¬ä¸‰æ–¹æ¡†æ¶ã€‚</p>
<table>
<thead>
<tr>
<th>è¡¨å•æäº¤çš„ Content-Type å€¼</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>application/x-www-form-urlencoded</td>
<td>HTML è¡¨å•é»˜è®¤å€¼</td>
</tr>
<tr>
<td>multipart/form-data</td>
<td>è¡¨å•ä¸­å«æœ‰æ–‡ä»¶æˆ–éASCIIæˆ–äºŒè¿›åˆ¶æ•°æ®æ—¶ä½¿ç”¨</td>
</tr>
</tbody>
</table>
<h3>1. å¤„ç†æäº¤çš„è¡¨å•åŸŸ</h3>
<p>æ”¯æŒGETå’ŒPOSTçš„HTTPæœåŠ¡å™¨ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> qs = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> items = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'/'</span> == req.url) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (req.method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">                show(res);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                add(req, res);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                badRequest(res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        notFound(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ç”¨æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹æ³•ç”Ÿæˆ HTML</span></span><br><span class="line">    <span class="keyword">var</span> html = <span class="string">'&lt;html&gt;&lt;head&gt;&lt;title&gt;Todo List&lt;/title&gt;&lt;/head&gt;&lt;body&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;h1&gt;Todo List&lt;/h1&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;ul&gt;'</span></span><br><span class="line">            + items.map(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'&lt;li&gt;'</span> + item + <span class="string">'&lt;/li&gt;'</span></span><br><span class="line">            &#125;).join(<span class="string">' '</span>)</span><br><span class="line">            + <span class="string">'&lt;/ul&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;form method="post" action="/"&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;p&gt;&lt;input type="text" name="item" /&gt;&lt;/p&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;p&gt;&lt;input type="submit" value="Add Item" /&gt;&gt;&lt;/p&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>;</span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</span><br><span class="line">res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(html));</span><br><span class="line">res.end(html);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;</span><br><span class="line">    req.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// æŠŠdataäº‹ä»¶çš„æ•°æ®å—æ‹¼æ¥åˆ°ä¸€èµ·å½¢æˆå®Œæ•´çš„è¯·æ±‚bodyå­—ç¬¦ä¸²ã€‚</span></span><br><span class="line">        body += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> obj = qs.parse(body);</span><br><span class="line">        items.push(obj.item);</span><br><span class="line">        show(res);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 404 Not Found</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notFound</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    res.statusCode = <span class="number">404</span>;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">    res.end(<span class="string">'Not Found'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 400 Bad Requests</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">badRequest</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = <span class="string">'Bad Request'</span>;</span><br><span class="line">    res.writeHead(<span class="number">400</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Length'</span>: Buffer.byteLength(body),</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>2. ç”¨formidableå¤„ç†ä¸Šä¼ çš„æ–‡ä»¶</h3>
<p>å®ç°Webä¸­çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œè¡¨å•çš„ enctype å±æ€§éœ€è¦è®¾ç½®ä¸º multipart/form-data--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"/"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Upload"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸‰æ–¹æ¨¡å—ï¼š<a href="https://www.npmjs.com/package/formidable" target="_blank" rel="noopener">npmï¼šformmidable</a>ï¼Œformidable çš„æµå¼è§£æå™¨æ˜¯å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„ç»ä½³é€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒèƒ½éšç€æ•°æ®å—çš„ä¸Šä¼ æ¥æ”¶å®ƒä»¬ï¼Œè§£æå®ƒä»¬ï¼Œå¹¶åå‡ºç‰¹å®šçš„éƒ¨åˆ†ã€‚è¿™ç§æ–¹å¼ä¸ä»…å¿«é€Ÿï¼Œè¿˜ä¸ä¼šå› ä¸ºéœ€è¦å¤§é‡ç¼“å†²è€Œå¯¼è‡´å†…å­˜è†¨èƒ€ï¼Œå³ä¾¿åƒè§†é¢‘è¿™ç§å¤§å‹æ–‡ä»¶ï¼Œä¹Ÿä¸ä¼šæŠŠè¿›ç¨‹å‹å®ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> formidable = <span class="built_in">require</span>(<span class="string">'formidable'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (req.method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">            show(req, res);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">            upload(req, res);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å¸¦æœ‰æ–‡ä»¶ä¸Šä¼ æ§ä»¶çš„ HTML è¡¨å•</span></span><br><span class="line">    <span class="keyword">var</span> html = <span class="string">' '</span></span><br><span class="line">            + <span class="string">'&lt;form method="post" action="/" enctype="multipart/form-data"&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;p&gt;&lt;input type="text" name="name" /&gt;&lt;/p&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;p&gt;&lt;input type="file" name="file" /&gt;&lt;/p&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;p&gt;&lt;input type="submit" value="Upload" /&gt;&lt;/p&gt;'</span></span><br><span class="line">            + <span class="string">'&lt;/form&gt;'</span>;</span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</span><br><span class="line">res.setHeader(<span class="string">'Content-Length'</span>, Buffer.byteLength(html));</span><br><span class="line">res.end(html);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFormData(req)) &#123;</span><br><span class="line">        res.statusCode = <span class="number">400</span>;</span><br><span class="line">        res.end(<span class="string">'Bad Request: expecting multipart/form-data'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> form = <span class="keyword">new</span> formidable.IncomingForm();</span><br><span class="line">    <span class="comment">// // æ”¶å®Œè¾“å…¥åŸŸåä¼šå‘å‡º field äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// // æ¯å½“æ”¶åˆ°å­—æ®µ / å€¼å¯¹æ—¶å‘å‡ºã€‚</span></span><br><span class="line">    <span class="comment">// form.on('field', function (name, value) &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(name);</span></span><br><span class="line">    <span class="comment">//     console.log(value);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// // åœ¨æ”¶åˆ°æ–‡ä»¶å¹¶å¤„ç†å¥½åä¼šå‘å‡º file äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// // æ–‡ä»¶ä¸Šä¼ å®Œæˆåå‘å‡ºäº†fileäº‹ä»¶</span></span><br><span class="line">    <span class="comment">// // æ¯å½“æ”¶åˆ°å­—æ®µ / æ–‡ä»¶å¯¹æ—¶å‘å‡ºã€‚</span></span><br><span class="line">    <span class="comment">// form.on('file', function (name, file) &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(name);</span></span><br><span class="line">    <span class="comment">//     console.log(file);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    <span class="comment">// form.on('end', function () &#123;</span></span><br><span class="line">    <span class="comment">//     res.end('upload complete');</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">    form.parse(req, <span class="function"><span class="keyword">function</span> (<span class="params">err, fields, files</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(fields);</span><br><span class="line">        <span class="built_in">console</span>.log(files);</span><br><span class="line">        res.end(<span class="string">'upload complete'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨String.indexOf()æ–¹æ³•æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„Content-Typeå­—æ®µï¼Œ æ–­è¨€å®ƒçš„å€¼æ˜¯ä»¥multipart/form-dataå¼€å¤´çš„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFormData</span>(<span class="params">req</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type = req.headers[<span class="string">'content-type'</span>] || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> == type.indexOf(<span class="string">'multipart/form-data'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>3. è®¡ç®—ä¸Šä¼ è¿›åº¦</h3>
<p><a href="https://github.com/felixge/node-formidable" target="_blank" rel="noopener">Formidable</a> çš„ progress äº‹ä»¶èƒ½ç»™å‡ºæ”¶åˆ°çš„å­—èŠ‚æ•°ï¼Œä»¥åŠæœŸæœ›æ”¶åˆ°çš„å­—èŠ‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªåšå‡ºä¸€ä¸ªè¿›åº¦æ¡ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">form.on(<span class="string">'progress'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">bytesReceived, bytesExpected</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> percent = <span class="built_in">Math</span>.floor(bytesReceived / bytesExpected * <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(percent);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥ï¼ŒæŠŠè¿™ä¸ªè¿›åº¦ä¼ å›åˆ°ç”¨æˆ·çš„æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <strong>WebSocket</strong> åè®®æˆ–è€… <strong>Socket.IO</strong> è¿™æ ·çš„å®æ—¶æ¨¡å—ã€‚</p>
<h2>äº”ã€ç”¨ HTTPS åŠ å¼ºç¨‹åºçš„å®‰å…¨æ€§</h2>
<p>å¼€å‘ç¯å¢ƒä¸­ï¼Œç”Ÿæˆè‡ªç­¾åè¯ä¹¦ç”¨äºæµ‹è¯•ï¼š</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨ OpenSSL ç”Ÿæˆç§é’¥</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl genrsa 2048 &gt; key.pem</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨ç§é’¥åˆ›å»ºè¯ä¹¦</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl req -x509 -new -key key.pem &gt; key-cert.pem</span></span><br></pre></td></tr></table></figure></p>
<p>HTTPS æœåŠ¡å™¨é…ç½®é¡¹ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½œä¸ºé…ç½®é¡¹çš„å¯†é’¥å’Œè¯ä¹¦</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    key: fs.readFileSync(<span class="string">'./key.pem'</span>),</span><br><span class="line">    cert: fs.readFileSync(<span class="string">'./key-cert.pem'</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https å’Œ http æ¨¡å—çš„APIå‡ ä¹ä¸€æ ·</span></span><br><span class="line">https.createServer(options, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'Hello World'</span>);</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/01/Node.jså®æˆ˜_1.Node åŸºç¡€/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/01/Node.jså®æˆ˜_1.Node åŸºç¡€/" class="post-title-link" itemprop="url">Node.jså®æˆ˜_1.Node åŸºç¡€</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-01 14:07:00" itemprop="dateCreated datePublished" datetime="2018-11-01T14:07:00+08:00">2018-11-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">12k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">11 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>Node åŸºç¡€</h1>
<p><strong>JavaScript æ˜¯ç¼–ç¨‹è¯­è¨€ï¼Œè€Œ Node.js æ˜¯æ‰§è¡Œç¯å¢ƒã€‚</strong></p>
<p>Node.js æ˜¯ä¸€ä¸ªåŸºäº Chrome V8 å¼•æ“çš„ JavaScript è¿è¡Œç¯å¢ƒï¼ˆruntimeï¼‰ã€‚</p>
<p>Node.js ç‰¹æ€§ï¼šäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥ APIã€éé˜»å¡ I/Oã€‚</p>
<p>Node.js æ˜¯ä¸“ä¸ºæ•°æ®å¯†é›†å‹å®æ—¶ç¨‹åºï¼ˆDITRï¼‰è®¾è®¡çš„ã€‚</p>
<p>Node.js é€šè¿‡**äº‹ä»¶è½®è¯¢ï¼ˆevent loopï¼‰**æ¥å®ç°éé˜»å¡I/Oç½‘ç»œçš„è°ƒç”¨ï¼Œè€Œäº‹ä»¶è½®è¯¢æ˜¯å•å‘è¿è¡Œçš„å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ã€‚</p>
<p>&lt;!-- more --&gt;</p>
<h2>ES2015</h2>
<p>ECMAScript 2015 æ˜¯ ECMAScript æ ‡å‡†çš„ç¬¬6ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸º ES6ï¼Œä¸€èˆ¬ç®€å†™ä¸º ES2015ã€‚</p>
<p><a href="https://node.green/" target="_blank" rel="noopener">Node æ”¯æŒçš„ ES2015 ç‰¹æ€§æ±‡æ€»</a></p>
<h3>ç±»</h3>
<p>ES5 ä¹‹å‰éœ€è¦ç”¨ prototype å¯¹è±¡æ¥åˆ›å»ºç±»ä¼¼äºç±»çš„ç»“æ„ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">User</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ„é€ å™¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">User.prototype.method = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ES6 ç‰ˆæœ¬æ”¯æŒç±»ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;&#125;</span><br><span class="line">  method() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>const å’Œ let è§£å†³ä½œç”¨åŸŸé—®é¢˜</h3>
<p>åœ¨ ES5 ä¸­ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½æ˜¯ç”¨ <code>var</code> åˆ›å»ºçš„ã€‚</p>
<blockquote>
<p>åº”è¯¥ç”¨ <code>const</code> è¿˜æ˜¯ <code>let</code>ï¼Ÿ</p>
<p>åœ¨å†³å®šæ˜¯ç”¨ <code>const</code> è¿˜æ˜¯ç”¨ <code>let</code> æ—¶ï¼Œå‡ ä¹éƒ½å¯ä»¥ç”¨ <code>const</code>ã€‚å› ä¸ºä½ çš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯åœ¨ç”¨ä½ è‡ªå·±çš„ç±»å®ä¾‹ã€å¯¹è±¡å¸¸é‡æˆ–ä¸ä¼šå˜çš„å€¼ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½å¯ä»¥ç”¨ <code>const</code>ã€‚å³ä¾¿æ˜¯æœ‰å¯ä¿®æ”¹å±æ€§çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨ <code>const</code> å£°æ˜çš„ï¼Œ<strong>å› ä¸º <code>const</code> çš„æ„æ€æ˜¯å¼•ç”¨æ˜¯åªè¯»çš„ï¼Œè€Œä¸æ˜¯å€¼æ˜¯ä¸å¯å˜çš„</strong>ã€‚</p>
</blockquote>
<h3>åŸç”Ÿçš„ promise å’Œç”Ÿæˆå™¨æ”¯æŒ</h3>
<p>ç”Ÿæˆå™¨èƒ½æŠŠå¼‚æ­¥ I/O å˜æˆåŒæ­¥ç¼–ç¨‹é£æ ¼ã€‚</p>
<h3>æ¨¡ç‰ˆå­—ç¬¦ä¸²</h3>
<p>ç”¨åå¼•å·ï¼ˆ`ï¼‰å®šä¹‰æ¨¡ç‰ˆå­—ç¬¦ä¸²</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5 ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡ä¸æ”¯æŒæ’å€¼ï¼Œä¹Ÿä¸æ”¯æŒè·¨è¡Œã€‚</span></span><br><span class="line"><span class="comment">// æ—§çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'ä¸€å…±æœ‰ '</span> + a + <span class="string">' ä¸ªé¸¡è›‹ï¼'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡ç‰ˆå­—ç¬¦ä¸²è¯­æ³•</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`ä¸€å…±æœ‰ <span class="subst">$&#123;a&#125;</span> ä¸ªé¸¡è›‹ï¼`</span>);</span><br></pre></td></tr></table></figure></p>
<h3>ç®­å¤´å‡½æ•°</h3>
<p>æ—§ç‰ˆè¯­æ³•ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.end(<span class="string">'Hello, world.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(port, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server listening on: http://localhost:%s'</span>, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>ç®­å¤´å‡½æ•°è¯­æ³•ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.end(<span class="string">'Hello, world.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(port, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server listening on: http://localhost:%s'</span>, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2>Node.js æ¶æ„</h2>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075914.jpg" alt="Node.js çš„è½¯ä»¶æ ˆ"></p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075916.jpg" alt="Node.js æ¶æ„"></p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>libuv æ˜¯æä¾›å¿«é€Ÿã€è·¨å¹³å°ã€éé˜»å¡ I/O çš„æœ¬åœ°åº“ï¼›</li>
<li>V8 è´Ÿè´£ JavaScript ä»£ç çš„è§£é‡Šå’Œæ‰§è¡Œï¼Œå®ƒå¯ä»¥å°† JavaScript ç›´æ¥ç¼–è¯‘ä¸ºæœºå™¨ç ï¼›</li>
<li>C++ ç»‘å®šå±‚å¯ä»¥å°† libuv å’Œ V8 ç»“åˆèµ·æ¥ã€‚</li>
</ul>
<h3>Node çš„ä½¿ç”¨åœºæ™¯</h3>
<p>Node ç¨‹åºä¸»è¦å¯ä»¥åˆ†æˆä¸‰ç§ç±»å‹ï¼šWeb åº”ç”¨ç¨‹åºã€å‘½ä»¤è¡Œå·¥å…·ã€å’Œåå°ç¨‹åºã€æ¡Œé¢ç¨‹åºã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075917.jpg" alt="Node çš„ä½¿ç”¨åœºæ™¯"></p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075920.jpg" alt="From @itying.com"></p>
<h2>Node åŠŸèƒ½çš„ç»„ç»‡åŠé‡ç”¨</h2>
<p>Node æ¨¡å—æ‰“åŒ…ä»£ç æ˜¯ä¸ºäº†é‡ç”¨ï¼Œä½†å®ƒä»¬ä¸ä¼šæ”¹å˜å…¨å±€ä½œç”¨åŸŸã€‚</p>
<p>Node çš„æ¨¡å—ç³»ç»Ÿé¿å…äº†å¯¹å…¨å±€ä½œç”¨åŸŸçš„æ±¡æŸ“ï¼Œä»è€Œä¹Ÿå°±é¿å…äº†å‘½åå†²çªï¼Œå¹¶ç®€åŒ–äº†ä»£ç çš„é‡ç”¨ã€‚</p>
<p>æ¨¡å—å³å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶çš„ç›®å½•ï¼ˆé»˜è®¤æ¨¡å—å…¥å£ä¸º index.js æ–‡ä»¶ï¼‰ã€‚</p>
<h4>currency.js</h4>
<p>è‡ªå®šä¹‰æ¨¡å—ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æ·»åŠ ä¸¤ä¸ªè´§å¸è½¬æ¢å‡½æ•°ï¼š
æ–¹æ³•ï¼šé€šè¿‡è®¾å®š <code>exports</code> å¯¹è±¡çš„å±æ€§æ¥æŒ‡æ˜è¦æš´éœ²çš„å‡½æ•°æˆ–å˜é‡ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç§æœ‰å˜é‡ï¼Œå¤–ç•Œæ— æ³•è®¿é—®åˆ°ã€‚</span></span><br><span class="line"><span class="keyword">var</span> candaianDollar = <span class="number">0.91</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">roundTwoDecimals</span>(<span class="params">amount</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.round(amount * <span class="number">100</span>) / <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// canadianToUS() å‡½æ•°è®¾å®šåœ¨ exports æ¨¡å—ä¸­ï¼Œæ‰€ä»¥å¼•å…¥è¿™ä¸ªæ¨¡å—çš„ä»£ç å¯ä»¥ä½¿ç”¨å®ƒã€‚</span></span><br><span class="line">exports.canadianToUS = <span class="function"><span class="keyword">function</span> (<span class="params">canadian</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> roundTwoDecimals(canadian * candaianDollar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// USToCanadian() å‡½æ•°ä¹Ÿè®¾å®šåœ¨ exports æ¨¡å—ä¸­ã€‚</span></span><br><span class="line">exports.USToCanadian = <span class="function"><span class="keyword">function</span> (<span class="params">us</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> roundTwoDecimals(us / candaianDollar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4>test-currency.js</h4>
<p>å¼•å…¥æ¨¡å—</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require() å‡½æ•°æ˜¯ä¸€ä¸ªåŒæ­¥I/Oå‡½æ•°ï¼Œä¸€èˆ¬åœ¨æ–‡ä»¶é¡¶ç«¯å¼•å…¥ã€‚</span></span><br><span class="line"><span class="comment">// ç›¸å¯¹è·¯å¾„ ./ è¡¨ç¤ºå½“å‰åŒä¸€ç›®å½•ä¸‹ã€‚</span></span><br><span class="line"><span class="keyword">const</span> currency = <span class="built_in">require</span>(<span class="string">'./currency'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ currency æ¨¡å—çš„ canadianToUS() å‡½æ•°</span></span><br><span class="line"><span class="built_in">console</span>.log(currency.canadianToUS(<span class="number">50</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ currency æ¨¡å—çš„ USToCanadian() å‡½æ•°</span></span><br><span class="line"><span class="built_in">console</span>.log(currency.USToCanadian(<span class="number">30</span>));</span><br></pre></td></tr></table></figure></p>
<h3>ç”¨ module.exports å¾®è°ƒæ¨¡å—çš„åˆ›å»º</h3>
<ul>
<li>
<p>å¦‚æœåªéœ€è¦ä»æ¨¡å—ä¸­å¾—åˆ°ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆä» require ä¸­è¿”å›ä¸€ä¸ªå‡½æ•°çš„ä»£ç æ¯”è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ä»£ç æ›´ä¼˜é›…ã€‚</p>
</li>
<li>
<p>ä¸èƒ½ç”¨ä»»ä½•å…¶ä»–å¯¹è±¡ã€å‡½æ•°æˆ–è€…å˜é‡ç»™ <strong>exports</strong> èµ‹å€¼ã€‚</p>
<blockquote>
<p>æˆ‘çš„ç†è§£ï¼šå¯ä»¥æŠŠå‡½æ•°æˆ–è€…å¯¹è±¡è®¾ç½®ä¸º exports çš„å±æ€§ï¼ˆ<code>exports.function = {...}</code>ï¼‰ï¼Œä½†æ˜¯ä¸èƒ½æŠŠå‡½æ•°æˆ–è€…å¯¹è±¡èµ‹å€¼ï¼ˆ<code>exports = function</code>ï¼‰ç»™ exportsã€‚</p>
</blockquote>
</li>
<li>
<p>ç”¨ <strong>module.exports</strong> å¯ä»¥å¯¹å¤–æä¾›å•ä¸ªå˜é‡ã€å‡½æ•°æˆ–è€…å¯¹è±¡ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªæ—¢æœ‰ <strong>exports</strong> åˆæœ‰ <strong>module.exports</strong> çš„æ¨¡å—ï¼Œé‚£å®ƒä¼šè¿”å› <strong>module.exports</strong>ï¼Œè€Œ <strong>exports</strong> ä¼šè¢«å¿½ç•¥ã€‚</p>
</li>
</ul>
<blockquote>
<p><strong>exports ä¸ module.exports</strong></p>
<p>æœ€ç»ˆåœ¨ç¨‹åºé‡Œå¯¼å‡ºçš„æ˜¯module.exportsã€‚<strong>exportsåªæ˜¯å¯¹module.exportsçš„ä¸€ä¸ªå…¨å±€å¼•ç”¨</strong>ï¼Œæœ€åˆè¢«å®šä¹‰ä¸ºä¸€ä¸ªå¯ä»¥æ·»åŠ å±æ€§çš„ç©ºå¯¹è±¡ã€‚æ‰€ä»¥exports.myFuncåªæ˜¯module.exports.myFuncçš„ç®€å†™ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæŠŠexportsè®¾å®šä¸ºåˆ«çš„ï¼Œå°±æ‰“ç ´äº†module.exportså’Œexportsä¹‹é—´çš„å¼•ç”¨å…³ç³»ã€‚</p>
</blockquote>
<ul>
<li>æ ¹æ®éœ€è¦ä½¿ç”¨ <strong>exports</strong> æˆ– <strong>module.exports</strong> å¯ä»¥å°†åŠŸèƒ½ç»„ç»‡æˆæ¨¡å—ï¼Œè§„é¿æ‰ç¨‹åºè„šæœ¬ä¸€ç›´å¢é•¿äº§ç”Ÿçš„å¼Šç«¯ã€‚</li>
</ul>
<h3>ç”¨ node_modules é‡ç”¨æ¨¡å—</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075922.jpg" alt="Node æŸ¥æ‰¾æ¨¡å—çš„æ­¥éª¤"></p>
<ul>
<li>ç”¨ç¯å¢ƒå˜é‡ <strong>NODE_PATH</strong> å¯ä»¥æ”¹å˜ Node æ¨¡å—çš„é»˜è®¤è·¯å¾„ã€‚</li>
</ul>
<h3>æ³¨æ„äº‹é¡¹</h3>
<ol>
<li>å¦‚æœæ¨¡å—æ˜¯ç›®å½•ï¼Œåœ¨æ¨¡å—ç›®å½•ä¸­å®šä¹‰æ¨¡å—çš„æ–‡ä»¶å¿…é¡»è¢«å‘½åä¸º <strong>index.js</strong>ï¼Œé™¤éä½ åœ¨è¿™ä¸ªç›®å½•ä¸‹ä¸€ä¸ªå«<strong>package.json</strong> çš„æ–‡ä»¶é‡Œç‰¹åˆ«æŒ‡æ˜ã€‚</li>
<li>Node èƒ½æŠŠæ¨¡å—ä½œä¸ºå¯¹è±¡ç¼“å­˜èµ·æ¥ã€‚Node åŠ è½½æ¨¡å—çš„é¡ºåºï¼šç¼“å­˜æ¨¡å—&gt;æ ¸å¿ƒæ¨¡å—&gt;å½“å‰ç›®å½•æ¨¡å—&gt;node_modulesæ¨¡å—ã€‚</li>
<li>æœ‰äº›å¸¸ç”¨çš„ Node æ ¸å¿ƒæ¨¡å—åœ¨ Node åˆå§‹åŒ–æ—¶å°±è¢«åŠ è½½ç¼“å­˜èµ·æ¥äº†ï¼Œæ‰€ä»¥åŠ è½½é€Ÿåº¦ç›¸å¯¹ä¹Ÿä¼šæ›´å¿«ã€‚</li>
</ol>
<h2>å¼‚æ­¥ç¼–ç¨‹æŠ€æœ¯</h2>
<p>Node ä¸­ä¸¤ç§å“åº”é€»è¾‘ç®¡ç†æ–¹å¼ï¼šå›è°ƒå’Œäº‹ä»¶ç›‘å¬ã€‚</p>
<ul>
<li>
<p>å›è°ƒï¼šé€‚ç”¨äºä¸€æ¬¡æ€§å¼‚æ­¥é€»è¾‘ã€‚</p>
</li>
<li>
<p>äº‹ä»¶å‘å°„å™¨ï¼šæŠŠå¼‚æ­¥é€»è¾‘è·Ÿä¸€ä¸ªæ¦‚å¿µå®ä½“å…³è”èµ·æ¥ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬å™¨è½»æ¾ç®¡ç†ã€‚</p>
</li>
<li>
<p>æµç¨‹æ§åˆ¶ï¼šå¯ä»¥ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œä¸²è¡Œæ‰§è¡Œæˆ–è€…å¹¶è¡Œæ‰§è¡Œã€‚</p>
</li>
</ul>
<h3>1. ç”¨å›è°ƒå¤„ç†ä¸€æ¬¡æ€§äº‹ä»¶</h3>
<p>å›è°ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¢«å½“åšå‚æ•°ä¼ ç»™å¼‚æ­¥å‡½æ•°ï¼Œå®ƒæè¿°äº†å¼‚æ­¥æ“ä½œå®Œæˆä¹‹åè¦åšä»€ä¹ˆã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075923.jpg" alt="HTMLç¤ºä¾‹"></p>
<h4>title.json</h4>
<p>JSON æ–‡ä»¶ä¼šè¢«æ ¼å¼åŒ–æˆä¸€ä¸ªåŒ…å«æ–‡ç« æ ‡é¢˜çš„å­—ç¬¦ä¸²æ•°ç»„ã€‚</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="string">"Kazakhstan is a huge country...what goes on there?"</span>,</span><br><span class="line">    <span class="string">"This weather is making me craaazy"</span>,</span><br><span class="line">    <span class="string">"My neighbor sort of howls at night"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<h4>template.html</h4>
<p>HTML æ¨¡ç‰ˆæ–‡ä»¶ï¼Œ% ä¼šè¢«æ›¿æ¢ä¸ºåšå®¢æ–‡ç« çš„æ ‡é¢˜ã€‚</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Page Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Latest Posts<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>%<span class="tag">&lt;/<span class="name">li</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4>blog_recent.js</h4>
<p>åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¼‚æ­¥è·å–å­˜æ”¾åœ¨ JSON æ–‡ä»¶ä¸­çš„æ–‡ç« çš„æ ‡é¢˜ï¼›</li>
<li>å¼‚æ­¥è·å–ç®€å•çš„ HTML æ¨¡ç‰ˆï¼›</li>
<li>æŠŠæ ‡é¢˜ç»„è£…åœ¨ HTML æ¨¡ç‰ˆä¸­ï¼›</li>
<li>æŠŠ HTML é¡µé¢å‘é€ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– JSON æ–‡ä»¶ä¸­çš„æ ‡é¢˜ï¼Œå¹¶æ¸²æŸ“ Web é¡µé¢</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º HTTP æœåŠ¡å™¨ï¼Œå¹¶ç”¨å›è°ƒå®šä¹‰å“åº”é€»è¾‘</span></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (req.url == <span class="string">'/'</span>) &#123;</span><br><span class="line">        <span class="comment">// è¯»å– JSON æ–‡ä»¶å¹¶ç”¨å›è°ƒå®šä¹‰å¦‚ä½•å¤„ç†å…¶ä¸­çš„å†…å®¹</span></span><br><span class="line">        <span class="comment">// fs.readFile() ç›´æ¥è¯»å–æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ä¼šæŠ¥é”™ï¼Œè¿™é‡Œç”¨ path æ‹¼æ¥ã€‚</span></span><br><span class="line">        fs.readFile(path.join(__dirname, <span class="string">'./titles.json'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå‡ºé”™ï¼Œè¾“å…¥é”™è¯¯æ—¥å¿—ï¼Œå¹¶ç»™å®¢æˆ·ç«¯è¿”å›é”™è¯¯</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123; </span><br><span class="line">                <span class="built_in">console</span>.error(err);</span><br><span class="line">                res.end(<span class="string">'Server Error: Read JSON File Error'</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ä» JSON æ–‡æœ¬ä¸­è§£ææ•°æ®</span></span><br><span class="line">                <span class="keyword">var</span> titles = <span class="built_in">JSON</span>.parse(data.toString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è¯»å– HTML æ¨¡ç‰ˆï¼Œå¹¶åœ¨åŠ è½½å®Œæˆåä½¿ç”¨å›è°ƒ</span></span><br><span class="line">                fs.readFile(path.join(__dirname, <span class="string">'./template.html'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.error(err);</span><br><span class="line">                        res.end(<span class="string">'Server Error: Read html Error'</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">var</span> tmp1 = data.toString();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ç»„è£… HTML é¡µé¢ä»¥æ˜¾ç¤ºåšå®¢æ ‡é¢˜</span></span><br><span class="line">                        <span class="keyword">var</span> html = tmp1.replace(<span class="string">'%'</span>, titles.join(<span class="string">'&lt;/li&gt;&lt;li&gt;'</span>));</span><br><span class="line">                        res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">                        <span class="comment">// å°† HTML é¡µé¢å‘é€ç»™ç”¨æˆ·</span></span><br><span class="line">                        res.end(html);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).listen(<span class="number">8000</span>, <span class="string">'127.0.0.1'</span>);</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç¤ºä¾‹åµŒå…¥äº†ä¸‰å±‚å›è°ƒï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123; </span><br><span class="line">    fs.readFile(path.join(__dirname, <span class="string">'./titles.json'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        fs.readFile(path.join(__dirname, <span class="string">'./template.html'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>ä¼˜åŒ–æ–¹å¼ï¼šåˆ›å»ºä¸­é—´å‡½æ•°ä»¥å‡å°‘åµŒå¥—ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼šå°†ä»£ç æ¨¡å—åŒ–ï¼‰ã€‚</p>
<p>å°±æ˜¯æŠŠæ­¥éª¤ä¸­çš„å•ä¸€åŠŸèƒ½æŠ½è±¡ä¸ºå•ç‹¬çš„ä¸­é—´å‡½æ•°ã€‚</p>
<p>...</p>
<p>ä¼˜åŒ–æ–¹å¼ï¼šé€šè¿‡å°½æ—©è¿”å›å‡å°‘åµŒå¥—ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    getTitles(res);</span><br><span class="line">&#125;).listen(<span class="number">8000</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTitles</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path.join(__dirname, <span class="string">'./titles.json'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ä¸å†åˆ›å»º else åˆ†æ”¯ï¼Œè€Œæ˜¯ç›´æ¥returnï¼Œå› ä¸ºå¦‚æœå‡ºé”™çš„è¯ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦ç»§ç»­æ‰§è¡Œè¿™ä¸ªå‡½æ•°äº†ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> hadError(err, res);</span><br><span class="line">        getTemplate(<span class="built_in">JSON</span>.parse(data.toString()), res);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTemplate</span>(<span class="params">titles, res</span>) </span>&#123;</span><br><span class="line">    fs.readFile(path.join(__dirname, <span class="string">'./template.html'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> hadError(err, res);</span><br><span class="line">        formatHtml(titles, data.toString(), res);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatHtml</span>(<span class="params">titles, tmp1, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> html = tmp1.replace(<span class="string">'%'</span>, titles.join(<span class="string">'&lt;/li&gt;&lt;li&gt;'</span>));</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">    res.end(html);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hadError</span>(<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">    res.end(<span class="string">'Server Error'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Node çš„å¼‚æ­¥å›è°ƒæƒ¯ä¾‹</strong></p>
<p>Node ä¸­çš„å¤§å¤šæ•°å†…ç½®æ¨¡å—åœ¨ä½¿ç”¨å›è°ƒæ—¶éƒ½ä¼šå¸¦ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªç”¨æ¥æ”¾å¯èƒ½ä¼šå‘ç”Ÿçš„é”™è¯¯ï¼Œç¬¬äºŒä¸ªæ”¾ç»“æœã€‚é”™è¯¯å‚æ•°ç»å¸¸è¢«ç¼©å†™ä¸º errã€‚</p>
<p>ä¸‹é¢æ˜¯è¿™ä¸ªå¸¸ç”¨çš„å‡½æ•°ç­¾åçš„å…¸å‹ç¤ºä¾‹:</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">&gt; fs.readFile(<span class="string">'./titles.json'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">&gt;     <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">&gt;     <span class="comment">// do something with data if no error has occurred</span></span><br><span class="line">&gt; &#125;)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3>2. ç”¨äº‹ä»¶å‘å°„å™¨å¤„ç†é‡å¤æ€§äº‹ä»¶</h3>
<p>äº‹ä»¶å‘å°„å™¨ä¼šè§¦å‘äº‹ä»¶ï¼Œå¹¶ä¸”åœ¨é‚£äº›äº‹ä»¶è¢«è§¦å‘æ—¶èƒ½å¤„ç†å®ƒä»¬ã€‚</p>
<p>äº‹ä»¶æ˜¯é€šè¿‡<strong>ç›‘å¬å™¨</strong>è¿›è¡Œå¤„ç†çš„ã€‚</p>
<p><strong>ç›‘å¬å™¨</strong>æ˜¯è·Ÿäº‹ä»¶ç›¸å…³è”çš„ã€å½“æœ‰äº‹ä»¶å‡ºç°æ—¶å°±ä¼šè¢«è§¦å‘çš„å›è°ƒå‡½æ•°ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">var</span> server = net.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å½“æœ‰å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥æ—¶ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€ä¸ªsocketã€‚</span></span><br><span class="line">    <span class="comment">// ç”¨ on æ–¹æ³•æ·»åŠ ç›‘å¬å™¨å“åº” data äº‹ä»¶ã€‚</span></span><br><span class="line">    socket.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        socket.write(data);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// once æ–¹æ³•ï¼Œdata äº‹ä»¶åªæ˜¯åœ¨ç¬¬ä¸€æ¬¡ä¼šè¢«å¤„ç†</span></span><br><span class="line">    socket.once(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        socket.write(data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure></p>
<p>ç”¨ Node å†…ç½®çš„äº‹ä»¶æ¨¡ç‰ˆåˆ›å»ºè‡ªå·±çš„äº‹ä»¶å‘å°„å™¨ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªchanneläº‹ä»¶å‘å°„å™¨ï¼Œå¸¦æœ‰ä¸€ä¸ªç›‘å¬å™¨ï¼Œå¯ä»¥å‘åŠ å…¥é¢‘é“çš„äººåšå‡ºå“åº”ã€‚</span></span><br><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>).EventEmitter;</span><br><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> EventEmitter();</span><br><span class="line"><span class="comment">// ç”¨on(æˆ–è€…ç”¨æ¯”è¾ƒé•¿çš„addListener)æ–¹æ³•ç»™äº‹ä»¶å‘å°„å™¨æ·»åŠ äº†ç›‘å¬å™¨:</span></span><br><span class="line">channel.on(<span class="string">'join'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Welcome!'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨emitå‡½æ•°å‘å°„è¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">channel.emit(<span class="string">'join'</span>);</span><br></pre></td></tr></table></figure></p>
<h4>é”™è¯¯å¤„ç†</h4>
<p>åˆ›å»ºå‘å‡º error ç±»å‹äº‹ä»¶çš„äº‹ä»¶å‘å°„å™¨ï¼Œè€Œä¸æ˜¯ç›´æ¥æŠ›å‡ºé”™è¯¯ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªé”™è¯¯ç›‘å¬å™¨ï¼Œå°†è¢«å‘å‡ºçš„é”™è¯¯è¾“å‡ºåˆ°æ§åˆ¶å°ä¸­:</span></span><br><span class="line"><span class="keyword">const</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">var</span> myEmitter = <span class="keyword">new</span> events.EventEmitter();</span><br><span class="line">myEmitter.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ERROR: '</span> + err.message);</span><br><span class="line">&#125;);</span><br><span class="line">myEmitter.emit(<span class="string">'error'</span>, <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Something is wrong.'</span>));</span><br></pre></td></tr></table></figure></p>
<h3>å¼‚æ­¥å¼€å‘çš„éš¾é¢˜</h3>
<p>åˆ›å»ºå¼‚æ­¥ç¨‹åºæ—¶ï¼Œå¿…é¡»å¯†åˆ‡å…³æ³¨ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€...</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šä½œç”¨åŸŸæ˜¯å¦‚ä½•å¯¼è‡´ bug å‡ºç°çš„ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncFunction</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 200ms åï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°</span></span><br><span class="line">  setTimeout(callback, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> color = <span class="string">'blue'</span>;</span><br><span class="line">asyncFunction(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`The color is <span class="subst">$&#123;color&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">color = <span class="string">'green'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">// [Running] node "/Users/andy/Desktop/node/test_async.js"</span></span><br><span class="line"><span class="comment">// The color is green</span></span><br></pre></td></tr></table></figure></p>
<p>ç”¨åŒ¿åå‡½æ•°ä¿ç•™å…¨å±€å˜é‡çš„å€¼ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JavaScript ç¼–ç¨‹æŠ€å·§ï¼šç”¨é—­åŒ…æ§åˆ¶ç¨‹åºçš„çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncFunction</span>(<span class="params">callbback</span>) </span>&#123;</span><br><span class="line">    setTimeout(callbback, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> conlor = <span class="string">'blue'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°† color çš„å€¼ä¼ ç»™åŒ¿åå‡½æ•°</span></span><br><span class="line"><span class="comment">// color å˜æˆäº†åŒ¿åå‡½æ•°çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŒ¿åå‡½æ•°å†…éƒ¨çš„æœ¬åœ°å˜é‡ï¼Œ</span></span><br><span class="line"><span class="comment">// å½“åŒ¿åå‡½æ•°å¤–é¢çš„colorå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæœ¬åœ°ç‰ˆçš„colorä¸ä¼šå—å½±å“ã€‚</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">color</span>) </span>&#123;</span><br><span class="line">    asyncFunction(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'The color is'</span> + color);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)(color);</span><br><span class="line"></span><br><span class="line">color = <span class="string">'green'</span>;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures" target="_blank" rel="noopener">MDN web docs: JavaScript é—­åŒ…</a></p>
<h3>å¼‚æ­¥é€»è¾‘çš„é¡ºåºåŒ–</h3>
<p><strong>æµç¨‹æ§åˆ¶</strong>ï¼šè®©ä¸€ç»„å¼‚æ­¥ä»»åŠ¡æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ä¸²è¡Œ/å¹¶è¡Œã€‚</p>
<p>éœ€è¦ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåšçš„ä»»åŠ¡å«åš<strong>ä¸²è¡Œä»»åŠ¡</strong>ã€‚</p>
<p>ä¸éœ€è¦ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåšçš„ä»»åŠ¡å«åš<strong>å¹¶è¡Œä»»åŠ¡</strong>ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075925.jpg" alt="ä¸²è¡Œä»»åŠ¡ä¸å¹¶è¡Œä»»åŠ¡"></p>
<h3>å®ç°ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶</h3>
<p>ä½¿ç”¨å›è°ƒè®©å‡ ä¸ªå¼‚æ­¥ä»»åŠ¡é¡ºåºæ‰§è¡Œï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1'</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'2'</span>);</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'3'</span>);</span><br><span class="line">        &#125;, <span class="number">100</span>); <span class="comment">// ä»»åŠ¡3ï¼ŒèŠ±è´¹ 0.1 ç§’</span></span><br><span class="line">    &#125;, <span class="number">500</span>); <span class="comment">// ä»»åŠ¡2ï¼ŒèŠ±è´¹ 0.5 ç§’</span></span><br><span class="line">&#125;, <span class="number">1000</span>); <span class="comment">// ä»»åŠ¡1ï¼ŒèŠ±è´¹ 1 ç§’</span></span><br></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸‰æ–¹æ¨¡å—ï¼š<a href="http://caolan.github.io/nimble/" target="_blank" rel="noopener">Nimble</a>ï¼šè¿™ä¸ªæ¨¡å—å®˜ç½‘ä¸Šæ˜¾ç¤º7å¹´æ²¡æ›´æ–°äº†ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œè€Œä¸”ç°åœ¨æµè¡Œç”¨ Promise æˆ–è€… async æ¥å®ç°ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ã€ŠNode.js å®æˆ˜ï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹Async ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™ Async ä¸€ä¸ªå‡½æ•°æ•°ç»„ï¼Œè®©å®ƒä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">async</span>.series([</span><br><span class="line">  callback =&gt; &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'I execute first.'</span>);</span><br><span class="line">      callback();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  callback =&gt; &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'I execute next.'</span>);</span><br><span class="line">      callback();</span><br><span class="line">    &#125;, <span class="number">500</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  callback =&gt; &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'I execute last.'</span>);</span><br><span class="line">      callback();</span><br><span class="line">    &#125;, <span class="number">100</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œç»“æœï¼š</span></span><br><span class="line"><span class="comment">// [Running] node "/Users/andy/Desktop/node/test_async.js"</span></span><br><span class="line"><span class="comment">// I execute first.</span></span><br><span class="line"><span class="comment">// I execute next.</span></span><br><span class="line"><span class="comment">// I execute last.</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶çš„å·¥ä½œæœºåˆ¶ï¼š</p>
<p>ä¸ºäº†ç”¨ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶è®©å‡ ä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œéœ€è¦å…ˆæŠŠè¿™äº›ä»»åŠ¡æŒ‰é¢„æœŸçš„æ‰§è¡Œé¡ºåºæ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚</p>
<p>è¿™ä¸ªæ•°ç»„å°†èµ·åˆ°é˜Ÿåˆ—çš„ä½œç”¨ï¼šå®Œæˆä¸€ä¸ªä»»åŠ¡åæŒ‰é¡ºåºä»æ•°ç»„ä¸­å–å‡ºä¸‹ä¸€ä¸ªã€‚</p>
<p>Demoç¤ºä¾‹ï¼šå®ç°ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶ã€‚</p>
<h3>å®ç°å¹¶è¡ŒåŒ–æµç¨‹æ§åˆ¶</h3>
<p>ä¸ºäº†è®©å¼‚æ­¥ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œä»ç„¶æ˜¯è¦æŠŠä»»åŠ¡æ”¾åˆ°æ•°ç»„ä¸­ï¼Œä½†ä»»åŠ¡çš„å­˜æ”¾é¡ºåºæ— å…³ç´§è¦ã€‚æ¯ä¸ªä»»åŠ¡éƒ½åº”è¯¥è°ƒç”¨å¤„ç†å™¨å‡½æ•°å¢åŠ å·²å®Œæˆä»»åŠ¡çš„è®¡æ•°å€¼ã€‚å½“æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆåï¼Œå¤„ç†å™¨å‡½æ•°åº”è¯¥æ‰§è¡Œåç»­çš„é€»è¾‘ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"><span class="keyword">const</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾…åŠ©å‡½æ•°ï¼šä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„ Node.js æºç </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadNodeVersion</span>(<span class="params">version, destination, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`http://nodejs.org/dist/v<span class="subst">$&#123;version&#125;</span>/node-v<span class="subst">$&#123;version&#125;</span>.tar.gz`</span>;</span><br><span class="line">  <span class="keyword">const</span> filepath = <span class="string">`<span class="subst">$&#123;destination&#125;</span>/<span class="subst">$&#123;version&#125;</span>.tgz`</span>;</span><br><span class="line">  exec(<span class="string">`curl <span class="subst">$&#123;url&#125;</span> &gt; <span class="subst">$&#123;filepath&#125;</span>`</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸²è¡Œæ‰§è¡Œä¸¤ä¸ªä»»åŠ¡ï¼š</span></span><br><span class="line"><span class="comment">// ä»»åŠ¡ä¸€ï¼šå¹¶è¡Œä¸‹è½½ä¸¤ä¸ªç‰ˆæœ¬çš„æºç ï¼›</span></span><br><span class="line"><span class="comment">// ä»»åŠ¡äºŒï¼šå°†ä¸‹è½½å¥½çš„ç‰ˆæœ¬å½’æ¡£åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// ç”¨ä¸²è¡ŒåŒ–æµç¨‹æ§åˆ¶ä¿è¯åœ¨æ–‡ä»¶ä¸‹è½½å®Œæˆä¹‹å‰ä¸ä¼šåšå½’æ¡£å¤„ç†ã€‚</span></span><br><span class="line"><span class="keyword">async</span>.series([</span><br><span class="line">  callback =&gt; &#123;</span><br><span class="line">    <span class="comment">// å¹¶è¡Œä¸‹è½½</span></span><br><span class="line">    <span class="keyword">async</span>.parallel([</span><br><span class="line">      callback =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Downloading Node V4.4.7...'</span>);</span><br><span class="line">        downloadNodeVersion(<span class="string">'4.4.7'</span>, <span class="string">'/tmp'</span>, callback);</span><br><span class="line">      &#125;,</span><br><span class="line">      callback =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Downloading Node v6.3.0'</span>);</span><br><span class="line">        downloadNodeVersion(<span class="string">'6.3.0'</span>, <span class="string">'/tmp'</span>, callback);</span><br><span class="line">      &#125;,</span><br><span class="line">    ], callback);</span><br><span class="line">  &#125;,</span><br><span class="line">  callback =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Creating archive of download files ...'</span>);</span><br><span class="line">    exec(</span><br><span class="line">      <span class="string">'tar cvf node_distros.tar /tmp/4.4.7.tgz /tmp/6.3.0.tgz'</span>,</span><br><span class="line">      err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'All down!'</span>);</span><br><span class="line">        callback();</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(results);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/10/29/æ·±å…¥æµ…å‡ºNode.js_ç½‘ç»œç¼–ç¨‹/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/29/æ·±å…¥æµ…å‡ºNode.js_ç½‘ç»œç¼–ç¨‹/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºNode.js_ç½‘ç»œç¼–ç¨‹</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-10-29 10:25:00" itemprop="dateCreated datePublished" datetime="2018-10-29T10:25:00+08:00">2018-10-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">1.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">2 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075314-1.jpg" alt="Node ç½‘ç»œæ¨¡å—"></p>
<p>&lt;!-- more --&gt;</p>
<h2>æ„å»º TCP æœåŠ¡</h2>
<p>TCP æ˜¯ ISO æ¨¡å‹ä¸­çš„ä¼ è¾“å±‚åè®®ï¼š</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075315.jpg" alt="OSIæ¨¡å‹"></p>
<p>TCP æ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œæ˜¾è‘—ç‰¹æ€§ï¼šä¸‰æ¬¡æ¡æ‰‹ã€‚</p>
<h2>æ„å»º UDP æœåŠ¡</h2>
<p>æœªå®Œå¾…ç»­...</p>
<h2>æ„å»º HTTP æœåŠ¡</h2>
<p>HTTP æœåŠ¡å™¨ï¼šå¤„ç†HTTPè¯·æ±‚+å‘é€HTTPå“åº”ã€‚</p>
<p>HTTPæœåŠ¡ç»§æ‰¿è‡ªTCPæœåŠ¡å™¨ï¼ˆnet æ¨¡å—ï¼‰ï¼ŒTCPæœåŠ¡ä»¥connectionä¸ºå•ä½è¿›è¡ŒæœåŠ¡ï¼ŒHTTPæœåŠ¡ä»¥requestä¸ºå•ä½è¿›è¡ŒæœåŠ¡ã€‚HTTPæ¨¡å—å³æ˜¯å°†connectionåˆ°requestè¿‡ç¨‹è¿›è¡Œäº†å°è£…ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075317-1.jpg" alt="HTTPå¯¹TCPçš„å°è£…"></p>
<p>æ„å»º Hello World ç¤ºä¾‹ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¼å…¥ http æ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="comment">// åˆ›å»º http serverï¼Œå¹¶ä¼ å…¥å›è°ƒå‡½æ•°</span></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å›è°ƒå‡½æ•°æ¥æ”¶ request å’Œ response å¯¹è±¡</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å°† HTTP å“åº”çŠ¶æ€ç  200 å†™å…¥ responseï¼ŒåŒæ—¶è®¾ç½® content-type æ–‡æœ¬ç±»å‹</span></span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'content-type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">    <span class="comment">// å°† HTTP å“åº”å†…å®¹å†™å…¥ response</span></span><br><span class="line">    res.end(<span class="string">'Hello World\n'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æœåŠ¡å™¨ç›‘å¬ç«¯å£ å’Œ IP åœ°å€</span></span><br><span class="line">&#125;).listen(<span class="number">1337</span>, <span class="string">'127.0.0.1'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:1337'</span>);</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ curl å·¥å…·è·å– HTTP çš„æŠ¥æ–‡ï¼š</p>
<p>æŠ¥æ–‡å†…å®¹ï¼šæŠ¥æ–‡å¤´+æŠ¥æ–‡ä½“</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â˜  node [master] âš¡  curl -v http://127.0.0.1:1337</span><br><span class="line">* Rebuilt URL to: http://127.0.0.1:1337/</span><br><span class="line">*   Trying 127.0.0.1... # 1. ä¸‰æ¬¡æ¡æ‰‹éƒ¨åˆ†</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 1337 (#0)</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET / HTTP/1.1        <span class="comment"># 2. å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚æŠ¥æ–‡</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host: 127.0.0.1:1337</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.54.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br><span class="line">&lt; HTTP/1.1 200 OK       # 3. æœåŠ¡å™¨å®Œæˆå¤„ç†åï¼Œå‘å®¢æˆ·ç«¯å‘é€å“åº”å†…å®¹</span><br><span class="line">&lt; content-type: text/plain</span><br><span class="line">&lt; Date: Sun, 28 Oct 2018 07:44:31 GMT</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Transfer-Encoding: chunked</span><br><span class="line">&lt;</span><br><span class="line">Hello World</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact  # 4. ç»“æŸä¼šè¯ä¿¡æ¯</span><br></pre></td></tr></table></figure></p>
<ul>
<li>å¯¹äº TCP è¿æ¥çš„==è¯»==æ“ä½œï¼Œhttp æ¨¡å—å°†å…¶å°è£…ä¸º <strong>ServerRequest</strong> å¯¹è±¡ã€‚</li>
<li>å¯¹äº TCP è¿æ¥çš„==å†™==æ“ä½œï¼Œhttp æ¨¡å—å°†å…¶å°è£…ä¸º <strong>ServerResponse</strong> å¯¹è±¡ã€‚</li>
<li>ä¸ºäº†é‡ç”¨ TCP è¿æ¥ï¼Œhttp æ¨¡å—åŒ…å«ä¸€ä¸ªé»˜è®¤çš„å®¢æˆ·ç«¯ä»£ç†å¯¹è±¡ <strong>http.globalAgent</strong>ã€‚</li>
<li>å¦‚æœè®¾ç½® agent ä¸º falseï¼Œå°±ä¼šè„±ç¦»è¿æ¥æ± çš„ç®¡ç†ï¼Œä½¿å¾—è¯·æ±‚ä¸å—å¹¶å‘çš„é™åˆ¶ã€‚</li>
<li>Agent å¯¹è±¡çš„ sockets å’Œ requests å±æ€§åˆ†åˆ«è¡¨ç¤ºå½“å‰è¿æ¥æ± ä¸­ä½¿ç”¨ä¸­çš„è¿æ¥æ•°å’Œå¤„äºç­‰å¾…çŠ¶æ€çš„è¯·æ±‚æ•°ã€‚</li>
</ul>
<h2>æ„å»º WebScoket æœåŠ¡</h2>
<p>ç›¸æ¯”äº HTTPï¼ŒWebSocket çš„ä¼˜ç‚¹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯åªå»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨æ›´å°‘çš„è¿æ¥ã€‚</li>
<li>WebSocket æœåŠ¡ç«¯å¯ä»¥æ¨é€æ•°æ®åˆ°å®¢æˆ·ç«¯ï¼Œå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„å…¨åŒå·¥é€šä¿¡ã€‚</li>
<li>æ›´è½»é‡çº§çš„åè®®å¤´ï¼Œå‡å°‘æ•°æ®ä¼ é€é‡ã€‚</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/10/28/æ·±å…¥æµ…å‡ºNode.js_Buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/28/æ·±å…¥æµ…å‡ºNode.js_Buffer/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºNode.js_Buffer</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-10-28 14:25:00" itemprop="dateCreated datePublished" datetime="2018-10-28T14:25:00+08:00">2018-10-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-05-01 20:45:20" itemprop="dateModified" datetime="2019-05-01T20:45:20+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">2 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>åœ¨ç½‘ç»œæµå’Œæ–‡ä»¶çš„æ“ä½œä¸­ï¼Œéœ€è¦å¤„ç†å¤§é‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒJavaScriptè‡ªæœ‰çš„å­—ç¬¦ä¸²æ•°æ®ç±»å‹æ— æ³•æ»¡è¶³éœ€æ±‚ï¼ˆæ³¨ï¼šECAMScript 2015 å¼•å…¥äº† <strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" target="_blank" rel="noopener">TypedArray</a></strong>ï¼‰ï¼ŒBuffer å¯¹è±¡åº”è¿è€Œç”Ÿï¼Œä»¥æä¾›å¯¹<strong>äºŒè¿›åˆ¶æ•°æ®</strong>çš„æ“ä½œã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://nodejs.cn/api/buffer.html" target="_blank" rel="noopener">Node.js Buffer API</a></p>
<h2>Buffer ç»“æ„</h2>
<p>Buffer æ˜¯ä¸€ä¸ªç±»ä¼¼äº Array çš„å¯¹è±¡ï¼Œä½†å®ƒä¸»è¦ç”¨äºæ“ä½œ<strong>å­—èŠ‚</strong>ã€‚
Buffer çš„è¿ç”¨åœºæ™¯ï¼š<strong>æ–‡ä»¶I/O</strong>ã€<strong>ç½‘ç»œI/O</strong>ã€‚
Buffer æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œå­—ç¬¦ä¸²ä¸Bufferä¹‹é—´å­˜åœ¨ç¼–ç å…³ç³»ã€‚</p>
<p>&lt;!-- more --&gt;</p>
<h3>æ¨¡å—ç»“æ„</h3>
<p>Buffer ä¸­ï¼Œæ€§èƒ½ç›¸å…³éƒ¨åˆ†ï¼Œä½¿ç”¨C++å®ç°ï¼›éæ€§èƒ½ç›¸å…³éƒ¨åˆ†ï¼Œä½¿ç”¨JavaScriptå®ç°ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075314.jpg" alt="image"></p>
<ul>
<li>Buffer æ‰€å ç”¨çš„å†…å­˜ä¸æ˜¯é€šè¿‡ V8 åˆ†é…çš„ï¼Œå±äº==å †å¤–å†…å­˜==ã€‚</li>
<li>Node åœ¨è¿›ç¨‹å¯åŠ¨æ—¶å·²ç»åŠ è½½äº† Bufferï¼Œå¹¶å°†å…¶æ”¾åœ¨äº†å…¨å±€å¯¹è±¡ï¼ˆglobalï¼‰ä¸Šã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ Buffer æ—¶ï¼Œæ— é¡»é€šè¿‡ <code>require()</code> å³å¯ç›´æ¥ä½¿ç”¨ã€‚</li>
</ul>
<h3>Buffer å¯¹è±¡</h3>
<p>Buffer å¯¹è±¡ç±»ä¼¼äºæ•°ç»„ï¼Œå®ƒçš„å…ƒç´ ä¸º 16 è¿›åˆ¶çš„ä¸¤ä½æ•°ï¼Œå³0åˆ°255çš„æ•°å€¼ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">'æ·±å…¥æµ…å‡º node.js'</span>;</span><br><span class="line"><span class="keyword">var</span> buf = Buffer.from(str, <span class="string">'utf-8'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(buf); <span class="comment">// &lt;Buffer e6 b7 b1 e5 85 a5 e6 b5 85 e5 87 ba 20 6e 6f 64 65 2e 6a 73&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf2 = Buffer.alloc(<span class="number">100</span>);</span><br><span class="line"><span class="comment">// é€šè¿‡ length è·å–é•¿åº¦</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2.length); <span class="comment">// 100</span></span><br><span class="line"><span class="comment">// é€šè¿‡ä¸‹æ ‡è®¿é—®å…ƒç´ ã€èµ‹å€¼</span></span><br><span class="line"><span class="built_in">console</span>.log(buf2[<span class="number">10</span>]); <span class="comment">// 0</span></span><br></pre></td></tr></table></figure></p>
<p>ç»™å…ƒç´ çš„èµ‹å€¼ï¼ˆ0ï½255ï¼‰è§„åˆ™ï¼š</p>
<ul>
<li>èµ‹å€¼&lt;0ï¼Œé€æ¬¡åŠ 256ï¼›</li>
<li>èµ‹å€¼&gt;255ï¼Œé€æ¬¡å‡256ï¼›</li>
<li>æœ‰å°æ•°ï¼Œèˆå¼ƒå°æ•°éƒ¨åˆ†ï¼›</li>
</ul>
<h3>Buffer å†…å­˜åˆ†é…</h3>
<ul>
<li>
<p>Buffer å¯¹è±¡çš„å†…å­˜åˆ†é…æ˜¯åœ¨ Node çš„ C++ å±‚é¢ä¸Šå®ç°çš„å†…å­˜ç”³è¯·ã€‚</p>
</li>
<li>
<p>Nodeé‡‡ç”¨äº† slab åˆ†é…æœºåˆ¶ï¼Œslab æ˜¯ä¸€ç§åŠ¨æ€å†…å­˜ç®¡ç†æœºåˆ¶ã€‚slab æ˜¯ä¸€å—ç”³è¯·å¥½çš„å›ºå®šå¤§å°çš„å†…å­˜åŒºåŸŸï¼Œslabçš„3ç§çŠ¶æ€ï¼š</p>
<ul>
<li>fullï¼šå®Œå…¨åˆ†é…çŠ¶æ€ï¼›</li>
<li>partialï¼šéƒ¨åˆ†åˆ†é…çŠ¶æ€ï¼›</li>
<li>emptyï¼šæ²¡æœ‰è¢«åˆ†é…çŠ¶æ€ï¼›</li>
</ul>
</li>
<li>
<p>Node ä»¥ 8KB æ¥åŒºåˆ† Buffer æ˜¯å¤§å¯¹è±¡è¿˜æ˜¯å°å¯¹è±¡ã€‚</p>
</li>
</ul>
<p>ç®€å•è€Œè¨€ï¼ŒçœŸæ­£çš„å†…å­˜æ˜¯åœ¨ Node çš„ C++ å±‚é¢æä¾›çš„ï¼ŒJavaScript å±‚é¢åªæ˜¯ä½¿ç”¨å®ƒã€‚</p>
<ul>
<li>å½“è¿›è¡Œå°è€Œé¢‘ç¹çš„ Buffer æ“ä½œæ—¶ï¼Œé‡‡ç”¨ slab çš„æœºåˆ¶è¿›è¡Œé¢„å…ˆç”³è¯·å’Œäº‹ååˆ†é…ï¼Œä½¿å¾— JavaScript åˆ°æ“ä½œç³»ç»Ÿä¹‹é—´ä¸å¿…æœ‰è¿‡å¤šçš„å†…å­˜ç”³è¯·æ–¹é¢çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>å¯¹äºå¤§å—çš„ Buffer è€Œè¨€ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ C++ å±‚é¢æä¾›çš„å†…å­˜ï¼Œè€Œæ— éœ€ç»†è…»çš„åˆ†é…æ“ä½œã€‚</li>
</ul>
<h2>Buffer çš„è½¬æ¢</h2>
<p>Buffer å¯¹è±¡å¯ä»¥ä¸å­—ç¬¦ä¸²ä¹‹é—´ç›¸äº’è½¬æ¢ã€‚</p>
<p>æ”¯æŒçš„å­—ç¬¦ä¸²ç¼–ç ç±»å‹æœ‰ï¼šASCIIã€UTF-8ã€UTF-16LE/UCS-2ã€Base64ã€Latin1ã€Binaryã€Hexã€‚</p>
<p>åˆ¤æ–­ç¼–ç æ˜¯å¦æ”¯æŒè½¬æ¢ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Buffer.isEncoding(ecoding); <span class="comment">// true/false</span></span><br></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸‰æ–¹æ¨¡å—ï¼š</p>
<ul>
<li>iconvï¼šé€šè¿‡ C++ è°ƒç”¨ libiconv åº“å®Œæˆã€‚</li>
<li>iconv-liteï¼šé€šè¿‡ JavaScript å®ç°ã€‚</li>
</ul>
<h3>å®½å­—èŠ‚ä¸­æ–‡ä¹±ç </h3>
<ul>
<li><code>buf.toString([encoding[, start[, end]]])</code></li>
<li>æ–‡ä»¶å¯è¯»æµåœ¨è¯»å–æ—¶ä¼šé€ä¸ªè¯»å–Bufferã€‚</li>
<li>å®½å­—èŠ‚å­—ç¬¦ä¸²åœ¨UTF-8ç¼–ç ä¸‹æ˜¯ä»¥3ä¸ªå­—èŠ‚çš„æ–¹å¼å­˜å‚¨çš„ã€‚</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Buffer çš„æ‹¼æ¥</span></span><br><span class="line"><span class="keyword">var</span> chunks = []; <span class="comment">// ç”¨æ•°ç»„æ¥å­˜å‚¨æ¥æ”¶åˆ°çš„æ‰€æœ‰Bufferç‰‡æ®µ</span></span><br><span class="line"><span class="keyword">var</span> size = <span class="number">0</span>;    <span class="comment">// è®°å½•ä¸‹æ‰€æœ‰ç‰‡æ®µçš„æ€»é•¿åº¦</span></span><br><span class="line">res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    chunks.push(chunk);</span><br><span class="line">    size += chunk.length;</span><br><span class="line">&#125;);</span><br><span class="line">res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Buffer.concat() ç”Ÿæˆä¸€ä¸ªåˆå¹¶çš„ Buffer å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> buf = Buffer.concat(chunks, size);</span><br><span class="line">    vr str = iconv.decode(buf, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(str);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2>Buffer ä¸æ€§èƒ½</h2>
<ul>
<li>é€šè¿‡é¢„å…ˆè½¬æ¢é™æ€å†…å®¹ä¸º Buffer å¯¹è±¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å‡å°‘ CPU çš„é‡å¤ä½¿ç”¨ï¼ŒèŠ‚çœæœåŠ¡å™¨èµ„æºã€‚</li>
<li>åœ¨æ–‡ä»¶è¯»å–æ—¶ï¼Œ<strong>highWaterMark</strong> çš„è®¾ç½®å¯¹æ€§èƒ½è‡³å…³é‡è¦ã€‚è¯¥å€¼è¶Šå¤§ï¼Œè¯»å–é€Ÿåº¦è¶Šå¿«ã€‚</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/10/26/æ·±å…¥æµ…å‡ºNode.js_å†…å­˜æ§åˆ¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/26/æ·±å…¥æµ…å‡ºNode.js_å†…å­˜æ§åˆ¶/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºNode.js_å†…å­˜æ§åˆ¶</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-10-26 14:33:00" itemprop="dateCreated datePublished" datetime="2018-10-26T14:33:00+08:00">2018-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-05-01 20:45:02" itemprop="dateModified" datetime="2019-05-01T20:45:02+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">3.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">3 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>å†…å­˜æ§åˆ¶æ˜¯åœ¨<strong>æµ·é‡è¯·æ±‚</strong>å’Œ<strong>é•¿æ—¶é—´è¿è¡Œ</strong>çš„å‰æä¸‹è¿›è¡Œæ¢è®¨çš„ã€‚</p>
<p>åœ¨Nodeä¸­å¦‚ä½•é«˜æ•ˆåœ°ä½¿ç”¨å†…å­˜ï¼Ÿ</p>
<h2>V8 çš„åƒåœ¾å›æ”¶æœºåˆ¶ä¸å†…å­˜é™åˆ¶</h2>
<h3>V8 çš„å†…å­˜é™åˆ¶</h3>
<ul>
<li>Nodeé€šè¿‡ JavaScript ä½¿ç”¨å†…å­˜çš„é™åˆ¶ï¼š64ä½ç³»ç»Ÿä¸‹çº¦ä¸º 1.4 GBï¼Œ32ä½ç³»ç»Ÿä¸‹çº¦ä¸º 0.7 GBã€‚</li>
<li>Node åŸºäº V8 æ„å»ºï¼Œæ‰€ä»¥åœ¨ Node ä¸­ä½¿ç”¨çš„ JavaScript å¯¹è±¡åŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡ V8 è‡ªå·±çš„æ–¹å¼æ¥è¿›è¡Œç®¡ç†å’Œåˆ†é…çš„ã€‚</li>
</ul>
<h3>V8 çš„å¯¹è±¡åˆ†é…</h3>
<ul>
<li>åœ¨ V8 ä¸­ï¼Œæ‰€æœ‰çš„ JavaScript å¯¹è±¡éƒ½æ˜¯é€šè¿‡==å †==æ¥åˆ†é…çš„ã€‚</li>
<li>V8 é™åˆ¶å †å†…å­˜ï¼Œæ˜¯åŸºäºåƒåœ¾å›æ”¶æœºåˆ¶ä¸åº”ç”¨æ€§èƒ½çš„è€ƒé‡ï¼ˆåƒåœ¾å›æ”¶ä¼šå¼•èµ· JS çº¿ç¨‹æš‚åœæ‰§è¡Œï¼‰ã€‚</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h4>æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å ç”¨ï¼šprocess.memoryUsage()</h4>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> process.memoryUsage();</span></span><br><span class="line">&#123; rss: 23175168,      # è¿›ç¨‹çš„å¸¸é©»å†…å­˜éƒ¨åˆ†</span><br><span class="line">  heapTotal: 9682944, # å·²ç”³è¯·åˆ°çš„å †å†…å­˜</span><br><span class="line">  heapUsed: 5283000,  # å †å†…å­˜å½“å‰ä½¿ç”¨é‡</span><br><span class="line">  external: 11777 &#125;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å †ä¸­çš„å†…å­˜æ€»é‡&lt;è¿›ç¨‹çš„å¸¸é©»å†…å­˜ç”¨é‡</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å †å¤–å†…å­˜ï¼šä¸æ˜¯é€šè¿‡V8åˆ†é…çš„å†…å­˜ã€‚</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Buffer å¯¹è±¡ä¸ç»è¿‡ V8 çš„å†…å­˜åˆ†é…æœºåˆ¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Node çš„å†…å­˜æ„æˆï¼šé€šè¿‡ V8 åˆ†é…çš„éƒ¨åˆ† + Node è‡ªè¡Œåˆ†é…çš„éƒ¨åˆ†ã€‚</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å› æ­¤ï¼Œå—åˆ° V8 çš„åƒåœ¾å›æ”¶æœºåˆ¶é™åˆ¶çš„ä¸»è¦æ˜¯ V8 çš„å †å†…å­˜ã€‚</span></span><br></pre></td></tr></table></figure></p>
<h4>æŸ¥çœ‹ç³»ç»Ÿçš„å†…å­˜å ç”¨ï¼šos.totalmem() å’Œ freemem()</h4>
<p>æŸ¥çœ‹æ“ä½œç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> os.totalmem() <span class="comment"># è¿”å›ç³»ç»Ÿæ€»å†…å­˜</span></span></span><br><span class="line">17179869184</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> os.freemem() <span class="comment"># è¿”å›ç³»ç»Ÿé—²ç½®å†…å­˜</span></span></span><br><span class="line">4516331520</span><br></pre></td></tr></table></figure></p>
<p>Node å¯åŠ¨æ—¶å¯ä»¥è°ƒæ•´å†…å­˜ä½¿ç”¨é‡ï¼š</p>
<p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">--max-old-space-size</span>=<span class="number">1700</span> test.js // å•ä½ä¸ºMBï¼Œè®¾ç½®è€ç”Ÿä»£å†…å­˜ç©ºé—´æœ€å¤§å€¼</span><br><span class="line"><span class="keyword">node</span> <span class="title">--max-new-space-size</span>=<span class="number">1024</span> test.js // å•ä½ä¸ºKBï¼Œè®¾ç½®æ–°ç”Ÿä»£å†…å­˜ç©ºé—´å¤§å°</span><br></pre></td></tr></table></figure></p>
<h3>V8 çš„åƒåœ¾å›æ”¶æœºåˆ¶</h3>
<ul>
<li>
<p>V8 çš„åƒåœ¾å›æ”¶ç­–ç•¥ä¸»è¦åŸºäº==åˆ†ä»£å¼åƒåœ¾å›æ”¶æœºåˆ¶==ã€‚</p>
</li>
<li>
<p>V8 çš„å†…å­˜åˆ†ä»£ï¼š</p>
<ul>
<li>V8 å †å†…å­˜ï¼šæ–°ç”Ÿä»£å†…å­˜+è€ç”Ÿä»£å†…å­˜ã€‚</li>
<li>æ–°ç”Ÿä»£çš„å†…å­˜ç©ºé—´ä¸­çš„å¯¹è±¡ï¼šå­˜æ´»æ—¶é—´çŸ­ã€‚</li>
<li>è€ç”Ÿä»£çš„å†…å­˜ç©ºé—´ä¸­çš„å¯¹è±¡ï¼šå­˜æ´»æ—¶é—´é•¿ã€å¸¸é©»å†…å­˜å¯¹è±¡ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>V8å¼•æ“ä¸‹çš„å †å†…å­˜åˆ†é…</th>
<th>64ä½ç³»ç»Ÿ</th>
<th>32ä½ç³»ç»Ÿ</th>
</tr>
</thead>
<tbody>
<tr>
<td>é»˜è®¤è€ç”Ÿä»£å†…å­˜æœ€å¤§å€¼</td>
<td>1400 MB</td>
<td>700 MB</td>
</tr>
<tr>
<td>é»˜è®¤æ–°ç”Ÿä»£å†…å­˜æœ€å¤§å€¼</td>
<td>32 MB</td>
<td>16 MB</td>
</tr>
<tr>
<td>V8 å †å†…å­˜çš„æœ€å¤§å€¼</td>
<td>1464 MB ï¼ˆ1.4 GBï¼‰</td>
<td>732 MBï¼ˆ0.7 GBï¼‰</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸»è¦é€šè¿‡ Scavenge ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼ŒScavenge ç®—æ³•ä¸»è¦é‡‡ç”¨ Cheney ç®—æ³•ï¼ˆé‡‡ç”¨å¤åˆ¶çš„æ–¹å¼å®ç°åƒåœ¾å›æ”¶From-Toï¼‰å®ç°ã€‚</p>
</li>
<li>
<p>è€ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸»è¦é‡‡ç”¨äº†Mark-Sweepï¼ˆæ ‡è®°æ¸…é™¤ï¼‰å’ŒMarl-Compactï¼ˆæ ‡è®°æ•´ç†ï¼‰ç›¸ç»“åˆçš„æ–¹å¼è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075041.jpg" alt="image"></p>
</li>
</ul>
<h3>æŸ¥çœ‹åƒåœ¾å›æ”¶æ—¥å¿—ï¼š<code>--trach_gc</code></h3>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨ gc.log æ–‡ä»¶ä¸­å¾—åˆ°æ‰€æœ‰çš„åƒåœ¾å›æ”¶ä¿¡æ¯ã€‚</span></span><br><span class="line">node --trach_gc -e "var a = [];for (var i = 0; i &lt; 1000000; i++) a.push(new Array(100));" &gt; gc.log</span><br></pre></td></tr></table></figure></p>
<h3>æŸ¥çœ‹æ€§èƒ½åˆ†ææ•°æ®ï¼š<code>--prof</code></h3>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --prof test.js</span><br></pre></td></tr></table></figure></p>
<p>V8 æä¾›äº† linux-tick-processor å·¥å…·ï¼ˆNodeè·¯å¾„ï¼šdeps/v8/toolsï¼‰ç”¨äºç»Ÿè®¡æ—¥å¿—ä¿¡æ¯ã€‚</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å°†è¯¥å·¥å…·çš„ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ PATH ä¸­ï¼Œæ‰§è¡Œåˆ†ææ—¥å¿—å‘½ä»¤ï¼š</span></span><br><span class="line">linux-tick-processor v8.log</span><br></pre></td></tr></table></figure></p>
<h2>é«˜æ•ˆä½¿ç”¨å†…å­˜</h2>
<p>å¦‚ä½•è®©åƒåœ¾å›æ”¶æœºåˆ¶æ›´é«˜æ•ˆåœ°å·¥ä½œï¼Ÿ</p>
<h3>ä½œç”¨åŸŸ</h3>
<ul>
<li>
<p>JavaScript ä¸­èƒ½å½¢æˆä½œç”¨åŸŸçš„æ–¹å¼ï¼šå‡½æ•°è°ƒç”¨ã€withã€å…¨å±€ä½œç”¨åŸŸã€‚</p>
</li>
<li>
<p>æ ‡è¯†ç¬¦æŸ¥æ‰¾ï¼Œå˜é‡åªèƒ½å‘å¤–è®¿é—®ï¼Œè€Œä¸èƒ½å‘å†…è®¿é—®ï¼›</p>
</li>
<li>
<p>ä½œç”¨åŸŸé“¾ï¼›</p>
</li>
<li>
<p>å˜é‡çš„ä¸»åŠ¨é‡Šæ”¾ï¼šdelete æ“ä½œã€å°†å˜é‡é‡æ–°èµ‹å€¼ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€å˜é‡ï¼Œè¿›ç¨‹é€€å‡ºæ‰ä¼šé‡Šæ”¾</span></span><br><span class="line">global.foo = <span class="string">'I am global object'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(global.foo); <span class="comment">// =&gt; 'I am global object'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. delete æ“ä½œåˆ é™¤å…¨å±€å˜é‡</span></span><br><span class="line"><span class="keyword">delete</span> global.foo; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. é‡æ–°èµ‹å€¼</span></span><br><span class="line">global.foo = <span class="literal">undefined</span>; <span class="comment">// or null</span></span><br><span class="line"><span class="built_in">console</span>.log(global.foo); <span class="comment">// =&gt; 'undefined'</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ğŸ’¡ åœ¨ V8 ä¸­é€šè¿‡ delete åˆ é™¤å¯¹è±¡çš„å±æ€§æœ‰å¯èƒ½å¹²æ‰° V8 çš„ä¼˜åŒ–ï¼Œæ‰€ä»¥<strong>é€šè¿‡èµ‹å€¼æ–¹å¼è§£é™¤å¼•ç”¨</strong>æ›´å¥½ã€‚</p>
</blockquote>
</li>
</ul>
<h3>é—­åŒ…ï¼šå®ç°å¤–éƒ¨ä½œç”¨åŸŸè®¿é—®å†…éƒ¨ä½œç”¨åŸŸä¸­å˜é‡çš„æ–¹æ³•</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> local = <span class="string">'å±€éƒ¨å˜é‡'</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// å‡½æ•°ä½œä¸ºè¿”å›å€¼ï¼Œä¸”è¯¥åŒ¿åå‡½æ•°å¯ä»¥è®¿é—®local</span></span><br><span class="line">            <span class="keyword">return</span> local; <span class="comment">// å†…éƒ¨ä½œç”¨åŸŸå¯ä»¥è®¿é—®å¤–éƒ¨å¯¹è±¡</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> baz = bar(); <span class="comment">// bar() å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä¸”å¯ä»¥è®¿é—®local</span></span><br><span class="line">    <span class="built_in">console</span>.log(baz());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æ­£å¸¸çš„ JavaScript æ‰§è¡Œä¸­ï¼Œæ— æ³•ç«‹å³å›æ”¶çš„å†…å­˜ï¼š</p>
<ol>
<li>é—­åŒ…ï¼›</li>
<li>å…¨å±€å˜é‡ï¼›</li>
</ol>
<h3>æ…å°†å†…å­˜å½“ç¼“å­˜</h3>
<ul>
<li>åœ¨Nodeä¸­ï¼Œä»»ä½•è¯•å›¾æ‹¿å†…å­˜å½“ç¼“å­˜çš„è¡Œä¸ºéƒ½åº”å½“è¢«é™åˆ¶ã€‚</li>
<li><a href="https://github.com/isaacs/node-lru-cache" target="_blank" rel="noopener">Iru cache</a></li>
</ul>
<h4>ç¼“å­˜çš„è§£å†³æ–¹æ¡ˆ</h4>
<p>è¿›ç¨‹ä¹‹é—´æ— æ³•å…±äº«å†…å­˜ï¼Œä½¿ç”¨å¤§é‡ç¼“å­˜çš„è§£å†³æ–¹æ¡ˆï¼šé‡‡ç”¨è¿›ç¨‹å¤–çš„ç¼“å­˜ï¼Œè¿›ç¨‹è‡ªèº«ä¸å­˜å‚¨çŠ¶æ€ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li><a href="https://github.com/NodeRedis/node_redis" target="_blank" rel="noopener">redis</a></li>
<li><a href="https://github.com/3rd-Eden/memcached" target="_blank" rel="noopener">Memcached</a></li>
</ul>
<h3>å…³æ³¨é˜Ÿåˆ—çŠ¶æ€</h3>
<p>æ¶ˆè´¹é€Ÿåº¦ &lt; ç”Ÿäº§é€Ÿåº¦æ—¶ï¼Œå°†ä¼šå½¢æˆå †ç§¯ï¼š</p>
<p>æ—¥å¿—æ”¶é›†æ—¶ï¼Œé€‰æ‹©æ›´é«˜æ•ˆçš„æ–‡ä»¶å†™å…¥æ—¥å¿—ï¼Œè€Œä¸æ˜¯æ•°æ®åº“å†™å…¥æ—¥å¿—ã€‚</p>
<p>æ·±åº¦çš„è§£å†³æ–¹æ¡ˆï¼š1. ç›‘æ§é˜Ÿåˆ—çš„é•¿åº¦ï¼›2.ä»»æ„å¼‚æ­¥è°ƒç”¨éƒ½åº”è¯¥åŒ…å«è¶…æ—¶æœºåˆ¶ã€‚</p>
<p>Bagpipe çš„è¶…æ—¶æ¨¡å¼å’Œæ‹’ç»æ¨¡å¼ã€‚</p>
<h3>å†…å­˜æ³„æ¼æ’æŸ¥</h3>
<p>Nodeå†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼š</p>
<ul>
<li><s>v8-profilerã€‚ç”±Danny Coastesæä¾›ï¼Œå®ƒå¯ä»¥ç”¨äºå¯¹V8å †å†…å­˜æŠ“å–å¿«ç…§å’Œå¯¹CPUè¿›è¡Œåˆ†æï¼Œè¯¥é¡¹ç›®å·²æœ‰3å¹´æ²¡ç»´æŠ¤äº†</s></li>
<li>node-heapdumpã€‚è¿™æ˜¯Nodeæ ¸å¿ƒè´¡çŒ®è€…ä¹‹ä¸€Ben Noordhuisç¼–å†™çš„æ¨¡å—ï¼Œå®ƒå…è®¸å¯¹V8å †å†…å­˜æŠ“å–å¿«ç…§ï¼Œç”¨äºäº‹ååˆ†æã€‚</li>
<li>node-mtraceã€‚ç”±Jimb Esseræä¾›ï¼Œå®ƒä½¿ç”¨äº†GCCçš„mtraceå·¥å…·æ¥åˆ†æå †çš„ä½¿ç”¨ã€‚</li>
<li>dtaceã€‚åœ¨Joyentçš„SmartOSç³»ç»Ÿä¸Šï¼Œæœ‰å®Œå–„çš„dtraceå·¥å…·ç”¨æ¥åˆ†æå†…å­˜æ³„æ¼ã€‚</li>
<li>node-memwatchã€‚æ¥è‡ªMozillaçš„Lloyd Hilaielè´¡çŒ®çš„æ¨¡å—ï¼Œé‡‡ç”¨WTFPLè®¸å¯å‘å¸ƒã€‚</li>
</ul>
<h3>å¤§å†…å­˜åº”ç”¨</h3>
<p>Node æä¾›äº† <strong>stream</strong> æ¨¡å—ç”¨äºå¤„ç†å¤§æ–‡ä»¶ã€‚</p>
<p>fs æ¨¡å—çš„<code>createReadStream()</code> å’Œ <code>createWriteStream()</code> æ–¹æ³•å¯ä»¥åˆ†åˆ«ç”¨äºåˆ›å»ºæ–‡ä»¶çš„å¯è¯»æµä¸å¯å†™æµã€‚</p>
<p>process æ¨¡å—ä¸­çš„ stdin å’Œ stdout åˆ†åˆ«æ˜¯å¯è¯»æµå’Œå¯å†™æµçš„ç¤ºä¾‹ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå°†æ•°æ®å†™å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="comment">// æµå¤„ç†çš„æ–¹å¼ä¸ä¼šå—åˆ°V8å†…å­˜é™åˆ¶çš„å½±å“ã€‚</span></span><br><span class="line"><span class="keyword">var</span> reader = fs.createReadStream(<span class="string">'in.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> writer = fs.createWriteStream(<span class="string">'out.txt'</span>);</span><br><span class="line">reader.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    writer.write(chunk);</span><br><span class="line">&#125;);</span><br><span class="line">reader.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    writer.end();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šè¿°ä»£ç çš„ç®€å†™æ–¹æ³•ï¼š</span></span><br><span class="line"><span class="keyword">var</span> reader = fs.createReadStream(<span class="string">'in.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> writer = fs.createWriteStream(<span class="string">'out.txt'</span>);</span><br><span class="line">reader.pipe(writer);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ğŸ’¡</p>
<p>å¦‚æœä¸éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²å±‚é¢çš„æ“ä½œï¼Œåˆ™ä¸éœ€è¦å€ŸåŠ© V8 æ¥å¤„ç†ï¼Œå¯ä»¥å°è¯•è¿›è¡Œçº¯ç²¹çš„ ==Buffer== æ“ä½œï¼Œè¿™ä¸ä¼šå—åˆ° V8 å †å†…å­˜çš„é™åˆ¶ã€‚</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/10/26/æ·±å…¥æµ…å‡ºNode.js_å¼‚æ­¥ç¼–ç¨‹/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/26/æ·±å…¥æµ…å‡ºNode.js_å¼‚æ­¥ç¼–ç¨‹/" class="post-title-link" itemprop="url">æ·±å…¥æµ…å‡ºNode.js_å¼‚æ­¥ç¼–ç¨‹</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-10-26 14:32:00" itemprop="dateCreated datePublished" datetime="2018-10-26T14:32:00+08:00">2018-10-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">11k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">10 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>Node çš„ç‰¹ç‚¹ï¼šäº‹ä»¶é©±åŠ¨ã€éé˜»å¡I/O</h1>
<ol>
<li>å¼‚æ­¥I/Oï¼›</li>
<li>äº‹ä»¶ï¼ˆè½»é‡çº§ã€æ¾è€¦åˆã€åªå…³æ³¨äº‹åŠ¡ç‚¹ï¼‰ä¸å›è°ƒå‡½æ•°ï¼›</li>
<li>å•çº¿ç¨‹ï¼šchild_process å­è¿›ç¨‹ï¼›</li>
<li>è·¨å¹³å°ï¼šlibuvï¼›</li>
</ol>
<p>&lt;!-- more --&gt;</p>
<h1>Node çš„åº”ç”¨åœºæ™¯</h1>
<ul>
<li>I/Oå¯†é›†å‹ï¼›</li>
<li>CPUå¯†é›†å‹ï¼Ÿï¼ˆå……åˆ†åˆ©ç”¨CPUçš„æ–¹æ³•ï¼šç¼–å†™ C/C++ æ‰©å±•é«˜æ•ˆåˆ©ç”¨CPUã€ä½¿ç”¨å­è¿›ç¨‹ï¼‰ï¼›</li>
</ul>
<h1>å¼‚æ­¥I/O</h1>
<p>å•çº¿ç¨‹åŒæ­¥ç¼–ç¨‹æ¨¡å‹ä¼šå› é˜»å¡I/Oå¯¼è‡´ç¡¬ä»¶èµ„æºå¾—ä¸åˆ°æ›´ä¼˜çš„ä½¿ç”¨ã€‚</p>
<p>å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ä¹Ÿå› ä¸ºç¼–ç¨‹ä¸­çš„æ­»é”ã€çŠ¶æ€åŒæ­¥ç­‰é—®é¢˜è®©å¼€å‘äººå‘˜å¤´ç–¼ã€‚</p>
<p>Node åœ¨ä¸¤è€…ä¹‹é—´ç»™å‡ºäº†å®ƒçš„æ–¹æ¡ˆï¼šåˆ©ç”¨å•çº¿ç¨‹ï¼Œè¿œç¦»å¤šçº¿ç¨‹æ­»é”ã€çŠ¶æ€åŒæ­¥ç­‰é—®é¢˜ï¼›åˆ©ç”¨å¼‚æ­¥I/Oï¼Œè®©å•çº¿ç¨‹è¿œç¦»é˜»å¡ï¼Œä»¥æ›´å¥½åœ°ä½¿ç”¨CPUã€‚</p>
<h2>è½®è¯¢</h2>
<ul>
<li>è½®è¯¢ï¼šé‡å¤è°ƒç”¨åˆ¤æ–­æ“ä½œæ˜¯å¦å®Œæˆã€‚</li>
<li>è½®è¯¢æŠ€æœ¯ï¼šreadã€selectã€pollã€epollã€kqeueã€‚</li>
<li>è½®è¯¢æŠ€æœ¯æ»¡è¶³äº†éé˜»å¡I/Oç¡®ä¿è·å–å®Œæ•´æ•°æ®çš„éœ€æ±‚ã€‚</li>
</ul>
<h2>Node çš„å¼‚æ­¥I/O</h2>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075932.jpg" alt="image"></p>
<p>Nodeå¼‚æ­¥I/Oæ¨¡å‹çš„åŸºæœ¬è¦ç´ ï¼šäº‹ä»¶å¾ªç¯ã€è§‚å¯Ÿè€…ã€è¯·æ±‚å¯¹è±¡ã€I/Oçº¿ç¨‹æ± ã€‚</p>
<p>å¼‚æ­¥å®ç°çš„æ ¸å¿ƒæ˜¯<strong>äº‹ä»¶å¾ªç¯</strong>ã€‚</p>
<p>äº‹ä»¶é©±åŠ¨çš„æœ¬è´¨ï¼šé€šè¿‡ä¸»å¾ªç¯åŠ äº‹ä»¶è§¦å‘çš„æ–¹å¼æ¥è¿è¡Œç¨‹åºã€‚</p>
<p>ğŸ’¡ğŸ’¡ğŸ’¡</p>
<ul>
<li>åœ¨ Node ä¸­ï¼Œé™¤äº† JavaScript æ˜¯å•çº¿ç¨‹å¤–ï¼ŒNodeè‡ªèº«å…¶å®æ˜¯å¤šçº¿ç¨‹çš„ï¼Œåªæ˜¯ I/O çº¿ç¨‹ä½¿ç”¨çš„ CPU è¾ƒå°‘ã€‚</li>
<li>é™¤äº†ç”¨æˆ·ä»£ç æ— æ³•å¹¶è¡Œæ‰§è¡Œå¤–ï¼Œæ‰€æœ‰çš„ I/Oï¼ˆç£ç›˜I/Oå’Œç½‘ç»œI/Oç­‰ï¼‰åˆ™å¯ä»¥æ˜¯å¹¶è¡Œèµ·æ¥çš„ã€‚</li>
</ul>
<h2>éI/Oçš„å¼‚æ­¥API</h2>
<ul>
<li><code>setTimeout()</code>ï¼Œå•æ¬¡æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚</li>
<li><code>setInterval()</code>ï¼Œé‡å¤æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚</li>
<li><code>setImmediate()</code>ï¼Œå°†å›è°ƒå‡½æ•°å»¶è¿Ÿæ‰§è¡Œã€‚</li>
<li><code>process.nextTick()</code>ï¼Œå°†å›è°ƒå‡½æ•°å»¶è¿Ÿæ‰§è¡Œã€‚</li>
</ul>
<h1>å¼‚æ­¥ç¼–ç¨‹</h1>
<p>å¼‚æ­¥ç¼–ç¨‹åœ¨æµç¨‹æ§åˆ¶ä¸­ï¼Œä¸šåŠ¡è¡¨è¾¾å¹¶ä¸å¤ªé€‚åˆè‡ªç„¶è¯­è¨€çš„çº¿æ€§æ€ç»´ä¹ æƒ¯ã€‚</p>
<h3>é«˜é˜¶å‡½æ•°</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šå¸¸çš„è¯­è¨€</span></span><br><span class="line"><span class="comment">// å‡½æ•°çš„å‚æ•°ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨</span></span><br><span class="line"><span class="comment">// å‡½æ•°çš„è¿”å›å€¼ï¼šåŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">functionName</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜é˜¶å‡½æ•°ï¼šå¯ä»¥æŠŠå‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">functionName</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åç»­ä¼ é€’é£æ ¼</span></span><br><span class="line"><span class="comment">// å°†ä¸šåŠ¡çš„é‡ç‚¹ä»è¿”å›å€¼è½¬ç§»åˆ°äº†å›è°ƒå‡½æ•°ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">functionName</span>(<span class="params">x, bar</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bar(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>åå‡½æ•°ç”¨æ³•</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">var</span> toString = <span class="built_in">Object</span>.prototype.toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isString = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toString.call(obj) == <span class="string">'[object String]'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> isFunction = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toString.call(obj) == <span class="string">'[object Function]'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå‡½æ•°ç”¨æ³•</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªè°ƒç”¨å¦å¤–ä¸€ä¸ªéƒ¨åˆ†â€”â€”å‚æ•°æˆ–å˜é‡å·²ç»é¢„ç½®çš„å‡½æ•°â€”â€”çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">var</span> isType = <span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡æŒ‡å®šéƒ¨åˆ†å‚æ•°æ¥äº§ç”Ÿä¸€ä¸ªæ–°çš„å®šåˆ¶å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> toString.call(obj) == <span class="string">'[object '</span> + type + <span class="string">']'</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isString = isType(<span class="string">'String'</span>);</span><br><span class="line"><span class="keyword">var</span> isFunction = isType(<span class="string">'Function'</span>);</span><br></pre></td></tr></table></figure></p>
<h3>éš¾ç‚¹1ï¼šå¼‚å¸¸å¤„ç†</h3>
<p>Nodeåœ¨å¤„ç†å¼‚å¸¸æ—¶çš„çº¦å®šï¼š<strong>å°†å¼‚å¸¸ä½œä¸ºå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå®å‚ä¼ å›ï¼Œå¦‚æœä¸ºç©ºå€¼ï¼Œåˆ™è¡¨æ˜å¼‚æ­¥è°ƒç”¨æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚</strong></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>(<span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>ç¼–å†™å¼‚æ­¥æ–¹æ³•éœ€è¦éµå¾ªçš„åŸåˆ™ï¼š</p>
<ol>
<li>å¿…é¡»æ‰§è¡Œè°ƒç”¨è€…ä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼›</li>
<li>æ­£ç¡®ä¼ é€’å›å¼‚å¸¸ä¾›è°ƒç”¨è€…åˆ¤æ–­ï¼›</li>
</ol>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">async</span> = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> results = something;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(error); <span class="comment">// 2. æ­£ç¡®ä¼ é€’å›å¼‚å¸¸ä¾›è°ƒç”¨è€…åˆ¤æ–­</span></span><br><span class="line">        &#125;</span><br><span class="line">        callback(<span class="literal">null</span>, results); <span class="comment">// 1. å¿…é¡»æ‰§è¡Œè°ƒç”¨è€…ä¼ å…¥çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3>éš¾ç‚¹2ï¼šå‡½æ•°åµŒå¥—è¿‡æ·±</h3>
<p>å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œå‡½æ•°åµŒå¥—è¿‡æ·±çš„é—®é¢˜æ˜¯ï¼šæ²¡æœ‰å……åˆ†åˆ©ç”¨å¼‚æ­¥I/Oå¸¦æ¥çš„å¹¶è¡Œä¼˜åŠ¿ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨Nodeä¸­ï¼Œäº‹ä»¶ä¸­å­˜åœ¨å¤šä¸ªå¼‚æ­¥è°ƒç”¨çš„åœºæ™¯ï¼Œå°±ä¼šäº§ç”ŸåµŒå¥—</span></span><br><span class="line"><span class="comment">// éå†ä¸€ä¸ªç›®å½•</span></span><br><span class="line">fs.readdir(path.join(__dirname, <span class="string">'..'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">err, files</span>) </span>&#123;</span><br><span class="line">    files.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">filename, index</span>) </span>&#123;</span><br><span class="line">        fs.readFile(filename, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, file</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// TODO</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3>éš¾ç‚¹3ï¼šé˜»å¡ä»£ç </h3>
<p>é‡åˆ°éœ€è¦é˜»å¡ä»£ç çš„éœ€æ±‚æ—¶ï¼Œåœ¨ç»Ÿä¸€è§„åˆ’ä¸šåŠ¡é€»è¾‘ä¹‹åï¼Œè°ƒç”¨ <code>setTimeout()</code> çš„æ•ˆæœä¼šæ›´å¥½ã€‚</p>
<h3>éš¾ç‚¹4ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹</h3>
<p>å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼Œå¦‚æœæœåŠ¡å™¨æ˜¯å¤šæ ¸CPUï¼Œå•ä¸ªNodeè¿›ç¨‹å®è´¨ä¸Šæ˜¯æ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ã€‚</p>
<p>Nodeçš„å¤šçº¿ç¨‹å®ç°ï¼šchild_process æ˜¯å…¶åŸºç¡€APIï¼Œ<a href="http://nodejs.cn/api/cluster.html" target="_blank" rel="noopener">cluster</a> æ¨¡å—æ˜¯æ›´æ·±å±‚æ¬¡çš„åº”ç”¨ã€‚</p>
<h3>éš¾ç‚¹5ï¼šå¼‚æ­¥è½¬åŒæ­¥</h3>
<h2>å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆ</h2>
<ul>
<li>äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼›</li>
<li>Promise/Deferredæ¨¡å¼ï¼ˆQã€whenï¼‰ï¼›</li>
<li>æµç¨‹æ§åˆ¶æ¨¡å¼ï¼›
<ul>
<li>å°¾è§¦å‘ä¸Nextï¼ˆConnetcï¼‰ï¼›</li>
<li><a href="https://github.com/caolan/async" target="_blank" rel="noopener">async</a>ï¼›</li>
<li>Stepï¼›</li>
<li>windï¼›</li>
</ul>
</li>
</ul>
<h3>äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¨¡å¼</h3>
<ul>
<li>äº‹ä»¶ç›‘å¬æ¨¡å¼ï¼ˆevents æ¨¡å—ï¼‰ï¼šå®ç°ä¸€ä¸ªäº‹ä»¶ä¸å¤šä¸ªå›è°ƒå‡½æ•°çš„å…³è”ã€‚</li>
<li>å¹¿æ³›ç”¨äºå¼‚æ­¥ç¼–ç¨‹ã€‚</li>
<li>å¸¸ç”¨äºè§£è€¦ä¸šåŠ¡é€»è¾‘ã€‚</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEmitter</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> MyEmitter();</span><br><span class="line"><span class="comment">// on() æ³¨å†Œç›‘å¬å™¨</span></span><br><span class="line">myEmitter.on(<span class="string">'event'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'è§¦å‘äº‹ä»¶'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">myEmitter.emit(<span class="string">'event'</span>); <span class="comment">// emit() è§¦å‘äº‹ä»¶</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>
<p>ç»§æ‰¿eventsæ¨¡å—ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node ä¸­ Stream å¯¹è±¡ç»§æ‰¿ EventEmitter çš„ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="keyword">var</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Stream</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    event.EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Uint8ClampedArray</span>.inherits(Stream, events.EventEmitter);</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>åˆ©ç”¨äº‹ä»¶é˜Ÿåˆ—è§£å†³é›ªå´©é—®é¢˜ï¼ˆé«˜è®¿é—®é‡ã€å¤§å¹¶å‘çš„æƒ…å†µä¸‹ç¼“å­˜å¤±æ•ˆçš„æƒ…æ™¯ï¼‰:</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ çŠ¶æ€é”</span></span><br><span class="line"><span class="keyword">var</span> proxy = <span class="keyword">new</span> events.EventEmitter();</span><br><span class="line"><span class="keyword">var</span> status = <span class="string">'ready'</span>;</span><br><span class="line"><span class="keyword">var</span> select = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// once()ï¼Œæ‰§è¡Œä¸€æ¬¡å°±ä¼šå°†ç›‘è§†å™¨ç§»é™¤ï¼Œä¿è¯æ¯ä¸€ä¸ªå›è°ƒåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚</span></span><br><span class="line">    proxy.once(<span class="string">'selected'</span>, callback);</span><br><span class="line">    <span class="keyword">if</span> (status === <span class="string">'ready'</span>) &#123;</span><br><span class="line">        status = <span class="string">'pending'</span>;</span><br><span class="line">        db.select(<span class="string">'SQL'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">results</span>) </span>&#123;</span><br><span class="line">            proxy.emit(<span class="string">'selected'</span>, results);</span><br><span class="line">            status = <span class="string">'ready'</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>å¤šå¼‚æ­¥ä¹‹é—´çš„åä½œæ–¹æ¡ˆ</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€èˆ¬è€Œè¨€ï¼Œäº‹ä»¶ä¸ä¾¦å¬å™¨çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œä¹Ÿä¼šå‡ºç°äº‹ä»¶ä¸ä¾¦å¬å™¨çš„å…³ç³»æ˜¯å¤šå¯¹ä¸€çš„æƒ…å†µï¼š</span></span><br><span class="line"><span class="keyword">var</span> after = <span class="function"><span class="keyword">function</span> (<span class="params">times, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>, results = &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">        results[key] = value;</span><br><span class="line">        count ++;</span><br><span class="line">        <span class="comment">// å“¨å…µå˜é‡ï¼šcount æ˜¯ç”¨äºæ£€æµ‹æ¬¡æ•°çš„å˜é‡</span></span><br><span class="line">        <span class="keyword">if</span> (count === times) &#123;</span><br><span class="line">            callback(results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> done = after(times, render);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šEventProxyã€‚</li>
</ul>
</li>
</ol>
<h3>Promise/Deferred æ¨¡å¼</h3>
<p><strong>å…ˆæ‰§è¡Œå¼‚æ­¥è°ƒç”¨ï¼Œå»¶è¿Ÿä¼ é€’å¤„ç†ã€‚</strong></p>
<h4>Promises/A</h4>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075932-1.jpg" alt="image"></p>
<ul>
<li>Promise æ“ä½œçš„3ç§çŠ¶æ€ï¼šæœªå®Œæˆæ€ã€å®Œæˆæ€å’Œå¤±è´¥æ€ã€‚</li>
<li>Promise çš„çŠ¶æ€åªä¼šå‡ºç°ä»æœªå®Œæˆæ€å‘å®Œæˆæ€æˆ–å¤±è´¥æ€è½¬åŒ–ï¼Œä¸èƒ½é€†åã€‚å®Œæˆæ€å’Œå¤±è´¥æ€ä¸èƒ½äº’ç›¸è½¬åŒ–ã€‚</li>
<li>Promise çš„çŠ¶æ€ä¸€æ—¦è½¬åŒ–ï¼Œå°†ä¸èƒ½æ›´æ”¹ã€‚</li>
<li><a href="https://github.com/kriskowal/q" target="_blank" rel="noopener">A promise library for javascriptï¼šq</a></li>
</ul>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Promise</span> = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line">&#125;;</span><br><span class="line">util.inherits(<span class="built_in">Promise</span>, EventEmitter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// then() æ–¹æ³•å°†å›è°ƒå‡½æ•°å­˜æ”¾èµ·æ¥</span></span><br><span class="line"><span class="built_in">Promise</span>.prototype.then = <span class="function"><span class="keyword">function</span> (<span class="params">fulfilledHander, errorHandler, progressHandler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fulfilledHander === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨ once() æ–¹æ³•ï¼Œä¿è¯æˆåŠŸå›è°ƒåªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">this</span>.once(<span class="string">'success'</span>, fulfilledHander);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> errorHandler === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨ once() æ–¹æ³•ï¼Œä¿è¯å¼‚å¸¸å›è°ƒåªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">this</span>.once(<span class="string">'error'</span>, errorHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> progressHandler === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.once(<span class="string">'progress'</span>, progressHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deferredï¼Œå»¶è¿Ÿå¯¹è±¡ï¼Œè§¦å‘æ‰§è¡Œå›è°ƒ</span></span><br><span class="line"><span class="keyword">var</span> Deferred = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'unfulfilled'</span>;</span><br><span class="line">    <span class="keyword">this</span>.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>();</span><br><span class="line">&#125;;</span><br><span class="line">Deferred.prototype.resolve = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'fulfilled'</span>;</span><br><span class="line">    <span class="keyword">this</span>.promise.emit(<span class="string">'success'</span>, obj);</span><br><span class="line">&#125;;</span><br><span class="line">Deferred.prototype.reject = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'failed'</span>;</span><br><span class="line">    <span class="keyword">this</span>.promise.emit(<span class="string">'error'</span>, obj);</span><br><span class="line">&#125;;</span><br><span class="line">Deferred.prototype.progress = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.promise.emit(<span class="string">'progress'</span>, obj);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹ä¸€ä¸ªå…¸å‹çš„å“åº”å¯¹è±¡è¿›è¡Œå°è£…</span></span><br><span class="line">res.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'BODY: '</span> + chunk);</span><br><span class="line">&#125;)</span><br><span class="line">res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Done</span></span><br><span class="line">&#125;)</span><br><span class="line">res.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ Promises/Aæè®®çš„æ¨¡å¼å¯ä»¥è½¬æ¢ä¸ºå¦‚ä¸‹çš„ç®€ç•¥å½¢å¼ï¼š</span></span><br><span class="line">res.then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Done</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'BODY: '</span> + chunk);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šç®€å†™çš„æ”¹é€ æ–¹æ³•ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è£…ï¼š</span></span><br><span class="line"><span class="keyword">var</span> promisify = <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// *ä¸šåŠ¡ä¸­ä¸å¯å˜çš„éƒ¨åˆ†å°è£…åœ¨ Deferred ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">var</span> deferred = <span class="keyword">new</span> Deferred();</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">''</span>;</span><br><span class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        result += chunk;</span><br><span class="line">        deferred.progress(chunk);</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        deferred.resolve(result);</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">        deferred.reject(error);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> deferred.promise; <span class="comment">// è¿”å› deferred.promiseï¼Œä¸è®©å¤–éƒ¨ç¨‹åºç›´æ¥è°ƒç”¨ reslove()ã€reject() æ–¹æ³•ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="comment">// *ä¸šåŠ¡ä¸­å¯å˜çš„éƒ¨åˆ†å°è£…åœ¨ Promise ä¸­ã€‚</span></span><br><span class="line">promisify(res).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Done</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// progress</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'BODY: '</span> + chunk);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Deferred ä¸»è¦ç”¨äºå†…éƒ¨ï¼Œç”¨äºç»´æŠ¤å¼‚æ­¥æ¨¡å‹çš„çŠ¶æ€ã€‚</li>
<li>Promise ä¸»è¦ä½œç”¨äºå¤–éƒ¨ï¼Œé€šè¿‡ <code>then()</code> æ–¹æ³•æš´éœ²ç»™å¤–éƒ¨ä»¥æ·»åŠ è‡ªå®šä¹‰é€»è¾‘.</li>
</ul>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075933.jpg" alt="Promise å’Œ Deferred æ•´ä½“å…³ç³»ç¤ºæ„å›¾"></p>
<h3>Promise ä¸­çš„å¤šå¼‚æ­¥åä½œ</h3>
<h2>æµç¨‹æ§åˆ¶åº“</h2>
<h3>å°¾è§¦å‘ä¸Next</h3>
<p>å°¾è§¦å‘ï¼šéœ€è¦æ‰‹å·¥è°ƒç”¨æ‰èƒ½æŒç»­æ‰§è¡Œåç»­è°ƒç”¨çš„æ–¹æ³•ã€‚</p>
<p>å°¾è§¦å‘ç›®å‰åº”ç”¨æœ€å¤šçš„åœ°æ–¹æ˜¯ <a href="https://www.npmjs.com/package/connect" target="_blank" rel="noopener">Connect</a> çš„ä¸­é—´ä»¶ã€‚</p>
<p>åœ¨ <a href="https://www.npmjs.com/package/connect" target="_blank" rel="noopener">Connect</a> ä¸­ï¼Œå°¾è§¦å‘ååˆ†é€‚åˆå¤„ç†ç½‘ç»œè¯·æ±‚çš„åœºæ™¯ã€‚å°†å¤æ‚çš„å¤„ç†é€»è¾‘æ‹†è§£ä¸ºç®€æ´ã€å•ä¸€çš„å¤„ç†å•å…ƒï¼Œé€æ¬¡åœ°å¤„ç†è¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡ã€‚</p>
<h3><a href="https://www.npmjs.com/package/async" target="_blank" rel="noopener">async</a></h3>
<h5>å¼‚æ­¥çš„ä¸²è¡Œæ‰§è¡Œ</h5>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°ä½œç”¨ï¼šè¯»å–2ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment">// async æä¾›äº† series() æ–¹æ³•æ¥å®ç°ä¸€ç»„ä»»åŠ¡çš„ä¸²è¡Œæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªcallback() æ‰§è¡Œæ—¶ä¼šå°†ç»“æœä¿å­˜èµ·æ¥ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ªè°ƒç”¨ï¼Œç›´åˆ°ç»“æŸæ‰€æœ‰è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="keyword">async</span>.series([</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file2.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;</span><br><span class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// results =&gt; [file1.txt, file2.txt]</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸Šä»£ç ç­‰ä»·äº</span></span><br><span class="line">fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(err);</span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(<span class="string">'file2.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(err);</span><br><span class="line">        &#125;</span><br><span class="line">        callback(<span class="literal">null</span>, [content, data]);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h5>å¼‚æ­¥çš„å¹¶è¡Œæ‰§è¡Œ</h5>
<p><code>parallel()</code> æ–¹æ³•å¯¹äºå¼‚å¸¸çš„åˆ¤æ–­ä¾ç„¶æ˜¯ä¸€æ—¦æŸä¸ªå¼‚æ­¥è°ƒç”¨äº§ç”Ÿäº†å¼‚å¸¸ï¼Œå°±ä¼šå°†å¼‚å¸¸ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ç»™æœ€ç»ˆçš„å›è°ƒå‡½æ•°ã€‚åªæœ‰æ‰€æœ‰å¼‚æ­¥è°ƒç”¨éƒ½æ­£å¸¸å®Œæˆæ—¶ï¼Œæ‰ä¼šå°†ç»“æœä»¥æ•°ç»„çš„æ–¹å¼ä¼ å…¥ã€‚</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parallel() æ–¹æ³•ï¼Œå¹¶è¡Œæ‰§è¡Œå¼‚æ­¥æ“ä½œ</span></span><br><span class="line"><span class="comment">// è¯»å–ä¸¤ä¸ªæ–‡ä»¶çš„å¹¶è¡Œç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">async</span>.parallel([</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file2.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;</span><br><span class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// results =&gt; [file1.txt, file2.txt]</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸Šä»£ç ç­‰ä»·äºä¸‹é¢çš„ä»£ç </span></span><br><span class="line"><span class="keyword">var</span> counter = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> results = [];</span><br><span class="line"><span class="keyword">var</span> done = <span class="function"><span class="keyword">function</span> (<span class="params">index, value</span>) </span>&#123;</span><br><span class="line">    results[index] = value;</span><br><span class="line">    counter--;</span><br><span class="line">    <span class="keyword">if</span> (counter === <span class="number">0</span>) &#123;</span><br><span class="line">        callback(<span class="literal">null</span>, results);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åªä¼ é€’ç¬¬ä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">var</span> hasErr = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> fail = <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasErr) &#123;</span><br><span class="line">        hasErr = <span class="literal">true</span>;</span><br><span class="line">        callback(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> fail(err);</span><br><span class="line">    &#125;</span><br><span class="line">    done(<span class="number">0</span>, content);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'file2.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> fail(err);</span><br><span class="line">    &#125;</span><br><span class="line">    done(<span class="number">1</span>, data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h5>å¼‚æ­¥è°ƒç”¨çš„ä¾èµ–å¤„ç†</h5>
<p><code>series()</code> é€‚åˆ<strong>æ— ä¾èµ–çš„å¼‚æ­¥ä¸²è¡Œæ‰§è¡Œ</strong>ï¼Œä½†å½“å‰ä¸€ä¸ªç»“æœæ˜¯åä¸€ä¸ªè°ƒç”¨çš„è¾“å…¥æ—¶ï¼Œ<code>series()</code> æ–¹æ³•å°±æ— æ³•æ»¡è¶³éœ€æ±‚äº†ã€‚async æä¾›äº† <code>waterfall()</code>  æ–¹æ³•æ¥æ»¡è¶³ï¼š</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span>.waterfall([</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">            callback(err, content);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">arg1, callback</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// arg1 =&gt; file2.txt</span></span><br><span class="line">        fs.readFile(arg1, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">            callback(err, content);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">arg1, callback</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// arg1 =&gt; file3.txt</span></span><br><span class="line">        fs.readFile(arg1, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, content</span>) </span>&#123;</span><br><span class="line">            callback(err, content);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// result =&gt; file4.txt</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸Šä»£ç ç­‰ä»·äº</span></span><br><span class="line">fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> callback(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// data1ä½œä¸ºä¸‹ä¸ªå‡½æ•°çš„å…¥å‚</span></span><br><span class="line">    fs.readFile(data1, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data2</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// data2 ä½œä¸ºä¸‹ä¸ªå‡½æ•°çš„å…¥å‚</span></span><br><span class="line">        fs.readFile(data2, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, data3</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="keyword">return</span> callback(err);</span><br><span class="line">            &#125;</span><br><span class="line">            callback(<span class="literal">null</span>, data3);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h5>è‡ªåŠ¨ä¾èµ–å¤„ç†</h5>
<p><code>auto()</code> å®ç°å¤æ‚çš„ä¸šåŠ¡å¤„ç†ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¾èµ–å…³ç³»è‡ªåŠ¨åˆ†æï¼Œä»¥æœ€ä½³çš„é¡ºåºæ‰§è¡Œä¸šåŠ¡æµã€‚</p>
<h2>å¼‚æ­¥å¹¶å‘æ§åˆ¶</h2>
<ul>
<li><a href="https://github.com/JacksonTian/bagpipe" target="_blank" rel="noopener">bagpipe</a> çš„è§£å†³æ–¹æ¡ˆï¼›</li>
<li>async çš„è§£å†³æ–¹æ¡ˆï¼š<code>parallelLimit()</code> æ–¹æ³•ï¼›</li>
<li><a href="https://github.com/JeffreyZhao/wind" target="_blank" rel="noopener">wind</a></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¢åŠ é™åˆ¶å¹¶å‘æ•°é‡çš„å‚æ•°ï¼Œä½¿å¾—ä»»åŠ¡åªèƒ½åŒæ—¶å¹¶å‘ä¸€å®šæ•°é‡ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶å¹¶å‘ã€‚</span></span><br><span class="line"><span class="keyword">async</span>.parallelLimit([</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file1.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        fs.readFile(<span class="string">'file2.txt'</span>, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">    &#125;</span><br><span class="line">], <span class="number">1</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// queue() æ–¹æ³•ï¼Œè§£å†³ parallelLiment() æ— æ³•åŠ¨æ€åœ°å¢åŠ å¹¶è¡Œä»»åŠ¡ã€‚</span></span><br><span class="line"><span class="keyword">var</span> q = <span class="keyword">async</span>.queue(<span class="function"><span class="keyword">function</span> (<span class="params">file, callback</span>) </span>&#123;</span><br><span class="line">    fs.readFile(file, <span class="string">'utf-8'</span>, callback);</span><br><span class="line">&#125;, <span class="number">2</span>);</span><br><span class="line">q.drain = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å®Œæˆäº†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">&#125;;</span><br><span class="line">fs.readdirSync(<span class="string">'.'</span>).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</span><br><span class="line">    q.push(file, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/10/23/OpenSSL-æ— æ³•ä½¿ç”¨-RSA-éå¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†å¤§æ–‡ä»¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
      <meta itemprop="description" content="æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç‹¬æœ¨èˆŸçš„æœ¨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/10/23/OpenSSL-æ— æ³•ä½¿ç”¨-RSA-éå¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†å¤§æ–‡ä»¶/" class="post-title-link" itemprop="url">OpenSSL-æ— æ³•ä½¿ç”¨-RSA-éå¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†å¤§æ–‡ä»¶</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2018-10-23 21:05:00" itemprop="dateCreated datePublished" datetime="2018-10-23T21:05:00+08:00">2018-10-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI-å¯†ç å­¦/" itemprop="url" rel="index"><span itemprop="name">PKI&å¯†ç å­¦</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
                
                <span title="æœ¬æ–‡å­—æ•°">736</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">1 åˆ†é’Ÿ</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h3>Shell ç¤ºä¾‹ä»£ç </h3>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨ genrsa å‘½ä»¤ç”Ÿæˆ RSA-2048 ä½çš„å¯†é’¥ï¼ˆrsa_private.keyï¼‰</span></span><br><span class="line">openssl genrsa -out rsa_private.key 2048</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£æç§é’¥ç»“æ„ï¼ŒæŸ¥çœ‹å¯†é’¥å†…å®¹</span></span><br><span class="line">openssl rsa -text -in rsa_private.key</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç”Ÿæˆå¯†é’¥çš„å…¬é’¥ï¼ˆrsa_private.keyï¼‰</span></span><br><span class="line">openssl rsa -in rsa_private.key -pubout -out rsa_public.key</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨ç”Ÿæˆçš„å…¬é’¥åŠ å¯†æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -pubin è¡¨æ˜ç”¨çº¯å…¬é’¥æ–‡ä»¶åŠ å¯†</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -inkey æŒ‡å®šå¯†é’¥ï¼ˆrsa_private.keyï¼‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -<span class="keyword">in</span> æŒ‡å®šè¦åŠ å¯†çš„æ–‡ä»¶ï¼ˆtest.pdfï¼Œ3.2Mï¼‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -out åŠ å¯†åçš„æ–‡ä»¶ï¼ˆencrypted.enï¼‰</span></span><br><span class="line">openssl rsautl -encrypt -pubin -inkey rsa_public.key  -in test.pdf -out encrypted.en</span><br><span class="line">RSA operation error</span><br><span class="line">4475450988:error:04FFF06E:rsa routines:CRYPTO_internal:data too large for key size:/BuildRoot/Library/Caches/com.apple.xbs/Sources/libressl/libressl-22.200.4/libressl-2.6/crypto/rsa/rsa_pk1.c:151:</span><br></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://stackoverflow.com/questions/7143514/how-to-encrypt-a-large-file-in-openssl-using-public-key" target="_blank" rel="noopener">How to encrypt a large file in openssl using public key</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png" alt="ç‹¬æœ¨èˆŸçš„æœ¨">
            
              <p class="site-author-name" itemprop="name">ç‹¬æœ¨èˆŸçš„æœ¨</p>
              <div class="site-description motion-element" itemprop="description">æœ‰æ—¶å€™é˜³å…‰å¾ˆå¥½ æœ‰æ—¶å€™é˜³å…‰å¾ˆæš—</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">316</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Andy0570" title="GitHub &rarr; https://github.com/Andy0570" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:andywhm@163.com" title="E-Mail &rarr; mailto:andywhm@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ç‹¬æœ¨èˆŸçš„æœ¨</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="ç«™ç‚¹æ€»å­—æ•°">2.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">32:53</span>
  
</div>



  <span id="busuanzi_container_site_uv">
  æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
  </span>
  <span class="post-meta-divider">|</span>

  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





  



  






  



  
    
    
      
    
  
  <script color="17,119,176" opacity="0.5" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>













  
  <script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/fastclick@1/lib/fastclick.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/jquery-lazyload@1/jquery.lazyload.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  
  
  
    
  

  
    
      
    
  

  
  
  
    <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
    <script>
      
        window.addEventListener('load', () => {
      
        quicklink({
          timeout: 3000,
          priority: true,
          ignores: [uri => uri.includes('#'),uri => uri == 'https://andy0570.com/page/6/',]
        });
      
        });
      
    </script>
  


  



  



  
  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">

  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.js"></script>
  

  <script src="/js/algolia-search.js?v=7.1.0"></script>



  

  

  

  

  

  

  

  

  

  
  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script>pangu.spacingPage();</script>


  
  
  
    
  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-bookmark@1/bookmark.min.js"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script>


  

  

  
  
</body>
</html>
