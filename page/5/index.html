<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
      
    
    
      
    
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">



  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/han-css@3/dist/han.min.css">













  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">







  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/panda/apple-touch-icon.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/panda/favicon-32x32.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/panda/favicon-16x16.png?v=7.1.0">


  <link rel="mask-icon" href="/images/panda/safari-pinned-tab.svg?v=7.1.0" color="#222">


  <link rel="manifest" href="/images/panda/site.webmanifest">


  <meta name="msapplication-config" content="/images/panda/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: true,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '0E2AON8EZF',
      apiKey: '22fbefd84c8343239f5c04365b9728de',
      indexName: 'MyBlogPlatform',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="有时候阳光很好 有时候阳光很暗">
<meta name="keywords" content="独木舟的木">
<meta property="og:type" content="website">
<meta property="og:title" content="独木舟的木">
<meta property="og:url" content="https://andy0570.com/page/5/index.html">
<meta property="og:site_name" content="独木舟的木">
<meta property="og:description" content="有时候阳光很好 有时候阳光很暗">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="独木舟的木">
<meta name="twitter:description" content="有时候阳光很好 有时候阳光很暗">



  <link rel="alternate" href="/atom.xml" title="独木舟的木" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://andy0570.com/page/5/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>独木舟的木</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8229a094facca297f211d61323fd9fde";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <a href="https://github.com/andy0570" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">独木舟的木</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">iOS Developer</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">14</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">38</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">315</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/andy0570" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/13/iOS 应用上架参考/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/13/iOS 应用上架参考/" class="post-title-link" itemprop="url">iOS 应用上架参考</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-13 10:36:00" itemprop="dateCreated datePublished" datetime="2018-12-13T10:36:00+08:00">2018-12-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 20:53:02" itemprop="dateModified" datetime="2019-05-01T20:53:02+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">781</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2>iOS开发证书与配置文件</h2>
<ul>
<li><a href="http://www.jianshu.com/p/efda63c04055" target="_blank" rel="noopener">iOS APP提交上架最新流程 @2015/11</a></li>
<li><a href="http://www.jianshu.com/p/9d9e3699515e" target="_blank" rel="noopener">iOS开发证书与配置文件的使用 @2015/12/6</a></li>
<li><a href="http://www.cocoachina.com/appstore/20170627/19622.html" target="_blank" rel="noopener">最新iOS发布App Store详细图文教程 @ 2017/6/27</a></li>
<li><a href="http://yiweifen.com/html/news/WaiYu/172011.html" target="_blank" rel="noopener">ios APP最新打包上线超详细流程，保证一看就会的教程！@2017/8/4</a> 【简单介绍申请 APP ID、创建证书】</li>
<li><a href="http://ios.jobbole.com/84643/" target="_blank" rel="noopener">史上最用心的 iOS App 上架流程 @2016/4/15</a></li>
<li><a href="http://www.jianshu.com/p/862349f49c3c" target="_blank" rel="noopener">iOS开发证书配置系列之——真机调试相关文件配置导引</a></li>
<li><a href="http://blog.csdn.net/smallsky_keke/article/details/11098653" target="_blank" rel="noopener">图文讲解：iOS App提交流程 @2013/9/4</a></li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h2>审核</h2>
<ul>
<li><a href="https://developer.apple.com/app-store/review/guidelines/cn/" target="_blank" rel="noopener">苹果开发者官网App Store 审核指南（中文版）</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/LanguagesUtilities/Conceptual/iTunesConnect_Guide_zh_CN/Chapters/About.html#//apple_ref/doc/uid/TP40016325" target="_blank" rel="noopener">iTunes Connect 开发者指南</a></li>
<li><a href="http://help.apple.com/itc/apploader/#/apdS673accdb" target="_blank" rel="noopener">使用 Application Loader</a></li>
<li><a href="https://www.zhihu.com/question/20216099" target="_blank" rel="noopener">知乎：应用提交 App Store 上架被拒的原因都有哪些？</a></li>
<li><a href="http://www.jianshu.com/p/c1f25e1747e2" target="_blank" rel="noopener">关于苹果审核被拒 PLA 1.2, ipv6被拒该如何解决</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22572268" target="_blank" rel="noopener">iOS审核总被拒？腾讯教你提升iOS审核通过率！</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/20010725?columnSlug=100000PM" target="_blank" rel="noopener">10个大坑，当你产品上架AppStore会遇到（上） - 十万产品经理 - 知乎专栏</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/20010731?columnSlug=100000PM" target="_blank" rel="noopener">10个大坑，当你产品上架AppStore会遇到（下） - 十万产品经理 - 知乎专栏</a></li>
<li><a href="https://aso100.com/zhuanlan/article/id/191" target="_blank" rel="noopener">惊！苹果再次加强审核力度，众App纷纷止步应用标题</a></li>
<li><a href="https://aso100.com/zhuanlan/article/id/200" target="_blank" rel="noopener">【详解】苹果加强审核力度，被拒原因终逃不过这些！</a></li>
<li><a href="https://aso100.com/zhuanlan/article/id/214" target="_blank" rel="noopener">重磅！苹果官方公开 11 大被拒原因，你中招了吗？！</a></li>
</ul>
<h2>测试</h2>
<ul>
<li><a href="http://cdc.tencent.com/2012/11/28/%E3%80%90cdc%E7%BF%BB%E5%AE%A2%E3%80%91%E7%A7%BB%E5%8A%A8%E7%AB%AFapp%E6%B5%8B%E8%AF%95%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/" target="_blank" rel="noopener">【CDC翻客】移动端App测试实用指南</a></li>
</ul>
<h2>其他</h2>
<ul>
<li><a href="https://objccn.io/issue-17-2/" target="_blank" rel="noopener">objc中国：代码签名探析</a></li>
</ul>
<h2>iOS 版本渗透统计</h2>
<ul>
<li><a href="https://developer.apple.com/support/app-store/" target="_blank" rel="noopener">Apple’s world-wide iOS version penetration statistics</a></li>
<li><a href="http://iossupportmatrix.com/" target="_blank" rel="noopener">iOS Support Matrix</a></li>
<li><a href="https://david-smith.org/iosversionstats/" target="_blank" rel="noopener">DavidSmith: iOS Version Stats</a></li>
<li><a href="https://mixpanel.com/trends/#report/ios_frag" target="_blank" rel="noopener">Mixpanel Trends: iOS Version</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/12/Web 开发的身份数据和安全_1.导论/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/12/Web 开发的身份数据和安全_1.导论/" class="post-title-link" itemprop="url">Web 开发的身份数据和安全_1.导论</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-12 02:16:00" itemprop="dateCreated datePublished" datetime="2018-12-12T02:16:00+08:00">2018-12-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-17 13:50:20" itemprop="dateModified" datetime="2019-05-17T13:50:20+08:00">2019-05-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI-密码学/" itemprop="url" rel="index"><span itemprop="name">PKI&密码学</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.5k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>参考：《Web 开发的身份数据和安全》</p>
</blockquote>
<p>主要内容：</p>
<ul>
<li>了解 Web 和应用安全的现状。</li>
<li>构建安全的加密方式、以及与各种密码攻击媒介斗争。</li>
<li>创建数字指纹，在浏览器、设备和配对设备中识别用户。</li>
<li>通过 OAuth 和 OpenID Connect 构建安全的数据传输系统。</li>
<li>使用其他的识别方法提供第二种身份验证方式。</li>
<li>加固 Web 应用，防止攻击。</li>
<li>使用 SSL/TLS 及同步和异步加密创建安全的数据传输系统。</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h1>导论</h1>
<h2>关于安全，你需要觉醒的是</h2>
<blockquote>
<p>对系统，公司或应用最重要的投资之一是<strong>安全和身份基础设施</strong>。</p>
<p>保护数据没有万无一失的安全方法。身份和数据安全的要务是降低风险、保护严守的数据，当不幸发生时，留出足够的时间采取行动，减少损失。</p>
</blockquote>
<h2>现有安全模型的问题</h2>
<ul>
<li>
<p>不是技术跟不上潜在的攻击媒介的发展步伐，而是开发方式的选择导致系统变得薄弱。</p>
</li>
<li>
<p>错误的思想：</p>
<ul>
<li>你以为用户始终会选择最安全的方案（如：强密码、双因素身份验证），实际上用户更愿意选择最简单的方案。</li>
<li>为了确保系统安全，不惜牺牲可用性。</li>
<li>安全措施绝不会遭到破坏。</li>
</ul>
</li>
<li>
<p><strong>强密码</strong>：不管系统的体量有多大，都始终应该假设数据库的安全措施有可能被攻破，导致数据被盗取。一切敏感的信息都应该妥善加密。</p>
</li>
<li>
<p><strong>可用性和安全性</strong>一定要适当平衡。</p>
</li>
<li>
<p><strong>数据加密</strong>：数据不是为了防止数据被盗，而是要拖慢黑客的步伐，让他们在短时间内无法解密大量数据，或者拖延时间，以便采取必要的行动。</p>
</li>
<li>
<p>最薄弱的环节，人类：双因素身份认证、密码疲劳。</p>
<blockquote>
<p>解决“密码疲劳”问题：</p>
<ul>
<li>苹果（Apple）系统的密码管理应用：Keychain。</li>
<li>应用：1Password、Dashlane、LastPass。</li>
</ul>
<p>增强用户体验并提升密码强度的三个方式：</p>
<ul>
<li>显示密码规则；</li>
<li>显示用户输入；</li>
<li>显示强度表；</li>
</ul>
</blockquote>
</li>
<li>
<p>单点登录（single sign-on，SSO）：OpenID、OAuth 1.0、OAuth 2.0、OpenID Connect。</p>
</li>
</ul>
<h2>理解密码安全中的熵</h2>
<ul>
<li>判断密码强度的标准机制——<strong>信息熵</strong>。</li>
<li>信息熵的衡量方式：源（如密码）中信息的比特数。通常认为，熵至少为 36.86 比特的密码才是好密码。</li>
<li>衡量密码熵的几个关键特征：所用的符号集、符号集通过大小写字符所做的扩充、密码长度。</li>
<li>作用：预测通过猜测、字典攻击、暴力攻击等手段破解密码的难度。</li>
<li>生成密码的方式：1. 随机生成。2. 人为设置。</li>
<li>因为人类创建的密码难以确定安全性，所以 Web 开发时，通常：
<ul>
<li>要求用户在创建密码时提高密码的强度。</li>
<li>默默在背后尽自己所能提升数据的安全性（如：加密、限制尝试登录次数）。</li>
</ul>
</li>
</ul>
<h2>区分用户名和密码在系统中的作用</h2>
<ul>
<li>用户名（或公钥）用于认证用户的身份。</li>
<li>密码（或私钥）则以只有用户自己知道的方式证明用户的身份。</li>
<li>身份验证的两种方式：1. 增强系统。2. 删除用户名和密码。</li>
</ul>
<h2>好的和不好的安全算法（对密码而言）</h2>
<p><div class="note info">
            <p>这边的“好”与“不好”指的是<strong>对密码进行哈希加密而言</strong>。</p>
          </div></p>
<p>在保护数据和受限的用户信息方面，不是所有的加密算法都具有同等效果。</p>
<p>两种哈希加密算法：</p>
<ul>
<li>追求快速度的算法，用于快速而准确地加密和解密大量数据。</li>
<li>故意放慢速度的算法，防止暴力破解，用于保护密码。</li>
</ul>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075059.jpg" alt="哈希算法"></p>
<h2>应该保护哪些数据？</h2>
<p>哪些信息必须加密？</p>
<p>任何能认证身份的信息（身份数据、个人信息、支付详情），以及那些对系统至关重要，公开后可能导致架构出现漏洞的信息。</p>
<h2>账户恢复机制还需要考虑到社会工程的影响</h2>
<ul>
<li>安全问题的设置重复、搞怪、不易回答、难以记住。（如：小时候我喜欢吃什么菜？你最喜欢读哪本书？）。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/11/浅尝辄止·摄影/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/11/浅尝辄止·摄影/" class="post-title-link" itemprop="url">浅尝辄止·摄影</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-11 00:47:00" itemprop="dateCreated datePublished" datetime="2018-12-11T00:47:00+08:00">2018-12-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 20:44:35" itemprop="dateModified" datetime="2019-05-01T20:44:35+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发工具-Mac应用/" itemprop="url" rel="index"><span itemprop="name">开发工具&Mac应用</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>参考：<a href="https://www.apple.com/cn/iphone/photography-how-to/" target="_blank" rel="noopener">Apple 官方教程：使用 iPhone 拍摄的窍门</a></p>
<h3>使用 iPhone 「景深控制功能」调整照片的窍门</h3>
<ol>
<li>选一张人像；</li>
<li>轻点「编辑」；</li>
<li>滑动来调节景深；</li>
<li>轻点「完成」；</li>
</ol>
<h3>使用 iPhone 编辑「人像自拍」的窍门</h3>
<ol>
<li>打开相簿，选一张「人像自拍」；</li>
<li>轻点「编辑」；</li>
<li>选择「光效」；</li>
<li>滑动来调节景深；</li>
<li>轻点「完成」；</li>
</ol>
<p>&lt;!-- more --&gt;</p>
<h3>使用 iPhoneX「慢动作」拍摄的窍门</h3>
<ol>
<li>找个尽可能低的角度；</li>
<li>选择慢动作模式；</li>
<li>调整效果的起点；</li>
</ol>
<h3>使用 iPhoneX「逆光」拍摄的窍门</h3>
<ol>
<li>锁定对焦（轻点画面），调整曝光（按住空白处上下拖动手指）；</li>
<li>制造点气氛；</li>
<li>抓拍动作；</li>
</ol>
<h3>使用 iPhoneX「连拍快照」拍摄的窍门</h3>
<ol>
<li>找到合适的角度；</li>
<li><strong>按住快门按钮</strong>，激活连拍快照模式；</li>
<li>选择你最喜欢的；</li>
</ol>
<h3>使用 iPhoneX「全景拍摄」的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075407.png" alt="全景拍摄"></p>
<ol>
<li>选择全景模式；</li>
<li>拍到中间时保持不动（所有人从拍摄者背后绕到另一边摆Poss）；</li>
<li>完成右半边拍摄；</li>
</ol>
<h3>让实况照片来回播放的窍门</h3>
<ol>
<li>选一张<strong>实况</strong>照片；</li>
<li>向上轻扫；</li>
<li>选择来回播放；</li>
</ol>
<h3>拍摄「黑白照片」的窍门</h3>
<ol>
<li>选一个滤镜（在拍摄画面向上轻扫）；</li>
<li>让主体和背景间形成明显的反差；</li>
<li>调出合适的曝光；</li>
<li>开拍；</li>
</ol>
<h3>编辑「慢动作时间点」的窍门</h3>
<ol>
<li>选一段<strong>慢动作</strong>视频；</li>
<li>轻点「编辑」；</li>
<li>滑动调整慢动作时间点（选择慢动作区间）；</li>
<li>完成；</li>
</ol>
<h3>「俯视」拍摄的窍门</h3>
<ol>
<li>打开<strong>网格</strong>（系统设置-相机中开启）；</li>
<li>躲开头顶的光线（构图）；</li>
<li>让两个++对齐（让手机水平对齐）；</li>
<li>开拍；</li>
</ol>
<h3>「巧用框架构图」拍摄的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075411.png" alt="巧用框架构图"></p>
<ol>
<li>寻找合适的线条作为框架突出主体；</li>
<li>安排好拍摄主体的位置；</li>
<li>开拍；</li>
</ol>
<h3>调整照片「颜色」的窍门</h3>
<ol>
<li>选一张照片；</li>
<li>点一下「编辑」；</li>
<li>调整「颜色」的浓淡（饱和度/对比度/色偏）；</li>
<li>完成；</li>
</ol>
<h3>「长焦镜头」构图的窍门</h3>
<ol>
<li>轻点（1x）简化构图；</li>
<li>开拍；</li>
</ol>
<h3>拍摄「人像光效照片」的窍门</h3>
<ol>
<li>切换到<strong>人像</strong>模式；</li>
<li>轻扫来选择光线效果；</li>
<li>开拍；</li>
</ol>
<h3>编辑「人像光效」的窍门</h3>
<ol>
<li>选择用<strong>人像模式</strong>拍摄的照片；</li>
<li>轻按「编辑」；</li>
<li>轻扫来选择<strong>光线效果</strong>；</li>
<li>轻点完成；</li>
</ol>
<h3>拍摄「微距特写」的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075415.png" alt="微距特写"></p>
<ol>
<li>靠近，再靠近，近到 10cm 为止；</li>
<li>轻点「对焦」，并滑动调整曝光；</li>
<li>开拍；</li>
</ol>
<h3>拍摄「竖幅全景」的窍门</h3>
<ol>
<li>首先要把镜头横过来；</li>
<li>切换到「全景」模式；</li>
<li>从底部开始慢慢地平稳地向上；</li>
</ol>
<h3>「关闭闪光」拍摄的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075425.png" alt="关闭闪光"></p>
<ol>
<li>找一个光源；</li>
<li>关闭闪光灯；</li>
<li>轻点拍摄对象设定曝光；</li>
<li>开拍</li>
</ol>
<h3>拍摄「动感场景」的窍门</h3>
<ol>
<li>按住快门按钮，使用连拍快照模式；</li>
<li>点开你的照片；</li>
<li>从选一张你喜欢的；</li>
</ol>
<h3>拍摄「定时自拍照」的窍门</h3>
<ol>
<li>转换到前置摄像头；</li>
<li>将你的 iPhone 放稳；</li>
<li>设<strong>定时器</strong>；</li>
<li>轻点快门按钮；</li>
</ol>
<h3>抓拍「特殊角度」的窍门</h3>
<ol>
<li>选定拍摄对象；</li>
<li>尝试各种角度；</li>
<li>试试斜过来、试试仰起来、试试低下来（斜仰低近，多多尝试）；</li>
<li>开拍；</li>
</ol>
<h3>「变焦」拍摄的窍门</h3>
<ol>
<li>变焦有两种方式：
<ul>
<li>轻点 1x 可实现两倍光学变焦；</li>
<li>或者轻点并按住 1x 再滑动控制变焦；</li>
</ul>
</li>
<li>开拍；</li>
</ol>
<h3>录像时「抓拍照片」的窍门</h3>
<ol>
<li>切换到<strong>视频模式</strong>；</li>
<li>开始拍摄视频；</li>
<li>轻点快门按钮（除了中间的视频拍摄，左下角还有一个按钮）；</li>
</ol>
<h3>「用街头光线」拍摄的窍门</h3>
<ol>
<li>关闭闪光灯；</li>
<li>轻点并按住锁定对焦；</li>
<li>调到合适的曝光量；</li>
<li>开拍；</li>
</ol>
<h3>「让作品简洁抢眼」的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075429.png" alt="让作品简洁抢眼"></p>
<ol>
<li>找一些形成强烈反差效果的色彩；</li>
<li>简化一下画面；</li>
<li>使构图平衡对称；</li>
<li>尝试不同的曝光；</li>
<li>开拍</li>
</ol>
<h3>「在夕阳余晖下」拍摄的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075433.png" alt="在夕阳余晖下"></p>
<ol>
<li>赶在日落之前；</li>
<li>让阳光从正面照亮拍摄对象；</li>
<li>轻点并下滑减弱曝光；</li>
<li>开拍；</li>
</ol>
<h3>拍摄「单手自拍照」的窍门</h3>
<ol>
<li>将锁定屏幕向左轻扫快速打开相机；</li>
<li>转换到前置摄像头；</li>
<li>按任意一个音量键都可以开拍；</li>
</ol>
<h3>拍摄「日落剪影」的窍门</h3>
<ol>
<li>让拍摄对象位于落日前；</li>
<li>轻点并按住锁定对焦；</li>
<li>下滑降低曝光量；</li>
<li>开拍</li>
</ol>
<h3>抓拍「亲密瞬间」的窍门</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075435.png" alt="亲密瞬间"></p>
<ol>
<li>将锁定屏幕向左轻扫快速打开相机；</li>
<li>悄悄地将你的手机调成静音；</li>
<li>轻点并按住 1x，再滑动变焦；</li>
<li>轻点对焦并滑动调整曝光量；</li>
<li>开拍；</li>
</ol>
<blockquote>
<p>key：构图、变焦、对焦、曝光量、</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/06/Node.js_uuid 模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/06/Node.js_uuid 模块/" class="post-title-link" itemprop="url">Node.js_uuid 模块</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-06 22:49:00" itemprop="dateCreated datePublished" datetime="2018-12-06T22:49:00+08:00">2018-12-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">2.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>UUID 定义</h1>
<p>UUID 是由一组 32 位的 16 进制数所构成，是故 UUID 理论上的总数为 16^32=2^128，约等于 3.4 x 10^38。也就是说若每<a href="https://www.wikiwand.com/zh-hans/%E7%BA%B3%E7%A7%92" target="_blank" rel="noopener">纳秒</a>产生 1 <a href="https://www.wikiwand.com/zh-hans/%E5%85%86" target="_blank" rel="noopener">兆</a>个 UUID，要花 100 亿年才会将所有 UUID 用完。</p>
<p>UUID 示例：74760410-f963-11e8-b2a3-1bb26e1e5b69</p>
<p>&lt;!-- more --&gt;</p>
<h1>UUID 版本</h1>
<ul>
<li>&quot;版本 1&quot; UUID 是根据时间和节点 ID（通常是 MAC 地址）生成；</li>
<li>&quot;版本 2&quot; UUID 是根据标识符（通常是组或用户 ID）、时间和节点 ID 生成；</li>
<li>&quot;版本 3&quot; 和 &quot;版本 5&quot; 确定性 UUID 通过散列 (hashing) 命名空间 (namespace) 标识符和名称生成；</li>
<li>&quot;版本 4&quot; UUID 使用<a href="https://www.wikiwand.com/zh-hans/%E9%9A%8F%E6%9C%BA%E6%80%A7" target="_blank" rel="noopener">随机性</a>或<a href="https://www.wikiwand.com/zh-hans/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%80%A7" target="_blank" rel="noopener">伪随机性</a>生成。</li>
</ul>
<h1>Node.js <a href="https://github.com/kelektiv/node-uuid" target="_blank" rel="noopener">uuid</a> 模块示例</h1>
<p>在 JavaScript 中生成符合 RFC 规范的 UUID。</p>
<h2>版本 1：基于时间的 UUID</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv1 = <span class="built_in">require</span>(<span class="string">'uuid/v1'</span>);</span><br><span class="line">uuidv1() <span class="comment">//  ⇨ 43d7e120-f963-11e8-999e-51f3e5aa256f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> formatedUUID = uuidv1().replace(<span class="regexp">/-/g</span>, <span class="string">''</span>); <span class="comment">// 去除横线-</span></span><br></pre></td></tr></table></figure></p>
<h2>版本 2：DCE 安全的 UUID</h2>
<p>未实现。</p>
<h2>版本 3：基于名字空间的 UUID（MD5）</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv3 = <span class="built_in">require</span>(<span class="string">'uuid/v3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined DNS namespace (for domain names)</span></span><br><span class="line">uuidv3(<span class="string">'hello.example.com'</span>, uuidv3.DNS); <span class="comment">// ⇨ '9125a8dc-52ee-365b-a5aa-81b0b3681cf6'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined URL namespace (for, well, URLs)</span></span><br><span class="line">uuidv3(<span class="string">'http://example.com/hello'</span>, uuidv3.URL); <span class="comment">// ⇨ 'c6235813-3ba4-3801-ae84-e0a6ebb7d138'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using a custom namespace</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: Custom namespaces should be a UUID string specific to your application!</span></span><br><span class="line"><span class="comment">// E.g. the one here was generated using this modules `uuid` CLI.</span></span><br><span class="line"><span class="keyword">const</span> MY_NAMESPACE = <span class="string">'1b671a64-40d5-491e-99b0-da01ff1f3341'</span>;</span><br><span class="line">uuidv3(<span class="string">'Hello, World!'</span>, MY_NAMESPACE); <span class="comment">// ⇨ 'e8b5a51d-11c8-3310-a6ab-367563f20686'</span></span><br></pre></td></tr></table></figure></p>
<h2>版本 4：基于随机数的 UUID</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv4 = <span class="built_in">require</span>(<span class="string">'uuid/v4'</span>);</span><br><span class="line">uuidv4(); <span class="comment">// ⇨ 57751a52-db27-4b2f-8a08-7e02f9e94a42</span></span><br></pre></td></tr></table></figure></p>
<h2>版本 5：基于名字空间的 UUID（SHA1）</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uuidv5 = <span class="built_in">require</span>(<span class="string">'uuid/v5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined DNS namespace (for domain names)</span></span><br><span class="line">uuidv5(<span class="string">'hello.example.com'</span>, uuidv5.DNS); <span class="comment">// ⇨ 'fdda765f-fc57-5604-a269-52a7df8164ec'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using predefined URL namespace (for, well, URLs)</span></span><br><span class="line">uuidv5(<span class="string">'http://example.com/hello'</span>, uuidv5.URL); <span class="comment">// ⇨ '3bbcee75-cecc-5b56-8031-b6641c1ed1f1'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... using a custom namespace</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note: Custom namespaces should be a UUID string specific to your application!</span></span><br><span class="line"><span class="comment">// E.g. the one here was generated using this modules `uuid` CLI.</span></span><br><span class="line"><span class="keyword">const</span> MY_NAMESPACE = <span class="string">'1b671a64-40d5-491e-99b0-da01ff1f3341'</span>;</span><br><span class="line">uuidv5(<span class="string">'Hello, World!'</span>, MY_NAMESPACE); <span class="comment">// ⇨ '630eb68f-e0fa-5ecc-887a-7c7a62614681'</span></span><br></pre></td></tr></table></figure></p>
<h1>参考</h1>
<ul>
<li><a href="https://www.jianshu.com/p/d77f3ef0868a" target="_blank" rel="noopener">关于 UUID 的二三事</a></li>
<li><a href="https://www.wikiwand.com/zh-hans/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81" target="_blank" rel="noopener">wikiwand: 通用唯一识别码</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/06/Node.js_crypto 模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/06/Node.js_crypto 模块/" class="post-title-link" itemprop="url">Node.js_crypto 模块</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-06 11:04:00" itemprop="dateCreated datePublished" datetime="2018-12-06T11:04:00+08:00">2018-12-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-13 10:26:31" itemprop="dateModified" datetime="2019-05-13T10:26:31+08:00">2019-05-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">8.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">8 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2>Hash 算法</h2>
<p>查看 crypto 模块支持的 hash 函数：<code>crypto.getHashes()</code></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">'RSA-MD4'</span>,</span><br><span class="line">  <span class="string">'RSA-MD5'</span>,</span><br><span class="line">  <span class="string">'RSA-MDC2'</span>,</span><br><span class="line">  <span class="string">'RSA-RIPEMD160'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA1'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA1-2'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA224'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA256'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA384'</span>,</span><br><span class="line">  <span class="string">'RSA-SHA512'</span>,</span><br><span class="line">  <span class="string">'blake2b512'</span>,</span><br><span class="line">  <span class="string">'blake2s256'</span>,</span><br><span class="line">  <span class="string">'md4'</span>,</span><br><span class="line">  <span class="string">'md4WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'md5'</span>,</span><br><span class="line">  <span class="string">'md5-sha1'</span>,</span><br><span class="line">  <span class="string">'md5WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'mdc2'</span>,</span><br><span class="line">  <span class="string">'mdc2WithRSA'</span>,</span><br><span class="line">  <span class="string">'ripemd'</span>,</span><br><span class="line">  <span class="string">'ripemd160'</span>,</span><br><span class="line">  <span class="string">'ripemd160WithRSA'</span>,</span><br><span class="line">  <span class="string">'rmd160'</span>,</span><br><span class="line">  <span class="string">'sha1'</span>,</span><br><span class="line">  <span class="string">'sha1WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'sha224'</span>,</span><br><span class="line">  <span class="string">'sha224WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'sha256'</span>,</span><br><span class="line">  <span class="string">'sha256WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'sha384'</span>,</span><br><span class="line">  <span class="string">'sha384WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'sha512'</span>,</span><br><span class="line">  <span class="string">'sha512WithRSAEncryption'</span>,</span><br><span class="line">  <span class="string">'ssl3-md5'</span>,</span><br><span class="line">  <span class="string">'ssl3-sha1'</span>,</span><br><span class="line">  <span class="string">'whirlpool'</span> ]</span><br></pre></td></tr></table></figure></p>
<p>&lt;!-- more --&gt;</p>
<h3>SHA-256</h3>
<p>示例：使用 <code>hash.update()</code> 和 <code>hash.digest()</code>：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> hash = crypto.createHash(<span class="string">'sha256'</span>); <span class="comment">// 创建哈希函数 sha256</span></span><br><span class="line"></span><br><span class="line">hash.update(<span class="string">'some data to hash'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(hash.digest(<span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// 6a2da20943931e9834fc12cfe5bb47bbd9ae43489a30726962b576f4e3993e50</span></span><br></pre></td></tr></table></figure></p>
<h3>PBKDF2</h3>
<p>PBKDF2 是 Node.js 的 <strong>crypto</strong> 模块原生支持的标准方法。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pbkdf2_encrypt</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// crypto.randomBytes(）方法生成 32 字节的随机数 - 这里作为盐值</span></span><br><span class="line">  crypto.randomBytes(<span class="number">32</span>, (err, salt) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数列表：（密码，盐值，迭代次数，密钥长度，摘要函数）</span></span><br><span class="line">    crypto.pbkdf2(password, salt, <span class="number">4096</span>, <span class="number">512</span>, <span class="string">'sha256'</span>, (err, key) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      <span class="comment">// 将用户名、密码哈希值和盐值存入数据库</span></span><br><span class="line">      <span class="built_in">console</span>.log(username, key.toString(<span class="string">'hex'</span>), salt.toString(<span class="string">'hex'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pbkdf2_encrypt(<span class="string">'zhangSan'</span>, <span class="string">'123456'</span>);</span><br></pre></td></tr></table></figure></p>
<p>同步函数示例：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> salt = crypto.randomBytes(<span class="number">32</span>);</span><br><span class="line"><span class="keyword">const</span> result = crypto.pbkdf2Sync(password, salt, <span class="number">4096</span>, <span class="number">512</span>, <span class="string">'sha256'</span>);</span><br></pre></td></tr></table></figure></p>
<h2>Hmac 算法</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> key = <span class="string">'BDvDYUmfdykkBLgX'</span>;</span><br><span class="line"><span class="keyword">const</span> hmac = crypto.createHmac(<span class="string">'sha1'</span>, key.toString(<span class="string">'ascii'</span>));</span><br><span class="line"></span><br><span class="line">hmac.update(<span class="string">'data to crypt'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(hmac.digest(<span class="string">'hex'</span>)); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// a43bfb9f12b6f69ad9fcd4338a981efbed2569ae</span></span><br></pre></td></tr></table></figure></p>
<h2>加盐（salt）</h2>
<blockquote>
<p>盐值就是随机数值，用于在计算密码的哈希值时加强数据的安全性，可以有效抵御诸如字典攻击、彩虹表攻击等密码攻击媒介。</p>
</blockquote>
<p>常见的 Hash 算法使用示例：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = crypto.createHash(<span class="string">'md5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> password = <span class="string">'123456'</span>;</span><br><span class="line"><span class="comment">// 直接对密码原文进行 Hash</span></span><br><span class="line">md5.update(password);</span><br><span class="line"><span class="built_in">console</span>.log(md5.digest(<span class="string">'hex'</span>)); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// e10adc3949ba59abbe56e057f20f883e</span></span><br><span class="line"><span class="comment">// 可以通过 &lt;https://www.cmd5.com/&gt; 反向查询得到密码，不够安全。</span></span><br></pre></td></tr></table></figure></p>
<p>加“盐”的 Hash 算法：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = crypto.createHash(<span class="string">'md5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> password = <span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">let</span> salt = <span class="string">'hhug6dcKyCNBQ5sUC0i6hja5dCTqdSzV'</span>; <span class="comment">// 盐值</span></span><br><span class="line"><span class="comment">// 将密码拼接上任意长度的随机字符串后，再进行 Hash</span></span><br><span class="line">md5.update(password+salt);</span><br><span class="line"><span class="built_in">console</span>.log(md5.digest(<span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// b2d23b0443c319e574f1ea3f8bddc6e0</span></span><br></pre></td></tr></table></figure></p>
<p><code>crypto.randomBytes()</code> 方法可以生成随机数，用于作为密钥或者盐值：
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// crypto.randomBytes() 生成强加密的伪随机数</span></span><br><span class="line">crypto.randomBytes(<span class="number">16</span>, (err, buf) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;buf.length&#125;</span> bytes of random data: <span class="subst">$&#123;buf.toString(<span class="string">'hex'</span>)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印</span></span><br><span class="line"><span class="comment">// 16 bytes of random data: 411fd0a79188f2fde58a91ea0302f148</span></span><br></pre></td></tr></table></figure></p>
<p>使用 Node <strong>crypto</strong> 模块为哈希函数生成随机的盐值：
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 异步方法</span></span><br><span class="line">crypto.randomBytes(<span class="number">32</span>, (err, salt) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录盐值可读的字符串版本</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'salt: '</span> + salt.toString(<span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续步骤：使用盐值</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 同步方法</span></span><br><span class="line"><span class="keyword">const</span> buf = crypto.randomBytes(<span class="number">256</span>);</span><br></pre></td></tr></table></figure></p>
<h2>加密（Cipher）和解密（Decipher）算法</h2>
<h3>对称加密算法</h3>
<p>查看 Openssl 对称加密算法列表：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl list -cipher-algorithms</span><br><span class="line">$ openssl list-cipher-algorithms <span class="comment"># 旧版本命令</span></span><br></pre></td></tr></table></figure></p>
<h4>AES-256-GCM 示例1:</h4>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化参数</span></span><br><span class="line"><span class="keyword">const</span> text = <span class="string">'Encryption Testing AES GCM mode'</span>; <span class="comment">// 要加密和解密的数据</span></span><br><span class="line"><span class="keyword">const</span> key = crypto.randomBytes(<span class="number">32</span>); <span class="comment">// 256 位的共享密钥</span></span><br><span class="line"><span class="keyword">const</span> iv = crypto.randomBytes(<span class="number">16</span>); <span class="comment">// 初始向量，16 字节</span></span><br><span class="line"><span class="keyword">const</span> algorithm = <span class="string">'aes-256-gcm'</span>; <span class="comment">// 加密算法和操作模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密</span></span><br><span class="line"><span class="keyword">const</span> cipher = crypto.createCipheriv(algorithm, key, iv); <span class="comment">// 初始化加密算法</span></span><br><span class="line"><span class="keyword">let</span> encrypted = cipher.update(text, <span class="string">'utf8'</span>, <span class="string">'hex'</span>);</span><br><span class="line">encrypted += cipher.final(<span class="string">'hex'</span>);</span><br><span class="line"><span class="keyword">const</span> tag = cipher.getAuthTag(); <span class="comment">// 生成标签，用于验证密文的来源</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解密</span></span><br><span class="line"><span class="keyword">const</span> decipher = crypto.createDecipheriv(algorithm, key, iv); <span class="comment">// 初始化解密算法</span></span><br><span class="line">decipher.setAuthTag(tag); <span class="comment">// 传入验证标签，验证密文的来源</span></span><br><span class="line"><span class="keyword">let</span> decrypted = decipher.update(encrypted, <span class="string">'hex'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">decrypted += decipher.final(<span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(decrypted); <span class="comment">// Encryption Testing AES GCM mode</span></span><br></pre></td></tr></table></figure></p>
<h4>AES-256-GCM 示例2:</h4>
<ul>
<li><a href="https://gist.github.com/rjz/15baffeab434b8125ca4d783f4116d81" target="_blank" rel="noopener">Github - crypto-aes-256-gem-demo.js</a></li>
<li><a href="https://github.com/matt-wu/AES" target="_blank" rel="noopener">GitHub: AES 简介</a></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aes256gcm = <span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ALGO = <span class="string">'aes-256-gcm'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// encrypt returns base64-encoded ciphertext</span></span><br><span class="line">  <span class="keyword">const</span> encrypt = <span class="function"><span class="params">str</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Hint: the 'iv' should be unique (but not necessarily random).</span></span><br><span class="line">    <span class="comment">// 'randomBytes' here are (relatively) slow but convenient for demonstration</span></span><br><span class="line">    <span class="keyword">const</span> iv = <span class="keyword">new</span> Buffer.from(crypto.randomBytes(<span class="number">16</span>), <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="keyword">const</span> cipher = crypto.createCipheriv(ALGO, key, iv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hint: Larger inputs (it's GCM, after all!) should use the stream API</span></span><br><span class="line">    <span class="keyword">let</span> enc = cipher.update(str, <span class="string">'utf8'</span>, <span class="string">'base64'</span>);</span><br><span class="line">    enc += cipher.final(<span class="string">'base64'</span>);</span><br><span class="line">    <span class="keyword">return</span> [ enc, iv, cipher.getAuthTag() ];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// decrypt decodes base64-encoded ciphertext into a utf8-encoded string</span></span><br><span class="line">  <span class="keyword">const</span> decrpt = <span class="function">(<span class="params">enc, iv, authTag</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decipher = crypto.createDecipheriv(ALGO, key, iv);</span><br><span class="line">    decipher.setAuthTag(authTag);</span><br><span class="line">    <span class="keyword">let</span> str = decipher.update(enc, <span class="string">'base64'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">    str += decipher.final(<span class="string">'utf8'</span>);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; encrypt, decrpt &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密密钥</span></span><br><span class="line"><span class="comment">// Note: a key size of 16 bytes will use AES-128, 24 =&gt; AES-192, 32 =&gt; AES-256</span></span><br><span class="line"><span class="keyword">const</span> KEY = <span class="keyword">new</span> Buffer.from(crypto.randomBytes(<span class="number">32</span>), <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aesCipher = aes256gcm(KEY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密</span></span><br><span class="line"><span class="keyword">const</span> [ encrypted, iv, authTag ] = aesCipher.encrypt(<span class="string">'hello world'</span>);</span><br><span class="line"><span class="comment">// 解密</span></span><br><span class="line"><span class="keyword">const</span> decrypted = aesCipher.decrpt(encrypted, iv, authTag);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(decrypted); <span class="comment">// hello world</span></span><br></pre></td></tr></table></figure></p>
<h3>非对称加密算法的使用，1. 公钥加密-私钥解密；2. 私钥加密-公钥解密。</h3>
<ul>
<li><code>crypto.publicEncrypt(key, buffer)</code></li>
<li><code>crypto.publicDecrypt(key, buffer)</code></li>
<li><code>crypto.privateEncrypt(privateKey, buffer)</code></li>
<li><code>crypto.privateDecrypt(privateKey, buffer)</code></li>
</ul>
<h4>使用 RSA 2048 进行公钥加密，私钥解密</h4>
<p>使用 OpenSSL 生成 2048位 RSA 密钥：</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.生成 2048位 RSA 私钥</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl genrsa -out rsa_private_key.pem 2048</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 通过私钥生成公钥</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl rsa -<span class="keyword">in</span> rsa_private_key.pem -pubout -out rsa_public_key.pem</span></span><br></pre></td></tr></table></figure></p>
<p>使用公钥加密数据，再使用私钥解密数据：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> root = __dirname;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> publicKey = fs.readFileSync(path.join(root, <span class="string">'./rsa_public_key.pem'</span>)).toString(<span class="string">'ascii'</span>);</span><br><span class="line"><span class="keyword">const</span> privateKey = fs.readFileSync(path.join(root, <span class="string">'./rsa_private_key.pem'</span>)).toString(<span class="string">'ascii'</span>);</span><br><span class="line"><span class="keyword">const</span> data = <span class="string">'data to crypt'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 公钥加密</span></span><br><span class="line"><span class="keyword">const</span> encryptData = crypto.publicEncrypt(publicKey, Buffer.from(data)).toString(<span class="string">'base64'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'encode'</span>, encryptData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 私钥解密</span></span><br><span class="line"><span class="keyword">const</span> decryptData = crypto.privateDecrypt(privateKey, Buffer.from(encryptData.toString(<span class="string">'base64'</span>), <span class="string">'base64'</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'decode'</span>, decryptData.toString());</span><br></pre></td></tr></table></figure></p>
<h2>签名（Sign）和验证（Verify）算法</h2>
<p>签名算法示例：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> root = __dirname;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载私钥文件</span></span><br><span class="line"><span class="keyword">const</span> pem = fs.readFileSync(path.join(root, <span class="string">'./rsa_private_key.pem'</span>));</span><br><span class="line"><span class="keyword">const</span> key = pem.toString(<span class="string">'ascii'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sign = crypto.createSign(<span class="string">'RSA-SHA256'</span>); <span class="comment">// 创建签名算法</span></span><br><span class="line">sign.update(<span class="string">'data to sign'</span>); <span class="comment">// 更新待签名内容</span></span><br><span class="line"><span class="keyword">const</span> result = sign.sign(key, <span class="string">'hex'</span>); <span class="comment">// 生成并返回签名</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'result:'</span>, result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印</span></span><br><span class="line"><span class="comment">// 3a26e0c3ec5ad1f517aad27f0f3a48cc0db156c2221800e4c2f995220f62a9077b4507a72ac6b0f1f50ee72386191d5ada4013945ff2afdb1ea6aa4e8d51a94f186089a67c2d6f4236150d59a1db134286fd7ba8deab0fc28f97eba7ad35820113f24dc6e30c6d11f0773527c4d81582c2b42016c9f972b5f4809e6d1f9115c2fb6db3168c68af3cfca986a458e3ea1c15606e7d33ee0bf5400ca460cf5371a51e800abe7ac943f16d9546239949bf7eec77488212d815b6a013e68fc2f456c4f2eb9d38c551e3f94168b076c3f761341afa3b724d8e73f486aacbace5a09412ef16c9b88182fcaeaaf97d96fdb402832530708a915d34c42131d7a26e4f04d4</span></span><br></pre></td></tr></table></figure></p>
<p>验证算法示例：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> root = __dirname;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载公钥文件</span></span><br><span class="line"><span class="keyword">const</span> publicKey = fs.readFileSync(path.join(root, <span class="string">'./rsa_public_key.pem'</span>)).toString(<span class="string">'ascii'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> verify = crypto.createVerify(<span class="string">'RSA-SHA256'</span>); <span class="comment">// 创建验证算法</span></span><br><span class="line">verify.update(<span class="string">'data to sign'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(verify.verify(publicKey, result, <span class="string">'hex'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印</span></span><br><span class="line"><span class="comment">// true</span></span><br></pre></td></tr></table></figure></p>
<h2>参考</h2>
<ul>
<li>
<p><a href="https://itbilu.com/nodejs/core/4koGTGNY.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 Hash 类计算数据的哈希值</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/VJKNIOVF.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 Hmac 类计算哈希密钥</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/EJOj6hBY.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 Cipher 类加密数据</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/4ySMqlUF.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 Decipher 类解密数据</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/NkQOETLK.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 Sign 类生成数字签名并使用 Verify 类验证数字签名</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/EknZWVKt.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 DiffieHellman 类生成交换密钥</a></p>
</li>
<li>
<p><a href="https://itbilu.com/nodejs/core/41iXzVot.html" target="_blank" rel="noopener">Node.js 的加密模块 crypto 之使用 ECDH 类生成 EC Diffie-Hellman 交换密钥</a></p>
</li>
<li>
<p><a href="https://github.com/iddatasecuritybook" target="_blank" rel="noopener">Identity and Data Security for Web DevelopmentReport abuse</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/qq_39791705/article/details/79567410" target="_blank" rel="noopener">Node.js 使用 RSA 加密 / 解密</a></p>
</li>
</ul>
<h3>相关第三方库</h3>
<ul>
<li><a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="noopener">bcrypt</a>——密码哈希函数</li>
<li><a href="https://www.npmjs.com/package/bcryptjs" target="_blank" rel="noopener">bcrypt.js</a></li>
<li><a href="https://www.npmjs.com/package/node-rsa" target="_blank" rel="noopener">node-rsa</a></li>
<li><a href="https://www.npmjs.com/package/node-forge" target="_blank" rel="noopener">node-forge</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/05/全球网络身份管理的现状与发展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/05/全球网络身份管理的现状与发展/" class="post-title-link" itemprop="url">全球网络身份管理的现状与发展</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-05 10:52:00" itemprop="dateCreated datePublished" datetime="2018-12-05T10:52:00+08:00">2018-12-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 20:44:48" itemprop="dateModified" datetime="2019-05-01T20:44:48+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI-密码学/" itemprop="url" rel="index"><span itemprop="name">PKI&密码学</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">997</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>书名：《全球网络身份管理的现状与发展》</p>
</blockquote>
<blockquote>
<p>提及网络身份管理，我们很容易将之等效于“网络实名制”。</p>
<p><strong>网络实名制</strong>是一种政策，是政府部门对网络管理所采取的一种模式，是将网络虚拟身份与社会物理身份相对应的一种要求；</p>
<p><strong>网络身份管理</strong>则是对网络身份唯一性判定、真实性鉴别的一种能力要求。</p>
<p>网络身份管理在对网络用户管理时，可以采用基于公民网络电子身份标识（eID）的管理模式来支持网络实名制的管理要求。同时，网络身份管理所面对的还可以是网络设备、企事业法人、官方代表等具有特定网络身份的角色。</p>
<p>因此，网络身份管理与网络实名制之间虽有些相通之处，但更多的是区别。</p>
</blockquote>
<h1>一、网络身份管理综述</h1>
<h3>网络身份管理的范围</h3>
<ol>
<li>网络身份的<strong>产生</strong>——用户如何获取自己的网络身份？</li>
<li>网络身份的<strong>保护</strong>——如何防止网络身份被盗用或冒用？密码口令、生物识别技术、数字证书、安全的网络协议。</li>
<li>网络身份的<strong>使用</strong>——网络身份验证。</li>
<li>网络身份的<strong>维护</strong>——网络身份生命周期的管理。</li>
</ol>
<p>&lt;!-- more --&gt;</p>
<h3>网络身份管理的参与方</h3>
<ul>
<li>个体；</li>
<li>身份服务提供方/身份提供商；</li>
<li>身份标识及载体；</li>
<li>依赖方；</li>
<li>属性服务提供方；</li>
</ul>
<h3>网络身份管理需求</h3>
<h4>一、个人/企业</h4>
<ol>
<li>便利；</li>
<li>安全；</li>
<li>隐私；</li>
</ol>
<h4>二、互联网服务提供方</h4>
<ol>
<li>确认用户身份的真实性和有效性。</li>
<li>身份管理方案的经济性。</li>
</ol>
<h4>三、政府</h4>
<ol>
<li>维护国家安全和社会安全，有效遏制网络欺诈、身份盗窃和在线信息滥用的增长，防止由此造成的个人或组织的财产、名誉等各类损失。</li>
<li>推动个人和组织使用权威、高效、易用和互操作性的身份管理解决方案安全访问在线服务。</li>
<li>保护公民隐私，防止公民身份信息被非法获取，防范大规模网络身份信息的泄漏。</li>
</ol>
<h3>网络身份管理与网络实名制的区别</h3>
<ol>
<li>身份信息的采集、传输、存储和使用必须严格受控。</li>
<li>并不是所有的网络活动都需要实名。</li>
<li>网络身份管理的关键作用是<strong>建立网络上各参与方之间的信任关系</strong>。</li>
</ol>
<p>网络实名制的初衷：防止匿名情况下的网络犯罪。</p>
<p>网络实名制存在的问题：压缩公民诉求表达的渠道、个人隐私泄露。</p>
<h3>网络身份管理的关键作用</h3>
<ol>
<li>保障网络空间安全。</li>
<li>保护个人财产安全与隐私。</li>
<li>提高社会管理和服务效率。</li>
</ol>
<h3>身份认证的概念的方式</h3>
<p>网络身份认证的主要方式：</p>
<ol>
<li>用户名/密码组合认证；</li>
<li>动态口令认证；</li>
<li>智能卡认证；</li>
<li>短信密码认证；</li>
<li>智能密码钥匙（USBKey）认证；</li>
<li>基于生物特性认证；</li>
</ol>
<blockquote>
<p>未完待续...</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/12/04/密码学—密码算法与协议/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/04/密码学—密码算法与协议/" class="post-title-link" itemprop="url">密码学—密码算法与协议</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-04 15:42:00" itemprop="dateCreated datePublished" datetime="2018-12-04T15:42:00+08:00">2018-12-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-18 15:13:48" itemprop="dateModified" datetime="2019-05-18T15:13:48+08:00">2019-05-18</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PKI-密码学/" itemprop="url" rel="index"><span itemprop="name">PKI&密码学</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">22k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">20 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2>密码学思维导图</h2>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075910.png" alt="密码学"></p>
<p>&lt;!-- more --&gt;</p>
<h3>密码学基本认知</h3>
<ol>
<li>密码学是科学；</li>
<li>密码学理论是公开的；</li>
<li>密码学算法是相对安全的；</li>
<li>密码学攻击方法是多样的；</li>
<li>密码学应用标准很重要；</li>
<li>不具备很强的数学知识也能掌握密码学；</li>
<li>解决特点问题的密码学；</li>
</ol>
<h3>密码学的四个目标</h3>
<ol>
<li>机密性（隐私性）；</li>
<li>完整性；</li>
<li>身份验证；</li>
<li>不可抵赖性；</li>
</ol>
<h2>Hash 算法</h2>
<p><strong>摘要算法/散列函数/哈希函数/杂凑函数</strong>：把任意长的输入消息数据转化成固定长度的输出数据的一种密码算法。</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>算法</th>
<th>输出值长度</th>
<th>输入值最大长度</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>MD5</td>
<td>MD5</td>
<td>128 比特</td>
<td>无限制</td>
<td>实践中已经产生了碰撞，理论上不具备弱抗碰撞性</td>
</tr>
<tr>
<td>SHA-1</td>
<td>SHA-1</td>
<td>160 比特</td>
<td>2^64^ -1 比特</td>
<td>实践中已经产生了碰撞</td>
</tr>
<tr>
<td>SHA-2</td>
<td>SHA-256</td>
<td>256 比特</td>
<td>2^64^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA-512</td>
<td>512 比特</td>
<td>2^128^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA-224</td>
<td>224 比特</td>
<td>2^64^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA-384</td>
<td>384 比特</td>
<td>2^128^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td>SHA-3</td>
<td>SHA3-256</td>
<td>256 比特</td>
<td>2^64^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA3-512</td>
<td>512 比特</td>
<td>2^128^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA3-224</td>
<td>224 比特</td>
<td>2^64^ -1 比特</td>
<td>安全使用</td>
</tr>
<tr>
<td></td>
<td>SHA3-384</td>
<td>384 比特</td>
<td>2^128^ -1 比特</td>
<td>安全使用</td>
</tr>
</tbody>
</table>
<h3>Hash 算法实践</h3>
<p>OpenSSL 实现了 5 种 Hash/信息摘要 算法，分别是 MD2、MD5、MDC2、SHA（SHA1）和 RIPEMD。SHA 算法事实上包括了 SHA 和 SHA1 两种信息摘要算法，此外，OpenSSL 还实现了 DSS 标准中规定的两种信息摘要算法 DSS 和DSS1。</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file.txt 文件内容为：hello world</span></span><br><span class="line"><span class="comment"># 用 SHA-1 算法计算文件 file.txt 的 Hash 值，输出到 stdout</span></span><br><span class="line">$ openssl dgst -sha1 file.txt</span><br><span class="line">SHA1(file.txt)= 22596363b3de40b06f981fb85d82312e8c0ed511</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 SHA-1 算法计算文件 file.txt 的 Hash 值，输出到 digest.txt</span></span><br><span class="line">$ openssl sha1 -out digest.txt file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 DSS1(SHA1) 算法为文件 file.txt 签名,输出到文件 dsasign.bin</span></span><br><span class="line"><span class="comment"># 签名的 private key 必须为 DSA 算法产生的，保存在文件 dsakey.pem 中</span></span><br><span class="line">$ openssl dgst -dss1 -sign dsakey.pem -out dsasign.bin file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 DSS1 算法验证 file.txt 的数字签名 dsasign.bin，</span></span><br><span class="line"><span class="comment"># 验证的 private key 为 DSA 算法产生的文件 dsakey.pem</span></span><br><span class="line">$ openssl dgst -dss1 -prverify dsakey.pem -signature dsasign.bin file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 SHA-1 算法为文件 file.txt 签名，输出到文件 rsasign.bin</span></span><br><span class="line"><span class="comment"># 签名的 private key 为 RSA 算法产生的文件 rsaprivate.pem</span></span><br><span class="line">$ openssl sha1 -sign rsaprivate.pem -out rsasign.bin file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 SHA-1 算法验证 file.txt 的数字签名 rsasign.bin，</span></span><br><span class="line"><span class="comment"># 验证的 public key 为 RSA 算法生成的 rsapublic.pem</span></span><br><span class="line">$ openssl sha1 -verify rsapublic.pem -signature rsasign.bin file.txt</span><br></pre></td></tr></table></figure></p>
<h2>对称加密算法</h2>
<p><strong>对称加密算法/密码密钥算法/单密钥算法</strong>：加密和解密使用同一密钥或加密和解密的密钥之间存在简单的、容易计算的互推关系。</p>
<ul>
<li>流密码算法又称序列密码算法，每次加密或解密一位或一字节的明文或密文。</li>
<li>分组密码算法将明文（密文）分成固定长度的数据块（比特块或字节块），用同一密钥和算法对每一明文（密文）块加密（解密）后得到等长的密文（明文）块，然后将密文（文）块按照顺序组合起来最终得到密文（明文）。</li>
</ul>
<h3>流密码算法</h3>
<table>
<thead>
<tr>
<th>算法</th>
<th>密钥长度</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>RC4</td>
<td>可变密钥长度，建议 2048 比特</td>
<td>目前已被证明不安全</td>
</tr>
<tr>
<td>ChaCha</td>
<td>可变密钥长度，建议 256 比特</td>
<td>一种新型的流密码算法</td>
</tr>
</tbody>
</table>
<h3>块密码算法</h3>
<table>
<thead>
<tr>
<th>算法</th>
<th>密钥长度</th>
<th>分组长度</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AES</td>
<td>128、192、256 比特</td>
<td>128 比特</td>
<td>对称加密算法的标准算法</td>
</tr>
<tr>
<td>DES</td>
<td>56 比特</td>
<td>64 比特</td>
<td>早期对称加密算法标准</td>
</tr>
<tr>
<td>3DES</td>
<td>128 比特或 168 比特</td>
<td>64 比特</td>
<td>三重 DES 算法</td>
</tr>
<tr>
<td>Blowfish</td>
<td>可变密钥长度，32～448 比特之间</td>
<td>64 比特</td>
<td>不推荐使用</td>
</tr>
<tr>
<td>Rijndael</td>
<td>128、192、256 比特</td>
<td>128、192、256 比特</td>
<td>AES 算法的原生算法</td>
</tr>
<tr>
<td>Camellia</td>
<td>128、192、256 比特</td>
<td>128 比特</td>
<td>不太常见的加密算法</td>
</tr>
<tr>
<td>IDEA 算法</td>
<td>128、192、256 比特</td>
<td>128 比特</td>
<td>不太常见的加密算法</td>
</tr>
<tr>
<td>SEED 算法</td>
<td>128、192、256 比特</td>
<td>128 比特</td>
<td>不太常见的加密算法</td>
</tr>
</tbody>
</table>
<p>如果你对 AES 算法很感兴趣，可以参考这篇文章：<a href="https://github.com/matt-wu/AES" target="_blank" rel="noopener">AES 简介</a></p>
<h4>分组密码的工作模式/迭代模式/分组模式</h4>
<p>对称加密算法中，分组密码都有固定的分组长度，实际应用中需要加密的明文远远长于这个分组长度。如何对明文进行分组、填充？分组后的明文组和密文组之间有没有关系？这些要素形成了分组密码的不同工作模式。</p>
<table>
<thead>
<tr>
<th>模式</th>
<th>名称</th>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ECB</td>
<td>Electronic Codebook，电子密码本模式</td>
<td>运算快速，支持并行处理，需要填充，不适用于长报文、高度结构化报文</td>
<td>不推荐使用</td>
</tr>
<tr>
<td>CBC</td>
<td>Ciper Block Chaining，密文块链接模式</td>
<td>支持并行处理，需要填充</td>
<td>⭐️ 推荐使用</td>
</tr>
<tr>
<td>CFB</td>
<td>Ciper Feedback，密文反馈模式</td>
<td>分组密码转换为流密码，支持并行处理，不需要填充，</td>
<td>不推荐使用</td>
</tr>
<tr>
<td>OFB</td>
<td>Output Feedback，输出反馈模式</td>
<td>迭代运算使用流密码模式，不需要填充，缺点：难以检测对密文的篡改。</td>
<td>不推荐使用</td>
</tr>
<tr>
<td>CTR</td>
<td>Count，计数器模式</td>
<td>迭代运算使用流密码模式，支持并行处理，不需要填充</td>
<td>⭐️ 推荐使用</td>
</tr>
<tr>
<td>XTS</td>
<td>XEX-based tweaked-codebook</td>
<td>不需要填充</td>
<td>用于本地硬盘存储解决方案中</td>
</tr>
</tbody>
</table>
<h4>分组加密的操作模式</h4>
<p>为要加密的数据分组提供保密或数据验证等功能。</p>
<table>
<thead>
<tr>
<th>分组加密的操作模式</th>
<th>描述</th>
<th>种类</th>
</tr>
</thead>
<tbody>
<tr>
<td>加密操作模式</td>
<td>只保护数据的私密性，无需验证数据来源</td>
<td>ECB、CBC、OFB、CFB、==CTR==</td>
</tr>
<tr>
<td>验证操作模式</td>
<td>不在乎数据的保密性，只想确保数据的发送来源</td>
<td>==CMAC==</td>
</tr>
<tr>
<td>验证加密操作模式</td>
<td>既想保密要传输的数据，还要确认数据的来源</td>
<td>CCM、==GCM==、KW/KWP/TKW</td>
</tr>
</tbody>
</table>
<p><div class="note info">
            <p>详细参考《Web开发的身份和数据安全》第 172～174 页。</p>
          </div></p>
<h4>分组密码的填充标准</h4>
<p>在分组对称加密算法中，明文长度必须是分组长度的倍数，如果不是倍数，必须有一种填充（padding）机制，填充冗余数据以保证明文长度是分组长度的倍数。</p>
<h5>PKCS#5 填充标准</h5>
<p>PKCS#5 处理的长度只能是 8 字节。</p>
<h5>PKCS#7 填充标准</h5>
<p>PKCS#7 处理的长度可以是 1 到 255 任意字节。</p>
<p>AES 算法中分组长度没有 8 字节，所以 <strong>AES 算法使用 PKCS#7 标准</strong>（在 OpenSSL 命令行中默认使用的填充标准即为 PKCS#7 标准）。</p>
<h3>对称加密算法实践</h3>
<p>OpenSSL一共提供了 8 种对称加密算法，其中 7 种是分组加密算法，仅有的一种流加密算法是 RC4。这 7 种分组加密算法分别是 AES、DES、Blowfish、CAST、IDEA、RC2、RC5，都支持电子密码本模式（ECB）、加密分组链接模式（CBC）、加密反馈模式（CFB）和输出反馈模式（OFB）四种常用的分组密码加密模式。其中，AES使用的加密反馈模式（CFB）和输出反馈模式（OFB）分组长度是 128 位，其它算法使用的则是 64 位。事实上，DES算法里面不仅仅是常用的 DES 算法，还支持三个密钥和两个密钥 3DES 算法。</p>
<p>在 OpenSSL 命令行中，对称加密算法主要使用 enc 子命令，后面的参数可以指定具体的加密算法。也可以直接使用对称加密算法对应的子命令来操作：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 采用 3des 算法</span></span><br><span class="line">$ openssl enc des3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 采用 3des 算法</span></span><br><span class="line">$ openssl des3</span><br></pre></td></tr></table></figure></p>
<p>显示系统支持的加密算法：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl list -cipher-algorithms</span><br></pre></td></tr></table></figure></p>
<p>使用 OpenSSL 执行加密操作：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 aes-256-cbc 算法对 file.txt 进行加密，输出到 file.enc 文件</span></span><br><span class="line"><span class="comment"># 密钥是通过口令（mypassword）和 Salt 生成的</span></span><br><span class="line">$ openssl enc -aes-256-cbc -salt -<span class="keyword">in</span> file.txt -out file.enc -pass pass:mypassword -p</span><br><span class="line">salt=4BAB66E493E8AA8E</span><br><span class="line">key=6C853931F7A6BCE75756F76A99D10F473C691CDECD05B2EB066FDDC5ED49A1B2</span><br><span class="line">iv =D26860583F714B4E4FF68F905D711E23</span><br></pre></td></tr></table></figure></p>
<p>参数：</p>
<ul>
<li>-in，从文件中读出明文内容。</li>
<li>-out，将加密内容保存到某个文件。</li>
<li>-aes-256-cbc，使用 AES 算法，密钥长度是 256 比特，分组模式是 CBC 模式。</li>
<li>-p，打印本次加密过程中的 salt、密钥、初始化向量的值。</li>
<li>另外，OpenSSL 默认使用 PKCS#7 填充标准。</li>
</ul>
<p>使用 OpenSSL 执行解密过程：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ openssl enc -d -aes-256-cbc -<span class="keyword">in</span> file.enc</span><br><span class="line">enter aes-256-cbc decryption password:mypassword</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure></p>
<h2>消息验证码（MAC）</h2>
<p>Hash 算法可以保证消息的完整性校验，对称加密算法保证消息的机密性，而<strong>消息验证码</strong>（Message Authentication Code，MAC）算法避免消息被篡改。</p>
<p>消息验证码一般结合加密算法一起使用，即 AE 加密模式。</p>
<table>
<thead>
<tr>
<th>MAC 算法</th>
<th>种类</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>CBC-MAC 算法</td>
<td>CBC-MAC</td>
<td>从块密码算法的 CBC 分组模式演变而来</td>
</tr>
<tr>
<td>HMAC 算法</td>
<td>HMAC-SHA-1、HMAC-SHA-256、HMAC-SHA-512</td>
<td>使用 Hash 算法作为加密基元</td>
</tr>
</tbody>
</table>
<h3>AE 加密模式</h3>
<p>对称加密算法保证消息的机密性，而 MAC 算法保证消息的完整性。结合这两个算法，提供机密性和完整性的模式也叫做 <strong>AE（Authenticated Encryption）加密模式</strong>。</p>
<ul>
<li>
<p><strong>AE 加密模式</strong>：需要使用者单独处理加密运算和 MAC 运算，一旦使用不当，就很容易出现安全问题。</p>
</li>
<li>
<p><strong>AEAD 加密模式</strong>：在底层组合了加密算法和 MAC 算法，能够同时保证数据机密性和完整性，减轻了使用者的负担。</p>
</li>
</ul>
<p>![](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/AE 加密模式.png)</p>
<h2>公开密钥算法</h2>
<p><strong>非对称算法/公钥算法</strong>：加密密钥（公钥）和解密密钥（私钥）不相同的密码算法。</p>
<h3>RSA 加密算法</h3>
<table>
<thead>
<tr>
<th>非对称加密算法</th>
<th>RSA 加密算法</th>
</tr>
</thead>
<tbody>
<tr>
<td>推荐密钥长度</td>
<td>2048 比特</td>
</tr>
<tr>
<td>推荐填充标准</td>
<td>RSAES-OAEP</td>
</tr>
<tr>
<td>用途</td>
<td>加密解密、密钥协商、数字签名</td>
</tr>
</tbody>
</table>
<h3>RSA 算法实践</h3>
<p>OpenSSL 一共实现了 4 种非对称加密算法，包括 DH 算法、RSA 算法、DSA 算法和椭圆曲线算法（ECC）。DH 算法一般用于密钥交换。RSA 算法既可以用于密钥交换，也可以用于数字签名，当然，如果你能够忍受其缓慢的速度，那么也可以用于数据加密。DSA 算法只用于数字签名。</p>
<h4>使用 genrsa 子命令生成密钥对，密钥对是一个文件</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------- 示例一 ----------------------------</span></span><br><span class="line"><span class="comment"># 使用 genrsa 命令生成密钥长度是 2048 比特的 RSA 密钥对</span></span><br><span class="line">$ openssl genrsa -out mykey.pem 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------- 示例二 ----------------------------</span></span><br><span class="line"><span class="comment"># 使用 genrsa 命令生成 2048 位的 RSA 密钥对，并使用 128 比特的 AES 算法保存密钥。</span></span><br><span class="line"><span class="comment"># **********************************************************</span></span><br><span class="line"><span class="comment"># 使用密码方式保护私钥只有在私钥并没有被放在生产环境服务器上的时候才有用。</span></span><br><span class="line"><span class="comment"># **********************************************************</span></span><br><span class="line">$ openssl genrsa -aes128 -out fd.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">....+++</span><br><span class="line">..........................+++</span><br><span class="line"><span class="comment"># e 表示公用指数，默认情况下会被设置为65 537。</span></span><br><span class="line"><span class="comment"># 这是所谓的短公用指数(short public exponent)，它可以显著提高 RSA 算法的验证性能。</span></span><br><span class="line">e is 65537 (0x10001) </span><br><span class="line">Enter pass phrase <span class="keyword">for</span> fd.key:mypassword <span class="comment"># 该口令用于生成 AES 算法的密钥</span></span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> fd.key:mypassword</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------- 示例三（生产环境不推荐 3DES 算法） ----------------------------</span></span><br><span class="line"><span class="comment"># 口令结合 3DES 算法保护密钥对</span></span><br><span class="line"><span class="comment"># 【说明】使用 genrsa 子命令生成 RSA 密钥对的时候，为了防止该密钥对被泄漏，</span></span><br><span class="line"><span class="comment">#        可以使用对称加密算法进行保护，而对称加密算法使用的密钥则是通过口令生成。</span></span><br><span class="line">$ openssl genrsa -des3 -out mykey2.pem 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.............+++</span><br><span class="line">..+++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> mykey2.pem:mypassword <span class="comment"># 该口令用于生成 3DES 算法的密钥</span></span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> mykey2.pem:mypassword</span><br></pre></td></tr></table></figure></p>
<h4>查看解析私钥</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment"># 查看以 PEM 格式存储的私钥</span></span><br><span class="line">$ cat mykey.pem</span><br><span class="line">-----BEGIN RSA PRIVATE KEY----- <span class="comment"># 第一行，表明它是一个私钥文件</span></span><br><span class="line">MIIEowIBAAKCAQEAsYkE9KZXZOQ7YI1maJBM6aVRqK8GICC854FD6j2Ut914KBYX</span><br><span class="line">... (略)</span><br><span class="line">1g0FI5lvvXjBYDUAKNiKrDbIAGcMUIgcgBy/q6X2EY5x8G/N9BVj</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"><span class="comment"># 解析私钥结构</span></span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> mykey.pem -text</span><br><span class="line">...(略)</span><br></pre></td></tr></table></figure></p>
<h4>从密钥对中分离出公钥：</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -<span class="keyword">in</span> mykey.pem -pubout -out mypubkey.pem</span><br></pre></td></tr></table></figure></p>
<p>参数：</p>
<ul>
<li>-pubout，表示输出一个公钥文件。</li>
</ul>
<h4>校验密钥对文件是否正确</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -<span class="keyword">in</span> mykey.pem -check -noout</span><br><span class="line">RSA key ok</span><br></pre></td></tr></table></figure></p>
<p>参数：</p>
<ul>
<li>-noout，表示不打印密钥对信息，如果校验成功，说明密钥对文件无误。</li>
</ul>
<h4>显示公钥信息</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -pubin -<span class="keyword">in</span> mypubkey.pem -text</span><br><span class="line">Public-Key: (2048 bit) <span class="comment">## 密钥长度</span></span><br><span class="line">Modulus:               <span class="comment">## 公开密钥系数，就是 RSA 结构中的 n</span></span><br><span class="line">    00:a7:ac:c2:c4:b1:48:24:ed:96:8f:56:53:14:a6:</span><br><span class="line">    2c:8d:70:58:26:e1:11:5d:71:0a:2c:bc:8e:dd:c3:</span><br><span class="line">    28:62:0e:8f:6f:ae:d0:6b:f0:6f:97:4a:63:8c:16:</span><br><span class="line">    a1:e5:a8:26:c7:e9:38:89:58:79:3b:24:84:53:2d:</span><br><span class="line">    d3:00:17:ce:18:45:45:a5:5c:71:6c:c5:e6:da:2e:</span><br><span class="line">    86:2d:<span class="built_in">cd</span>:75:35:7d:04:b8:cb:7b:2c:cb:fd:a5:eb:</span><br><span class="line">    15:4d:64:83:2b:75:8a:48:c3:41:a2:ee:17:cf:31:</span><br><span class="line">    66:e6:f9:31:eb:24:b6:8f:14:a2:ce:06:77:94:df:</span><br><span class="line">    1a:5d:78:92:d0:f3:30:75:fd:9c:77:53:f6:46:a8:</span><br><span class="line">    89:02:<span class="built_in">cd</span>:8d:2a:10:f8:51:78:c9:f0:93:77:b4:36:</span><br><span class="line">    c0:96:d9:72:69:2a:07:d8:2c:e2:23:8b:a1:25:1e:</span><br><span class="line">    1e:d8:9a:0f:1e:04:68:b5:72:74:5a:a9:d1:bf:ca:</span><br><span class="line">    7d:75:46:77:d7:f9:b1:0a:a7:01:33:ee:0e:16:29:</span><br><span class="line">    22:68:1f:e9:2f:14:41:0d:a2:45:7b:dc:8b:31:a7:</span><br><span class="line">    f5:15:8f:ac:e3:6c:ff:84:36:12:7c:06:6d:0f:94:</span><br><span class="line">    fd:99:ae:09:12:36:b0:13:20:40:85:4f:f2:b3:1c:</span><br><span class="line">    5a:b4:25:c2:4d:8b:89:20:94:69:b0:f2:a2:2a:bb:</span><br><span class="line">    08:c9</span><br><span class="line">Exponent: 65537 (0x10001) <span class="comment">## 公钥，就是 RSA 结构中的 e</span></span><br><span class="line">writing RSA key</span><br><span class="line">-----BEGIN PUBLIC KEY-----   <span class="comment">## 下面是公钥的具体值</span></span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAp6zCxLFIJO2Wj1ZTFKYs</span><br><span class="line">jXBYJuERXXEKLLyO3cMoYg6Pb67Qa/Bvl0pjjBah5agmx+k4iVh5OySEUy3TABfO</span><br><span class="line">GEVFpVxxbMXm2i6GLc11NX0EuMt7LMv9pesVTWSDK3WKSMNBou4XzzFm5vkx6yS2</span><br><span class="line">jxSizgZ3lN8aXXiS0PMwdf2cd1P2RqiJAs2NKhD4UXjJ8JN3tDbAltlyaSoH2Czi</span><br><span class="line">I4uhJR4e2JoPHgRotXJ0WqnRv8p9dUZ31/mxCqcBM+4OFikiaB/pLxRBDaJFe9yL</span><br><span class="line">Maf1FY+s42z/hDYSfAZtD5T9ma4JEjawEyBAhU/ysxxatCXCTYuJIJRpsPKiKrsI</span><br><span class="line">yQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></p>
<p>参数：</p>
<ul>
<li>-in 表示输入文件。</li>
<li>-pubin 如果输入文件是公钥，需要带上该参数。</li>
<li>-text 打印密钥的相关信息。</li>
</ul>
<h4>RSA 加密、解密</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"hello"</span> &gt;&gt;plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用密钥对加密</span></span><br><span class="line">$ openssl rsautl -encrypt -inkey mykey.pem -<span class="keyword">in</span> plain.txt -out cipher.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用公钥加密，务必有 -pubin 参数表明 -inkey 参数输入的是公钥文件</span></span><br><span class="line">$ openssl rsautl -encrypt -pubin -inkey mypubkey.pem -<span class="keyword">in</span> plain.txt -out cipher.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密</span></span><br><span class="line">$ openssl rsautl -decrypt -inkey mykey.pem -<span class="keyword">in</span> cipher.txt</span><br><span class="line">hello</span><br></pre></td></tr></table></figure></p>
<p>rsautl 命令默认的填充机制是 <strong>PKCS#1 v1.5</strong>，可以指定使用 <strong>PKCS#1 OAPE</strong> 机制，比如：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsautl -encrypt -inkey mykey.pem -<span class="keyword">in</span> plain.txt -out cipher.txt -oape</span><br></pre></td></tr></table></figure></p>
<h4>OpenSSL 无法使用 RSA 加密大文件</h4>
<p>RSA 算法通常用于<strong>密钥协商</strong>和<strong>数字签名/身份认证</strong>中。</p>
<p>当涉及存储大量数据时，不推荐使用 2048 位的 RSA 非对称加密算法进行加密，因为 RSA 非对称加密算法的加密效率极其缓慢。</p>
<p>因此，请不要使用 OpenSSL 加密大文件，错误示例如下：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 genrsa 命令生成 2048 位的 RSA 密钥对（rsa_private.key）</span></span><br><span class="line">openssl genrsa -out rsa_private.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析私钥结构，查看密钥内容</span></span><br><span class="line">openssl rsa -text -<span class="keyword">in</span> rsa_private.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成密钥的公钥（rsa_private.key）</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> rsa_private.key -pubout -out rsa_public.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用生成的公钥加密文件</span></span><br><span class="line"><span class="comment"># -pubin 表明用纯公钥文件加密</span></span><br><span class="line"><span class="comment"># -inkey 指定密钥（rsa_private.key）</span></span><br><span class="line"><span class="comment"># -in 指定要加密的文件（test.pdf，3.2M）</span></span><br><span class="line"><span class="comment"># -out 加密后的文件（encrypted.en）</span></span><br><span class="line">openssl rsautl -encrypt -pubin -inkey rsa_public.key  -<span class="keyword">in</span> test.pdf -out encrypted.en</span><br><span class="line">RSA operation error</span><br><span class="line">4475450988:error:04FFF06E:rsa routines:CRYPTO_internal:data too large <span class="keyword">for</span> key size:/BuildRoot/Library/Caches/com.apple.xbs/Sources/libressl/libressl-22.200.4/libressl-2.6/crypto/rsa/rsa_pk1.c:151:</span><br></pre></td></tr></table></figure></p>
<p>参考：<a href="https://stackoverflow.com/questions/7143514/how-to-encrypt-a-large-file-in-openssl-using-public-key" target="_blank" rel="noopener">How to encrypt a large file in openssl using public key</a></p>
<h3>ECDSA 算法实践</h3>
<p>生成 ECDSA-256 密钥（.pem文件）：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 secp256r1 命名曲线创建一个256位长度的 ECDSA 密钥，并使用 AES-128 位算法保存密钥。</span></span><br><span class="line">$ openssl ecparam -genkey -name secp256r1 | openssl ec -out mykey.pem -aes128</span><br></pre></td></tr></table></figure></p>
<p>只是生成密钥的命令不同，加密解密环节的命令和上面是一样的。</p>
<h2>密钥协商算法</h2>
<p>密钥协商算法解决密钥分配、存储、传输等问题。</p>
<table>
<thead>
<tr>
<th>密钥协商算法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>RSA 算法</td>
<td>缺点：会话密钥由客户端决定、无法提供前向安全性</td>
</tr>
<tr>
<td>DH 算法</td>
<td>静态DH算法、临时DH算法（EDH）</td>
</tr>
<tr>
<td>ECDH 算法</td>
<td>ECC 椭圆曲线密码学 + DH 算法</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>只有临时DH算法可以提供前向安全性。</p>
</li>
<li>
<p>ECC 椭圆曲线密码学算法的优势：密钥长度短，性能和安全性非常高。</p>
</li>
</ul>
<h3>ECC 算法中的命名曲线</h3>
<table>
<thead>
<tr>
<th>NIST 命名曲线</th>
<th>其他标准对应的命名曲线</th>
</tr>
</thead>
<tbody>
<tr>
<td>P-192</td>
<td>ansix9p192r1、prime192v1、secp192r1</td>
</tr>
<tr>
<td>P-256</td>
<td>ansix9p256r1、prime256v1、secp256r1</td>
</tr>
<tr>
<td>P-384</td>
<td>secp384r1</td>
</tr>
<tr>
<td>P-512</td>
<td>secp512r1</td>
</tr>
</tbody>
</table>
<p>以 secp256K1 命名曲线为例，其使用的有限域大小是 256 比特，其安全性等同于 3072 比特长度的 RSA 算法。</p>
<h3>DH 密钥协商算法实践</h3>
<ol>
<li>使用 dhparam 子命令生成参数文件：</li>
</ol>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个 1024 比特的参数文件</span></span><br><span class="line">$ openssl dhparam -out dhparam.pem -2 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看参数文件内容</span></span><br><span class="line">$ openssl dhparam -<span class="keyword">in</span> dhparam.pem -noout -C</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>根据参数文件，使用 genpeky 子命令生成密钥对：</li>
</ol>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genpkey -paramfile dhparam.pem -out dhkey.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看密钥对文件内容</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> dhkey.pem -text -noout</span><br><span class="line">DH Private-Key: (1024 bit)</span><br><span class="line">    private-key: <span class="comment">## 私钥</span></span><br><span class="line">        7f:1b:bc:8f:b6:ec:a7:11:00:fd:92:0d:ff:36:a5:</span><br><span class="line">        73:a9:83:f1:b6:a6:8e:ed:83:13:e6:b9:39:09:69:</span><br><span class="line">        3f:eb:4e:05:eb:37:ac:76:86:3e:08:65:50:7a:de:</span><br><span class="line">        16:a6:<span class="built_in">cd</span>:9e:36:c9:aa:0e:23:bb:37:a5:18:d7:e1:</span><br><span class="line">        d6:64:fa:b3:c8:9f:2c:3b:35:14:d8:eb:19:5c:1b:</span><br><span class="line">        33:34:5b:f9:c9:c0:35:4f:4b:b6:79:ec:fe:e0:19:</span><br><span class="line">        64:e6:30:a8:14:6a:60:b8:b5:44:97:ef:cf:05:05:</span><br><span class="line">        c6:70:d4:38:57:19:a2:b6:71:08:ee:cc:3f:66:b8:</span><br><span class="line">        36:a1:a9:1b:65:38:56:72</span><br><span class="line">    public-key: <span class="comment">## 公钥</span></span><br><span class="line">        4d:0a:d1:67:bc:63:ec:16:8e:94:ee:a1:fd:8e:67:</span><br><span class="line">        5e:20:fa:3c:65:b7:f6:91:ab:40:5d:34:fd:9d:0d:</span><br><span class="line">        07:20:2d:a7:4b:4c:bf:4a:c3:6d:ca:9a:5f:6d:8c:</span><br><span class="line">        19:2c:1d:52:5d:48:dd:03:54:b2:54:7f:2e:43:3b:</span><br><span class="line">        c8:da:82:e5:c7:9f:5b:fe:81:5d:7a:e8:ff:d3:c9:</span><br><span class="line">        a6:44:1a:51:95:9e:12:e7:4c:9e:c1:85:16:f8:96:</span><br><span class="line">        e1:04:35:be:03:ca:6d:54:e7:3e:9d:2b:18:b2:6c:</span><br><span class="line">        d4:43:8c:26:a8:a6:0d:77:6d:83:b0:ae:35:c5:61:</span><br><span class="line">        73:7c:88:fa:1b:ef:e5:de</span><br><span class="line">    prime: <span class="comment">## 大质数</span></span><br><span class="line">        00:b7:46:0d:75:c9:34:57:f8:9c:30:1e:0d:ea:03:</span><br><span class="line">        2c:a9:c3:<span class="built_in">cd</span>:66:2a:04:9f:fb:ad:f6:4a:12:4f:80:</span><br><span class="line">        9a:d0:d2:7f:f1:9b:df:69:48:a8:d8:07:ef:45:3f:</span><br><span class="line">        2a:a5:da:8f:0c:16:92:ab:4e:0a:6e:09:05:64:d4:</span><br><span class="line">        3d:49:87:61:4e:92:9c:1c:c8:f3:cf:c3:d1:44:2c:</span><br><span class="line">        9a:05:a8:79:fd:61:3d:e7:17:24:82:34:d3:3e:71:</span><br><span class="line">        91:4a:bb:e2:30:90:5a:9e:67:70:53:81:18:d0:92:</span><br><span class="line">        d0:7d:62:06:7a:d1:d7:85:7b:8c:5a:11:f9:f3:e0:</span><br><span class="line">        e5:e4:fb:a9:4f:ed:0e:7e:9b</span><br><span class="line">    generator: 2 (0x2) <span class="comment">## 生成元</span></span><br></pre></td></tr></table></figure></p>
<h4>完整的 DH 密钥协商示例</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通信双方的任何一方生成 DH 的参数文件，可以对外公开</span></span><br><span class="line">$ openssl genpkey -genparam -algorithm DH -out dhp.pem</span><br><span class="line"><span class="comment"># 查看参数文件的内容，包括 p 和 g 等参数</span></span><br><span class="line">$ openssl pkeyparam -<span class="keyword">in</span> dhp.pem -text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 A 基于参数文件生成一个密钥对（akey.pem）</span></span><br><span class="line">$ openssl genpkey -paramfile dhp.pem -out akey.pem</span><br><span class="line"><span class="comment"># 查看密钥对内容</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> akey.pem -text -noout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 B 基于参数文件生成一个密钥对 (bkey.pem)</span></span><br><span class="line">$ openssl genpkey -paramfile dhp.pem -out bkey.pem</span><br><span class="line"><span class="comment"># 查看密钥对内容</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> bkey.pem -text -noout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 A 拆出公钥文件 akey_pub.pem，私钥自己保存</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> akey.pem -pubout -out akey_pub.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 B 拆出公钥文件 bkey_pub.pem，私钥自己保存</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> bkey.pem -pubout -out bkey_pub.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 A 收到 B 发送过来的公钥，将协商出的密钥保存到 data_a.txt 文件</span></span><br><span class="line">$ openssl pkeyutl -derive -inkey akey.pem -peerkey bkey_pub.pem -out data_a.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送方 B 收到 A 发送过来的公钥，将协商出的密钥保存到 data_b.txt 文件</span></span><br><span class="line">$ openssl pkeyutl -derive -inkey bkey.pem -peerkey akey_pub.pem -out data_b.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最终会发现，data_a.txt 和 data_b.txt 两个二进制文件是相同的</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/DH%20%E5%AF%86%E9%92%A5%E5%8D%8F%E5%95%86%E7%AE%97%E6%B3%95%E7%A4%BA%E4%BE%8B%E5%9B%BE.png" alt="DH密钥协商算法示例图"></p>
<h3>ECC 算法实践</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统支持的椭圆曲线，通信双方需要选择一条都支持的命名曲线</span></span><br><span class="line">$ openssl ecparam -list_curves</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个参数文件，通过 -name 指定命名曲线</span></span><br><span class="line">$ openssl ecparam -name secp256k1 -out secp256k1.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认情况下，查看参数文件只会显示曲线的名称</span></span><br><span class="line">$ openssl ecparam -<span class="keyword">in</span> secp256k1.pem -text -noout</span><br><span class="line">ASN1 OID: secp256k1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示参数文件里的具体参数</span></span><br><span class="line">$ openssl ecparam -<span class="keyword">in</span> secp256k1.pem -text -param_enc explicit -noout</span><br></pre></td></tr></table></figure></p>
<p>参数文件示例：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Field Type: prime-field</span><br><span class="line"><span class="comment">## P 是大质数，ECC 所有点的大小控制在有限域中，几乎所有 ECC 操作都会对 P 进行取模运算。</span></span><br><span class="line">Prime:</span><br><span class="line">    00:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:</span><br><span class="line">    ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:fe:ff:</span><br><span class="line">    ff:<span class="built_in">fc</span>:2f</span><br><span class="line"><span class="comment">## A 和 B 是椭圆曲线公式</span></span><br><span class="line">A:    0  </span><br><span class="line">B:    7 (0x7)</span><br><span class="line"><span class="comment">## Generator，就是基点，由（gx, gy）组合</span></span><br><span class="line">Generator (uncompressed):</span><br><span class="line">    04:79:be:66:7e:f9:dc:bb:ac:55:a0:62:95:ce:87:</span><br><span class="line">    0b:07:02:9b:<span class="built_in">fc</span>:db:2d:ce:28:d9:59:f2:81:5b:16:</span><br><span class="line">    f8:17:98:48:3a:da:77:26:a3:c4:65:5d:a4:fb:<span class="built_in">fc</span>:</span><br><span class="line">    0e:11:08:a8:fd:17:b4:48:a6:85:54:19:9c:47:d0:</span><br><span class="line">    8f:fb:10:d4:b8</span><br><span class="line"><span class="comment">## Order，基点的打点次数</span></span><br><span class="line">Order:</span><br><span class="line">    00:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:ff:</span><br><span class="line">    ff:fe:ba:ae:dc:e6:af:48:a0:3b:bf:d2:5e:8c:d0:</span><br><span class="line">    36:41:41</span><br><span class="line"><span class="comment">## Cofactor：该值等于椭圆曲线上所有点总数除以 n。</span></span><br><span class="line">Cofactor:  1 (0x1)</span><br></pre></td></tr></table></figure></p>
<h3>ECDH 算法实践</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成参数文件</span></span><br><span class="line">$ openssl ecparam -name secp256k1 -out secp256k1.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># A 和 B 各自生成一个 ECDH 私钥对文件</span></span><br><span class="line">$ openssl genpkey -paramfile secp256k1.pem -out akey.pem</span><br><span class="line">$ openssl genpkey -paramfile secp256k1.pem -out bkey.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># A 和 B 分解出公钥，将公钥发送给对方</span></span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> akey.pem -pubout -out akey_pub.pem</span><br><span class="line">$ openssl pkey -<span class="keyword">in</span> bkey.pem -pubout -out bkey_pub.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># A 和 B 分别用自己的私钥和对方的公钥计算出同样的会话密钥</span></span><br><span class="line">$ openssl pkeyutl -derive -inkey akey.pem -peerkey bkey_pub.pem -out data_a.txt</span><br><span class="line">$ openssl pkeyutl -derive -inkey bkey.pem -peerkey akey_pub.pem -out data_b.txt</span><br></pre></td></tr></table></figure></p>
<p>最终 data_a.txt、data_b.txt 包含的值是相同的。</p>
<h2>数字签名</h2>
<p>消息加密只是解决了传送消息的保密问题，而防止他人对传输文件进行破坏，以及确定发信人的身份需要使用数字签名。完善的数字签名应具备签字方不能抵赖、他人不能伪造、在公证人面前能够验证真伪的能力。</p>
<p><strong>数字签名的作用</strong>：验证消息源及数据内容的真实性；签名能够被第三方验证，并确定消息内容的真实性和签名者身份。</p>
<p>数字签名体制包括三个算法：密钥生成算法、签名算法、验证算法。</p>
<h3>数字签名原理</h3>
<blockquote>
<p>私钥拥有者使用密钥（注意不是加密操作）签署一条消息然后发送给任意的接收方，接收方只要拥有私钥对应的公钥，就能成功反解签署消息，由于只有私钥持有者才能“签署”消息，不能抵赖说这条签署消息不是他发送的，这就是数字签名技术的全部。</p>
</blockquote>
<p>报文的发送方从报文文本中生成一个固定长度的散列值（报文摘要）。发送方用自己的私钥对这个散列值进行加密来形成发送方的数字签名。然后，这个数字签名将作为报文的附件和报文一起发送给报文的接收方。报文的接收方首先从接收到的原始报文中计算出散列值，接着再用发送方的公钥来对报文附加的数字签名进行解密。如果两个散列值相同，那么接收方就能确认该数字签名是发送方的。通过数字签名能够实现对原始报文的鉴别。</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/1280px-Digital_Signature_diagram_zh-CN.svg.png" alt></p>
<p>采用数字签名，能够保证：</p>
<ol>
<li>信息是由签名者发送的；</li>
<li>信息自签发后到收到为止未曾有过任何修改；</li>
</ol>
<h3>数字签名算法</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95.png" alt="数字签名算法"></p>
<p>数字签名技术的特点：</p>
<ol>
<li>防篡改；</li>
<li>防抵赖；</li>
<li>放伪造；</li>
</ol>
<h3>数字签名与非对称加密的关系</h3>
<blockquote>
<p>一言以蔽之，数字签名就是将<a href="https://www.wikiwand.com/zh-hans/%E5%85%AC%E9%92%A5%E5%AF%86%E7%A0%81" target="_blank" rel="noopener">公钥密码</a>反过来使用。</p>
</blockquote>
<ul>
<li>都使用公钥体系，但实现的方法正好相反，使用的密钥对也不同。</li>
<li><strong>数字签名</strong> 使用的是发送方的密钥对，发送方用自己的私钥进行加密，接收方用发送方的公开密钥进行解密。一对多关系。</li>
<li><strong>非对称加密</strong>的加密解密则使用的是接收方的密钥对，这是多对一的关系：任何知道接收方公开密钥的人都可以向接收方发送加密信息，只有唯一拥有接收方私有密钥的人才能对信息解密。</li>
<li>在实用过程中，通常一个用户拥有两个密钥对，一个密钥对用来进行数字签名，另一个密钥对用来进行非对称加密，这种方式提供了更高的安全性。</li>
</ul>
<h3>RSA 数字签名算法实践</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个 RSA 密钥对，密钥长度 1024 比特</span></span><br><span class="line">$ openssl genrsa -out privatekey.pem 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从密钥对中分离出公钥</span></span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> privatekey.pem -pubout -out pubilckey.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对 plain.txt 文件使用 sha256 Hash 算法和签名算法生成签名文件 signature.txt</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"hello"</span>&gt;&gt;plain.txt</span><br><span class="line">$ openssl dgst -sha256 -sign privatekey.pem -out signature.txt plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用相同的摘要算法和签名算法校验签名文件，需要对比签名文件和原始文件</span></span><br><span class="line">$ openssl dgst -sha256 -verify pubilckey.pem -signature signature.txt plain.txt</span><br><span class="line">Verified OK</span><br></pre></td></tr></table></figure></p>
<p>OpenSSL 命令行进行签名的时候默认使用的是 RSAES-PKCS1-V1_5 填充标准，也可以指定 PSASSA-PSS 标准：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个 RSA 密钥对</span></span><br><span class="line">$ openssl genrsa -out privatekey.pem 1024</span><br><span class="line">$ openssl rsa -<span class="keyword">in</span> privatekey.pem -pubout -out pubilckey.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对 plain.txt 文件使用 sha256 Hash 算法和签名算法生成签名文件 signature.txt</span></span><br><span class="line"><span class="comment"># 指定 PSASSA-PSS 标准：-sigopt rsa_padding_mode:pss</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"hello"</span>&gt;&gt;plain.txt</span><br><span class="line">$ openssl dgst -sha256 -sign privatekey.pem -sigopt rsa_padding_mode:pss -out signature.txt plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#校验签名文件</span></span><br><span class="line">$ openssl dgst -sha256 -verify pubilckey.pem -sigopt rsa_padding_mode:pss -signature signature.txt plain.txt</span><br><span class="line">Verified OK</span><br></pre></td></tr></table></figure></p>
<h3>DSA 数字签名算法实践</h3>
<h4>生成参数文件和密钥对文件</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成参数文件，类似于 DH 参数文件</span></span><br><span class="line">$ openssl dsaparam -out dsaparam.pem 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过参数文件生成密钥对文件（privatekey.pem）</span></span><br><span class="line">$ openssl gendsa -out private.pem dsaparam.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对私钥文件使用 des3 算法进行加密</span></span><br><span class="line">$ openssl gendsa -out private2.pem -des3 dsaparam.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过密钥对文件拆分出公钥</span></span><br><span class="line">$ openssl dsa -<span class="keyword">in</span> private.pem -pubout -out publickey.pem</span><br></pre></td></tr></table></figure></p>
<h4>显示参数、密钥对信息</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示私钥文件的信息，包括三个公共参数、公钥、私钥</span></span><br><span class="line">$ openssl dsa -<span class="keyword">in</span> private.pem -text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示公钥文件的信息</span></span><br><span class="line">$ openssl dsa -pubin -<span class="keyword">in</span> publickey.pem -text</span><br></pre></td></tr></table></figure></p>
<p>私钥文件示例：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> DSA key</span><br><span class="line">Private-Key: (1024 bit)</span><br><span class="line">priv: <span class="comment">## 密钥对私钥</span></span><br><span class="line">    00:89:ca:36:b3:56:f4:61:91:1c:df:40:02:73:9b:</span><br><span class="line">    40:cb:98:c2:e0:65</span><br><span class="line">pub: <span class="comment">## 密钥对公钥</span></span><br><span class="line">    35:ce:67:fa:79:aa:ce:64:18:6d:7e:fb:41:e6:ff:</span><br><span class="line">    e3:59:7c:10:<span class="built_in">fc</span>:a9:82:f7:a9:13:3b:22:96:3e:5f:</span><br><span class="line">    f4:ad:09:56:bd:47:ab:2c:ca:11:81:99:ed:0c:b2:</span><br><span class="line">    61:38:84:d9:d8:6b:6b:ab:67:2e:8e:01:fa:66:db:</span><br><span class="line">    e6:de:3d:ac:d0:55:1c:b5:e8:20:63:56:c1:75:d8:</span><br><span class="line">    11:a6:a3:2f:ed:46:ea:9c:63:d0:a3:03:ce:d0:20:</span><br><span class="line">    f3:fe:0f:22:fe:9c:35:74:c3:6a:d3:f4:1f:86:e3:</span><br><span class="line">    d1:ef:63:f4:8e:03:1a:3c:cb:f9:85:d1:c2:2a:b5:</span><br><span class="line">    a0:26:61:53:2b:ac:0c:de</span><br><span class="line">P: <span class="comment">## DSA 参数，大质数</span></span><br><span class="line">    00:9e:3b:2d:3c:88:cb:3a:3e:93:74:9b:c5:85:52:</span><br><span class="line">    8c:4c:03:89:ef:25:c5:f3:50:01:39:55:a0:71:18:</span><br><span class="line">    3b:25:75:a6:b9:be:f7:ff:e0:b7:63:7b:4a:6f:70:</span><br><span class="line">    60:b7:e7:05:e1:ad:ec:5f:17:a5:92:d1:f9:ef:72:</span><br><span class="line">    33:37:53:2c:c1:30:0a:d5:c6:dc:1a:b6:d5:<span class="built_in">fc</span>:73:</span><br><span class="line">    7c:c0:d6:be:ba:73:b6:a7:ac:3a:7b:f0:46:f2:<span class="built_in">cd</span>:</span><br><span class="line">    1a:35:f3:19:d0:3d:b6:6e:7e:5a:c6:aa:2c:2a:ab:</span><br><span class="line">    53:f6:7c:4b:84:e7:be:cb:3b:87:8a:ce:3f:83:cc:</span><br><span class="line">    1a:44:a4:df:18:45:23:c6:45</span><br><span class="line">Q: <span class="comment">## DSA 参数</span></span><br><span class="line">    00:d7:3c:05:b4:6a:bd:a8:4d:25:be:3b:12:ac:c0:</span><br><span class="line">    c4:50:23:c3:43:43</span><br><span class="line">G: <span class="comment">## DSA 参数，数学表达式结果，数值来源于 p 和 q</span></span><br><span class="line">    4b:ef:8d:33:d4:1e:65:fe:3a:25:92:2c:1b:27:b1:</span><br><span class="line">    36:12:21:7d:59:80:66:a1:ec:ea:76:f2:6f:98:60:</span><br><span class="line">    <span class="built_in">cd</span>:7c:ec:e2:39:aa:4b:3a:86:8f:33:9a:ae:1d:3d:</span><br><span class="line">    c6:b4:36:30:f0:e0:fe:76:ce:b5:c4:22:5c:2d:7f:</span><br><span class="line">    63:b1:56:bb:b8:71:28:91:70:bc:ef:20:d8:cb:c4:</span><br><span class="line">    b4:5a:e4:72:23:57:ae:<span class="built_in">fc</span>:79:ac:f6:88:35:67:30:</span><br><span class="line">    61:be:5d:e6:d7:35:72:f4:3c:b3:9a:d5:a0:75:0a:</span><br><span class="line">    dd:b1:27:38:df:c5:05:ec:74:56:24:cf:99:36:<span class="built_in">cd</span>:</span><br><span class="line">    4f:6c:a2:6a:0d:25:a1:14</span><br><span class="line">writing DSA key <span class="comment">## DSA 私钥</span></span><br><span class="line">-----BEGIN DSA PRIVATE KEY-----</span><br><span class="line">MIIBuwIBAAKBgQCeOy08iMs6PpN0m8WFUoxMA4nvJcXzUAE5VaBxGDsldaa5vvf/</span><br><span class="line">4Ldje0pvcGC35wXhrexfF6WS0fnvcjM3UyzBMArVxtwattX8c3zA1r66c7anrDp7</span><br><span class="line">8EbyzRo18xnQPbZuflrGqiwqq1P2fEuE577LO4eKzj+DzBpEpN8YRSPGRQIVANc8</span><br><span class="line">BbRqvahNJb47EqzAxFAjw0NDAoGAS++NM9QeZf46JZIsGyexNhIhfVmAZqHs6nby</span><br><span class="line">b5hgzXzs4jmqSzqGjzOarh09xrQ2MPDg/nbOtcQiXC1/Y7FWu7hxKJFwvO8g2MvE</span><br><span class="line">tFrkciNXrvx5rPaINWcwYb5d5tc1cvQ8s5rVoHUK3bEnON/FBex0ViTPmTbNT2yi</span><br><span class="line">ag0loRQCgYA1zmf6earOZBhtfvtB5v/jWXwQ/KmC96kTOyKWPl/0rQlWvUerLMoR</span><br><span class="line">gZntDLJhOITZ2Gtrq2cujgH6Ztvm3j2s0FUcteggY1bBddgRpqMv7UbqnGPQowPO</span><br><span class="line">0CDz/g8i/pw1dMNq0/QfhuPR72P0jgMaPMv5hdHCKrWgJmFTK6wM3gIVAInKNrNW</span><br><span class="line">9GGRHN9AAnObQMuYwuBl</span><br><span class="line">-----END DSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure></p>
<h4>生成和验证签名</h4>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"hello"</span>&gt;&gt;plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签名</span></span><br><span class="line">$ openssl dgst -sha256 -sign private.pem -out signature.txt plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证签名</span></span><br><span class="line">$ openssl dgst -sha256 -verify publickey.pem -signature signature.txt plain.txt</span><br><span class="line">Verified OK</span><br></pre></td></tr></table></figure></p>
<h3>ECDSA 算法实践</h3>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 生成 ECDSA 私钥</span></span><br><span class="line">$ openssl ecparam -name secp256k1 -genkey -out ecdsa_private_key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示私钥信息</span></span><br><span class="line">$ openssl ec -<span class="keyword">in</span> ecdsa_private_key.pem -text -noout</span><br><span class="line"><span class="built_in">read</span> EC key</span><br><span class="line">Private-Key: (256 bit) <span class="comment">## 私钥长度</span></span><br><span class="line">priv: <span class="comment">## 私钥</span></span><br><span class="line">    00:d8:c5:c2:f0:19:d6:84:de:0f:5b:53:8d:16:98:</span><br><span class="line">    5c:7b:e4:9e:c2:d9:7a:59:25:52:5a:cc:b9:78:62:</span><br><span class="line">    86:2b:c2</span><br><span class="line">pub: <span class="comment">## 公钥</span></span><br><span class="line">    04:ed:ab:7e:93:3b:83:b3:02:ff:8d:45:2d:e4:8b:</span><br><span class="line">    e0:79:6b:5a:44:77:8e:d2:72:7b:94:fb:f9:d7:7f:</span><br><span class="line">    54:66:76:a3:a6:a5:f4:86:dd:7c:11:<span class="built_in">cd</span>:26:66:d9:</span><br><span class="line">    6a:62:21:08:d7:84:83:cc:9e:87:03:9c:27:93:f0:</span><br><span class="line">    b5:1a:a9:50:57</span><br><span class="line">ASN1 OID: secp256k1 <span class="comment">## 命名曲线信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生成私钥对应的公钥</span></span><br><span class="line">$ openssl ec -<span class="keyword">in</span> ecdsa_private_key.pem -pubout -out ecdsa_public_key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示公钥信息</span></span><br><span class="line">$ openssl ec -pubin -<span class="keyword">in</span> ecdsa_public_key.pem -text -noout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成待签名文件</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"hello"</span>&gt;&gt;plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 生成签名值</span></span><br><span class="line">$ openssl dgst -sha256 -sign ecdsa_private_key.pem -out signature.txt plain.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 校验签名</span></span><br><span class="line">$ openssl dgst -sha256 -verify ecdsa_public_key.pem -signature signature.txt plain.txt</span><br><span class="line">Verified OK</span><br></pre></td></tr></table></figure></p>
<h2>算法安全性和性能</h2>
<h3>推荐密钥长度</h3>
<table>
<thead>
<tr>
<th>密码学算法</th>
<th>推荐的密钥安全长度</th>
</tr>
</thead>
<tbody>
<tr>
<td>AES 对称加密算法</td>
<td>128 比特</td>
</tr>
<tr>
<td>RSA 加密和签名算法</td>
<td>2048 比特</td>
</tr>
<tr>
<td>DSA 数字签名算法</td>
<td>2048 比特</td>
</tr>
<tr>
<td>ECC 椭圆曲线</td>
<td>256 比特</td>
</tr>
</tbody>
</table>
<p>参考 <a href="https://cordis.europa.eu/docs/projects/cnect/6/216676/080/deliverables/002-DSPA20.pdf" target="_blank" rel="noopener">ECRYPT II</a></p>
<h3>密码学性能</h3>
<p>关注密码学性能的两个途径：</p>
<ol>
<li>参考专业的安全公司、大型互联网公司的密码学性能评测报告；</li>
<li>密码学性能测试；</li>
</ol>
<h4>性能评测</h4>
<p>OpenSSL 中，可以使用 speed 子命令评测系统的能力和上限：</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ openssl speed rc4 aes rsa ecdh sha</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让speed命令并发使用4核测试</span></span><br><span class="line">$ openssl speed -multi 4 rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持AES-NI指令的服务器可以加速AES计算，使用-evp开关激活硬件加速卡</span></span><br><span class="line">$ openssl speed -evp aes-128-cbc</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>性能测试中的 evp 模式</p>
<p>evp 模式相当于调用 OpenSSL EVP 库（OpenSSL 基于底层密码库实现的一个高层次库）。</p>
<p>evp 模式能够基于硬件对算法运算进行调，能基于当前的 CPU 模型选择最佳的运行模式。</p>
</blockquote>
<h2>参考</h2>
<ul>
<li>《密码学——密码算法与协议（第2版）》</li>
<li>《深入浅出 HTTPS：从原理到实践》</li>
<li><a href="%5Bhttp://linux.51yip.com/search/openssl%5D(http://linux.51yip.com/search/openssl)">openssl</a></li>
<li><a href="https://www.freebuf.com/articles/network/42692.html" target="_blank" rel="noopener">加密通讯可以防止隐私窃取，为何我们都不用它？</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/29/PerfOps-CLI-多地点网络测试工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/29/PerfOps-CLI-多地点网络测试工具/" class="post-title-link" itemprop="url">PerfOps CLI 多地点网络测试工具</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-29 13:51:00" itemprop="dateCreated datePublished" datetime="2018-11-29T13:51:00+08:00">2018-11-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:03:55" itemprop="dateModified" datetime="2019-05-01T21:03:55+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发工具-Mac应用/" itemprop="url" rel="index"><span itemprop="name">开发工具&Mac应用</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1><a href="https://perfops.net/cli" target="_blank" rel="noopener">perfops-cli</a> - 一款IT运维工具</h1>
<p><a href="https://github.com/ProspectOne/perfops-cli" target="_blank" rel="noopener">GitHub：perfops-cli</a></p>
<p>PerfOps CLI 是一款适合于运维人员使用的命令行工具，方便从多地点执行 ping、traceroute、mtr 等网络基准测试。
PerfOps 使用简单，你可以从位于全世界的数百个节点向目标地址发起网络测试。在不设置 API 密钥的条件下，它允许每小时进行 10 次测试，免费注册用户则可以在每小时内发起最多 200 次测试。</p>
<h2>Homebrew - MacOS 安装方法</h2>
<p>使用 Homebrew 安装：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew tap ProspectOne/perfops</span><br><span class="line">brew install perfops</span><br><span class="line">perfops --help</span><br></pre></td></tr></table></figure></p>
<p>&lt;!-- more --&gt;</p>
<h2>使用方法</h2>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> perfops --<span class="built_in">help</span></span></span><br><span class="line">perfops is a simple command line tool to interact with hunderds of servers around the world. Run benchmarks and debug your infrastructure without leaving your console.</span><br><span class="line">perfops 是一个简单的命令行工具，可与世界各地的数百台服务器进行交互。 无需离开控制台即可运行基准测试并调试基础架构。</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  perfops [flags]</span><br><span class="line">  perfops [command]</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">perfops traceroute --from "New York" google.com</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  credits     Displays the remaing credits</span><br><span class="line">  curl        Run a curl test on a domain name or IP address</span><br><span class="line">  dnsperf     Find the time it takes to resolve a DNS record on a target</span><br><span class="line">  help        Help about any command</span><br><span class="line">  latency     Run a ICMP latency test on a domain name or IP address</span><br><span class="line">  mtr         Run a MTR test on a domain name or IP address</span><br><span class="line">  ping        Run a ping test on a domain name or IP address</span><br><span class="line">  resolve     Resolve a DNS record on a domain name</span><br><span class="line">  traceroute  Run a traceroute test on a domain name or IP address</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --debug             Enables debug output</span><br><span class="line">  -F, --from string       A continent, region (e.g eastern europe), country, US state or city</span><br><span class="line">  -h, --help              help for perfops</span><br><span class="line">  -J, --json              Print the result of a command in JSON format</span><br><span class="line">  -K, --key string        The PerfOps API key (default is $PERFOPS_API_KEY)</span><br><span class="line">  -N, --nodeid intSlice   A comma separated list of node IDs to run a test from</span><br><span class="line">  -v, --version           Prints the version information of perfops</span><br><span class="line"></span><br><span class="line">Use "perfops [command] --help" for more information about a command.</span><br></pre></td></tr></table></figure></p>
<h3>ping - 测试网络连通性</h3>
<ol>
<li>
<p>从亚洲（Asia）的随机一台服务器上 Ping baidu.com：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> perfops ping --from Asia baidu.com</span></span><br><span class="line">Node203, AS45102, Dubai, United Arab Emirates # Node203，AS45102，迪拜，阿拉伯联合酋长国</span><br><span class="line">PING baidu.com (220.181.57.216) 56(84) bytes of data.</span><br><span class="line">64 bytes from 220.181.57.216: icmp_seq=1 ttl=47 time=341 ms</span><br><span class="line">64 bytes from 220.181.57.216: icmp_seq=2 ttl=47 time=342 ms</span><br><span class="line">64 bytes from 220.181.57.216: icmp_seq=3 ttl=47 time=342 ms</span><br><span class="line"></span><br><span class="line">--- baidu.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 800ms</span><br><span class="line">rtt min/avg/max/mdev = 341.865/342.230/342.800/0.789 ms</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>从亚洲（Asia）的随机两台服务器上 Ping 某一个IP地址：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> perfops ping --from Asia 52.14.183.223 --<span class="built_in">limit</span> 2</span></span><br><span class="line">Node297, AS199524, Seoul, South Korea # 韩国首尔的节点</span><br><span class="line">PING 52.14.183.223 (52.14.183.223) 56(84) bytes of data.</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=1 ttl=39 time=193 ms</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=2 ttl=39 time=193 ms</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=3 ttl=39 time=193 ms</span><br><span class="line"></span><br><span class="line">--- 52.14.183.223 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 802ms</span><br><span class="line">rtt min/avg/max/mdev = 193.768/193.786/193.814/0.020 ms</span><br><span class="line"></span><br><span class="line">Node112, AS14061, Bangalore, India # Node112，AS14061，班加罗尔，印度</span><br><span class="line">PING 52.14.183.223 (52.14.183.223) 56(84) bytes of data.</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=1 ttl=41 time=233 ms</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=2 ttl=41 time=232 ms</span><br><span class="line">64 bytes from 52.14.183.223: icmp_seq=3 ttl=41 time=232 ms</span><br><span class="line"></span><br><span class="line">--- 52.14.183.223 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 801ms</span><br><span class="line">rtt min/avg/max/mdev = 232.727/232.975/233.375/0.486 ms</span><br></pre></td></tr></table></figure></p>
</li>
</ol>
<h3>traceroute - 对域名或 IP 地址运行路由跟踪测试</h3>
<p>从上海的某一台服务器测试 baidu.com 的路由跟踪：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> perfops traceroute --from <span class="string">"Shanghai"</span> baidu.com</span></span><br><span class="line">Node276, AS37963, Shanghai, China</span><br><span class="line">traceroute to baidu.com (123.125.115.110), 20 hops max, 60 byte packets</span><br><span class="line"> 2  11.222.252.181 (11.222.252.181)  5.770 ms  5.911 ms</span><br><span class="line"> 3  11.222.252.10 (11.222.252.10)  5.519 ms  52.961 ms</span><br><span class="line"> 4  11.220.159.58 (11.220.159.58)  1.760 ms  1.863 ms</span><br><span class="line"> 5  116.251.106.157 (116.251.106.157)  2.412 ms  2.402 ms</span><br><span class="line"> 6  140.205.50.225 (140.205.50.225)  2.185 ms  2.189 ms</span><br><span class="line"> 7  140.206.207.205 (140.206.207.205)  3.937 ms  4.036 ms</span><br><span class="line"> 8  140.206.207.29 (140.206.207.29)  4.209 ms  4.247 ms</span><br><span class="line"> 9  * *</span><br><span class="line">10  139.226.227.33 (139.226.227.33)  9.367 ms  9.365 ms</span><br><span class="line">11  219.158.6.165 (219.158.6.165)  30.609 ms  30.525 ms</span><br><span class="line">12  * *</span><br><span class="line">13  61.51.113.246 (61.51.113.246)  25.389 ms  25.578 ms</span><br><span class="line">14  202.106.43.38 (202.106.43.38)  25.545 ms  25.531 ms</span><br><span class="line">15  * *</span><br><span class="line">16  * *</span><br><span class="line">17  123.125.115.110 (123.125.115.110)  25.586 ms  25.594 ms</span><br></pre></td></tr></table></figure></p>
<h3>latency - 对域名或 IP 地址运行 ICMP 延迟测试</h3>
<p>分别在位于中国的随机10台服务器上测试 google.com 的ICMP延迟：
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">perfops latency --from China google.com --limit 10</span><br><span class="line">Node208, AS37963, Hangzhou, China # 杭州，100%丢包😂</span><br><span class="line"><span class="meta">100%</span><span class="bash"> packet loss</span></span><br><span class="line">Node329, AS37963, Hohhot, China # 呼和浩特，100%丢包😂</span><br><span class="line"><span class="meta">100%</span><span class="bash"> packet loss</span></span><br><span class="line">Node207, AS37963, Beijing, China # 北京。。。😂</span><br><span class="line"><span class="meta">100%</span><span class="bash"> packet loss</span></span><br><span class="line">Node276, AS37963, Shanghai, China # 上海。。。😂</span><br><span class="line"><span class="meta">100%</span><span class="bash"> packet loss</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/15/Node.js 异步编程笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/15/Node.js 异步编程笔记/" class="post-title-link" itemprop="url">Node.js 异步编程笔记</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-15 18:00:00" itemprop="dateCreated datePublished" datetime="2018-11-15T18:00:00+08:00">2018-11-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:00:45" itemprop="dateModified" datetime="2019-05-01T21:00:45+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>从 Callback Hell 到 Promise 到 Async/Await</h1>
<h3><a href="https://i5ting.github.io/How-to-learn-node-correctly/" target="_blank" rel="noopener">【知乎 Live】狼叔：如何正确的学习 Node.js</a></h3>
<p>Node.js 异步流程控制的学习重点：</p>
<ol>
<li>API 写法：Error-first Callback 和 EventEmitter；</li>
<li>中流砥柱：<a href="https://github.com/then/promise#readme" target="_blank" rel="noopener">Promise</a>；</li>
<li>终极解决方案：Async/Await</li>
</ol>
<p>&lt;!-- more --&gt;</p>
<h4>回调地狱（Callback Hell ）</h4>
<p>Node.js 默认使用回调函数（callback）风格语法来实现异步编程：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node.js 默认的回调函数风格写法，Callback Hell</span></span><br><span class="line">step1(<span class="function"><span class="keyword">function</span>(<span class="params">value1</span>) </span>&#123;</span><br><span class="line">  step2(value1, <span class="function"><span class="keyword">function</span>(<span class="params">value2</span>) </span>&#123;</span><br><span class="line">    step3(value2, <span class="function"><span class="keyword">function</span>(<span class="params">value3</span>) </span>&#123;</span><br><span class="line">      step4(value3, <span class="function"><span class="keyword">function</span>(<span class="params">value4</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Do something with value 4.</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ES6 箭头函数语法：</span></span><br><span class="line">step1(<span class="function"><span class="params">value1</span> =&gt;</span> &#123;</span><br><span class="line">  step2(value1, value2 =&gt; &#123;</span><br><span class="line">    step3(value2, value3 =&gt; &#123;</span><br><span class="line">      step4(value3, value4 =&gt; &#123;</span><br><span class="line">        <span class="comment">// Do something with value4.</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4>Promise 语法</h4>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> step1().then(step2).then(step3).then(step4).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do something with error.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3><a href="https://www.infoq.cn/article/JQxzWt7FqDc9p7jJ_1hs" target="_blank" rel="noopener">InfoQ：异步 JavaScript 的演化史：从回调到 Promise 再到 Async/Await</a> ⭐️⭐️⭐️⭐️</h3>
<h4>什么是回调函数（callback）？</h4>
<blockquote>
<p>首先，就像可以将字符串或数字以参数的形式传递给函数一样，我们也可以将函数的引用作为参数进行传递。但我们这样做的时候，作为参数传递的函数被称为回调函数（callback function），而接收回调函数传入的那个函数则被称为高阶函数（higher order function）。</p>
</blockquote>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">higherOrderFunction</span>(<span class="params">x, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> callback(x, <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">higherOrderFunction(<span class="number">10</span>, add);</span><br></pre></td></tr></table></figure></p>
<p>回调的使用场景：将函数的执行延迟至一个特定的时间。</p>
<h4>Promise</h4>
<p><code>Promise</code>会处于如下三种状态中的某一种： <code>pending</code>、<code>fulfilled</code>或<code>rejected</code>。</p>
<p>如果异步请求依然还在进行，那么<code>Promise</code>的状态会是<code>pending</code>。如果异步请求成功完成的话，那么<code>Promise</code>会将状态转换为<code>fulfilled</code>。如果异步请求失败的话，<code>Promise</code>会将状态转换为<code>rejected</code>。</p>
<hr>
<p><code>Promise</code>的构造函数会接收一个参数，这个参数是一个（回调）函数。该函数会被传入两个参数<code>resolve</code>和<code>reject</code>。</p>
<p><code>resolve</code>：一个能将 Promise 状态变为<code>fulfilled</code>的函数；</p>
<p><code>reject</code>：一个能将 Promise 状态变为<code>rejected</code>的函数；</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(); <span class="comment">// 将状态变为"fulfilled"</span></span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>当 Promise 的状态变为<code>fulfilled</code>的时候，传递给<code>.then</code>的函数将会被调用。如果 Promise 的状态变为<code>rejected</code>，传递给<code>.catch</code>的函数将会被调用。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onSuccess</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Success'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Error'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(); <span class="comment">// 将状态变为"fulfilled"</span></span><br><span class="line">  &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.then(onSuccess);</span><br><span class="line">promise.catch(onError);</span><br></pre></td></tr></table></figure></p>
<p>Promise 的链式语法。</p>
<h4>Async/Await</h4>
<p>如何完全按照编写同步代码的方式来编写异步代码？</p>
<ol>
<li>首先，只要你为函数添加<code>async</code>，它就会隐式的返回一个 Promise 对象：</li>
</ol>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getPromise</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise = getPromise();</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>其次，如果<code>async</code>函数有返回值的话，它也将会包装到一个 Promise 中。这意味着，你必须要使用<code>.then</code>来访问它。</li>
</ol>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, <span class="number">3</span>).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result); <span class="comment">// 5</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>
<p>不能将 <code>await</code> 用到非 <code>async</code> 的函数中。</p>
<p>当你将 <code>await</code> 添加到一个函数上的时候：首先，它会让这个函数本身返回一个 Promise（或者将返回的内容包装到 Promise 中）；其次，它会确保你能够在这个函数中使用<code>await</code>。</p>
</li>
</ol>
<h3><a href="https://juejin.im/entry/589401b68fd9c57277376470" target="_blank" rel="noopener">Node.js 异步最佳实践 &amp; 避免回调地狱 | @RisingStack</a></h3>
<blockquote>
<p>要成为一个高效的 Node.js 开发者，你必须避免不断增加的缩进级别，书写简洁且易读的代码，以及处理复杂的流程。</p>
<p>尽可能使用异步 API 而不是同步 API。因为非阻塞的方式比同步的方式性能更好。</p>
</blockquote>
<h3><a href="https://www.infoq.cn/article/2011%2F09%2Fjs-promise" target="_blank" rel="noopener">InfoQ：JavaScript 异步编程的 Promise 模式</a></h3>
<p>关键字：2011 年 9 月 15 日、JavaScript、Ajax 示例。</p>
<h2>Promise</h2>
<ul>
<li><a href="https://cnodejs.org/topic/560dbc826a1ed28204a1e7de" target="_blank" rel="noopener">Node.js 最新技术栈之 Promise 篇</a> ⭐️⭐️⭐️</li>
<li><a href="https://cnodejs.org/topic/569c8226adf526da2aeb23fd" target="_blank" rel="noopener">理解 Promise 的工作原理</a> ⭐️</li>
<li><a href="http://liubin.github.io/promises-book/" target="_blank" rel="noopener">Promise 迷你书</a> ⭐️</li>
<li><a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="noopener">promise模块：bluebird</a></li>
<li><a href="https://github.com/kriskowal/q" target="_blank" rel="noopener">promise模块: q</a></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调地狱</span></span><br><span class="line">asyncOperation(<span class="function"><span class="keyword">function</span>(<span class="params">data1</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 处理 data1</span></span><br><span class="line">  anotherAsync(<span class="function"><span class="keyword">function</span>(<span class="params">data2</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 data2</span></span><br><span class="line">    yetAnotherAsync(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 完成</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise 语法</span></span><br><span class="line">promiseSomething()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">data1</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 data1</span></span><br><span class="line">    <span class="keyword">return</span> anotherAsync();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">data2</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 data2</span></span><br><span class="line">    <span class="keyword">return</span> yetAnotherAsync();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 完成</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<h3>Promise/A 规范</h3>
<p>promise 表示一个最终值，该值由一个操作完成时返回。</p>
<ul>
<li>promise 有3种状态：<strong>未完成（Pending）</strong>、<strong>完成（Fulfilled）</strong>、<strong>失败（Rejected）</strong>。</li>
<li>promise 的状态转换：
<ul>
<li>未完成 ➡️ 完成。</li>
<li>未完成 ➡️ 失败。</li>
</ul>
</li>
<li>promise 的状态转换只发生一次。</li>
</ul>
<p>promise 的 <code>then()</code> 方法可以接受3个函数作为参数：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">promiseSomething().then(<span class="function"><span class="keyword">function</span>(<span class="params">fulfilled</span>) </span>&#123;</span><br><span class="line"><span class="comment">// 当 promise 状态变成 fulfilled 时，调用此函数。</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">rejected</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 当 promise 状态变成 rejected 时，调用此函数</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">progress</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//当返回进度信息时，调用此函数（可选）</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2>Async</h2>
<ul>
<li><a href="https://github.com/caolan/async" target="_blank" rel="noopener">async</a></li>
<li><a href="https://caolan.github.io/async/index.html" target="_blank" rel="noopener">Document: async</a></li>
</ul>
<h3><a href="http://es6.ruanyifeng.com/#docs/async" target="_blank" rel="noopener">async 函数的含义和用法 @阮一峰</a></h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> asyncMethod = <span class="keyword">async</span> () =&gt; &#123;  <span class="comment">// async 用于声明一个函数是异步的。</span></span><br><span class="line">  <span class="keyword">const</span> f1 = <span class="keyword">await</span> firstMethod();  <span class="comment">// await 用于等待一个异步方法执行完成。</span></span><br><span class="line">  <span class="keyword">const</span> f2 = <span class="keyword">await</span> anotherMethod();</span><br><span class="line">  <span class="built_in">console</span>.log(f1, f2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>async 函数就是 Generator 函数的语法糖。</p>
<p>async 函数就是将 Generator 函数的星号（<code>*</code>）替换成 async，将 yield 替换成 await，仅此而已。</p>
<p>await 命令后面的 Promise 对象，运行结果可能是 rejected，所以最好把 await 命令放在 try...catch 代码块中。</p>
<p>async 函数返回的是一个 Promise 对象。</p>
<p>await 命令只能用在 async 函数之中，如果用在普通函数，就会报错。</p>
</blockquote>
<h3><a href="https://segmentfault.com/a/1190000007535316" target="_blank" rel="noopener">理解 JavaScript 的 async/await</a> ⭐️⭐️⭐️</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">testAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = testAsync();</span><br><span class="line"><span class="built_in">console</span>.log(result); <span class="comment">// Promise &#123; 'Hello World' &#125;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>async 函数（包含函数语句、函数表达式、Lambda 表达式）会返回一个 Promise 对象，如果在函数中 <code>return</code> 一个直接量，async 会把这个直接量通过 <code>Promise.resolve()</code> 封装成 Promise 对象。</p>
</blockquote>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">testAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">testAsync().then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result); <span class="comment">// Hello World</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4>用 <code>setTimeout</code> 模拟耗时操作的示例</h4>
<p>Promise 语法：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">takeLongTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">'long_time_value'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">takeLongTime().then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result); <span class="comment">// long_time_value</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>async/await 语法：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">takeLongTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">'long_time_value'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> takeLongTime();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test();</span><br></pre></td></tr></table></figure></p>
<h4>async/await 的优势在于处理 then 链。</h4>
<p>假设一个业务，分多个步骤完成，每个步骤都是异步的，而且依赖于上一个步骤的结果。我们仍然用 <code>setTimeout</code> 来模拟异步操作：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回值：time+200</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">takeLongTime</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(time + <span class="number">200</span>), time);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step1</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step1 with <span class="subst">$&#123;time&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> takeLongTime(time);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step2</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step2 with <span class="subst">$&#123;time&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> takeLongTime(time);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step3</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`step3 with <span class="subst">$&#123;time&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> takeLongTime(time);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>promise 语法：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">promiseMethod</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> time = <span class="number">300</span>;</span><br><span class="line">  step1(time)</span><br><span class="line">    .then(<span class="function"><span class="params">time2</span> =&gt;</span> step2(time2))</span><br><span class="line">    .then(<span class="function"><span class="params">time3</span> =&gt;</span> step3(time3))</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`result is <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 任何一个步骤有错误，程序跳转到这里执行。</span></span><br><span class="line">      <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">promiseMethod();</span><br></pre></td></tr></table></figure></p>
<p>async/await 语法：</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncMethod</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> time1 = <span class="number">300</span>;</span><br><span class="line">  <span class="keyword">const</span> time2 = <span class="keyword">await</span> step1(time1);</span><br><span class="line">  <span class="keyword">const</span> time3 = <span class="keyword">await</span> step2(time2);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> step3(time3);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`result is <span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asyncMethod();</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/11/14/Node.js示例_串行:并行流程控制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/11/14/Node.js示例_串行:并行流程控制/" class="post-title-link" itemprop="url">Node.js示例_串行/并行流程控制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-14 16:21:00" itemprop="dateCreated datePublished" datetime="2018-11-14T16:21:00+08:00">2018-11-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:02:16" itemprop="dateModified" datetime="2019-05-01T21:02:16+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Node-js/" itemprop="url" rel="index"><span itemprop="name">Node.js</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文内容：
用简单的示例程序描述 Node.js 串行和并行化流程控制的底层机制。
实际应用开发中以社区中的工具为主。比较流行的有 <a href="https://caolan.github.io/async/index.html" target="_blank" rel="noopener">Async</a>、Step、Seq 等。</p>
</blockquote>
<h1>一、串行化流程控制示例程序</h1>
<ul>
<li>参考：《Node.js 实战（第2版）》</li>
<li>示例程序功能：从一个随机选择的 RSS 预定源中获取一篇文章的标题和 URL，并显示出来。</li>
<li>示例程序的目的：用串行化流程控制让几个异步任务按顺序执行。</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h2>初始化项目</h2>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir listing_217</span><br><span class="line">cd listing_217</span><br><span class="line">npm init -y</span><br><span class="line">npm i request --save</span><br><span class="line">npm i htmlparser --save</span><br></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://github.com/request/request#readme" target="_blank" rel="noopener">request</a> 模块是一个经过简化的 HTTP 客户端，这里用它来获取 RSS 数据。</li>
<li><a href="https://github.com/tautologistics/node-htmlparser#readme" target="_blank" rel="noopener">htmlparser</a> 模块能把原始的 RSS 数据转换成 JavaScript 数据结构。</li>
</ul>
<h2>index.js 开发</h2>
<p>实现方式及原理：把一组任务按预期的执行顺序放到一个数组中。这个数组起到队列的作用：完成一个任务后按顺序从数组中取出下一个。
数组中的每个任务都是一个函数。任务完成后应该调用一个处理器函数，告诉它错误状态和结果。在这一实现中，如果有错误，处理器函数会终止执行；如果没有错误，处理器就从队列中取出下一个任务执行它。</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span><br><span class="line"><span class="keyword">const</span> htmlparser = <span class="built_in">require</span>(<span class="string">'htmlparser'</span>);</span><br><span class="line"><span class="keyword">const</span> configFilename = path.join(__dirname, <span class="string">'./rss_feeds.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【任务一】确保包含 RSS 预定源 URL 列表的文件存在</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForRSSFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  fs.exists(configFilename, (exists) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!exists)</span><br><span class="line">      <span class="comment">// 只要有错误就尽早返回</span></span><br><span class="line">      <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Missing RSS file: <span class="subst">$&#123;configFilename&#125;</span>`</span>));</span><br><span class="line">    next(<span class="literal">null</span>, configFilename);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【任务二】读取并解析包含预定源 URL 的文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readRSSFile</span>(<span class="params">configFilename</span>) </span>&#123;</span><br><span class="line">  fs.readFile(configFilename, (err, feedList) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</span><br><span class="line">    <span class="comment">// 将预定源 URL 列表转换成字符串，然后分隔成一个数组</span></span><br><span class="line">    feedList = feedList</span><br><span class="line">      .toString()</span><br><span class="line">      .replace(<span class="regexp">/^\s+|\s+$/g</span>, <span class="string">''</span>) <span class="comment">// 字符串替换</span></span><br><span class="line">      .split(<span class="string">'\n'</span>); <span class="comment">// split() 方法用于把一个字符串分割成字符串数组。按（\n）分割字符串</span></span><br><span class="line">    <span class="comment">// 从预定源 URL 数组中随机选择一个预定源 URL</span></span><br><span class="line">    <span class="keyword">const</span> random = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * feedList.length);</span><br><span class="line">    next(<span class="literal">null</span>, feedList[random]);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【任务三】向选定的预定源发送 HTTP 请求以获取数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadRSSFeed</span>(<span class="params">feedUrl</span>) </span>&#123;</span><br><span class="line">  request(&#123; <span class="attr">uri</span>: feedUrl &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</span><br><span class="line">    <span class="keyword">if</span> (res.statusCode !== <span class="number">200</span>)</span><br><span class="line">      <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Abnormal response status code'</span>));</span><br><span class="line">    next(<span class="literal">null</span>, body);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【任务四】将预定源数据解析到一个条目数组中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseRSSFeed</span>(<span class="params">rss</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> handler = <span class="keyword">new</span> htmlparser.RssHandler();</span><br><span class="line">  <span class="keyword">const</span> parser = <span class="keyword">new</span> htmlparser.Parser(handler);</span><br><span class="line">  parser.parseComplete(rss);</span><br><span class="line">  <span class="keyword">if</span> (!handler.dom.items.length)</span><br><span class="line">    <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No RSS items found'</span>));</span><br><span class="line">  <span class="comment">// 如果有数据，显示第一个预定源条目的标题和 URL</span></span><br><span class="line">  <span class="keyword">const</span> item = handler.dom.items.shift();</span><br><span class="line">  <span class="built_in">console</span>.log(item.title);</span><br><span class="line">  <span class="built_in">console</span>.log(item.link);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把所有要做的任务按执行顺序添加到一个数组中</span></span><br><span class="line"><span class="keyword">const</span> tasks = [</span><br><span class="line">  checkForRSSFile,</span><br><span class="line">  readRSSFile,</span><br><span class="line">  downloadRSSFeed,</span><br><span class="line">  parseRSSFeed,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 负责执行任务的 next 函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err; <span class="comment">// 如果任务出错，则中断程序，抛出异常。</span></span><br><span class="line">  <span class="comment">// shift()：把数组的第一个元素从其中删除，并返回第一个元素的值。</span></span><br><span class="line">  <span class="keyword">const</span>  currentTask = tasks.shift(); <span class="comment">// 从任务数组中取出下一个任务。</span></span><br><span class="line">  <span class="keyword">if</span> (currentTask) &#123;</span><br><span class="line">    currentTask(result); <span class="comment">// 执行当前任务</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">next(); <span class="comment">// 开始任务的串行化执行。</span></span><br></pre></td></tr></table></figure></p>
<p>串行化流程控制的本质：在需要的时候让回调进场，而不是简单地把它们嵌套起来。</p>
<h2>订阅源文件 rss_feeds.txt</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://blog.nodejs.org/feed/</span><br><span class="line">http://blog.npmjs.org/rss</span><br></pre></td></tr></table></figure></p>
<h2>运行实例效果：</h2>
<p><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Running] node "/Users/andy/Desktop/application/listing_217/app/index.js"</span><br><span class="line">![CDATA[Node v11.1.0 (Current)]]</span><br><span class="line">https://nodejs.org/en/blog/release/v11.1.0</span><br></pre></td></tr></table></figure></p>
<h1>二、并行化流程控制示例程序</h1>
<p>为了让异步任务并行执行，仍然是要把任务放到数组中，但任务的存放顺序无关紧要。每个任务都应该调用处理器函数增加已完成任务的计数值。当所有任务都完成后，处理器函数应该执行后续的逻辑。</p>
<ul>
<li>参考《Node.js 实战（第2版）》</li>
<li>示例程序功能：读取几个文本文件的内容，并输出单词在整个文件中出现的次数。</li>
<li>示例程序目的：让异步任务并行执行</li>
</ul>
<h2>初始化项目</h2>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir listing_218</span><br><span class="line">cd listing_218</span><br><span class="line">mkdir text</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure></p>
<h2>word_count.js 开发</h2>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> tasks = [];</span><br><span class="line"><span class="keyword">const</span> wordCounts = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> filesDir = <span class="string">'./text'</span>;</span><br><span class="line"><span class="keyword">let</span> completedTasks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查并行任务是否完成</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkIfComplete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  completedTasks++;</span><br><span class="line">  <span class="keyword">if</span> (completedTasks === tasks.length) &#123;</span><br><span class="line">    <span class="comment">// 当所有任务全部完成后，列出文件中用到的每个单词以及用了多少次。</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> index <span class="keyword">in</span> wordCounts) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;index&#125;</span>: <span class="subst">$&#123;wordCounts[index]&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加单次计数次数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addWordCount</span>(<span class="params">word</span>) </span>&#123;</span><br><span class="line">  wordCounts[word] = (wordCounts[word]) ? wordCounts[word] + <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">countWordsInText</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> words = text</span><br><span class="line">    .toString()</span><br><span class="line">    .toLowerCase()</span><br><span class="line">    .split(<span class="regexp">/\w+/</span>)</span><br><span class="line">    .sort();</span><br><span class="line">  </span><br><span class="line">  words</span><br><span class="line">    .filter(<span class="function"><span class="params">word</span> =&gt;</span> word)</span><br><span class="line">    .forEach(<span class="function"><span class="params">word</span> =&gt;</span> addWordCount(word)); <span class="comment">// 对文本中出现的单次计数</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs.readdir(filesDir, (err, files) =&gt; &#123; <span class="comment">//得出 text 目录中的文件列表</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  files.forEach(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 定义处理每个文件的任务。</span></span><br><span class="line">    <span class="comment">// 每个任务中都会调用一个异步读取文件的函数并对文件中使用的单次计数。</span></span><br><span class="line">    <span class="keyword">const</span> task = (<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        fs.readFile(file, (err, text) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">          countWordsInText(text);</span><br><span class="line">          checkIfComplete();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;)(<span class="string">`<span class="subst">$&#123;filesDir&#125;</span>/<span class="subst">$&#123;file&#125;</span>`</span>);</span><br><span class="line">    task.push(task); <span class="comment">// 把所有任务都添加到函数调用数组中。</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  tasks.forEach(<span class="function"><span class="params">task</span> =&gt;</span> task()); <span class="comment">// 开始并行执行所有任务。</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png" alt="独木舟的木">
            
              <p class="site-author-name" itemprop="name">独木舟的木</p>
              <div class="site-description motion-element" itemprop="description">有时候阳光很好 有时候阳光很暗</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">315</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Andy0570" title="GitHub &rarr; https://github.com/Andy0570" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:andywhm@163.com" title="E-Mail &rarr; mailto:andywhm@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">独木舟的木</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">2.3m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">34:07</span>
  
</div>



  <span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
  <span class="post-meta-divider">|</span>

  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





  



  






  



  
    
    
      
    
  
  <script color="17,119,176" opacity="0.5" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>













  
  <script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/fastclick@1/lib/fastclick.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/jquery-lazyload@1/jquery.lazyload.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  
  
  
    
  

  
    
      
    
  

  
  
  
    <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
    <script>
      
        window.addEventListener('load', () => {
      
        quicklink({
          timeout: 3000,
          priority: true,
          ignores: [uri => uri.includes('#'),uri => uri == 'https://andy0570.com/page/5/',]
        });
      
        });
      
    </script>
  


  



  



  
  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">

  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.js"></script>
  

  <script src="/js/algolia-search.js?v=7.1.0"></script>



  

  

  

  

  

  

  

  

  

  
  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script>pangu.spacingPage();</script>


  
  
  
    
  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-bookmark@1/bookmark.min.js"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script>


  

  

  
  
</body>
</html>
