<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
      
    
    
      
    
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">



  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/han-css@3/dist/han.min.css">













  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">







  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/panda/apple-touch-icon.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/panda/favicon-32x32.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/panda/favicon-16x16.png?v=7.1.0">


  <link rel="mask-icon" href="/images/panda/safari-pinned-tab.svg?v=7.1.0" color="#222">


  <link rel="manifest" href="/images/panda/site.webmanifest">


  <meta name="msapplication-config" content="/images/panda/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: true,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '0E2AON8EZF',
      apiKey: '22fbefd84c8343239f5c04365b9728de',
      indexName: 'MyBlogPlatform',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="有时候阳光很好 有时候阳光很暗">
<meta name="keywords" content="独木舟的木">
<meta property="og:type" content="website">
<meta property="og:title" content="独木舟的木">
<meta property="og:url" content="https://andy0570.com/page/12/index.html">
<meta property="og:site_name" content="独木舟的木">
<meta property="og:description" content="有时候阳光很好 有时候阳光很暗">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="独木舟的木">
<meta name="twitter:description" content="有时候阳光很好 有时候阳光很暗">



  <link rel="alternate" href="/atom.xml" title="独木舟的木" type="application/atom+xml">



  
  
  <link rel="canonical" href="https://andy0570.com/page/12/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>独木舟的木</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8229a094facca297f211d61323fd9fde";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <a href="https://github.com/andy0570" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">独木舟的木</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">iOS Developer</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">14</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">37</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">316</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/andy0570" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/01/10/iOS 模型层的两种设计模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/01/10/iOS 模型层的两种设计模式/" class="post-title-link" itemprop="url">iOS 模型层的两种设计模式</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-10 15:13:00" itemprop="dateCreated datePublished" datetime="2018-01-10T15:13:00+08:00">2018-01-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 20:51:50" itemprop="dateModified" datetime="2019-05-01T20:51:50+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075319.jpg" alt="图片来自Pixabay"></p>
<p>&lt;!-- more --&gt;</p>
<p>模型层（Model）的两种设计方案：</p>
<ul>
<li>使用自定义的初始化器；</li>
<li>使用生成器模式；</li>
</ul>
<h3>一、自定义初始化器</h3>
<p>这是设计模型层的常用方式。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// ---------------------------------------------------</span><br><span class="line">//  HQLUser.h</span><br><span class="line">// ---------------------------------------------------</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface HQLUser : NSObject</span><br><span class="line"></span><br><span class="line">// 属性的设置：向外层暴露的属性尽量设置为不可变(immutable)、只读（readonly） </span><br><span class="line">@property (nonatomic, copy, readonly) NSString *userID;</span><br><span class="line">@property (nonatomic, copy, readonly) NSString *firstName;</span><br><span class="line">@property (nonatomic, copy, readonly) NSString *lastName;</span><br><span class="line">@property (nonatomic, copy, readonly) NSString *gender;</span><br><span class="line">@property (nonatomic, copy, readonly) NSDate *dateOfBirth;</span><br><span class="line">@property (nonatomic, copy, readonly) NSArray *albums;</span><br><span class="line"></span><br><span class="line">// 指定初始化方法</span><br><span class="line">- (instancetype)initWithUserID:(NSString *)userID</span><br><span class="line">                     firstName:(NSString *)firstName</span><br><span class="line">                      lastName:(NSString *)lastName</span><br><span class="line">                        gender:(NSString *)gender</span><br><span class="line">                   dateOfBirth:(NSDate *)dateOfBirth</span><br><span class="line">                        albums:(NSArray *)albums;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// ---------------------------------------------------</span><br><span class="line">//  HQLUser.m</span><br><span class="line">// ---------------------------------------------------</span><br><span class="line">#import &quot;HQLUser.h&quot;</span><br><span class="line"></span><br><span class="line">@interface HQLUser ()</span><br><span class="line"></span><br><span class="line">// 在内部将属性重新封装为 readwrite，这样属性在内部就是可读可写的。</span><br><span class="line">@property (nonatomic, copy, readwrite) NSString *userID;</span><br><span class="line">@property (nonatomic, copy, readwrite) NSString *firstName;</span><br><span class="line">@property (nonatomic, copy, readwrite) NSString *lastName;</span><br><span class="line">@property (nonatomic, copy, readwrite) NSString *gender;</span><br><span class="line">@property (nonatomic, copy, readwrite) NSDate *dateOfBirth;</span><br><span class="line">@property (nonatomic, copy, readwrite) NSArray *albums;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation HQLUser</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithUserID:(NSString *)userID</span><br><span class="line">                     firstName:(NSString *)firstName</span><br><span class="line">                      lastName:(NSString *)lastName</span><br><span class="line">                        gender:(NSString *)gender</span><br><span class="line">                   dateOfBirth:(NSDate *)dateOfBirth</span><br><span class="line">                        albums:(NSArray *)albums &#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        _userID      = [userID copy];</span><br><span class="line">        _firstName   = [firstName copy];</span><br><span class="line">        _lastName    = [lastName copy];</span><br><span class="line">        _gender      = [gender copy];</span><br><span class="line">        _dateOfBirth = dateOfBirth;</span><br><span class="line">        _albums      = [albums copy];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    @throw [NSException exceptionWithName:@&quot;Method Undefined&quot;</span><br><span class="line">                                   reason:@&quot;Use Designated Initializer Method&quot;</span><br><span class="line">                                 userInfo:nil];</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>调用如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 使用自定义的初始化器    </span><br><span class="line">HQLUser *user = [[HQLUser alloc] initWithUserID:@&quot;1214138&quot; firstName:@&quot;Hello&quot; lastName:@&quot;Kitty&quot; gender:@&quot;man&quot; dateOfBirth:[NSDate date] albums:[NSArray array]];</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>💡
指定初始化方法和非指定初始化方法可以用宏来进行标记：</p>
<ul>
<li><strong>NS_DESIGNATED_INITIALIZER</strong></li>
<li><strong>NS_UNAVAILABLE</strong></li>
</ul>
</blockquote>
<p>这种设计模式的缺点：</p>
<ol>
<li>如果类包含的属性很多，指定初始化方法的方法名会很长、非指定初始化方法的个数将会很多；</li>
<li>向下兼容问题：如果新增一个属性，就需要重构指定初始化方法，因此，新版模型无法实现向下兼容；</li>
</ol>
<h3>二、生成器模式</h3>
<p>需要引入外部类进行管理。生成器有setter方法，也需要提供与模型数据完全一致的存储。生成器最终也会使用初始化器。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">// ---------------------------------------------------</span><br><span class="line">//  HPUser.h</span><br><span class="line">// ---------------------------------------------------</span><br><span class="line"></span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@class HPUserBuilder;</span><br><span class="line">@class HPUser;</span><br><span class="line"></span><br><span class="line">typedef void(^HPUserBuilderBlock)(HPUserBuilder *builder);</span><br><span class="line"></span><br><span class="line">@interface HPUserBuilder : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString *username;</span><br><span class="line">@property (nonatomic, copy) NSString *gender;</span><br><span class="line">@property (nonatomic, copy) NSDate *dateOfBirth;</span><br><span class="line"></span><br><span class="line">- (HPUser *)build;</span><br><span class="line">- (HPUserBuilder *)username:(NSString *)username;</span><br><span class="line">- (HPUserBuilder *)gender:(NSString *)gender;</span><br><span class="line">- (HPUserBuilder *)dateOfBirth:(NSDate *)dateOfBirth;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface HPUser : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString *username;</span><br><span class="line">@property (nonatomic, copy) NSString *gender;</span><br><span class="line">@property (nonatomic, copy) NSDate *dateOfBirth;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithBuilder:(HPUserBuilder *)builder;</span><br><span class="line">- (instancetype)initWithBlock:(HPUserBuilderBlock)block;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// ---------------------------------------------------</span><br><span class="line">//  HPUser.m</span><br><span class="line">// ---------------------------------------------------</span><br><span class="line"></span><br><span class="line">#import &quot;HPUser.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation HPUserBuilder</span><br><span class="line"></span><br><span class="line">- (HPUser *)build &#123;</span><br><span class="line">    // 构造器的初始化方法，调用的还是模型层的指定初始化方法</span><br><span class="line">    return [[HPUser alloc] initWithBuilder:self];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (HPUserBuilder *)username:(NSString *)username &#123;</span><br><span class="line">    _username = [username copy];</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (HPUserBuilder *)gender:(NSString *)gender &#123;</span><br><span class="line">    _gender = [gender copy];</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (HPUserBuilder *)dateOfBirth:(NSDate *)dateOfBirth &#123;</span><br><span class="line">    _dateOfBirth = dateOfBirth;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation HPUser</span><br><span class="line"></span><br><span class="line">// 指定初始化方法</span><br><span class="line">- (instancetype)initWithBuilder:(HPUserBuilder *)builder &#123;</span><br><span class="line">    if (self = [super init]) &#123;</span><br><span class="line">        _username = builder.username;</span><br><span class="line">        _gender = builder.gender;</span><br><span class="line">        _dateOfBirth = builder.dateOfBirth;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithBlock:(HPUserBuilderBlock)block &#123;</span><br><span class="line">    HPUserBuilder *builder = [[HPUserBuilder alloc] init];</span><br><span class="line">    block(builder);</span><br><span class="line">    // 返回的是构造器的初始化方法</span><br><span class="line">    return [builder build];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>生产器模式解决了自定义初始化方法的两个缺点，它的方法名不会很长、也解决了向下的兼容性问题，调用如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 1</span><br><span class="line">HPUserBuilder *builder = [[[[[HPUserBuilder alloc] init] username:@&quot;username&quot;] gender:@&quot;man&quot;] dateOfBirth:[NSDate date]];</span><br><span class="line">HPUser *usr = [[HPUser alloc] initWithBuilder:builder];</span><br><span class="line"></span><br><span class="line">// 2</span><br><span class="line">HPUser *user = [[HPUser alloc] initWithBlock:^(HPUserBuilder *builder) &#123;</span><br><span class="line">    builder.username    = @&quot;username&quot;;</span><br><span class="line">    builder.gender      = @&quot;man&quot;;</span><br><span class="line">    builder.dateOfBirth = [NSDate date];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p><strong>生成器模式</strong> 其实就是在普通的 Model 层之上又封装了一个中间层，这个中间类的属性和 Model 层是一样的。<strong>本质上到最后还是要去调用 Model 层的指定初始化方法</strong>。</p>
<p>使用指南：</p>
<ol>
<li>当你的 Model 层中的属性很多、或者后期很有可能新增其他属性，那么使用生成器模式可以解决向后的兼容性问题（Model 层新增属性后，使用了该 Model 类的其他地方不需要因为 Model 类指定初始化方法的改变而跟着修改）。</li>
<li>当你的 Model 层中的属性不是很多，后期也不大可能新增属性时，不太适合使用生成器模式，这种模式几乎要写原本 2 倍的代码量，有种为了封装而封装的感觉，会延长我们的开发周期，降低开发效率，提高开发成本。</li>
</ol>
<h3>总结</h3>
<p>生成器模式可以引用一句经典的话来总结：</p>
<blockquote>
<p>All problems in computer science can be solved by another level of indirection.——Butler Lampson</p>
<p>“计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决”</p>
</blockquote>
<h3>参考</h3>
<ul>
<li>Gaurav Vaish. 高性能iOS应用开发 [M]. 北京：人民邮电出版社，2017. 102-105</li>
<li><a href="http://holko.pl/2015/05/12/immutable-object-initialization/" target="_blank" rel="noopener">Improving Immutable Object Initialization in Objective-C</a></li>
<li><a href="http://mrpeak.cn/blog/ios-init/" target="_blank" rel="noopener">iOS 创建对象的姿势 @MrPeak</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/01/09/iOS 跟踪内存、CPU、电池电量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/01/09/iOS 跟踪内存、CPU、电池电量/" class="post-title-link" itemprop="url">iOS 跟踪内存、CPU、电池电量</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-09 11:00:00" itemprop="dateCreated datePublished" datetime="2018-01-09T11:00:00+08:00">2018-01-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 20:51:30" itemprop="dateModified" datetime="2019-05-01T20:51:30+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075036.png" alt="图片来自Pixabay"></p>
<p>&lt;!-- more --&gt;</p>
<h3>跟踪可用和已用的内存方法</h3>
<blockquote>
<p>💡在出现低内存警告时对应用进行埋点，包括内存的使用及统计信息，并在应用重新运行时将这些信息上报给服务器。使用这些信息来识别出应用发生内存溢出的常见场景和边缘情况。</p>
</blockquote>
<h4>示例代码</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// HPMemoryAnalyzer.h</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 跟踪可用和已用的内存</span><br><span class="line"> */</span><br><span class="line">@interface HPMemoryAnalyzer : NSObject</span><br><span class="line"></span><br><span class="line">vm_size_t getUsedMemory();</span><br><span class="line">vm_size_t getFreeMemory();</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// HPMemoryAnalyzer.m</span><br><span class="line">#import &quot;HPMemoryAnalyzer.h&quot;</span><br><span class="line">#import &lt;mach/mach.h&gt;</span><br><span class="line"></span><br><span class="line">vm_size_t getUsedMemory() &#123;</span><br><span class="line">    task_basic_info_data_t info;</span><br><span class="line">    mach_msg_type_number_t size = sizeof(info);</span><br><span class="line">    kern_return_t kerr = task_info(mach_task_self(), TASK_BASIC_INFO, (task_info_t)&amp;info, &amp;size);</span><br><span class="line">    </span><br><span class="line">    if (kerr == KERN_SUCCESS) &#123;</span><br><span class="line">        return info.resident_size;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vm_size_t getFreeMemory() &#123;</span><br><span class="line">    mach_port_t host = mach_host_self();</span><br><span class="line">    mach_msg_type_number_t size = sizeof(vm_statistics_data_t) / sizeof(integer_t);</span><br><span class="line">    vm_size_t pagesize;</span><br><span class="line">    vm_statistics_data_t vmstat;</span><br><span class="line">    </span><br><span class="line">    host_page_size(host, &amp;pagesize);</span><br><span class="line">    host_statistics(host, HOST_VM_INFO, (host_info_t)&amp;vmstat, &amp;size);</span><br><span class="line">    </span><br><span class="line">    return vmstat.free_count * pagesize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@implementation HPMemoryAnalyzer</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>另外，<a href="https://github.com/ibireme/YYKit" target="_blank" rel="noopener">YYKit</a> 框架中也集成了关于获取应用内存使用量、CPU使用量的相关方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// UIApplication+YYAdd.h</span><br><span class="line"></span><br><span class="line">/// Current thread real memory used in byte. (-1 when error occurs)</span><br><span class="line">@property (nonatomic, readonly) int64_t memoryUsage;</span><br><span class="line"></span><br><span class="line">/// Current thread CPU usage, 1.0 means 100%. (-1 when error occurs)</span><br><span class="line">@property (nonatomic, readonly) float cpuUsage;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// UIApplication+YYAdd.m</span><br><span class="line">- (int64_t)memoryUsage &#123;</span><br><span class="line">    struct task_basic_info info;</span><br><span class="line">    mach_msg_type_number_t size = sizeof(info);</span><br><span class="line">    kern_return_t kern = task_info(mach_task_self(), TASK_BASIC_INFO, (task_info_t)&amp;info, &amp;size);</span><br><span class="line">    if (kern != KERN_SUCCESS) return -1;</span><br><span class="line">    return info.resident_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (float)cpuUsage &#123;</span><br><span class="line">    kern_return_t kr;</span><br><span class="line">    task_info_data_t tinfo;</span><br><span class="line">    mach_msg_type_number_t task_info_count;</span><br><span class="line">    </span><br><span class="line">    task_info_count = TASK_INFO_MAX;</span><br><span class="line">    kr = task_info(mach_task_self(), TASK_BASIC_INFO, (task_info_t)tinfo, &amp;task_info_count);</span><br><span class="line">    if (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    thread_array_t thread_list;</span><br><span class="line">    mach_msg_type_number_t thread_count;</span><br><span class="line">    </span><br><span class="line">    thread_info_data_t thinfo;</span><br><span class="line">    mach_msg_type_number_t thread_info_count;</span><br><span class="line">    </span><br><span class="line">    thread_basic_info_t basic_info_th;</span><br><span class="line">    </span><br><span class="line">    kr = task_threads(mach_task_self(), &amp;thread_list, &amp;thread_count);</span><br><span class="line">    if (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    long tot_sec = 0;</span><br><span class="line">    long tot_usec = 0;</span><br><span class="line">    float tot_cpu = 0;</span><br><span class="line">    int j;</span><br><span class="line">    </span><br><span class="line">    for (j = 0; j &lt; thread_count; j++) &#123;</span><br><span class="line">        thread_info_count = THREAD_INFO_MAX;</span><br><span class="line">        kr = thread_info(thread_list[j], THREAD_BASIC_INFO,</span><br><span class="line">                         (thread_info_t)thinfo, &amp;thread_info_count);</span><br><span class="line">        if (kr != KERN_SUCCESS) &#123;</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        basic_info_th = (thread_basic_info_t)thinfo;</span><br><span class="line">        </span><br><span class="line">        if (!(basic_info_th-&gt;flags &amp; TH_FLAGS_IDLE)) &#123;</span><br><span class="line">            tot_sec = tot_sec + basic_info_th-&gt;user_time.seconds + basic_info_th-&gt;system_time.seconds;</span><br><span class="line">            tot_usec = tot_usec + basic_info_th-&gt;system_time.microseconds + basic_info_th-&gt;system_time.microseconds;</span><br><span class="line">            tot_cpu = tot_cpu + basic_info_th-&gt;cpu_usage / (float)TH_USAGE_SCALE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kr = vm_deallocate(mach_task_self(), (vm_offset_t)thread_list, thread_count * sizeof(thread_t));</span><br><span class="line">    assert(kr == KERN_SUCCESS);</span><br><span class="line">    </span><br><span class="line">    return tot_cpu;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除了 <strong>UIApplication+YYAdd</strong> 中这两个方法，你会发现 <strong>UIDevice+YYAdd</strong> 中还有更丰富的方法，包括获取设备信息、磁盘空间、内存信息、CPU信息学。</p>
<h3>电池电量与代码感知</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075038.gif" alt></p>
<p>一个智能的应用会考虑到电池的电量和自身的状态，从而决定是否要真正执行资源密集消耗型的操作。另外一个有价值的点是对充电的判断，确定设备是否处于充电状态。
例如：每次更新iOS系统时，系统会判断当前设备电量是否低于50%，如果低于这个值，系统是不会执行更新系统的任务的，它会提示用户先充电之后再更新系统。</p>
<h4>示例代码</h4>
<p>传入执行特定操作需要的最低电量级别。该级别是浮点数，范围在 0～100 之间（100表示电池完全充满）
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">BOOL</span>)shouldProceedWithMinLevel:(<span class="keyword">int</span>)minLevel</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">UIDevice</span> *device = [<span class="built_in">UIDevice</span> currentDevice];</span><br><span class="line">	device.batteryMonitoringEnabled = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UIDeviceBatteryState</span> state = device.batteryState;</span><br><span class="line">	<span class="keyword">if</span>(state == <span class="built_in">UIDeviceBatteryStateCharging</span> || state == <span class="built_in">UIDeviceBatteryStateFull</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> batteryLevel = (<span class="keyword">int</span>) (device.batteryLevel * <span class="number">100</span>);</span><br><span class="line">	<span class="keyword">if</span>(batteryLevel &gt;= minLevel) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>谨慎使用电量的最佳实践</h3>
<ul>
<li>最小化硬件使用。换句话说，尽可能晚地与硬件打交道，并且一旦完成任务立即结束使用。</li>
<li>在进行密集型任务前，检查电池电量和充电状态。</li>
<li>在电量低时，提示用户是否确定要执行任务，并在用户同意后再执行。</li>
<li>或提供设置的选项，允许用户定义电量的阈值，以便在执行密集型操作前提示用户。</li>
</ul>
<h3>参考</h3>
<ul>
<li>Gaurav Vaish. 高性能iOS应用开发 [M]. 北京：人民邮电出版社，2017. 66-67</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2018/01/04/iOS 编程：一次截取字符串日期算法优化历程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/01/04/iOS 编程：一次截取字符串日期算法优化历程/" class="post-title-link" itemprop="url">iOS 编程：一次截取字符串日期算法优化历程</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-04 11:09:00" itemprop="dateCreated datePublished" datetime="2018-01-04T11:09:00+08:00">2018-01-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-28 15:59:34" itemprop="dateModified" datetime="2019-04-28T15:59:34+08:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-C-编程/" itemprop="url" rel="index"><span itemprop="name">Objective-C 编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.9k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/075354.jpg" alt></p>
<p>&lt;!-- more --&gt;</p>
<h3>问题分析</h3>
<ul>
<li>需求：在UI页面上显示起止年月。</li>
<li>后台服务器返回的原始字符串：<code>201709—————201709</code>，在后台老大哥的眼里，这种格式当然是完美的🤷🏻‍♂️，可在前端眼里，如果直接把酱紫的字符串直接显示在页面上，显示粗糙，又难读，用户体验非常糟糕，连我这样毫无审美感的程序猿都看不下去了好吧。</li>
<li>优化后显示字符串：<code>2017年9月 ⇀ 2017年9月</code>。</li>
</ul>
<h3>最初的方法：用正则表达式匹配，再截取，可能存在边界溢出导致崩溃。</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// 正则表达式</span><br><span class="line">- (BOOL)validateExpensePeriod &#123;</span><br><span class="line">    NSString *regex = @&quot;^\\d&#123;6&#125;\\D+\\d&#123;6&#125;$&quot;;</span><br><span class="line">    NSPredicate *predicate = [NSPredicate predicateWithFormat:@&quot;SELF MATCHES %@&quot;,regex];</span><br><span class="line">    return [predicate evaluateWithObject:_expensePeriod];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 输入日期格式</span><br><span class="line">- (NSDateFormatter *)inputDateFormatter &#123;</span><br><span class="line">    if (!_inputDateFormatter) &#123;</span><br><span class="line">        _inputDateFormatter = [[NSDateFormatter alloc] init];</span><br><span class="line">        _inputDateFormatter.dateFormat = @&quot;yyyyMM&quot;; // 201710</span><br><span class="line">    &#125;</span><br><span class="line">    return _inputDateFormatter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 输出日期格式</span><br><span class="line">- (NSDateFormatter *)outputDateFormatter &#123;</span><br><span class="line">    if (!_outputDateFormatter) &#123;</span><br><span class="line">        _outputDateFormatter = [[NSDateFormatter alloc] init];</span><br><span class="line">        _outputDateFormatter.dateFormat = @&quot;yyyy年MMM&quot;; // 2017年10月</span><br><span class="line">    &#125;</span><br><span class="line">    return _outputDateFormatter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">// 因为后台有时候会返回预料之外的字符串，如果仍按照正常逻辑截取会导致边界溢出崩溃——要背锅的哦</span><br><span class="line">NSUInteger strLength = _expensePeriod.length;</span><br><span class="line">if (strLength &lt; 16 || ![self validateExpensePeriod]) &#123;</span><br><span class="line">    return _expensePeriod;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 截取字符串中的开始日期和结束日期</span><br><span class="line">NSString *beginDateStr = [_expensePeriod substringToIndex:6];</span><br><span class="line">NSString *endDateStr = [_expensePeriod substringFromIndex:strLength-6];    </span><br><span class="line"></span><br><span class="line">// 将字符串转换为</span><br><span class="line">NSDate *beginDate = [self.inputDateFormatter dateFromString:beginDateStr];</span><br><span class="line">NSDate *endDate   = [self.inputDateFormatter dateFromString:endDateStr];</span><br><span class="line">if ((beginDate == nil) || (endDate == nil)) &#123;</span><br><span class="line">    return _expensePeriod;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    NSString *formartDateStr = [NSString stringWithFormat:@&quot;%@ ⇀ %@&quot;,</span><br><span class="line">                                [self.outputDateFormatter stringFromDate:beginDate],</span><br><span class="line">                                [self.outputDateFormatter stringFromDate:endDate]];</span><br><span class="line">    return formartDateStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>优化方法，正则表达式返回所有匹配结果的范围，自动截取，实现成功，方法太过复杂</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// 标签文本字符串</span><br><span class="line">- (NSString *)expensePeriodLabelText &#123;</span><br><span class="line">    // 优化显示起止日期 201709----201709</span><br><span class="line">    NSUInteger strLength = _expensePeriod.length;</span><br><span class="line">    __block NSString *beginDateStr;</span><br><span class="line">    __block NSString *endDateStr;</span><br><span class="line">    </span><br><span class="line">    // 正则表达式匹配结果</span><br><span class="line">    NSString *regex = @&quot;\\d&#123;6&#125;&quot;;</span><br><span class="line">    NSRegularExpression *regularExpression = [NSRegularExpression regularExpressionWithPattern:regex options:NSRegularExpressionCaseInsensitive error:nil];</span><br><span class="line">  	// 正则表达式匹配，将结果返回到数组</span><br><span class="line">    NSArray *matches = [regularExpression matchesInString:_expensePeriod options:NSMatchingReportProgress range:NSMakeRange(0, strLength)];</span><br><span class="line">    if (matches.count &gt; 0 &amp;&amp; matches.count == 2) &#123;</span><br><span class="line">        [matches enumerateObjectsUsingBlock:^(NSTextCheckingResult *obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">            // 用匹配结果的范围去截取字符串</span><br><span class="line">            if (idx == 0) &#123;</span><br><span class="line">                beginDateStr = [_expensePeriod substringWithRange:obj.range];</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                endDateStr = [_expensePeriod substringWithRange:obj.range];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        return _expensePeriod;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSDate *beginDate = [self.inputDateFormatter dateFromString:beginDateStr];</span><br><span class="line">    NSDate *endDate   = [self.inputDateFormatter dateFromString:endDateStr];</span><br><span class="line">    if ((beginDate == nil) || (endDate == nil)) &#123;</span><br><span class="line">        return _expensePeriod;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        NSString *formartDateStr = [NSString stringWithFormat:@&quot;%@ ⇀ %@&quot;,</span><br><span class="line">                                    [self.outputDateFormatter stringFromDate:beginDate],</span><br><span class="line">                                    [self.outputDateFormatter stringFromDate:endDate]];</span><br><span class="line">        return formartDateStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>再优化方法，使用 YYKit 方法，方法相对简洁</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)expensePeriodLabelText &#123;</span><br><span class="line">    __block NSMutableArray *mutableArray = [NSMutableArray arrayWithCapacity:2];</span><br><span class="line">    [_expensePeriod enumerateRegexMatches:@&quot;\\d&#123;6&#125;&quot; options:NSRegularExpressionCaseInsensitive usingBlock:^(NSString * _Nonnull match, NSRange matchRange, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        [mutableArray addObject:match];</span><br><span class="line">    &#125;];</span><br><span class="line">    if (mutableArray.count != 2) &#123;</span><br><span class="line">        return _expensePeriod;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSDate *beginDate = [self.inputDateFormatter dateFromString:mutableArray.firstObject];</span><br><span class="line">    NSDate *endDate   = [self.inputDateFormatter dateFromString:mutableArray.lastObject];</span><br><span class="line">    if (!beginDate || !endDate) &#123;</span><br><span class="line">        return _expensePeriod;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSString *formartDateStr = [NSString stringWithFormat:@&quot;%@ ⇀ %@&quot;,</span><br><span class="line">                                [self.outputDateFormatter stringFromDate:beginDate],</span><br><span class="line">                                [self.outputDateFormatter stringFromDate:endDate]];</span><br><span class="line">    return formartDateStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的效果：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2648731-dd9478bfaa14c70d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/29/iOS 编程：星级评价功能的两种实现方式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/29/iOS 编程：星级评价功能的两种实现方式/" class="post-title-link" itemprop="url">iOS 编程：星级评价功能的两种实现方式</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-29 13:17:00" itemprop="dateCreated datePublished" datetime="2017-12-29T13:17:00+08:00">2017-12-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:51:11" itemprop="dateModified" datetime="2019-05-01T21:51:11+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">11k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">10 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073232.jpg" alt="图片来自 Pixabay"></p>
<p>&lt;!-- more --&gt;</p>
<p>如何在 iOS 应用上用自定义视图实现星级评分功能呢？最近研究学习了两个实现方法，现总结如下：</p>
<h2>一、实现方式一</h2>
<p>参考 Ray Wenderlich 系列教程：</p>
<p><a href="https://www.raywenderlich.com/1768/uiview-tutorial-for-ios-how-to-make-a-custom-uiview-in-ios-5-a-5-star-rating-view" target="_blank" rel="noopener">UIView Tutorial for iOS: How To Make a Custom UIView in iOS 5: A 5 Star Rating View</a></p>
<h3>1.Demo 示例</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073239.gif" alt></p>
<h3>2.实现的功能：</h3>
<ol>
<li>可任意设置星星数量;</li>
<li>可以设置星星是否可编辑、星星的左边距、星星之间的间隔等；</li>
<li>整星评价和半星评价；</li>
<li><strong>不仅仅是点击触摸屏幕评分，还可以实现手指按住屏幕滑动评分;</strong></li>
<li>用 Delegate 方式实现回调；</li>
</ol>
<h3>3.视图层级</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073245.jpg" alt="视图层级"></p>
<p>视图的层级比较简单，一个自定义 UIView 子类对象，上面添加了 5 个星星图片对象，即 UIImageView 对象。</p>
<p>评分值修改时，我们需要遍历这5个 UIImageView 对象，并对他们的图片进行相应的更改。</p>
<h3>4.实现原理：根据 rating 值遍历设置每个星星图案</h3>
<p>讲解一下大概的实现思路，具体内容可以参考源码：<a href="https://github.com/Andy0570/CustomView" target="_blank" rel="noopener">GitHub</a></p>
<ol>
<li>首先需要三张星星图片：空星图片、半星图片、全星图片：</li>
</ol>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073248.jpg" alt="kermit_empty"><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073250.jpg" alt="kermit_half"><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073252.jpg" alt="kermit_full"></p>
<ol start="2">
<li>
<p>初始化设置最大评分数 <code>maxRating</code>（即总共的星星数量）时，就把所有的 imageView 添加到视图上，然后发送 <code>[self setNeedsLayout]</code> 方法让系统布局子视图（即 <code>layoutSubviews</code>），计算每个 imageView 的位置和大小：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> 设置最大评分数，它决定了我们会有多少个 UIImageView 子视图</span><br><span class="line"> 做了两件事：</span><br><span class="line"> 1.添加图片：根据最大评分数初始化图片数量，移除旧图片，添加新图片。</span><br><span class="line"> 2.刷新UI，设置图片大小：调用 setNeedsLayout 方法后，系统会调用 layoutSubviews 方法来设置每个图片的位置和大小。</span><br><span class="line"> */</span><br><span class="line">- (void)setMaxRating:(int)maxRating &#123;</span><br><span class="line">    _maxRating = maxRating;</span><br><span class="line">    </span><br><span class="line">    // 移除所有旧的图片</span><br><span class="line">    for (int i = 0; i &lt; self.imageViews.count; i++) &#123;</span><br><span class="line">        UIImageView *imageView = (UIImageView *)[self.imageViews objectAtIndex:i];</span><br><span class="line">        [imageView removeFromSuperview];</span><br><span class="line">    &#125;</span><br><span class="line">    [self.imageViews removeAllObjects];</span><br><span class="line">    </span><br><span class="line">    // 重新添加新的图片</span><br><span class="line">    for (int i = 0; i &lt; maxRating; i++) &#123;</span><br><span class="line">        UIImageView *imageView = [[UIImageView alloc] init];</span><br><span class="line">        imageView.contentMode = UIViewContentModeScaleAspectFit;</span><br><span class="line">        [self.imageViews addObject:imageView];</span><br><span class="line">        [self addSubview:imageView];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 重新布局、刷新UI</span><br><span class="line">    [self setNeedsLayout];</span><br><span class="line">    [self refresh];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置合适的子视图大小</span><br><span class="line">- (void)layoutSubviews &#123;</span><br><span class="line">    [super layoutSubviews];</span><br><span class="line">    </span><br><span class="line">    if (!self.notSelectedImage) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /*</span><br><span class="line">     设置每个五角星的尺寸大小</span><br><span class="line">     这里，教程中的计算方法如下，请仔细看，他的数学估计是体育老师教的吧。😂😂😂</span><br><span class="line">     float desiredImageWidth = (self.frame.size.width - (self.leftMargin*2) - (self.midMargin*self.imageViews.count)) / self.imageViews.count;</span><br><span class="line">     */</span><br><span class="line">    float desiredImageWidth = (self.frame.size.width - self.leftMargin*2 -(self.midMargin*(self.imageViews.count-1))) / self.imageViews.count;</span><br><span class="line">    float imageWidth = MAX(self.minImageSize.width, desiredImageWidth);</span><br><span class="line">    float imageHeight = MAX(self.minImageSize.height, desiredImageWidth);</span><br><span class="line">    for (int i = 0; i &lt; self.imageViews.count; i++) &#123;</span><br><span class="line">        </span><br><span class="line">        UIImageView *imageView = [self.imageViews objectAtIndex:i];</span><br><span class="line">        CGRect imageFrame = CGRectMake(self.leftMargin + i*(self.midMargin+imageWidth), 0, imageWidth, imageHeight);</span><br><span class="line">        imageView.frame = imageFrame;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>以上两个步骤中，我们设置了最大评分数、添加并布局好了所有的 imageView。接下来，需要接收用户事件，根据用户手指触摸的位置计算评分值 <code>rating</code>:</p>
<p>首先，要接受用户的触摸事件：</p>
<p>因为 <strong>UIView</strong> 是 <strong>UIResponder</strong> 的子类，所以覆盖以下四个方法就可以处理四种不同的触摸事件：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// ① 一根手指或多根手指触摸屏幕</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line"></span><br><span class="line">// ② 一根手指或多根手指在屏幕上移动（随着手指的移动，相关的对象会持续发送该消息）</span><br><span class="line">- (void)touchesMoved:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line"></span><br><span class="line">// ③ 一根手指或多根手指离开屏幕</span><br><span class="line">- (void)touchesEnded:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br><span class="line"></span><br><span class="line">// ④ 在触摸操作正常结束前，某个系统事件（例如突然来电话）打断了触摸过程</span><br><span class="line">- (void)touchesCancelled:(NSSet&lt;UITouch *&gt; *)touches withEvent:(nullable UIEvent *)event;</span><br></pre></td></tr></table></figure></p>
<p>这里我们只用到了前三个方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    UITouch *touch = [touches anyObject];</span><br><span class="line">    CGPoint touchLocation = [touch locationInView:self];</span><br><span class="line">    [self handleTouchAtLocation:touchLocation];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)touchesMoved:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    UITouch *touch = [touches anyObject];</span><br><span class="line">    CGPoint touchLocation = [touch locationInView:self];</span><br><span class="line">    [self handleTouchAtLocation:touchLocation];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)touchesEnded:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    [self.delegate rateView:self ratingDidChange:self.rating];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最最重要的是，计算评分值的方法：<strong>将当前手指触摸位置的 X 值与每个 <code>imageView</code> 宽度的中点作比较</strong>：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073253.jpg" alt="五角星-2"></p>
<ol>
<li>如果触摸位置的X值 &gt; 当前图片宽度的中点，那 <code>rating</code> 值就是整数，是全星评价。</li>
<li>如果  触摸位置的X值 &lt;= 当前图片宽带的中点，并且触摸位置的X值 &gt; 当前图片的起始值，那 <code>rating</code> 值就是 非整数，半星评价。</li>
</ol>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// 根据手指触摸位置，计算当前评分值</span><br><span class="line">- (void)handleTouchAtLocation:(CGPoint)touchLocation &#123;</span><br><span class="line">    if (!self.editable) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    float newRating = 0;</span><br><span class="line">    for (NSInteger i = self.imageViews.count - 1; i &gt;= 0 ; i--) &#123;</span><br><span class="line">        UIImageView *imageView = [self.imageViews objectAtIndex:i];</span><br><span class="line">        CGFloat originValue = imageView.frame.origin.x;</span><br><span class="line">        CGFloat midValue = originValue + imageView.frame.size.width / 2;</span><br><span class="line">                </span><br><span class="line">        if (touchLocation.x &gt; midValue) &#123;</span><br><span class="line">            newRating = i+1;</span><br><span class="line">            break;</span><br><span class="line">        &#125;else if ((touchLocation.x &gt; originValue) &amp;&amp; (touchLocation.x &lt;= midValue)) &#123;</span><br><span class="line">            newRating = i + 0.5;</span><br><span class="line">            break;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self.rating = newRating;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setRating:(float)rating &#123;</span><br><span class="line">    _rating = rating;</span><br><span class="line">    [self refresh]; // 每次评分值改变，就调用刷新方法，重新设置 imageView.![Demo](StarRateView/image/Demo.gif)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>上面一个步骤，我们得到了评分值。最后，每次 <code>rating</code> 值该改变，就重新设置 imageView:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 刷新视图，根据当前评分修改对应的五角星图片</span><br><span class="line">- (void)refresh &#123;</span><br><span class="line">    // 从左往右遍历每个小星星</span><br><span class="line">    for (int i = 0; i &lt; self.imageViews.count; i++) &#123;</span><br><span class="line">        UIImageView *imageView = [self.imageViews objectAtIndex:i];</span><br><span class="line">        if (self.rating &gt;= i+1) &#123;</span><br><span class="line">            // 如果 rating &gt;= 该星星图片的索引，则该星星是全星图片。</span><br><span class="line">            imageView.image = self.fullSelectedImage;</span><br><span class="line">        &#125;else if (self.rating &gt; i) &#123;</span><br><span class="line">            // 如果 rating &gt; 上一个图片索引，则该星星是半星图片。</span><br><span class="line">            imageView.image = self.halfSelectedImage;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            // 默认，空星图片。</span><br><span class="line">            imageView.image = self.notSelectedImage;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>整个实现思路大致如上。</p>
</li>
</ol>
<h2>实现方式二</h2>
<p>参考 @XHJCoder 的源码：</p>
<p><a href="https://www.jianshu.com/p/f7ccfca4bf71" target="_blank" rel="noopener">简书：【iOS】实现星级评分</a></p>
<h3>1.Demo示例</h3>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073253.gif" alt></p>
<h3>2.实现的功能</h3>
<ol>
<li>可任意设置星星数量;</li>
<li>支持动画修改评论；</li>
<li>评分样式支持：整星评论、半星评论、不完整星星评论；</li>
<li>支持 block  和 delegate 两种方式返回修改结果；</li>
</ol>
<h3>3.实现原理，根据 rating 值整体修改视图的 frame 宽度</h3>
<p>我对源码 fork 并进行了一些修改：<a href="https://github.com/Andy0570/XHStarRateView" target="_blank" rel="noopener">XHStarRateView</a></p>
<p>下面是视图的层级结构：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073255.jpg" alt="视图层级"></p>
<ul>
<li>backgroundStarView 、foregroundStarView 是 UIView 的实例对象。</li>
<li>backgroundStarView 视图上添加5个灰色的 imageView。</li>
<li>foregroundStarView 视图上添加5个黄色的 image View。</li>
</ul>
<ol>
<li>
<p>初始化时添加所有视图:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// 指定初始化方法</span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame</span><br><span class="line">                 numberOfStar:(NSInteger)numberOfStar</span><br><span class="line">                    rateStyle:(XHStarRateViewRateStye)rateStyle</span><br><span class="line">                  isAnimation:(BOOL)isAnimation</span><br><span class="line">                   completion:(XHStarRateViewRateCompletionBlock)completionBlock</span><br><span class="line">                     delegate:(id)delegate</span><br><span class="line">&#123;</span><br><span class="line">    if (self = [super initWithFrame:frame]) &#123;</span><br><span class="line">        _numberOfStar    = numberOfStar;</span><br><span class="line">        _rateStyle       = rateStyle;</span><br><span class="line">        _isAnimation     = isAnimation;</span><br><span class="line">        _completionBlock = completionBlock;</span><br><span class="line">        _delegate        = delegate;</span><br><span class="line">        [self createStarView];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)createStarView &#123;</span><br><span class="line">    self.foregroundStarView = [self createStarViewWithImageNamed:KForegroundStarImage];</span><br><span class="line">    self.backgroundStarView = [self createStarViewWithImageNamed:KBackgroundStarImage];</span><br><span class="line">    </span><br><span class="line">    self.foregroundStarView.frame = CGRectMake(0, 0, self.bounds.size.width * _currentRating / _numberOfStar, self.bounds.size.height);</span><br><span class="line">    [self addSubview:self.backgroundStarView];</span><br><span class="line">    [self addSubview:self.foregroundStarView];</span><br><span class="line"></span><br><span class="line">    //...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (UIView *)createStarViewWithImageNamed:(NSString *)name &#123;</span><br><span class="line">    UIView *view = [[UIView alloc] initWithFrame:self.bounds];</span><br><span class="line">    view.clipsToBounds = YES;</span><br><span class="line">    view.backgroundColor = [UIColor clearColor];</span><br><span class="line">    for (NSInteger i = 0; i &lt; _numberOfStar; i ++) &#123;</span><br><span class="line">        UIImageView *imageView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:name]];</span><br><span class="line">        imageView.frame = CGRectMake(i * self.bounds.size.width / _numberOfStar, 0, self.bounds.size.width / _numberOfStar, self.bounds.size.height);</span><br><span class="line">        imageView.contentMode = UIViewContentModeScaleAspectFit;</span><br><span class="line">        [view addSubview:imageView];</span><br><span class="line">    &#125;</span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>使用 <strong>UITapGestureRecognizer</strong> 实现手势识别并更新 rating 值：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (void)createStarView &#123;</span><br><span class="line">	//...</span><br><span class="line">	</span><br><span class="line">    UITapGestureRecognizer *tapGesture = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(userTapRateView:)];</span><br><span class="line">    tapGesture.numberOfTapsRequired = 1;</span><br><span class="line">    [self addGestureRecognizer:tapGesture];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 这里面用到了两个数学函数</span><br><span class="line">// ceilf():返回大于或者等于指定表达式的最小整数。</span><br><span class="line">// roundf():返回四舍五入的整数。</span><br><span class="line">- (void)userTapRateView:(UITapGestureRecognizer *)gesture &#123;</span><br><span class="line">    </span><br><span class="line">    CGPoint tapPoint = [gesture locationInView:self];</span><br><span class="line">    CGFloat offset = tapPoint.x;</span><br><span class="line">    CGFloat realRating = offset / (self.bounds.size.width / _numberOfStar);</span><br><span class="line"></span><br><span class="line">    switch (_rateStyle) &#123;</span><br><span class="line">        case XHStarRateViewRateStyeFullStar: &#123;</span><br><span class="line">            self.currentRating = ceilf(realRating);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case XHStarRateViewRateStyeHalfStar: &#123;</span><br><span class="line">            float round = roundf(realRating);</span><br><span class="line">            self.currentRating = (round &gt; realRating) ? round : (round + 0.5);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case XHStarRateViewRateStyeIncompleteStar: &#123;</span><br><span class="line">            self.currentRating = realRating;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>每次更新 rating 值就修改 foregroundStarView 的 frame 宽度实现动画效果。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)layoutSubviews &#123;</span><br><span class="line">    [super layoutSubviews];</span><br><span class="line">    </span><br><span class="line">    CGFloat animationDuration = (self.isAnimation ? 0.2 : 0);</span><br><span class="line">    [UIView animateWithDuration:animationDuration animations:^&#123;</span><br><span class="line">        self.foregroundStarView.frame = CGRectMake(0, 0, self.bounds.size.width / self.numberOfStar * self.currentRating, self.bounds.size.height);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>OK，第二种方法就是实现如上。</p>
</li>
<li>
<p>第二种方法封装得相对第一种方法更好一些，调用也很方便：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> 1. Delegate 方式创建</span><br><span class="line"> */</span><br><span class="line">XHStarRateView *starRateView = [[XHStarRateView alloc] initWithFrame:CGRectMake(20, 60, 200, 30)];</span><br><span class="line">starRateView.isAnimation = YES; // 有动画</span><br><span class="line">starRateView.rateStyle = XHStarRateViewRateStyeIncompleteStar; //允许不完整星评论</span><br><span class="line">starRateView.tag = 1;</span><br><span class="line">starRateView.delegate = self;</span><br><span class="line">[self.view addSubview:starRateView];</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> 2. 初始化方法创建</span><br><span class="line"> 半星评论、无动画</span><br><span class="line"> */</span><br><span class="line">XHStarRateView *starRateView2 = [[XHStarRateView alloc] initWithFrame:CGRectMake(20, 100, 200, 30)</span><br><span class="line">                                                         numberOfStar:5</span><br><span class="line">                                                            rateStyle:XHStarRateViewRateStyeHalfStar</span><br><span class="line">                                                          isAnimation:NO</span><br><span class="line">                                                             delegate:self];</span><br><span class="line">starRateView2.tag = 2;</span><br><span class="line">[self.view addSubview:starRateView2];</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> 3. block 方法1</span><br><span class="line"> 默认设置：完整星评论、</span><br><span class="line"> */</span><br><span class="line">XHStarRateView *starRateView3 = [[XHStarRateView alloc] initWithFrame:CGRectMake(20, 140, 200, 30) completion:^(CGFloat currentScore) &#123;</span><br><span class="line">    NSLog(@&quot;3----  %f&quot;,currentScore);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[self.view addSubview:starRateView3];</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> 4. block 方法2</span><br><span class="line"> 半星评论、有动画</span><br><span class="line"> */</span><br><span class="line">XHStarRateView *starRateView4 = [[XHStarRateView alloc] initWithFrame:CGRectMake(20, 180, 200, 30) numberOfStar:8 rateStyle:XHStarRateViewRateStyeHalfStar isAnimation:YES completion:^(CGFloat currentScore) &#123;</span><br><span class="line">    NSLog(@&quot;4----  %f&quot;,currentScore);</span><br><span class="line">&#125;];</span><br><span class="line">[self.view addSubview:starRateView4];</span><br></pre></td></tr></table></figure></p>
</li>
</ol>
<h3>第三方框架</h3>
<ul>
<li><a href="https://github.com/akiroom/AXRatingView" target="_blank" rel="noopener">AXRatingView</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/26/iOS 多线程编程——iOS开发的一座大山/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/26/iOS 多线程编程——iOS开发的一座大山/" class="post-title-link" itemprop="url">iOS 多线程编程——iOS开发的一座大山</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-26 17:54:00" itemprop="dateCreated datePublished" datetime="2017-12-26T17:54:00+08:00">2017-12-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 22:08:10" itemprop="dateModified" datetime="2019-05-01T22:08:10+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">27k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">24 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073257.jpg" alt="&amp;quot;因为山在那里！&amp;quot;——1924年，英国登山家George Mallory回答《纽约时报》&amp;quot;你为什么要攀登珠峰？&amp;quot;时说的一句话"></p>
<p>&lt;!-- more --&gt;</p>
<h2>GCD简介</h2>
<blockquote>
<p>GCD 是 <code>libdispatch</code> 的市场名称，而 libdispatch 作为 Apple 的一个库，为并发代码在多核硬件（iOS 或 OS X ）上执行提供有力支持。它具有以下优点：</p>
<ul>
<li>GCD 能通过推迟昂贵计算任务并在后台运行它们来改善你的应用的响应性能。</li>
<li>GCD 提供一个易于使用的并发模型而不仅仅只是锁和线程，以帮助我们避开并发陷阱。</li>
<li>GCD 具有在常见模式（例如单例）上用更高性能的原语优化你的代码的潜在能力。</li>
</ul>
</blockquote>
<blockquote>
<p>为了让开发者更加容易的使用设备上的多核CPU，苹果在 OS X 10.6 和 iOS 4 中引入了 Grand Central Dispatch（GCD）。Grand Central Dispatch (GCD) 是 Apple 开发的多线程编程解决方法。</p>
<p>通过 GCD，开发者不用再直接跟线程打交道了，只需要向队列中添加代码块即可，GCD 在后端管理着一个<a href="http://en.wikipedia.org/wiki/Thread_pool_pattern" target="_blank" rel="noopener">线程池</a>。GCD 不仅决定着你的代码块将在哪个线程被执行，它还根据可用的系统资源对这些线程进行管理。这样可以将开发者从线程管理的工作中解放出来，通过集中的管理线程，来缓解大量线程被创建的问题。</p>
<p>GCD 带来的另一个重要改变是，作为开发者可以将工作考虑为一个队列，而不是一堆线程，这种并行的抽象模型更容易掌握和使用。</p>
<p>GCD 公开有 5 个不同的队列：运行在主线程中的 main queue，3 个不同优先级的后台队列，以及一个优先级更低的后台队列（用于 I/O）。 另外，开发者可以创建自定义队列：串行或者并行队列。自定义队列非常强大，在自定义队列中被调度的所有 block 最终都将被放入到系统的全局队列中和线程池中。</p>
</blockquote>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073259.png" alt="GCD 队列"></p>
<h3>GCD 与 操作队列 （operation queue）</h3>
<p>GCD 是纯 C 的 API，而操作队列则是 Objective-C 的对象。</p>
<p>操作队列在底层是用 GCD 来实现的。</p>
<h2>进程、线程、队列、串行、并发、同步、异步、傻傻分不清楚</h2>
<h3>Thread 线程</h3>
<p><a href="http://zh.wikipedia.org/wiki/%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">线程</a>（thread）是组成进程的子单元，操作系统的调度器可以对线程进行单独的调度。实际上，所有的并发编程 API 都是构建于线程之上的 —— 包括 GCD 和操作队列（operation queues）。</p>
<p>多线程可以在单核 CPU 上同时（或者至少看作同时）运行。操作系统将小的时间片分配给每一个线程，这样就能够让用户感觉到有多个任务在同时进行。如果 CPU 是多核的，那么线程就可以真正的以并发方式被执行，从而减少了完成某项操作所需要的总时间。</p>
<h3>Synchronous vs. Asynchronous 同步 vs. 异步</h3>
<p>描述一个函数/方法与一个任务之间的关系，该函数要求一个任务在GCD下执行。</p>
<p>同步函数：方法会在指定的任务完成之后才返回。</p>
<p>异步函数：方法会立即返回，预定的任务会完成但不会等待它完成。因此，一个异步函数不会阻塞当前线程去执行下一个函数。</p>
<p>区别：方法是否立即返回。</p>
<h3>Critical Section 临界区</h3>
<p>就是一段代码不能被并发执行，也就是，两个线程不能同时执行这段代码。这很常见，因为代码去操作一个共享资源，例如一个变量若能被并发进程访问，那么它很可能会变质（译者注：它的值可能被动态更改了但是还没有返回）</p>
<h3>Race Condition 竞态条件</h3>
<p>这种状况是指基于特定序列或时机的事件的软件系统以不受控制的方式运行的行为，例如程序的并发任务执行的确切顺序。竞态条件可导致无法预测的行为，而不能通过代码检查立即发现。</p>
<p>关于竞态条件更好的诠释可以参考 <a href="https://www.objccn.io/issue-2-1/" target="_blank" rel="noopener">objc.io</a> 的例子：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073259-1.png" alt="竞态条件"></p>
<h3>Deadlock 死锁</h3>
<p>两个（或更多）东西——在大多数情况下，是线程——所谓的死锁是指它们都卡住了，并等待对方完成或执行其它操作。第一个不能完成是因为它在等待第二个的完成。但第二个也不能完成，因为它在等待第一个的完成。【与内存管理的循环引用问题类似】</p>
<h3>互斥锁</h3>
<p><a href="http://en.wikipedia.org/wiki/Mutex" target="_blank" rel="noopener">互斥</a>访问的意思就是同一时刻，只允许一个线程访问某个特定资源。为了保证这一点，每个希望访问共享资源的线程，首先需要获得一个共享资源的<a href="http://en.wikipedia.org/wiki/Lock_%28computer_science%29" target="_blank" rel="noopener">互斥锁</a>，一旦某个线程对资源完成了操作，就释放掉这个互斥锁，这样别的线程就有机会访问该共享资源了。</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073303.png" alt="互斥锁"></p>
<h3>优先级反转</h3>
<p>优先级反转是指程序在运行时低优先级的任务阻塞了高优先级的任务，有效的反转了任务的优先级。由于 GCD 提供了拥有不同优先级的后台队列，甚至包括一个 I/O 队列，所以我们最好了解一下优先级反转的可能性。</p>
<p>高优先级和低优先级的任务之间共享资源时，就可能发生优先级反转。当低优先级的任务获得了共享资源的锁时，该任务应该迅速完成，并释放掉锁，这样高优先级的任务就可以在没有明显延时的情况下继续执行。然而高优先级任务会在低优先级的任务持有锁的期间被阻塞。如果这时候有一个中优先级的任务(该任务不需要那个共享资源)，那么它就有可能会抢占低优先级任务而被执行，因为此时高优先级任务是被阻塞的，所以中优先级任务是目前所有可运行任务中优先级最高的。此时，中优先级任务就会阻塞着低优先级任务，导致低优先级任务不能释放掉锁，这也就会引起高优先级任务一直在等待锁的释放。</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073305.png" alt="优先级反转"></p>
<p>解决这个问题的方法，通常就是不要使用不同的优先级。通常最后你都会以让高优先级的代码等待低优先级的代码来解决问题。<strong>当你使用 GCD 时，总是使用默认的优先级队列</strong>（直接使用，或者作为目标队列）。如果你使用不同的优先级，很可能实际情况会让事情变得更糟糕。</p>
<p>从中得到的教训是，使用不同优先级的多个队列听起来虽然不错，但毕竟是纸上谈兵。它将让本来就复杂的并行编程变得更加复杂和不可预见。如果你在编程中，遇到高优先级的任务突然没理由地卡住了，可能你会想起本文，以及那个美国宇航局的工程师也遇到过的被称为优先级反转的问题。</p>
<h3>Thread Safe 线程安全</h3>
<p>线程安全的代码能在多线程或并发任务中被安全地调用，而不会导致任何问题（数据损坏，崩溃等）。线程不安全的代码在某个时刻只能在一个上下文中运行。一个线程安全代码的例子是 <code>NSDictionary</code> 。你可以在同一时间在多个线程中使用它而不会有问题。相反，<code>NSMutableDictionary</code> 就不是线程安全的，应该保证一次只能有一个线程访问它。</p>
<h3>Context Switch 上下文切换</h3>
<p>一个上下文切换：在单个进程里切换执行不同的线程时存储与恢复执行状态的过程。这个过程在编写多任务应用时很普遍，但会带来一些额外的开销。</p>
<h3>Concurrency vs Parallelism 并发与并行</h3>
<p>并发代码的不同部分可以“同步”执行。然而，该怎样发生或是否发生都取决于系统。多核设备通过并行来同时执行多个线程；然而，为了使单核设备也能实现这一点，它们必须先运行一个线程，执行一个上下文切换，然后运行另一个线程或进程。这通常发生地足够快以致给我们并发执行地错觉，如下图所示：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073306.png" alt></p>
<p>虽然你可以编写代码在 GCD 下并发执行，但 GCD 会决定有多少并行的需求。<strong>并行要求并发，但并发不能保证并行</strong>。</p>
<h3>Queues 队列</h3>
<p>GCD 提供 <code>dispatch queues</code> 来处理代码块，这些队列管理你提供给 GCD 的任务并用 FIFO 顺序执行这些任务。这就保证了第一个被添加到队列里的任务会是队列中第一个开始的任务，而第二个被添加的任务将第二个开始，如此直到队列结束。</p>
<p>所有的调度队列（dispatch queues）自身都是线程安全的，你能从多个线程并行的访问它们。当你了解了调度队列如何为你自己代码的不同部分提供线程安全后，GCD的优点就会显而易见。关于这一点的关键是：<strong>选择正确类型的调度队列和正确的调度函数来提交你的工作</strong>。</p>
<h4>Serial vs. Concurrent 串行 vs. 并发</h4>
<p>描述当前任务与其它被执行任务之间的关系</p>
<p>串行队列：每次只有一个任务被执行；</p>
<p>并发队列：同一时间可以有多个任务被执行。</p>
<h4>Serial Queues 串行队列</h4>
<p>串行队列中的任务一次执行一个，每个任务只有在前一个任务完成后才会开始。而且，你不能确定 Block 任务执行的时间长度，如下图所示：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073308.png" alt></p>
<p>这些任务的执行时机受到 GCD 的控制；唯一能确保的事情是： <strong>GCD 一次只执行一个任务，并且按照我们添加到队列中的顺序来执行。</strong></p>
<p>由于在串行队列中不会有两个任务并发执行，因此不会出现同时访问临界区的风险；相对于这些任务来说，这就从竞态条件下保护了临界区。所以如果访问临界区的唯一方式是通过提交到调度队列的任务，那么你就不需要担心临界区的安全问题了。</p>
<h4>Concurrent Queues 并发队列</h4>
<p>并发队列中的任务能得到的保证是：<strong>它们会按照被添加的顺序开始执行</strong>，但这就是全部的保证了。任务可能以任意顺序完成，你不知道何时开始执行下一个任务，或者何时有多少 Block 任务在执行。再说一遍，这完全取决于 GCD 。</p>
<p>下图展示了一个示例任务执行计划，GCD 管理着四个并发任务：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073308-1.png" alt></p>
<p>注意 Block 1、2 和 3 都是立即执行的，一个接一个。在 Block 0 开始后，Block 1等待了好一会儿才开始。同样， Block 3 在 Block 2 之后才开始，但它先于 Block 2 完成。</p>
<p>何时开始一个 Block 完全取决于 GCD 。如果一个 Block 的执行时间与另一个重叠，也是由 GCD 来决定是否将其运行在另一个不同的核心上，如果那个核心可用，就用上下文切换的方式来执行不同的 Block 。</p>
<p>有趣的是， GCD 给你提供了至少五个特定的队列，可根据队列类型选择使用。</p>
<h4>Queue Types 队列类型</h4>
<p>首先，系统给你提供了一个叫做 <code>主队列（main queue）</code> 的特殊队列。和其它串行队列一样，该队列中的任务一次只能执行一个。然而，它能保证所有的任务都在主线程执行，而**主线程是唯一可用于更新 UI 的线程。**这个队列用于发送消息或通知给 <code>UIView</code> 、响应用户交互。</p>
<p>同时，系统给你提供了几个并发队列。它们叫做 <code>全局调度队列（Global Dispatch Queues）</code> 。目前的四个全局队列有着不同的优先级：<code>background</code>、<code>low</code>、<code>default</code> 以及 <code>high</code>。要知道，Apple 的 API 也会使用这些队列，所以你添加的任何任务都不会是这些队列中唯一的任务。</p>
<p>最后，你也可以创建自己的串行队列或并发队列。这就是说，至少有<strong>五个队列</strong>任你处置：主队列、四个全局调度队列，再加上任何你自己创建的队列。</p>
<p>以上是调度队列的大框架！</p>
<p>GCD 的“艺术”归结为<strong>选择合适队列的调度函数以提交你的工作</strong>。</p>
<h2>GCD 方法</h2>
<p>GCD 是纯 C 的 API，如果你使用 MBProgressHUD 框架，你会看到使用 GCD 的这个示例：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 在根视图上显示 HUD</span><br><span class="line">MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.navigationController.view animated:YES];</span><br><span class="line"></span><br><span class="line">// 异步后台线程执行，使UIKit有机会重新绘制 HUD 并添加到视图层次结构中。</span><br><span class="line">dispatch_async(dispatch_get_global_queue(QOS_CLASS_USER_INITIATED, 0), ^&#123;</span><br><span class="line"></span><br><span class="line">    // Do something useful in the background</span><br><span class="line">    [self doSomeWork];</span><br><span class="line"></span><br><span class="line">    // 主线程执行，请确保始终在主线程上更新UI（包括MBProgressHUD）。</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [hud hideAnimated:YES];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3>全局队列， <code>dispatch_get_global_queue()</code></h3>
<p>函数：<code>dispatch_get_global_queue(long identifier, unsigned long flags)</code></p>
<ol>
<li>
<p>参数一：<code>long identifier</code>：qos_class_t 中定义的服务质量或者 dispatch_queue_priority_t 中定义的队列优先级。</p>
<ul>
<li>
<p><strong>dispatch_queue_priority_t</strong> ：队列优先级</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 派发到队列中的任务将以最高优先级运行，此队列任务将会被安排到默认优先级或者低优先级的任务之前运行。</span><br><span class="line">#define DISPATCH_QUEUE_PRIORITY_HIGH 2</span><br><span class="line"></span><br><span class="line">// 派发到队列中的任务将以默认优先级运行，即，该任务将会在【所有高优先级任务已经被调度之后，并且在所有低优先级任务被调度之前】被调度执行。</span><br><span class="line">#define DISPATCH_QUEUE_PRIORITY_DEFAULT 0</span><br><span class="line"></span><br><span class="line">// 派发到队列中的任务将以低优先级运行，即在所有默认优先级和高优先级任务已经被执行之后，该队列中的任务将会被调度执行</span><br><span class="line">#define DISPATCH_QUEUE_PRIORITY_LOW (-2)</span><br><span class="line"></span><br><span class="line">// 派发到队列中的任务将以后台优先级运行，也就是说，在调度了所有高优先级任务之后，该队列中的任务将被调度执行，并且系统将在具有根据 setpriority 的后台状态的线程上运行该队列上的任务。（磁盘 I/O 受到限制，线程的调度优先级设置为最低值）。</span><br><span class="line">#define DISPATCH_QUEUE_PRIORITY_BACKGROUND INT16_MIN</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p><strong>qos_class_t</strong>：服务质量，<em>iOS 8.0 新增</em></p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> * Apple 建议我们使用服务质量类别的值来标记全局并发队列</span><br><span class="line"> *  - QOS_CLASS_USER_INTERACTIVE</span><br><span class="line"> *  - QOS_CLASS_USER_INITIATED</span><br><span class="line"> *  - QOS_CLASS_DEFAULT</span><br><span class="line"> *  - QOS_CLASS_UTILITY</span><br><span class="line"> *  - QOS_CLASS_BACKGROUND</span><br><span class="line"> *</span><br><span class="line"> * 全局并发队列仍然可以通过优先级来识别,它会被映射到以下QOS类：</span><br><span class="line"> *  - DISPATCH_QUEUE_PRIORITY_HIGH:         QOS_CLASS_USER_INITIATED</span><br><span class="line"> *  - DISPATCH_QUEUE_PRIORITY_DEFAULT:      QOS_CLASS_DEFAULT</span><br><span class="line"> *  - DISPATCH_QUEUE_PRIORITY_LOW:          QOS_CLASS_UTILITY</span><br><span class="line"> *  - DISPATCH_QUEUE_PRIORITY_BACKGROUND:   QOS_CLASS_BACKGROUND</span><br><span class="line">   </span><br><span class="line"> /*!</span><br><span class="line"> * @constant QOS_CLASS_USER_INTERACTIVE</span><br><span class="line"> * @abstract 该线程执行的是与用户交互的工作</span><br><span class="line"> * @discussion 与系统上运行的其他工作相比，该工作被要求以最高优先级运行。指定这个 QOS 类会请求几乎所有可用的系统 CPU 和 I/O 带宽运行，甚至不惜争用资源。</span><br><span class="line"> * 这不是一个适用于大型任务的节能 QOS 类。 这个 QOS 类的使用应限于与用户的关键交互，例如处理主事件循环中的事件，绘图，动画等。</span><br><span class="line"> *</span><br><span class="line"> * @constant QOS_CLASS_USER_INITIATED</span><br><span class="line"> * @abstract 该线程执行的工作的 QOS 类是由用户发起的并且用户可能正在等待结果。</span><br><span class="line"> * @discussion 这种工作的优先级低于关键的用户交互工作，但比系统上的其他工作要高。 </span><br><span class="line"> * 这不是一个适用于大型任务的节能 QOS 类。它的使用应该限制在足够短的时间内，以至于用户不太可能在等待结果的时候切换任务。 典型的用户发起的通过显示占位符内容或模态用户界面来指示进度的工作。</span><br><span class="line"> *</span><br><span class="line"> * @constant QOS_CLASS_DEFAULT</span><br><span class="line"> * @abstract 系统在缺少更具体的QOS分类信息的情况下使用的默认QOS分类。</span><br><span class="line"> * @discussion 这种工作优先级低于关键的用户交互和用户发起的工作，但比实用工具和后台任务要高。 由pthread_create（）创建的没有指定QOS类的属性的线程将默认为QOS_CLASS_DEFAULT。 这个QOS类的值并不打算作为工作分类，只有在传播或恢复系统提供的QOS类值时才应设置。</span><br><span class="line"> *</span><br><span class="line"> * @constant QOS_CLASS_UTILITY</span><br><span class="line"> * @abstract 该线程执行的工作的QOS类或许可能由用户发起，并且用户并不期待立即等待结果。</span><br><span class="line"> * @discussion 这种工作的优先级低于关键用户交互和用户启动的工作，但比低级系统维护任务要高。 使用这个QOS级别表明工作应该以节能和高效率的方式运行。 效用工作的进展可能会也可能不会被指示给用户，但这种工作的效果是用户可见的。</span><br><span class="line"> *</span><br><span class="line"> * @constant QOS_CLASS_BACKGROUND</span><br><span class="line"> * @abstract 该线程执行的工作的QOS类不是由用户发起的，并且用户可能不知道结果。</span><br><span class="line"> * @discussion 这项工作的优先级低于其他工作。 使用这个QOS级别表明工作应该以最节能，最高效的方式进行。</span><br><span class="line"> *</span><br><span class="line"> * @constant QOS_CLASS_UNSPECIFIED</span><br><span class="line"> * @abstract 指示QOS类信息的缺失或移除的QOS类值。</span><br><span class="line"> * @discussion 作为API返回值，可能表示线程或pthread属性是使用与旧版API不兼容或与QOS类系统冲突的配置。</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">__QOS_ENUM(qos_class, unsigned int,</span><br><span class="line">	QOS_CLASS_USER_INTERACTIVE</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x21,</span><br><span class="line">	QOS_CLASS_USER_INITIATED</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x19,</span><br><span class="line">	QOS_CLASS_DEFAULT</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x15,</span><br><span class="line">	QOS_CLASS_UTILITY</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x11,</span><br><span class="line">	QOS_CLASS_BACKGROUND</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x09,</span><br><span class="line">	QOS_CLASS_UNSPECIFIED</span><br><span class="line">			__QOS_CLASS_AVAILABLE(macos(10.10), ios(8.0)) = 0x00,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#undef __QOS_ENUM</span><br></pre></td></tr></table></figure></p>
</li>
</ul>
</li>
</ol>
<ol start="2">
<li>
<p>参数二：<code>unsigned long flags</code></p>
<p>Apple 保留以供将来使用的值。 传递除零以外的任何值都可能导致返回值为NULL。因此，<strong>这个值我们务必设置为0</strong>。</p>
</li>
</ol>
<p>使用示例：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 异步后台队列</span><br><span class="line">dispatch_queue_t global_queue = dispatch_get_global_queue(0, 0);</span><br><span class="line"></span><br><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">   // 异步后台任务...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3>异步队列， <code>dispatch_async</code></h3>
<p>三种方式：</p>
<h4>异步自定义串行队列</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t my_queue = dispatch_queue_create(&quot;com.companyName.projectName.taskName&quot;, NULL); // 传参 NULL 代表这是一个串行队列。</span><br><span class="line">dispatch_async(my_queue, ^&#123;</span><br><span class="line">    // 异步自定义任务</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>当你想串行执行后台任务并追踪它时就是一个好选择。这消除了资源争用，因为你知道一次只有一个任务在执行。注意若你需要获取某个方法的数据，你必须内联另一个 Block 来找回它或考虑使用 <code>dispatch_sync</code>。</p>
<h4>异步主队列</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    // 异步主线程任务</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这是在一个并发队列上完成任务后更新 UI 的共同选择。要这样做，你将在一个 Block 内部编写另一个 Block 。以及，如果你在主队列调用 <code>dispatch_async</code> 到主队列，你能确保这个新任务将在当前方法完成后的某个时间执行。</p>
<h4>异步全局队列</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    // 异步并发任务</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这是在后台执行非 UI 工作的共同选择。</p>
<h3>延后执行任务，dispatch_after</h3>
<p>延迟 n 秒执行，使用 snippet 代码块：==dispatch_after==</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">double delayInSeconds = 2.0;</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    // code to be executed after a specified delay</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><code>dispatch_after</code> 可以使任务延后执行，缺点是无法取消 block 中将要执行的代码。如果你需要一些事情在某个特定的时刻运行，那么 <code>dispatch_after</code> 或许会是个好的选择。确保同时考虑了 <code>NSTimer</code>，这个API虽然有点笨重，但是它允许你取消定时器的触发。</p>
<p>不知道何时适合使用 <code>dispatch_after</code> ？</p>
<ul>
<li>自定义串行队列：在一个自定义串行队列上使用 <code>dispatch_after</code> 要小心。你最好坚持使用主队列。</li>
<li>✅主队列（串行）：是使用 <code>dispatch_after</code> 的好选择；Xcode 提供了一个不错的 snippet 模版（==dispatch_after==）。</li>
<li>并发队列：在并发队列上使用 <code>dispatch_after</code> 也要小心；你会这样做就比较罕见。还是在主队列做这些操作吧。</li>
</ul>
<p>因此，<strong>强烈建议在主队列上执行延后任务</strong>。</p>
<h3>单次执行，dispatch_once</h3>
<p><code>dispatch_once()</code> 以线程安全的方式执行且仅执行其代码块一次。试图访问临界区（即传递给 <code>dispatch_once</code> 的代码）的不同的线程会在临界区已有一个线程的情况下被阻塞，直到临界区完成为止。</p>
<p>使用 snippet 代码块创建：==dispatch_once==</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static dispatch_once_t onceToken;</span><br><span class="line">dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">    // code to be executed once</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>该方法常用于<strong>单例类</strong>初始化，可以防止竞态条件发生：</p>
<p>❎不推荐的单例创建方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)sharedManager</span><br><span class="line">&#123;</span><br><span class="line">    static PhotoManager *sharedPhotoManager = nil;</span><br><span class="line">    if (!sharedPhotoManager) &#123;</span><br><span class="line">        sharedPhotoManager = [[PhotoManager alloc] init];</span><br><span class="line">        sharedPhotoManager-&gt;_photosArray = [NSMutableArray array];</span><br><span class="line">    &#125;</span><br><span class="line">    return sharedPhotoManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原因在于，**if 条件分支不是线程安全的。**如果调用这个单例方法多次，系统可能对创建多个实例对象——竞态条件。</p>
<p>✅推荐的方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)sharedManager</span><br><span class="line">&#123;</span><br><span class="line">    static PhotoManager *sharedPhotoManager = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        sharedPhotoManager = [[PhotoManager alloc] init];</span><br><span class="line">        sharedPhotoManager-&gt;_photosArray = [NSMutableArray array];</span><br><span class="line">    &#125;);</span><br><span class="line">    return sharedPhotoManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###栅栏，dispatch_barriers</p>
<blockquote>
<p>Note：这些称谓指的都是 dispatch_barriers 函数：栅栏、障碍、屏障...</p>
</blockquote>
<h4>读写问题</h4>
<p>照片管理类可以对照片执行<strong>写</strong>方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)addPhoto:(Photo *)photo &#123;</span><br><span class="line">    if (photo) &#123;</span><br><span class="line">        [_photosArray addObject:photo];</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [self postContentAddedNotification];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可以执行<strong>读</strong>方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray *)photos &#123;</span><br><span class="line">    return _photosArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>⚠️问题在于，这两个方法不能提供任何保护措施来对抗当一个线程调用读方法 <code>photos</code> 的同时另一个线程调用写方法 <code>addPhoto:</code> 。</p>
<p>GCD 通过用 <code>dispatch barriers</code> 创建一个<code>读写锁</code> 提供了一个优雅的解决方案。</p>
<p>Dispatch barriers 是一组函数，在并发队列上工作时扮演一个串行式的瓶颈。使用 GCD 的障碍（barrier）API 确保提交的 Block 在那个特定时间上是指定队列上唯一被执行的条目。这就意味着所有的先于调度障碍提交到队列的条目必能在这个 Block 执行前完成。</p>
<p>当这个 Block 的时机到达，调度障碍执行这个 Block 并确保在那个时间里队列不会执行任何其它 Block 。一旦完成，队列就返回到它默认的实现状态。 GCD 提供了同步和异步两种障碍函数。</p>
<p>下图显示了障碍函数对多个异步队列的影响：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073310.png" alt></p>
<p>注意到正常部分的操作就如同一个正常的并发队列。但当障碍执行时，它本质上就如同一个串行队列。也就是，障碍是唯一在执行的事物。在障碍完成后，队列回到一个正常并发队列的样子。</p>
<p>下面是你何时会，或者不会使用障碍函数的情况：</p>
<ul>
<li>❎自定义串行队列：一个很坏的选择；障碍不会有任何帮助，因为不管怎样，一个串行队列一次只执行一个操作。</li>
<li>❎全局并发队列：要小心；这可能不是最好的主意，因为其它系统可能在使用队列而且你不能垄断它们只为你自己的目的。</li>
<li>✅自定义并发队列：这对于原子或临界区代码来说是极佳的选择。任何你在设置或实例化的需要线程安全的事物都是使用障碍的最佳候选。</li>
</ul>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) dispatch_queue_t concurrentPhotoQueue;</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">1. “写操作”可以放入并发队列，因为设置方法并不需要返回值；</span><br><span class="line">2. 使用 dispatch_barrier 将此并发队列加锁，保证任一时刻只有一个“写操作”在执行；</span><br><span class="line">2. 自定义并发队列，而不是全局并发队列的原因是：全局队列中还可能有其他任务，一旦加锁就会阻塞其他任务的正常执行，不能为了个人利益影响国家嘛，因此我们开辟一个新的自定义并发队列专门处理这个问题。</span><br><span class="line">*/</span><br><span class="line">- (void)addPhoto:(Photo *)photo &#123;</span><br><span class="line">    if (photo) &#123;</span><br><span class="line">        dispatch_barrier_async(self.concurrentPhotoQueue, ^&#123;</span><br><span class="line">            [_photosArray addObject:photo];</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [self postContentAddedNotification];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>⚠️  注意：当使用并发队列时，要确保所有的 <em>barrier</em> 调用都是 <em>async</em> 的。如果你使用 <code>dispatch_barrier_sync</code> ，那么你很可能会使你自己（更确切的说是，你的代码）产生死锁。写操作<em>需要</em> barrier，并且<em>可以</em>是 async 的。</p>
<h3>自定义线程，dispatch_queue_create()</h3>
<p>函数：<code>dispatch_queue_create(const char * _Nullable label, dispatch_queue_attr_t _Nullable attr)</code></p>
<p>参数一：<code>const char * _Nullable label</code>，自定义线程的标识符，一般为反向DNS域名</p>
<p>参数二：指定队列类型（串行/并发队列），可以传入的参数类型如下：</p>
<ul>
<li>串行：<code>DISPATCH_QUEUE_SERIAL</code> ：一个按FIFO顺序调用块的调度队列。</li>
<li>并发：<code>DISPATCH_QUEUE_CONCURRENT</code>：使用 <code>DISPATCH_QUEUE_CONCURRENT</code> 属性创建的队列可以同时调用块（类似于全局并发队列，但可能会有更多的开销），并且，它支持使用调度栅栏 API （<code>dispatch barriers</code> ）提交的栅栏块，例如， 能够实现高效的读写器方案。</li>
</ul>
<blockquote>
<p>注意：当你在网上搜索例子时，你会经常看人们传递 <code>0</code> 或者 <code>NULL</code> 给 <code>dispatch_queue_create</code> 的第二个参数。这是创建串行队列的过时方式；明确你的参数总是更好。</p>
</blockquote>
<p>使用 <code>dispatch_queue_create</code> 方法</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t urls_queue = dispatch_queue_create(&quot;com.companyName.project.taskName&quot;, NULL);</span><br><span class="line">dispatch_async(urls_queue, ^&#123;</span><br><span class="line">  // your code</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>修改使用自定义队列：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) dispatch_queue_t concurrentPhotoQueue;</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line">+ (instancetype)sharedManager</span><br><span class="line">&#123;</span><br><span class="line">    static PhotoManager *sharedPhotoManager = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        sharedPhotoManager = [[PhotoManager alloc] init];</span><br><span class="line">        sharedPhotoManager-&gt;_photosArray = [NSMutableArray array];</span><br><span class="line">        </span><br><span class="line">        // 自定义并发队列 </span><br><span class="line">        sharedPhotoManager -&gt; _concurrentPhotoQueue = dispatch_queue_create(&quot;com.selander.GooglyPuff.photoQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    &#125;);</span><br><span class="line">    return sharedPhotoManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>同步队列，dispathc_sync</h3>
<p><code>dispatch_sync()</code> 同步地提交工作并在返回前等待它完成。使用 <code>dispatch_sync</code> 跟踪你的调度障碍工作，或者当你需要等待操作完成后才能使用 Block 处理过的数据。如果你使用第二种情况做事，你将不时看到一个 <code>__block</code> 变量写在 <code>dispatch_sync</code> 范围之外，以便返回时在 <code>dispatch_sync</code> 使用处理过的对象。</p>
<p>但你需要很小心。想像如果你调用 <code>dispatch_sync</code> 并放在你已运行着的当前队列。这会导致死锁，因为调用会一直等待直到 Block 完成，但 Block 不能完成（它甚至不会开始！），直到当前已经存在的任务完成，而当前任务无法完成！这将迫使你自觉于你正从哪个队列调用——以及你正在传递进入哪个队列。</p>
<p>下面是一个快速总览，关于在何时以及何处使用 <code>dispatch_sync</code> ：</p>
<ul>
<li>自定义串行队列：在这个状况下要非常小心！如果你正运行在一个队列并调用 <code>dispatch_sync</code> 放在同一个队列，那你就百分百地创建了一个死锁（同步队列嵌套会导致死锁问题！！！）</li>
<li>主队列（串行）：同上面的理由一样，必须非常小心！这个状况同样有潜在的导致死锁的情况。</li>
<li>✅并发队列：这才是做同步工作的好选择，不论是通过调度障碍，或者需要等待一个任务完成才能执行进一步处理的情况。</li>
</ul>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 将“读操作”放入同步队列，这样方法就不会立即返回了，它会等待执行“读操作”完毕后才返回。</span><br><span class="line">- (NSArray *)photos</span><br><span class="line">&#123;</span><br><span class="line">  // __block 关键字允许对象在 Block 内可变。没有它，array 在 Block 内部就只是只读的，你的代码甚至不能通过编译。</span><br><span class="line">    __block NSArray *array;</span><br><span class="line">    dispatch_sync(self.concurrentPhotoQueue, ^&#123;</span><br><span class="line">        array = [NSArray arrayWithArray:_photosArray];</span><br><span class="line">    &#125;);</span><br><span class="line">    return _photosArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>####小结：读写的线程安全问题</p>
<p>一、以上几个函数是如何解决读写问题的呢？</p>
<ol>
<li><strong>写方法</strong>：将<strong>写操作</strong>放在 <code>dispatch_barrier_async</code> 阻塞函数中，同时，该阻塞函数运行在自定义并发队列中：<code>dispatch_queue_create(&quot;com.selander.GooglyPuff.photoQueue&quot;, DISPATCH_QUEUE_CONCURRENT)</code>。</li>
<li><strong>读方法</strong>：将<strong>读操作</strong>放入同步队列 <code>dispatch_sync</code> 中，方法会等待<strong>读操作</strong>执行完毕后再返回，同时，该同步队列仍然运行在自定义并发队列中：因为多个获取方法可以并发执行。</li>
<li>获取方法与设置方法之间不能并发执行，因此我们将他们放在同一个自定义并发队列中。</li>
</ol>
<h3>dispatch_sync 与 dispatch_async 的区别</h3>
<ul>
<li><code>dispatch_sync</code>，同步队列，函数会等待它返回后再继续执行。</li>
<li><code>dispatch_async</code>，异步队列，函数会立即返回。</li>
</ul>
<h4>dispatch_sync</h4>
<p><code>viewDidLoad</code> 方法会等待同步队列任务返回后再继续执行。</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073311.gif" alt></p>
<h4>dispatch_async</h4>
<p><code>viewDidLoad</code> 方法会立即继续执行，不会等待异步队列任务返回。</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/073315.gif" alt></p>
<h3>调度组，dispatch_group_t</h3>
<p>Dispatch Group 会在整个组的任务都完成时通知你。这些任务可以是同步的，也可以是异步的，即便在不同的队列也行。而且在整个组的任务都完成时，Dispatch Group 可以用同步的或者异步的方式通知你。因为要监控的任务在不同队列，那就用一个 <code>dispatch_group_t</code> 的实例来记下这些不同的任务。</p>
<p>当组中所有的事件都完成时，GCD 的 API 提供了两种通知方式。</p>
<p>示例代码一：</p>
<p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让后台 2 个线程并行执行，然后等 2 个线程都结束后，再汇总执行结果。</span></span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line">dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="comment">// 并行执行线程一</span></span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="comment">// 并行执行线程二</span></span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_notify(group, dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="comment">// 汇总结果</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>因为下载任务是在后台执行的，它会立即返回，如何监听下载完成并做一些下载完成后的处理？使用 <code>dispatch_group_t</code>。</p>
<p>第一种是 <code>dispatch_group_wait</code> ，它会阻塞当前线程，直到组里面所有的任务都完成或者等到某个超时发生。</p>
<p>1⃣️ <strong>dispatch_group_wait()</strong> 函数，会阻塞主线程：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (void)downloadPhotosWithCompletionBlock:(BatchPhotoDownloadingCompletionBlock)completionBlock</span><br><span class="line">&#123;</span><br><span class="line">    // 因为 dispatch_group_wait() 方法会阻塞主线程，所以使用 dispatch_async() 将整个方法放入后台队列中以避免阻塞主线程。</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(QOS_CLASS_USER_INTERACTIVE, 0), ^&#123; // 1</span><br><span class="line">        </span><br><span class="line">        __block NSError *error;</span><br><span class="line">        </span><br><span class="line">        // 创建一个任务调度组</span><br><span class="line">        dispatch_group_t downloadGroup = dispatch_group_create(); // 2</span><br><span class="line">        </span><br><span class="line">        for (NSInteger i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            NSURL *url;</span><br><span class="line">            switch (i) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    url = [NSURL URLWithString:kOverlyAttachedGirlfriendURLString];</span><br><span class="line">                    break;</span><br><span class="line">                case 1:</span><br><span class="line">                    url = [NSURL URLWithString:kSuccessKidURLString];</span><br><span class="line">                    break;</span><br><span class="line">                case 2:</span><br><span class="line">                    url = [NSURL URLWithString:kLotsOfFacesURLString];</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // dispatch_group_enter 手动通知 Dispatch Group 任务已经开始。你必须保证 dispatch_group_enter 和 dispatch_group_leave 成对出现，否则你可能会遇到诡异的崩溃问题。</span><br><span class="line">            dispatch_group_enter(downloadGroup); // 3</span><br><span class="line">            Photo *photo = [[Photo alloc] initwithURL:url</span><br><span class="line">                                  withCompletionBlock:^(UIImage *image, NSError *_error) &#123;</span><br><span class="line">                                      if (_error) &#123;</span><br><span class="line">                                          error = _error;</span><br><span class="line">                                      &#125;</span><br><span class="line">                                      dispatch_group_leave(downloadGroup); // 4</span><br><span class="line">                                  &#125;];</span><br><span class="line">            </span><br><span class="line">            [[PhotoManager sharedManager] addPhoto:photo];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // dispatch_group_wait 会一直等待，直到任务全部完成或者超时。如果在所有任务完成前超时了，该函数会返回一个非零值。你可以对此返回值做条件判断以确定是否超出等待周期；然而，你在这里用 DISPATCH_TIME_FOREVER 让它永远等待。它的意思，勿庸置疑就是，永－远－等－待！这样很好，因为图片的创建工作总是会完成的。</span><br><span class="line">        dispatch_group_wait(downloadGroup, DISPATCH_TIME_FOREVER); // 5</span><br><span class="line">        </span><br><span class="line">        // 此时此刻，你已经确保了，要么所有的图片任务都已完成，要么发生了超时。然后，你在主线程上运行 completionBlock 回调。这会将工作放到主线程上，并在稍后执行。</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123; // 6</span><br><span class="line">            if (completionBlock) &#123;</span><br><span class="line">                completionBlock(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2⃣️ <strong>dispatch_group_notify()</strong> 函数，异步执行，不会阻塞主线程：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- (void)downloadPhotosWithCompletionBlock:(BatchPhotoDownloadingCompletionBlock)completionBlock</span><br><span class="line">&#123;</span><br><span class="line">    __block NSError *error;</span><br><span class="line"></span><br><span class="line">    // 创建一个任务调度组</span><br><span class="line">    dispatch_group_t downloadGroup = dispatch_group_create(); // 1</span><br><span class="line">    </span><br><span class="line">    for (NSInteger i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">        NSURL *url;</span><br><span class="line">        switch (i) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                url = [NSURL URLWithString:kOverlyAttachedGirlfriendURLString];</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                url = [NSURL URLWithString:kSuccessKidURLString];</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                url = [NSURL URLWithString:kLotsOfFacesURLString];</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        dispatch_group_enter(downloadGroup); // 2</span><br><span class="line">        Photo *photo = [[Photo alloc] initwithURL:url</span><br><span class="line">                              withCompletionBlock:^(UIImage *image, NSError *_error) &#123;</span><br><span class="line">                                  if (_error) &#123;</span><br><span class="line">                                      error = _error;</span><br><span class="line">                                  &#125;</span><br><span class="line">                                  dispatch_group_leave(downloadGroup); // 3</span><br><span class="line">                              &#125;];</span><br><span class="line">        </span><br><span class="line">        [[PhotoManager sharedManager] addPhoto:photo];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // dispatch_group_notify 以异步的方式工作。当 Dispatch Group 中没有任何任务时，它就会执行其代码，那么 completionBlock 便会运行。你还指定了运行 completionBlock 的队列，此处，主队列就是你所需要的。</span><br><span class="line">    dispatch_group_notify(downloadGroup, dispatch_get_main_queue(), ^&#123; // 4</span><br><span class="line">        if (completionBlock) &#123;</span><br><span class="line">            completionBlock(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于何时以及怎样使用有着不同的队列类型的 Dispatch Group ：</p>
<ul>
<li>自定义串行队列：它很适合当一组任务完成时发出通知。</li>
<li>主队列（串行）：它也很适合这样的情况。但如果你要同步地等待所有工作地完成，那你就不应该使用它，因为你不能阻塞主线程。然而，异步模型是一个很有吸引力的能用于在几个较长任务（例如网络调用）完成后更新 UI 的方式。</li>
<li>并发队列：它也很适合 Dispatch Group 和完成时通知。</li>
</ul>
<h3>并发循环、迭代执行，dispatch_apply</h3>
<p><code>dispatch_apply</code> 表现得就像一个 <code>for</code> 循环，但它能并发地执行不同的迭代。这个函数是同步的，所以和普通的 <code>for</code> 循环一样，它只会在所有工作都完成后才会返回。</p>
<p>当在 Block 内计算任何给定数量的工作的最佳迭代数量时，必须要小心，因为过多的迭代和每个迭代只有少量的工作会导致大量开销以致它能抵消任何因并发带来的收益。而被称为<code>跨越式（striding）</code>的技术可以在此帮到你，即通过在每个迭代里多做几个不同的工作。</p>
<blockquote>
<p>译者注：大概就能减少并发数量吧，作者是提醒大家注意并发的开销，记在心里！</p>
</blockquote>
<p>那何时才适合用 <code>dispatch_apply</code> 呢？</p>
<ul>
<li>自定义串行队列：串行队列会完全抵消 <code>dispatch_apply</code> 的功能；你还不如直接使用普通的 <code>for</code> 循环。</li>
<li>主队列（串行）：与上面一样，在串行队列上不适合使用 <code>dispatch_apply</code> 。还是用普通的 <code>for</code> 循环吧。</li>
<li>✅并发队列：对于并发循环来说是很好选择，特别是当你需要追踪任务的进度时。</li>
</ul>
<p>使用示例：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (void)downloadPhotosWithCompletionBlock:(BatchPhotoDownloadingCompletionBlock)completionBlock</span><br><span class="line">&#123;</span><br><span class="line">    __block NSError *error;</span><br><span class="line"></span><br><span class="line">    // 创建一个任务调度组</span><br><span class="line">    dispatch_group_t downloadGroup = dispatch_group_create(); // 1</span><br><span class="line">    </span><br><span class="line">    // 使用 dispatch_apply 代替 for (NSInteger i = 0; i &lt; 3; i++) 循环</span><br><span class="line">    dispatch_apply(3, dispatch_get_global_queue(QOS_CLASS_USER_INTERACTIVE, 0), ^(size_t i) &#123;</span><br><span class="line">        NSURL *url;</span><br><span class="line">        switch (i) &#123;</span><br><span class="line">            case 0:</span><br><span class="line">                url = [NSURL URLWithString:kOverlyAttachedGirlfriendURLString];</span><br><span class="line">                break;</span><br><span class="line">            case 1:</span><br><span class="line">                url = [NSURL URLWithString:kSuccessKidURLString];</span><br><span class="line">                break;</span><br><span class="line">            case 2:</span><br><span class="line">                url = [NSURL URLWithString:kLotsOfFacesURLString];</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        dispatch_group_enter(downloadGroup); // 2</span><br><span class="line">        Photo *photo = [[Photo alloc] initwithURL:url</span><br><span class="line">                              withCompletionBlock:^(UIImage *image, NSError *_error) &#123;</span><br><span class="line">                                  if (_error) &#123;</span><br><span class="line">                                      error = _error;</span><br><span class="line">                                  &#125;</span><br><span class="line">                                  dispatch_group_leave(downloadGroup); // 3</span><br><span class="line">                              &#125;];</span><br><span class="line">        </span><br><span class="line">        [[PhotoManager sharedManager] addPhoto:photo];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // dispatch_group_notify 以异步的方式工作。当 Dispatch Group 中没有任何任务时，它就会执行其代码，那么 completionBlock 便会运行。你还指定了运行 completionBlock 的队列，此处，主队列就是你所需要的。</span><br><span class="line">    dispatch_group_notify(downloadGroup, dispatch_get_main_queue(), ^&#123; // 4</span><br><span class="line">        if (completionBlock) &#123;</span><br><span class="line">            completionBlock(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际上，在这个例子里并不值得。下面是原因：</p>
<ul>
<li>你创建并行运行线程而付出的开销，很可能比直接使用  <code>for</code> 循环要多。若你要以合适的步长迭代非常大的集合，那才应该考虑使用 <code>dispatch_apply</code>。</li>
<li>你用于创建应用的时间是有限的——除非实在太糟糕否则不要浪费时间去提前优化代码。如果你要优化什么，那去优化那些明显值得你付出时间的部分。你可以通过在 Instruments 里分析你的应用，找出最长运行时间的方法。看看 <a href="http://www.raywenderlich.com/23037/how-to-use-instruments-in-xcode" target="_blank" rel="noopener">如何在 Xcode 中使用 Instruments</a> 可以学到更多相关知识。</li>
<li>通常情况下，优化代码会让你的代码更加复杂，不利于你自己和其他开发者阅读。请确保添加的复杂性能换来足够多的好处。</li>
</ul>
<p>记住，不要在优化上太疯狂。你只会让你自己和后来者更难以读懂你的代码。</p>
<blockquote>
<p>💡使用线程并不是没有代价的，线程会有<strong>创建时的时间开销</strong>，还会消耗内核的内存，即<strong>应用的内存空间</strong>。</p>
</blockquote>
<h3>信号量函数，dispatch_semaphore_t</h3>
<p>信号量让你控制多个消费者对有限数量资源的访问。举例来说，如果你创建了一个有着两个资源的信号量，那同时最多只能有两个线程可以访问临界区。其他想使用资源的线程必须在一个…你猜到了吗？…FIFO队列里等待。</p>
<p>...</p>
<h3>每秒执行，dispatch_source</h3>
<p>帮助你去响应或监测 Unix 信号、文件描述符、Mach 端口、VFS 节点，以及其它晦涩的东西。</p>
<p>常用于<strong>倒计时器</strong>，使用 snippet 代码块：==dispatch_source==</p>
<p>示例一：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 60秒倒计时定时器，每秒执行一次，</span><br><span class="line">double intervalInSeconds = 60.0; // 时间间隔</span><br><span class="line">dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, intervalInSeconds * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">    // code to be executed when timer fires</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(timer);</span><br></pre></td></tr></table></figure></p>
<p>示例二：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// 点击“获取验证码按钮”，开启60秒倒计时</span><br><span class="line">-(void)buttonCountDown:(UIButton *)button &#123;</span><br><span class="line">    button.enabled = NO;</span><br><span class="line">    </span><br><span class="line">    __block int timeout = 60; // 倒计时时间</span><br><span class="line">    NSTimeInterval intervalInSeconds = 1.0; // 执行时间间隔</span><br><span class="line">    </span><br><span class="line">    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">    dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, intervalInSeconds * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">        if (timeout &lt;= 0) &#123;</span><br><span class="line">            dispatch_source_cancel(timer);</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                button.enabled = YES;</span><br><span class="line">                [button setTitle:@&quot;重新获取验证码&quot; forState:UIControlStateNormal];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                button.enabled = NO;</span><br><span class="line">                NSString *buttonTitle = [NSString stringWithFormat:@&quot;%ds后重新发送&quot;,timeout];</span><br><span class="line">                [button setTitle:buttonTitle forState:UIControlStateNormal];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        timeout --;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_resume(timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3>参考文献</h3>
<ul>
<li>
<p><a href="https://bestswifter.com/deep-gcd/" target="_blank" rel="noopener">深入理解GCD</a></p>
</li>
<li>
<p><a href="http://blog.devtang.com/2012/02/22/use-gcd/" target="_blank" rel="noopener">使用GCD @唐巧</a></p>
<blockquote>
<p>简单描述了 block、GCD 的几个方法。</p>
</blockquote>
</li>
<li>
<p><a href="https://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial" target="_blank" rel="noopener">Ray Wenderlich: iOS系统中的多线程和GCD的初学者教程</a></p>
<blockquote>
<p>Ray Wenderlich 系列的教程，非常值得一看，只不过这篇教程是2011年写的，年代有些久远，教程中还使用了 ASIHTTPRequest（一个已经停止更新的网络库，目前流行的是 AFNetworking），参考起来有些费解，教程的大致内容总结如下：</p>
<p>教程讲解了一个 ImageGrabber 应用，它的功能是打开 HTML 网页，检索并抓取所有图片的链接，然后将所有抓取到的图片显示在列表视图上。它还可以下载 zip 文件，并提取出 zip 文件内的图像。</p>
<p>但是，如果应用程序在主线程上执行所有的操作：解析HTML、下载图片、下载并解压 zip 文件、遍历并提取出 zip 文件中所有图片。这样会导致主线程阻塞造成UI界面卡顿或者无法响应用户交互，用户不得不等待大量的时间，也不知道应用程序是否仍然正常工作！</p>
<p>优化一：异步下载，并使用 NSNotification 通知更新UI。</p>
<p>优化二：使用GCD将下载并解压 zip 文件的耗时任务放到后台线程执行。</p>
<p>不建议：在主线程上执行所有的任务。</p>
<p>推荐：把一个进程分解成多个线程执行。主线程用于更新UI，响应用户事件，后台线程用于检索HTML页面、下载并解压缩文件。</p>
</blockquote>
</li>
<li>
<p><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-04-19-grand-central-dispatch-in-depth-part-1.md" target="_blank" rel="noopener">Ray Wenderlich: GCD 深入理解：第一部分</a></p>
<blockquote>
<p>⭐️⭐️⭐️</p>
</blockquote>
</li>
<li>
<p><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-05-14-grand-central-dispatch-in-depth-part-2.md" target="_blank" rel="noopener">Ray Wenderlich: GCD 深入理解：第二部分</a></p>
<blockquote>
<p>⭐️⭐️⭐️</p>
</blockquote>
</li>
<li>
<p><a href="https://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift" target="_blank" rel="noopener">Ray Wenderlich: NSOperation and NSOperationQueue Tutorial in Swift</a></p>
</li>
<li>
<p><a href="http://blog.leichunfeng.com/blog/2015/07/29/ios-concurrency-programming-operation-queues/" target="_blank" rel="noopener">iOS 并发编程之 Operation Queues</a></p>
</li>
<li>
<p><a href="http://subscribe.mail.10086.cn/subscribe/readAll.do?columnId=563&amp;itemId=3130310" target="_blank" rel="noopener">ios多线程操作（六）—— GCD全局队列与主队列</a></p>
<blockquote>
<p>全局队列函数<code>dispatch_get_global_queue()</code>及其参数。</p>
</blockquote>
</li>
<li>
<p><a href="https://www.objccn.io/issues/" target="_blank" rel="noopener">Objc中国期刊 第二期：并发编程</a></p>
<blockquote>
<p>并发编程面临的挑战：资源共享导致的竞态条件、互斥锁、死锁、资源饥饿、优先级反转。</p>
<p>我们建议采纳的安全模式是这样的：从主线程中提取出要使用到的数据，并利用一个操作队列在后台处理相关的数据，最后回到主队列中来发送你在后台队列中得到的结果。使用这种方式，你不需要自己做任何锁操作，这也就大大减少了犯错误的几率。</p>
<p>Apple没有把 UIKit 设计为线程安全的类是有意为之的，将其打造为线程安全的话会使很多操作变慢。而事实上 UIKit 是和主线程绑定的，这一特点使得编写并发程序以及使用 UIKit 十分容易的，你唯一需要确保的就是<strong>对于 UIKit 的调用总是在主线程中来进行</strong>。</p>
</blockquote>
</li>
<li>
<p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/ThreadSafetySummary/ThreadSafetySummary.html#//apple_ref/doc/uid/10000057i-CH12-SW1" target="_blank" rel="noopener">Apple: Threading Programming Guide</a></p>
<blockquote>
<p>苹果官方文档，描述了OS X 和 iOS 中一些关键框架的高级线程安全性。</p>
</blockquote>
</li>
<li>
<p><a href="http://www.jianshu.com/p/7649fad15cdb" target="_blank" rel="noopener">iOS多线程全套：线程生命周期，多线程的四种解决方案，线程安全问题，GCD的使用，NSOperation的使用</a></p>
</li>
<li>
<p>Matt Galloway. Effective Objective-C 2.0: 编写高质量 iOS 与 OS X 代码的52个有效方法[M] .北京: 机械工业出版社，2014: 149-180.</p>
<blockquote>
<p><a href="https://www.jianshu.com/p/67492063fd49" target="_blank" rel="noopener">我的笔记</a></p>
<ul>
<li>第41条：多用派发队列，少用同步锁。</li>
</ul>
<p>这一条是针对读写的竞态条件而言的。作者推荐使用 GCD 方法中的同步队列以及栅栏块实现同步语义，而不是 @synchronized 块或者 NSLock 对象。</p>
<ul>
<li>第42条：多用GCD，少用 performSelector 系列方法。</li>
</ul>
<p>performSelector 系列方法本身有许多不足：内存管理方面有疏忽、可处理的方法也有局限。</p>
<p>performSelector 系列方法中有延后执行选择子，或者将其放在另一个线程上执行的方法，这些我们都可以通过 GCD 提供的方法来替换实现。</p>
<ul>
<li>第43条：掌握 GCD 及操作队列的使用时机。</li>
</ul>
<p>在解决多线程与任务管理问题时，派发队列并非唯一方案。</p>
<p>操作队列提供了一套高层的 Objective-C API，能实现纯 GCD 所具备的绝大部分功能，而且还能完成一些更为复杂的操作，那些操作若改用GCD来实现，则需另外编写代码。</p>
<ul>
<li>第44条：通过 Dispatch Group 机制，根据系统资源状况来执行任务。</li>
<li>第45条：使用 dispatch_once 来执行只需运行一次的线程安全代码。</li>
</ul>
<p>单例类的创建问题。</p>
<ul>
<li>第46条：不要使用 dispatch_get_current_queue。</li>
</ul>
<p>dispatch_get_current_queue 函数的行为常常与开发者所预期的不同。此函数已废弃，只应做调试之用。</p>
<p>由于派发队列是按层级来组织的，所以无法单用某个队列对象来描述当前队列这一概念。</p>
<p>dispatch_get_current_queue 函数用于解决由不可重入的代码所引发的死锁，然而能用此函数解决的问题，通常也能改用“队列特定数据”来解决。</p>
</blockquote>
</li>
<li>
<p>Gaurav Vaish. 高性能 iOS 应用开发[M] .北京: 人民邮电出版社，2017: 89-116.</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/22/nullable 与 nonnull 的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/22/nullable 与 nonnull 的使用/" class="post-title-link" itemprop="url">nullable 与 nonnull 的使用</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-22 14:25:00" itemprop="dateCreated datePublished" datetime="2017-12-22T14:25:00+08:00">2017-12-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 22:11:27" itemprop="dateModified" datetime="2019-05-01T22:11:27+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-C-编程/" itemprop="url" rel="index"><span itemprop="name">Objective-C 编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">2.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">3 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/071608.jpg" alt="生命是什么呢？生命是时时刻刻不知如何是好。"></p>
<p>&lt;!-- more --&gt;</p>
<h3>nullable 与 nonnull 的区别</h3>
<p><code>__nullable</code>:表示对象可以是 NULL 或者 nil。</p>
<p><code>__nonnull</code>:表示对象不可以为空。</p>
<p><code>__null_unspecified</code>：表示对象未指定、不明确。</p>
<p>如果没有显式声明，则表示 <code>__nonnull</code> 或者<code>_Null_unspecified</code> （不明确）</p>
<p>在 Xcode 7 中，为了避免与第三方库的冲突，Apple 把 <code>__nullable</code>/<code>__nonnull</code> 改成了 <code>_Nullable</code>/<code>_Nonnull</code>，也支持没有下划线的写法：<code>nullable</code>/<code>nonnull</code>。</p>
<h3>使用规范：</h3>
<ol>
<li>对于属性、方法返回值、方法参数的修饰，使用 <code>nonnull</code>/<code>nullable</code>。</li>
<li>对于 C 函数的参数、Block的参数、Block返回值 的修饰，使用 <code>_Nonnull</code>/<code>_Nullable</code>,建议弃用 <code>__nonnull</code>/<code>__nullable</code>。</li>
</ol>
<p>为安全起见，Apple 制定的使用规则：</p>
<ol>
<li>通过 typedef 定义的类型的 nullability 特性通常依赖于上下文，即使是在 Audited Regions 中，也不能假定它为 <code>nonnull</code> ；</li>
<li>对于复杂的指针类型（如 id * ）必须显式去指定是 <code>nonnull</code> 还是 <code>nullable</code>。例如，指定一个指向 <code>nullable</code> 对象的 <code>nonnull</code> 指针，可以使用 <code>__nullable id * __nonnul</code>l ；</li>
<li>我们经常使用的 <code>NSError **</code> 通常是被假定为一个指向 <code>nullable</code> NSError 对象的 <code>nullable</code> 指针。</li>
</ol>
<h3>使用区别</h3>
<p>共有三种用法：</p>
<ul>
<li><code>nonnull</code>，<code>nullable</code>, <code>null_unspecified</code></li>
<li><code>_Nonnull</code>，<code>_Nullable</code>，<code>_Null_unspecified</code>，</li>
<li><code>__nonnull</code>，<code>__nullable</code>，<code>__null_unspecified</code>。</li>
</ul>
<p>这几种用法在声明时的位置区别：</p>
<ol>
<li>单下划线和双下划线的需要放在类型定义之后。</li>
<li>无下划线的需要放在类型定义之前。</li>
</ol>
<h3>使用示例：</h3>
<h4>声明属性</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, copy, nullable) NSString *name;</span><br><span class="line">@property (nonatomic, copy) NSString *__nullable firstName;</span><br><span class="line">@property (nonatomic, copy) NSString *_Nullable lastName;</span><br></pre></td></tr></table></figure></p>
<h4>修饰方法返回值</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (nullable NSString *)method1;</span><br><span class="line">- (NSString *__nullable)method2;</span><br><span class="line">- (NSString *_Nullable)method3;</span><br></pre></td></tr></table></figure></p>
<h4>修饰方法参数</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)methodWithString1:(nullable NSString *)aString;</span><br><span class="line">- (void)methodWithString2:(NSString *__nullable)aString;</span><br><span class="line">- (void)methodWithString3:(NSString *_Nullable)aString;</span><br></pre></td></tr></table></figure></p>
<h4>例外情况</h4>
<p>⚠️双指针类型对象、Block 的返回值、Block 的传入参数等，不能用 <code>nonnull</code>/<code>nullable</code> 修饰，只能用带下划线的 <code>__nonnull</code>/<code>__nullable</code> 或者 <code>_Nonnull</code>/<code>_Nullable</code>。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (void)methodwithError1:(NSError * _Nullable * __null_unspecified)error;</span><br><span class="line">- (void)methodwithError2:(NSError * nullable * null_unspecified)error;</span><br></pre></td></tr></table></figure></p>
<h4>Block 返回值</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)methodWithBlock1:(nullable void(^)(void))block;</span><br><span class="line">// ⚠️ 以上 nullable 修饰的是方法传入参数，表示传入的 Block 可以为空，而不是修饰 BlocK 返回值。</span><br><span class="line"></span><br><span class="line">- (void)methodWithBlock2:(void (^ _Nullable)(void))block;</span><br><span class="line">- (void)methodWithBlock3:(void (^ __nullable)(void))block;</span><br></pre></td></tr></table></figure></p>
<h4>Block 传入参数</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)methodWithBlock21:(nullable id nonnull(^)(id nullable parameters))block;</span><br><span class="line">// ⚠️ 以上 nullable 修饰的是方法传入参数，表示传入的 BlocK 可以为空。而 __nonnull 用于修饰 Block 返回值 id 不能为空。</span><br><span class="line"></span><br><span class="line">- (void)methodWithBlock22:(id  nonnull(^ nullable)(id _Nullable parameters))block;</span><br><span class="line">- (void)methodWithBlock23:(id  _Nonnull (^ _Nonnull)(id _Nullable parameters))block;</span><br></pre></td></tr></table></figure></p>
<h3>宏 NS_ASSUME_NONNULL_BEGIN 与 NS_ASSUME_NONNULL_END</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">// 在这两个宏之间的代码，所有简单指针对象都被假定为 nonnull ，因此我们只需要去指定那些 nullable 指针对象即可。</span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">@interface MyObject : NSObject</span><br><span class="line"></span><br><span class="line">// 默认为 nonnull</span><br><span class="line">@property (nonatomic, copy) NSString *aString;</span><br><span class="line"></span><br><span class="line">// 方法返回值默认为 nonnull</span><br><span class="line">// 方法的参数显式声明为 nullabel,表示入参可以为空</span><br><span class="line">- (id)methodWithString:(nullable NSString *)string;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br></pre></td></tr></table></figure></p>
<h3>参考</h3>
<ul>
<li><a href="https://developer.apple.com/swift/blog/?id=25" target="_blank" rel="noopener">Apple Blog:Nullability and Objective-C</a></li>
<li><a href="https://stackoverflow.com/questions/32452889/difference-between-nullable-nullable-and-nullable-in-objective-c" target="_blank" rel="noopener">Difference between nullable, __nullable and _Nullable in Objective-C</a></li>
<li><a href="http://nshipster.cn/nil/" target="_blank" rel="noopener">nshipster: nil / Nil / NULL / NSNull</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/22/《Objective-C 编程》19.@property/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/22/《Objective-C 编程》19.@property/" class="post-title-link" itemprop="url">《Objective-C 编程》19.@property</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-22 10:55:00" itemprop="dateCreated datePublished" datetime="2017-12-22T10:55:00+08:00">2017-12-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:16:06" itemprop="dateModified" datetime="2019-05-01T21:16:06+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Objective-C-编程/" itemprop="url" rel="index"><span itemprop="name">Objective-C 编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1>属性</h1>
<h4>@property</h4>
<ul>
<li>尽管可以使用obj-&gt;arr的形式去强制读取对象的成员变量，但是良好的编程形式是对外界提供成员变量的读写接口。<strong>@property</strong> 关键字提供了外界对成员变量的访问接口，<strong>其本质是自动为某一个属性生成set和get方法</strong>。</li>
<li>根据不同的需要，可以添加 <strong>readonly</strong>（只读，相当于只添加get不添加set方法）或者 <strong>readwrite</strong>（读写，如果不添加则为默认）；</li>
<li>还有三种赋值方式可选 ：<strong>assign</strong>（直接赋值，通常用于基本类型），<strong>retain</strong>（释放旧值，增加新的retaincount），<strong>copy</strong>（常用于字符串，生成一个新的拷贝）.</li>
<li><strong>property的属性特性只对setter方法有效，对getter方法无效</strong></li>
</ul>
<p><strong>格式</strong>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (原子性©,内存管理©,读写性©) NSString *string;</span><br></pre></td></tr></table></figure></p>
<p>&lt;!-- more --&gt;</p>
<h1>属性特征</h1>
<ol>
<li>
<p>原子性</p>
<ul>
<li>
<p><strong>atomic</strong>(默认)：原子性</p>
<blockquote>
<p><strong>atomic</strong> 意为操作是原子的，意味着只有一个线程访问实例变量。atomic是线程安全的，至少在当前的存取器上是安全的。它是一个默认的特性，但是很少使用，因为比较影响效率，这跟ARM平台和内部锁机制有关。</p>
</blockquote>
</li>
<li>
<p><strong>nonatomic</strong>： 非原子性</p>
<blockquote>
<p><strong>nonatomic</strong> 跟 <strong>atomic</strong> 刚好相反。表示非原子的，可以被多个线程访问。它的效率比atomic快。但不能保证在多线程环境下的安全性，在单线程和明确只有一个线程访问的情况下广泛使用。</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>内存管理</p>
<ul>
<li>
<p><strong>assign</strong>（默认）：对象之外的类型使用，一般用来修饰基础数据类型)；</p>
<blockquote>
<p>1⃣️ 用于修饰值类型（基本数据类型），如：int，float，double，CGFloat，<strong>NSInteger</strong> 等。还包括不存在所有权关系的对象，如：<strong>delegate</strong>。</p>
<p>相对于 <strong>assign</strong> ，我们一般使用 <strong>weak</strong> 来修饰 <strong>delegate</strong>，会更加安全。</p>
</blockquote>
<blockquote>
<p>2⃣️ assign 修饰的属性不牵涉内存管理，不会被引用计数器管理。</p>
</blockquote>
</li>
<li>
<p><strong>retain</strong>：保留对象；（所有的对象，都使用retain）</p>
<blockquote>
<p>在<code>setter</code>方法中，需要对传入的对象进行引用计数加1的操作。
简单来说，就是对传入的对象拥有所有权，只要对该对象拥有所有权，该对象就不会被释放。</p>
</blockquote>
</li>
<li>
<p><strong>copy</strong>：拷贝对象；<strong>NSString</strong>／<strong>NSArray</strong> 的对象都使用<strong>copy</strong>属性；</p>
</li>
<li>
<p><strong>strong</strong>：强引用</p>
<blockquote>
<p><strong>strong</strong> 是在IOS引入ARC的时候引入的关键字，是retain的一个可选的替代。表示实例变量对传入的对象要有所有权关系，即强引用。strong跟retain的意思相同并产生相同的代码，但是语意上更好更能体现对象的关系。</p>
</blockquote>
</li>
<li>
<p><strong>weak</strong>：弱引用，一般用来修饰对象。</p>
<blockquote>
<p>针对对象类型，在setter方法中，不会对传入的对象执行引用计数器+1的操作。也就是对传入的对象没有所有权，是弱引用。另外当传入的对象引用计数器为0，也就是被释放后，用weak声明的实例变量会指向nil，即空对象。</p>
</blockquote>
</li>
<li>
<p><strong>unsafe_unretained:</strong></p>
<blockquote>
<p>1⃣️ 从字面上来看，我们可以拆分成两部分来理解，unretained和retain相反，也就是和strong相反，因此等同于weak，其实也是用在iOS5之前替代weak使用的。</p>
<p>2⃣️ unsafe，不安全的，如上所述等同于weak的话那应该是安全的，这里不安全的是指当传入的对象被释放后，使用unsafe_unretained修饰的变量是不知道的，也不会像weak一样指向nil，所以此时访问可能会引起crash。因此，总结来说unsafe_unretained作用是等同于weak，但是是不安全的。</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>读写性</p>
<ul>
<li>
<p><strong>readwrite</strong>（默认）：</p>
<blockquote>
<p><code>readwrite</code>是默认值，表示该属性同时拥有<code>setter</code>和<code>getter</code>。</p>
</blockquote>
</li>
<li>
<p><strong>readonly</strong>：只读</p>
<blockquote>
<p><code>readonly</code>表示只有<code>getter</code>没有<code>setter</code>。</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3>参考文章</h3>
<ul>
<li><a href="http://www.jianshu.com/p/74af03847e74" target="_blank" rel="noopener">我所理解的内存管理：4、property相关 @杨淳引</a></li>
<li><a href="http://www.jianshu.com/p/14552b4946c5" target="_blank" rel="noopener">理解@property使用的关键字 @MrLeoZou</a></li>
<li><a href="http://www.devtalking.com/articles/you-should-to-know-property/" target="_blank" rel="noopener">Objective-C中的@property @程序员说</a></li>
<li><a href="https://segmentfault.com/a/1190000004943276" target="_blank" rel="noopener">Objective-C 内存管理——你需要知道的一切</a></li>
<li><a href="http://blog.devtang.com/2016/07/30/ios-memory-management/" target="_blank" rel="noopener">理解 iOS 的内存管理 @唐巧</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/20/AFNetworking——优雅的网络框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/20/AFNetworking——优雅的网络框架/" class="post-title-link" itemprop="url">AFNetworking——优雅的网络框架</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-20 17:06:00" itemprop="dateCreated datePublished" datetime="2017-12-20T17:06:00+08:00">2017-12-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 21:33:12" itemprop="dateModified" datetime="2019-05-01T21:33:12+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS-开源框架/" itemprop="url" rel="index"><span itemprop="name">iOS 开源框架</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">18k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">17 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>GitHub源码:<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="noopener">AFNetworking</a></li>
<li>star:30000+</li>
</ul>
<h1>README文档</h1>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/072544.jpg" alt>
AFNetworking 是一个适用于 iOS 系统和 Mac OS X 系统的网络框架。它建立在 <a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/URLLoadingSystem/URLLoadingSystem.html" target="_blank" rel="noopener">Foundation URL Loading System</a> 之上，扩展了 Cocoa 强大的高级网络抽象。设计精良的模块化架构、功能丰富的 API，让你能够安心的使用，轻松实现各种网络请求，比如 GET 请求，POST 请求，以及上传多张图片等。</p>
<p>&lt;!-- more --&gt;</p>
<h2>如何开始</h2>
<ul>
<li><a href="https://github.com/AFNetworking/AFNetworking/archive/master.zip" target="_blank" rel="noopener">Download AFNetworking</a> and try out the included Mac and iPhone example apps</li>
<li>Read the <a href="https://github.com/AFNetworking/AFNetworking/wiki/Getting-Started-with-AFNetworking" target="_blank" rel="noopener">&quot;Getting Started&quot; guide</a>, <a href="https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-FAQ" target="_blank" rel="noopener">FAQ</a>, or <a href="https://github.com/AFNetworking/AFNetworking/wiki" target="_blank" rel="noopener">other articles on the Wiki</a></li>
<li>Check out the <a href="http://cocoadocs.org/docsets/AFNetworking/" target="_blank" rel="noopener">documentation</a> for a comprehensive look at all of the APIs available in AFNetworking</li>
<li>Read the <a href="https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-3.0-Migration-Guide" target="_blank" rel="noopener">AFNetworking 3.0 Migration Guide</a> for an overview of the architectural changes from 2.0.</li>
</ul>
<h2>讨论</h2>
<ul>
<li>If you <strong>need help</strong>, use <a href="http://stackoverflow.com/questions/tagged/afnetworking" target="_blank" rel="noopener">Stack Overflow</a>. (Tag 'afnetworking')</li>
<li>If you'd like to <strong>ask a general question</strong>, use <a href="http://stackoverflow.com/questions/tagged/afnetworking" target="_blank" rel="noopener">Stack Overflow</a>.</li>
<li>If you <strong>found a bug</strong>, <em>and can provide steps to reliably reproduce it</em>, open an issue.</li>
<li>If you <strong>have a feature request</strong>, open an issue.</li>
<li>If you <strong>want to contribute</strong>, submit a pull request.</li>
</ul>
<h2>安装</h2>
<p>AFNetworking 支持在项目中安装库的多种方法。</p>
<h2>CocoaPods 安装</h2>
<p><a href="http://cocoapods.org" target="_blank" rel="noopener">CocoaPods</a> is a dependency manager for Objective-C, which automates and simplifies the process of using 3rd-party libraries like AFNetworking in your projects. See the <a href="https://github.com/AFNetworking/AFNetworking/wiki/Getting-Started-with-AFNetworking" target="_blank" rel="noopener">&quot;Getting Started&quot; guide for more information</a>. You can install it with the following command:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gem install cocoapods</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>CocoaPods 0.39.0+ is required to build AFNetworking 3.0.0+.</p>
</blockquote>
<h4>配置</h4>
<p>To integrate AFNetworking into your Xcode project using CocoaPods, specify it in your <code>Podfile</code>:</p>
<p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">'https://github.com/CocoaPods/Specs.git'</span></span><br><span class="line">platform <span class="symbol">:ios</span>, <span class="string">'8.0'</span></span><br><span class="line"></span><br><span class="line">target <span class="string">'TargetName'</span> <span class="keyword">do</span></span><br><span class="line">pod <span class="string">'AFNetworking'</span>, <span class="string">'~&gt; 3.0'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>Then, run the following command:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pod install</span><br></pre></td></tr></table></figure></p>
<h3>Carthage 安装</h3>
<p><a href="https://github.com/Carthage/Carthage" target="_blank" rel="noopener">Carthage</a> is a decentralized dependency manager that builds your dependencies and provides you with binary frameworks.</p>
<p>You can install Carthage with <a href="http://brew.sh/" target="_blank" rel="noopener">Homebrew</a> using the following command:</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew update</span><br><span class="line">$ brew install carthage</span><br></pre></td></tr></table></figure></p>
<p>To integrate AFNetworking into your Xcode project using Carthage, specify it in your <code>Cartfile</code>:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">github &quot;AFNetworking/AFNetworking&quot; ~&gt; 3.0</span><br></pre></td></tr></table></figure></p>
<p>Run <code>carthage</code> to build the framework and drag the built <code>AFNetworking.framework</code> into your Xcode project.</p>
<h2>版本要求</h2>
<table>
<thead>
<tr>
<th style="text-align:center">AFNetworking Version</th>
<th style="text-align:center">Minimum iOS Target</th>
<th style="text-align:center">Minimum OS X Target</th>
<th style="text-align:center">Minimum watchOS Target</th>
<th style="text-align:center">Minimum tvOS Target</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">3.x</td>
<td style="text-align:center">iOS 7</td>
<td style="text-align:center">OS X 10.9</td>
<td style="text-align:center">watchOS 2.0</td>
<td style="text-align:center">tvOS 9.0</td>
<td style="text-align:center">Xcode 7+ is required. <code>NSURLConnectionOperation</code> support has been removed.</td>
</tr>
<tr>
<td style="text-align:center">2.6 -&gt; 2.6.3</td>
<td style="text-align:center">iOS 7</td>
<td style="text-align:center">OS X 10.9</td>
<td style="text-align:center">watchOS 2.0</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center">Xcode 7+ is required.</td>
</tr>
<tr>
<td style="text-align:center">2.0 -&gt; 2.5.4</td>
<td style="text-align:center">iOS 6</td>
<td style="text-align:center">OS X 10.8</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center">Xcode 5+ is required. <code>NSURLSession</code> subspec requires iOS 7 or OS X 10.9.</td>
</tr>
<tr>
<td style="text-align:center">1.x</td>
<td style="text-align:center">iOS 5</td>
<td style="text-align:center">Mac OS X 10.7</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">0.10.x</td>
<td style="text-align:center">iOS 4</td>
<td style="text-align:center">Mac OS X 10.6</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center">n/a</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>(OS X projects must support <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtVersionsPlatforms.html" target="_blank" rel="noopener">64-bit with modern Cocoa runtime</a>).</p>
<blockquote>
<p>Programming in Swift? Try <a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="noopener">Alamofire</a> for a more conventional set of APIs.</p>
</blockquote>
<h2>结构</h2>
<h3>NSURLSession</h3>
<ul>
<li><code>AFURLSessionManager</code></li>
<li><code>AFHTTPSessionManager</code></li>
</ul>
<h3>序列化</h3>
<ul>
<li><code>&lt;AFURLRequestSerialization&gt;</code> 请求序列化
<ul>
<li><code>AFHTTPRequestSerializer</code></li>
<li><code>AFJSONRequestSerializer</code></li>
<li><code>AFPropertyListRequestSerializer</code></li>
</ul>
</li>
<li><code>&lt;AFURLResponseSerialization&gt;</code> 响应序列化
<ul>
<li><code>AFHTTPResponseSerializer</code></li>
<li><code>AFJSONResponseSerializer</code></li>
<li><code>AFXMLParserResponseSerializer</code></li>
<li><code>AFXMLDocumentResponseSerializer</code> <em>(Mac OS X)</em></li>
<li><code>AFPropertyListResponseSerializer</code></li>
<li><code>AFImageResponseSerializer</code></li>
<li><code>AFCompoundResponseSerializer</code></li>
</ul>
</li>
</ul>
<h3>其他功能</h3>
<ul>
<li><code>AFSecurityPolicy</code></li>
<li><code>AFNetworkReachabilityManager</code></li>
</ul>
<h4>结构图</h4>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/072545.jpg" alt="006tKfTcly1fj0ndu06qaj307f0bqmye.jpg"></p>
<h2>用法</h2>
<h3>一、AFURLSessionManager</h3>
<ul>
<li><code>AFURLSessionManager</code> 创建并管理 <code>NSURLSession</code> 对象。</li>
<li><code>NSURLSession</code> 对象基于指定的 <code>NSURLSessionConfiguration</code> 对象。</li>
<li><code>NSURLSessionConfiguration</code> 对象遵守如下协议： <code>&lt;NSURLSessionTaskDelegate&gt;</code>, <code>&lt;NSURLSessionDataDelegate&gt;</code>, <code>&lt;NSURLSessionDownloadDelegate&gt;</code>, 和 <code>&lt;NSURLSessionDelegate&gt;</code> 。</li>
</ul>
<h4>NSURLSessionTask</h4>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/072547.jpg" alt></p>
<h4>NSURLSessionDelegate 委托协议</h4>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/072547-1.jpg" alt></p>
<h4>1.创建下载任务</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 NSURLSessionConfiguration 对象</span><br><span class="line">NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line"></span><br><span class="line">// 2.创建 AFURLSessionManager 对象</span><br><span class="line">AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:configuration];</span><br><span class="line"></span><br><span class="line">// 3.创建 NSURL、NSURLRequest 对象</span><br><span class="line">NSURL *URL = [NSURL URLWithString:@&quot;http://example.com/download.zip&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:URL];</span><br><span class="line"></span><br><span class="line">// 4.创建 NSURLSessionDownloadTask 对象</span><br><span class="line">NSURLSessionDownloadTask *downloadTask = [manager downloadTaskWithRequest:request progress:nil destination:^NSURL *(NSURL *targetPath, NSURLResponse *response) &#123;</span><br><span class="line">    NSURL *documentsDirectoryURL = [[NSFileManager defaultManager] URLForDirectory:NSDocumentDirectory inDomain:NSUserDomainMask appropriateForURL:nil create:NO error:nil];</span><br><span class="line">    return [documentsDirectoryURL URLByAppendingPathComponent:[response suggestedFilename]];</span><br><span class="line">&#125; completionHandler:^(NSURLResponse *response, NSURL *filePath, NSError *error) &#123;</span><br><span class="line">    NSLog(@&quot;File downloaded to: %@&quot;, filePath);</span><br><span class="line">&#125;];</span><br><span class="line">// 5.开启下载任务</span><br><span class="line">[downloadTask resume];</span><br></pre></td></tr></table></figure></p>
<h4>2.创建上传任务</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 NSURLSessionConfiguration 对象</span><br><span class="line">NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line"></span><br><span class="line">// 2.创建 AFURLSessionManager 对象</span><br><span class="line">AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:configuration];</span><br><span class="line"></span><br><span class="line">// 3.创建 NSURL、NSURLRequest 对象</span><br><span class="line">NSURL *URL = [NSURL URLWithString:@&quot;http://example.com/upload&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:URL];</span><br><span class="line"></span><br><span class="line">// 4.创建 NSURLSessionUploadTask 对象</span><br><span class="line">NSURL *filePath = [NSURL fileURLWithPath:@&quot;file://path/to/image.png&quot;];</span><br><span class="line">NSURLSessionUploadTask *uploadTask = [manager uploadTaskWithRequest:request fromFile:filePath progress:nil completionHandler:^(NSURLResponse *response, id responseObject, NSError *error) &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        NSLog(@&quot;Error: %@&quot;, error);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        NSLog(@&quot;Success: %@ %@&quot;, response, responseObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line">// 5.开启下载任务</span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure></p>
<h4>3.创建一个单次含有多个信息的有进度指示的上传任务</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 NSMutableURLRequest 对象</span><br><span class="line">NSMutableURLRequest *request = [[AFHTTPRequestSerializer serializer] multipartFormRequestWithMethod:@&quot;POST&quot; URLString:@&quot;http://example.com/upload&quot; parameters:nil constructingBodyWithBlock:^(id&lt;AFMultipartFormData&gt; formData) &#123;</span><br><span class="line">    [formData appendPartWithFileURL:[NSURL fileURLWithPath:@&quot;file://path/to/image.jpg&quot;] name:@&quot;file&quot; fileName:@&quot;filename.jpg&quot; mimeType:@&quot;image/jpeg&quot; error:nil];</span><br><span class="line">&#125; error:nil];</span><br><span class="line"></span><br><span class="line">// 2.创建 AFURLSessionManager 对象</span><br><span class="line">AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];</span><br><span class="line"></span><br><span class="line">// 3.创建 NSURLSessionUploadTask 对象</span><br><span class="line">NSURLSessionUploadTask *uploadTask;</span><br><span class="line">uploadTask = [manager</span><br><span class="line">              uploadTaskWithStreamedRequest:request</span><br><span class="line">              progress:^(NSProgress * _Nonnull uploadProgress) &#123;</span><br><span class="line">                  // 此处不会在主线程上回调</span><br><span class="line">                  // 你要负责在主线程上更新 UI</span><br><span class="line">                  dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                      // Update the progress view</span><br><span class="line">                      [progressView setProgress:uploadProgress.fractionCompleted];</span><br><span class="line">                  &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">              completionHandler:^(NSURLResponse * _Nonnull response, id  _Nullable responseObject, NSError * _Nullable error) &#123;</span><br><span class="line">                  if (error) &#123;</span><br><span class="line">                      NSLog(@&quot;Error: %@&quot;, error);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      NSLog(@&quot;%@ %@&quot;, response, responseObject);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;];</span><br><span class="line">// 4.开启下载任务</span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure></p>
<h4>4.创建数据任务</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 NSURLSessionConfiguration 对象</span><br><span class="line">NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line"></span><br><span class="line">// 2.创建 AFURLSessionManager 对象</span><br><span class="line">AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:configuration];</span><br><span class="line"></span><br><span class="line">// 3.创建 NSURL、NSURLRequest 对象</span><br><span class="line">NSURL *URL = [NSURL URLWithString:@&quot;http://httpbin.org/get&quot;];</span><br><span class="line">NSURLRequest *request = [NSURLRequest requestWithURL:URL];</span><br><span class="line"> </span><br><span class="line">// 4.创建 NSURLSessionDataTask 对象</span><br><span class="line">NSURLSessionDataTask *dataTask = [manager dataTaskWithRequest:request completionHandler:^(NSURLResponse *response, id responseObject, NSError *error) &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">        NSLog(@&quot;Error: %@&quot;, error);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        NSLog(@&quot;%@ %@&quot;, response, responseObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">// 5.开启下载任务</span><br><span class="line">[dataTask resume];</span><br></pre></td></tr></table></figure></p>
<p>从使用上看，<strong>AFURLSessionManager</strong> 只是封装了原生的 <strong>NSURLSession</strong> 对象，创建网络请求步骤流程与原生方法（使用 <code>NSURLSession</code> 类）类似：</p>
<p><img src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/072549.png" alt="AFURLSessionManager"></p>
<hr>
<h3>二、AFHTTPSessionManager</h3>
<p>💡说明：官方 README 文档中并没有给出该类的示例代码，这里补充。</p>
<p><strong>AFHTTPSessionManager</strong> 是 <strong>AFURLSessionManager</strong> 的子类对象，它提供了进行 HTTP 请求的便捷方法。当设置好  <code>baseURL</code>  （服务器地址）时，要发起 <code>GET</code>、<code>POST</code> 等请求，你可以使用一些便捷方法，而这些便捷方法只需要传入相对路径参数即可。</p>
<p>总之，<strong>AFHTTPSessionManager</strong> 提供了发起 <strong>GET</strong>、<strong>HEAD</strong>、<strong>POST</strong>、<strong>PUT</strong>、<strong>PATCH</strong>、<strong>DELETE</strong> 请求的便捷语法。它调用的是父类 <strong>AFURLSessionManager</strong> 的 <strong>NSURLSessionDataTask</strong> 类型的任务。</p>
<p>这个类并没有实现像 <strong>NSURLSessionUploadTask</strong>、<strong>NSURLSessionDownloadTask</strong>、<strong>NSURLSessionStreamTask</strong> 类型的任务。</p>
<p>初始化方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)manager;</span><br><span class="line">- (instancetype)initWithBaseURL:(nullable NSURL *)url;</span><br><span class="line">- (instancetype)initWithBaseURL:(nullable NSURL *)url</span><br><span class="line">           sessionConfiguration:(nullable NSURLSessionConfiguration *)configuration;</span><br></pre></td></tr></table></figure></p>
<p>发起 HTTP 请求：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// GET</span><br><span class="line">- (nullable NSURLSessionDataTask *)GET:(NSString *)URLString</span><br><span class="line">                            parameters:(nullable id)parameters</span><br><span class="line">                              progress:(nullable void (^)(NSProgress *downloadProgress))downloadProgress</span><br><span class="line">                               success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                               failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">// HEAD</span><br><span class="line">- (nullable NSURLSessionDataTask *)HEAD:(NSString *)URLString</span><br><span class="line">                    parameters:(nullable id)parameters</span><br><span class="line">                       success:(nullable void (^)(NSURLSessionDataTask *task))success</span><br><span class="line">                       failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">// POST</span><br><span class="line">- (nullable NSURLSessionDataTask *)POST:(NSString *)URLString</span><br><span class="line">                             parameters:(nullable id)parameters</span><br><span class="line">                               progress:(nullable void (^)(NSProgress *uploadProgress))uploadProgress</span><br><span class="line">                                success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                                failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">- (nullable NSURLSessionDataTask *)POST:(NSString *)URLString</span><br><span class="line">                             parameters:(nullable id)parameters</span><br><span class="line">              constructingBodyWithBlock:(nullable void (^)(id &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                               progress:(nullable void (^)(NSProgress *uploadProgress))uploadProgress</span><br><span class="line">                                success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                                failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">// PUT</span><br><span class="line">- (nullable NSURLSessionDataTask *)PUT:(NSString *)URLString</span><br><span class="line">                   parameters:(nullable id)parameters</span><br><span class="line">                      success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                      failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">// PATCH</span><br><span class="line">- (nullable NSURLSessionDataTask *)PATCH:(NSString *)URLString</span><br><span class="line">                     parameters:(nullable id)parameters</span><br><span class="line">                        success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                        failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br><span class="line"></span><br><span class="line">// DELETE</span><br><span class="line">- (nullable NSURLSessionDataTask *)DELETE:(NSString *)URLString</span><br><span class="line">                      parameters:(nullable id)parameters</span><br><span class="line">                         success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</span><br><span class="line">                         failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure;</span><br></pre></td></tr></table></figure></p>
<h4>一、GET 请求</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 AFHTTPSessionManager 对象</span><br><span class="line">AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line">// 2.构建参数，parameters 参数可以传 nil</span><br><span class="line">NSString *urlString = @&quot;https://www.google.com/login&quot;;</span><br><span class="line"></span><br><span class="line">// 3.Task 任务</span><br><span class="line">[manager GET:urlString parameters:nil progress:^(NSProgress * _Nonnull downloadProgress) &#123;</span><br><span class="line">    // 进度</span><br><span class="line">&#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</span><br><span class="line">    // 请求成功</span><br><span class="line">    // task:通过task拿到响应头</span><br><span class="line">    // responseObject:请求成功返回的响应结果（AFN内部已经把响应体转换为OC对象，通常是字典或数组)</span><br><span class="line">&#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</span><br><span class="line">    // 请求失败</span><br><span class="line">    NSLog(@&quot;GET ERROR:%@&quot;,error.localizedDescription);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<h4>二、POST 请求</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 1.创建 AFHTTPSessionManager 对象</span><br><span class="line">AFHTTPSessionManager *manager = [AFHTTPSessionManager alloc]</span><br><span class="line">    initWithBaseURL:[NSURL URLWithString:@&quot;https://www.google.com&quot;]];</span><br><span class="line"></span><br><span class="line">// 2.构建参数</span><br><span class="line">NSString *relativePaths = @&quot;/login&quot;;</span><br><span class="line">NSDictionary *parameters = @&#123;</span><br><span class="line">                             @&quot;username&quot;:@&quot;admin&quot;,</span><br><span class="line">                             @&quot;password&quot;:@&quot;123456&quot;,</span><br><span class="line">                             &#125;;</span><br><span class="line">// 3.Task 任务</span><br><span class="line">[manager POST:relativePaths parameters:parameters progress:^(NSProgress * _Nonnull uploadProgress) &#123;</span><br><span class="line">    // 进度</span><br><span class="line">&#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</span><br><span class="line">    // 请求成功</span><br><span class="line">&#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</span><br><span class="line">    // 请求失败</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></p>
<h4>其他设置</h4>
<h5>timeoutInterval 设置请求超时时间，默认为 60s：</h5>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 设置请求超时时间为 10s</span><br><span class="line">[manager.requestSerializer willChangeValueForKey:@&quot;timeoutInterval&quot;];</span><br><span class="line">manager.requestSerializer.timeoutInterval = 10.f;</span><br><span class="line">[manager.requestSerializer didChangeValueForKey:@&quot;timeoutInterval&quot;];</span><br></pre></td></tr></table></figure></p>
<h5>ContentTypes 类型</h5>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// AFN默认接收的 ContentTypes 有以下三种：</span><br><span class="line">self.acceptableContentTypes = [NSSet setWithObjects:@&quot;application/json&quot;, @&quot;text/json&quot;, @&quot;text/javascript&quot;, nil];</span><br><span class="line"></span><br><span class="line">// 如果服务器返回的 ContentTypes 类型为 text/html，需要设置如下：</span><br><span class="line">manager.responseSerializer.acceptableContentTypes = [NSSet setWithObject:@&quot;text/html&quot;];</span><br></pre></td></tr></table></figure></p>
<h5>responseSerializer 默认把服务器返回的数据当做是 JSON 类型并自动转化为Objec</h5>
<p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 设置为 <span class="keyword">XML</span> <span class="title">类型，此时返回的是 NSXMLParser</span> 类型，需要我们自己解析。</span><br><span class="line">manager.responseSerializer = [AFXMLParserResponseSerializer serializer];</span><br><span class="line"></span><br><span class="line">// 设置为其他类型</span><br><span class="line">manager.responseSerializer = [AFHTTPResponseSerializer serializer];</span><br></pre></td></tr></table></figure></p>
<h5>验证SSL证书</h5>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 验证CN域名</span><br><span class="line">NSString *cerPath = [[NSBundle mainBundle] pathForResource:@&quot;server&quot; ofType:@&quot;cer&quot;];</span><br><span class="line">NSData *cerData = [NSData dataWithContentsOfFile:cerPath];</span><br><span class="line">manager.securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate withPinnedCertificates:[[NSSet alloc]initWithObjects:cerData, nil]];</span><br><span class="line"></span><br><span class="line">// 是否信任具有无效或过期SSL证书的服务器（自建证书）</span><br><span class="line">manager.securityPolicy.allowInvalidCertificates = YES;</span><br><span class="line"></span><br><span class="line">// 是否在证书的CN字段中验证域名</span><br><span class="line">manager.securityPolicy.validatesDomainName = NO;</span><br></pre></td></tr></table></figure></p>
<h3>设置状态栏活动指示器</h3>
<p>启用后，系统会自动在应用程序发起网络请求时，在状态栏显示旋转的菊花。</p>
<ol>
<li>在项目的 <code>AppDelegate.m</code> 文件中导入<code>AFNetworkActivityIndicatorManager.h</code> 文件；</li>
<li>在<code>AppDelegate application:didFinishLaunchingWithOptions:</code>方法中设置如下代码：</li>
</ol>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[AFNetworkActivityIndicatorManager sharedManager] setEnabled:YES];</span><br></pre></td></tr></table></figure></p>
<hr>
<h3>请求序列化</h3>
<p>请求序列化通过将请求参数编码为查询字符串或者 HTTP 请求体,来为URL字符串创建请求。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSString *URLString = @&quot;http://example.com&quot;;</span><br><span class="line">NSDictionary *parameters = @&#123;@&quot;foo&quot;: @&quot;bar&quot;, @&quot;baz&quot;: @[@1, @2, @3]&#125;;</span><br></pre></td></tr></table></figure></p>
<h4>一、编码为查询字符串</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// GET</span><br><span class="line">[[AFHTTPRequestSerializer serializer] requestWithMethod:@&quot;GET&quot; URLString:URLString parameters:parameters error:nil];</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="link">http://example.com?foo=bar&amp;baz</span>[<span class="string"></span>]=1&amp;baz[]=2&amp;baz[]=3</span><br></pre></td></tr></table></figure></p>
<h4>二、编码为URL表单</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// POST</span><br><span class="line">[[AFHTTPRequestSerializer serializer] requestWithMethod:@&quot;POST&quot; URLString:URLString parameters:parameters error:nil];</span><br></pre></td></tr></table></figure></p>
<pre><code>POST http://example.com/
Content-Type: application/x-www-form-urlencoded

foo=bar&amp;baz[]=1&amp;baz[]=2&amp;baz[]=3
</code></pre>
<h4>三、编码为JSON字符串</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// AFJSONRequestSerializer</span><br><span class="line">[[AFJSONRequestSerializer serializer] requestWithMethod:@&quot;POST&quot; URLString:URLString parameters:parameters error:nil];</span><br></pre></td></tr></table></figure></p>
<pre><code>POST http://example.com/
Content-Type: application/json

{&quot;foo&quot;: &quot;bar&quot;, &quot;baz&quot;: [1,2,3]}
</code></pre>
<hr>
<h3>网络状态管理</h3>
<p><code>AFNetworkReachabilityManager</code> 类用于监测 WWAN 和 WiFi 接口的网络联通性。</p>
<ul>
<li>不要依据它来决定是否发起网络请求。
<ul>
<li>你应该尝试发送网络请求。</li>
</ul>
</li>
<li>你可以依据它来选择是否自动重新发送请求。
<ul>
<li>虽然它可能仍然失败，但当连接可用时，可访问性通知是重试某些东西的好时机。</li>
</ul>
</li>
<li>它是一个判断网络请求失败原因的很好用的工具。
<ul>
<li>当网络请求失败时,告诉用户他们已经离线,要比告诉他们一些比如”请求超时”一类的准确的错误更好。</li>
</ul>
</li>
</ul>
<p>See also <a href="https://developer.apple.com/videos/play/wwdc2012-706/" target="_blank" rel="noopener">WWDC 2012 session 706, &quot;Networking Best Practices.&quot;</a>.</p>
<h4>共享网络状态连通性</h4>
<p>示例：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">AFNetworkReachabilityManager *manager = [AFNetworkReachabilityManager sharedManager];</span><br><span class="line">[manager setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">    switch (status) &#123;</span><br><span class="line">        case AFNetworkReachabilityStatusUnknown: &#123;</span><br><span class="line">            DDLogInfo(@&quot;网络异常：未知网络&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AFNetworkReachabilityStatusNotReachable: &#123;</span><br><span class="line">            DDLogInfo(@&quot;网络异常：没有网络&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AFNetworkReachabilityStatusReachableViaWWAN: &#123;</span><br><span class="line">            DDLogInfo(@&quot;网络状态检测：蜂窝网络&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case AFNetworkReachabilityStatusReachableViaWiFi: &#123;</span><br><span class="line">            DDLogInfo(@&quot;网络状态检测：WiFi&quot;);</span><br><span class="line">            break;                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line">[networkReachabilityManager startMonitoring]; // 开启网络检测</span><br></pre></td></tr></table></figure></p>
<h4><s>基于特定域名的网络连通性</s></h4>
<hr>
<h3>安全策略</h3>
<p><code>AFSecurityPolicy</code> 基于 X.509 数字证书和公钥来确定服务器是否可信。</p>
<p>向应用程序中添加固定的 SSL 证书有助于防止中间人攻击和其他漏洞。强烈建议处理敏感客户数据或财务信息的应用程序通过 HTTPS 连接来和服务器通信。</p>
<h4>允许无效的 SSL 证书</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];</span><br><span class="line">manager.securityPolicy.allowInvalidCertificates = YES; // 生产环境不建议使用</span><br></pre></td></tr></table></figure></p>
<hr>
<h2>单元测试</h2>
<p>AFNetworking 在 Tests 子目录中包含一套单元测试。 这些测试可以简单地执行您想要测试的平台框架上的测试操作。</p>
<h2>账户</h2>
<p>AFNetworking is owned and maintained by the <a href="http://alamofire.org" target="_blank" rel="noopener">Alamofire Software Foundation</a>.</p>
<p>AFNetworking was originally created by <a href="https://github.com/sco/" target="_blank" rel="noopener">Scott Raymond</a> and <a href="https://github.com/mattt/" target="_blank" rel="noopener">Mattt Thompson</a> in the development of <a href="http://en.wikipedia.org/wiki/Gowalla" target="_blank" rel="noopener">Gowalla for iPhone</a>.</p>
<p>AFNetworking's logo was designed by <a href="http://www.alandefibaugh.com/" target="_blank" rel="noopener">Alan Defibaugh</a>.</p>
<p>And most of all, thanks to AFNetworking's <a href="https://github.com/AFNetworking/AFNetworking/contributors" target="_blank" rel="noopener">growing list of contributors</a>.</p>
<h3>Security Disclosure</h3>
<p>If you believe you have identified a security vulnerability with AFNetworking, you should report it as soon as possible via email to security@alamofire.org. Please do not post it to a public issue tracker.</p>
<h2>License</h2>
<p>AFNetworking is released under the MIT license. See LICENSE for details.
tive-C对象。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/20/Reachability——一个用于判断网络可达性的库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/20/Reachability——一个用于判断网络可达性的库/" class="post-title-link" itemprop="url">Reachability——一个用于判断网络可达性的库</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-20 16:03:00" itemprop="dateCreated datePublished" datetime="2017-12-20T16:03:00+08:00">2017-12-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 22:12:09" itemprop="dateModified" datetime="2019-05-01T22:12:09+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS-开源框架/" itemprop="url" rel="index"><span itemprop="name">iOS 开源框架</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>GitHub:<a href="https://github.com/tonymillion/Reachability" target="_blank" rel="noopener">tonymillion/<strong>Reachability</strong></a></li>
<li>Star:6500+</li>
</ul>
<blockquote>
<p>附上3个网络可达性库：</p>
<ol>
<li>Apple 官方Demo：<a href="https://developer.apple.com/library/content/samplecode/Reachability/Introduction/Intro.html#//apple_ref/doc/uid/DTS40007324-Intro-DontLinkElementID_2" target="_blank" rel="noopener">Reachability</a></li>
<li>本项目：<a href="https://github.com/tonymillion/Reachability" target="_blank" rel="noopener">tonymillion/<strong>Reachability</strong></a></li>
<li><a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="noopener">AFNetworking</a> 的 <code>AFNetworkReachabilityManager</code> 类</li>
</ol>
</blockquote>
<h1><strong>WARNING</strong> there have been reports of apps being rejected when Reachability is used in a framework. The only solution to this so far is to rename the class.</h1>
<blockquote>
<p>⚠️该类库可能使用了与Apple源码相同的类名，因此提交应用审核时，可能会被拒绝。目前为止，唯一的解决方法就是更改类名。</p>
</blockquote>
<p>&lt;!-- more --&gt;</p>
<h1>Reachability</h1>
<p>这是 Apple 的 <code>Reachability</code> 类的替代品。 它兼容ARC，它使用新的 GCD 方法来通知网络接口的变化。</p>
<p>除了标准的 <code>NSNotification</code> 之外，它还支持使用 block 块处理网络可达或不可达时的情况。</p>
<p>最后，你可以指定是否将 WWAN 连接视为“可达”。</p>
<p><em>在真实设备上测试之前，请不要开启 BUGS</em></p>
<p><strong>在你开启一个关于 iOS6 / iOS5 版本的构建错误之前，请使用标签3.2或3.1，因为它们支持分配类型。</strong></p>
<h2>Requirements</h2>
<p>Once you have added the <code>.h/m</code> files to your project, simply:</p>
<ul>
<li>Go to the <code>Project-&gt;TARGETS-&gt;Build Phases-&gt;Link Binary With Libraries</code>.</li>
<li>Press the plus in the lower left of the list.</li>
<li>Add <code>SystemConfiguration.framework</code>.</li>
</ul>
<p>Boom, you're done.</p>
<h2>示例</h2>
<h3>Blocks 方法示例</h3>
<p>该示例使用 blocks 块来监听网络接口状态是否改变。该 blocks 将会在<strong>后台线程</strong>被调用，因此你需要将UI更新切换到主线程中。</p>
<h4><strong>In</strong> Objective-C</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 创建 reachability 对象</span><br><span class="line">Reachability *reach = [Reachability reachabilityWithHostname:@&quot;www.google.com&quot;];</span><br><span class="line"></span><br><span class="line">// 设置网络可达的 blocks</span><br><span class="line">reach.reachableBlock = ^(Reachability*reach)</span><br><span class="line">&#123;</span><br><span class="line">	// 记住这里的代码会在后台线程中被调用，如果你想要更新UI，一定到切换到主线程：</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        NSLog(@&quot;REACHABLE!&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 设置网络不可达的 blocks</span><br><span class="line">reach.unreachableBlock = ^(Reachability*reach)</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;UNREACHABLE!&quot;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 开启监听</span><br><span class="line">[reach startNotifier];</span><br></pre></td></tr></table></figure></p>
<h3>In Swift 3</h3>
<p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Reachability</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reach: <span class="type">Reachability?</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="comment">// Allocate a reachability object</span></span><br><span class="line">        <span class="keyword">self</span>.reach = <span class="type">Reachability</span>.forInternetConnection()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set the blocks</span></span><br><span class="line">        <span class="keyword">self</span>.reach!.reachableBlock = &#123;</span><br><span class="line">            (reach: <span class="type">Reachability?</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// keep in mind this is called on a background thread</span></span><br><span class="line">            <span class="comment">// and if you are updating the UI it needs to happen</span></span><br><span class="line">            <span class="comment">// on the main thread, like this:</span></span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"REACHABLE!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.reach!.unreachableBlock = &#123;</span><br><span class="line">            (reach: <span class="type">Reachability?</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"UNREACHABLE!"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.reach!.startNotifier()</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3><code>NSNotification</code> 通知方法示例</h3>
<p>此示例将使用 <code>NSNotification</code> 来通知网络连接状态的变化。 它们将在主线程上被调用，因此你可以从该函数内部进行UI更新。</p>
<p>此外，它要求<code>Reachability</code>对象默认将 WWAN（3G / EDGE / CDMA）蜂窝网络视为不可达的连接（如果你正在编写视频流应用程序（例如，用于保存用户的数据计划），则可以使用此功能）。</p>
<h4>In Objective-C</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 通过指定域名的方式创建 reachability 对象</span><br><span class="line">Reachability* reach = [Reachability reachabilityWithHostname:@&quot;www.google.com&quot;];</span><br><span class="line"></span><br><span class="line">// 不判断蜂窝网络是否可用</span><br><span class="line">reach.reachableOnWWAN = NO;</span><br><span class="line"></span><br><span class="line">// Here we set up a NSNotification observer. The Reachability that caused the notification</span><br><span class="line">// is passed in the object parameter</span><br><span class="line">[[NSNotificationCenter defaultCenter] addObserver:self</span><br><span class="line">                                         selector:@selector(reachabilityChanged:)</span><br><span class="line">                                             name:kReachabilityChangedNotification</span><br><span class="line">                                           object:nil];</span><br><span class="line"></span><br><span class="line">[reach startNotifier];</span><br></pre></td></tr></table></figure></p>
<p>接收通知的方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-(void)reachabilityChanged:(NSNotification*)note</span><br><span class="line">&#123;</span><br><span class="line">    Reachability * reach = [note object];</span><br><span class="line">    if([reach isReachable])</span><br><span class="line">    &#123;</span><br><span class="line">        NSString * temp = [NSString stringWithFormat:@&quot;GOOGLE Notification Says Reachable(%@)&quot;, reach.currentReachabilityString];</span><br><span class="line">        NSLog(@&quot;%@&quot;, temp);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        NSString * temp = [NSString stringWithFormat:@&quot;GOOGLE Notification Says Unreachable(%@)&quot;, reach.currentReachabilityString];</span><br><span class="line">        NSLog(@&quot;%@&quot;, temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4>In Swift 3</h4>
<p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Reachability</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reach: <span class="type">Reachability?</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="comment">// Allocate a reachability object</span></span><br><span class="line">    <span class="keyword">self</span>.reach = <span class="type">Reachability</span>.forInternetConnection()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Tell the reachability that we DON'T want to be reachable on 3G/EDGE/CDMA</span></span><br><span class="line">    <span class="keyword">self</span>.reach!.reachableOnWWAN = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Here we set up a NSNotification observer. The Reachability that caused the notification</span></span><br><span class="line">    <span class="comment">// is passed in the object parameter</span></span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.addObserver(</span><br><span class="line">        <span class="keyword">self</span>,</span><br><span class="line">        selector: #selector(reachabilityChanged),</span><br><span class="line">        name: <span class="type">NSNotification</span>.<span class="type">Name</span>.reachabilityChanged,</span><br><span class="line">        object: <span class="literal">nil</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.reach!.startNotifier()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reachabilityChanged</span><span class="params">(notification: NSNotification)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.reach!.isReachableViaWiFi() || <span class="keyword">self</span>.reach!.isReachableViaWWAN() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Service avalaible!!!"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"No service avalaible!!!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2>Tell the world</h2>
<p>Head over to <a href="https://github.com/tonymillion/Reachability/wiki/Projects-using-Reachability" target="_blank" rel="noopener">Projects using Reachability</a> and add your project for &quot;Maximum Wins!&quot;.</p>
<h2>小结：</h2>
<ol>
<li>创建 <strong>Reachability</strong> 对象的方法有三种：</li>
</ol>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+(instancetype)reachabilityWithHostName:(NSString*)hostname; // 指定域名</span><br><span class="line">+(instancetype)reachabilityForInternetConnection; // 通用网络连接</span><br><span class="line">+(instancetype)reachabilityWithAddress:(void *)hostAddress; // 指定地址</span><br><span class="line">+(instancetype)reachabilityForLocalWiFi; // 指定Wi-Fi网络</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>
<p>可选设置，是否忽视蜂窝网络可达性</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, assign) BOOL reachableOnWWAN;</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>监听网络可达性的方法有两种：</p>
<p>2.1 Blocks 方式</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, copy) NetworkReachable    reachableBlock;</span><br><span class="line">@property (nonatomic, copy) NetworkUnreachable  unreachableBlock;</span><br></pre></td></tr></table></figure></p>
<p>2.2 通知方式</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[[NSNotificationCenter defaultCenter] addObserver:self </span><br><span class="line">                                         selector:@selector(reachabilityChanged:) </span><br><span class="line">                                             name:kReachabilityChangedNotification </span><br><span class="line">                                           object:nil];</span><br></pre></td></tr></table></figure></p>
</li>
<li>
<p>开始、停止监听</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-(BOOL)startNotifier;</span><br><span class="line">-(void)stopNotifier;</span><br></pre></td></tr></table></figure></p>
</li>
</ol>
<h3>实例代码：</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 网络可达性检查</span><br><span class="line">Reachability *reachability = [Reachability reachabilityWithHostName:URL_HOST];</span><br><span class="line">reachability.reachableBlock = ^(Reachability *reachability) &#123;</span><br><span class="line">    // 3.0s 后执行加载任务</span><br><span class="line">    // 默认情况下，切换到主线程更新UI，这里延迟3秒是为了多旋转一会菊花用的。</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        // 连接服务器</span><br><span class="line">        [self connectToServer];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">reachability.unreachableBlock = ^(Reachability *reachability) &#123;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        self.emptyDescription = @&quot;无法访问服务器，请稍后再试。&quot;;</span><br><span class="line">        self.displayEmptyDataSet = YES;</span><br><span class="line">        self.loading = NO;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">[reachability startNotifier];</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://andy0570.com/2017/12/07/Tomcat安装及配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="独木舟的木">
      <meta itemprop="description" content="有时候阳光很好 有时候阳光很暗">
      <meta itemprop="image" content="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独木舟的木">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/07/Tomcat安装及配置/" class="post-title-link" itemprop="url">Tomcat安装及配置</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-07 12:50:00" itemprop="dateCreated datePublished" datetime="2017-12-07T12:50:00+08:00">2017-12-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-05-01 22:24:06" itemprop="dateModified" datetime="2019-05-01T22:24:06+08:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/云计算/" itemprop="url" rel="index"><span itemprop="name">云计算</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://wiki.jikexueyuan.com/project/tomcat/" target="_blank" rel="noopener">Tomcat 8权威指南</a>
<a href="http://tomcat.apache.org/tomcat-8.0-doc/RUNNING.txt" target="_blank" rel="noopener">RUNNING.txt</a></p>
<h3>UNIX 指令路径</h3>
<table>
<thead>
<tr>
<th>UNIX 指令</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>根路径</td>
</tr>
<tr>
<td>./</td>
<td>当前路径</td>
</tr>
<tr>
<td>../</td>
<td>上一级路径</td>
</tr>
</tbody>
</table>
<p>&lt;!-- more --&gt;</p>
<h3>Tomcat 目录结构及作用</h3>
<table>
<thead>
<tr>
<th>目录</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>$CATALINA_HOME</td>
<td>Tomcat 安装的根目录</td>
</tr>
<tr>
<td>/bin</td>
<td>存放用于启动及关闭的文件，以及其他一些脚本。其中，UNIX 系统专用的 <code>*.sh</code> 文件在功能上等同于 Windows 系统专用的 <code>*.bat</code> 文件。因为 Win32 的命令行缺乏某些功能，所以又额外地加入了一些文件。</td>
</tr>
<tr>
<td>/conf</td>
<td>配置文件及相关的 DTD。其中最重要的文件是 server.xml，这是容器的主配置文件。</td>
</tr>
<tr>
<td>/lib</td>
<td>支持tomcat软件运行的jar包。其中还有技术支持包，如servlet，jsp</td>
</tr>
<tr>
<td>/logs</td>
<td>日志文件的默认目录。</td>
</tr>
<tr>
<td>/webapps</td>
<td>存放 Web 应用的相关文件。</td>
</tr>
<tr>
<td>/work</td>
<td>Web应用程序的临时工作目录。</td>
</tr>
<tr>
<td>/temp</td>
<td>JVM用于临时文件的目录（java.io.tmpdir）</td>
</tr>
</tbody>
</table>
<h2>Mac 系统下 Tomcat 安装及配置</h2>
<h3>一、下载</h3>
<p>下载页：https://tomcat.apache.org/download-80.cgi</p>
<p>下载文件包后，解压拷贝到：<code>/Library</code>（Macintosh HD - 资源库） 目录下，重命名为 <code>Tomcat8524</code></p>
<p>切换到 Tomcat 的 bin 目录下：<code>cd /Library/Tomcat8524/bin</code></p>
<p>修改权限：<code>sudo chmod 755 ./*.sh</code></p>
<p>启动 Tomcat：<code>./startup.sh</code></p>
<p>控制台输出日志如下：</p>
<p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Using <span class="string">CATALINA_BASE:</span>   <span class="regexp">/Library/</span>Tomcat8524</span><br><span class="line">Using <span class="string">CATALINA_HOME:</span>   <span class="regexp">/Library/</span>Tomcat8524</span><br><span class="line">Using <span class="string">CATALINA_TMPDIR:</span> <span class="regexp">/Library/</span>Tomcat8524/temp</span><br><span class="line">Using <span class="string">JRE_HOME:</span>        <span class="regexp">/Library/</span>Java<span class="regexp">/JavaVirtualMachines/</span>jdk1<span class="number">.8</span><span class="number">.0</span>_152.jdk<span class="regexp">/Contents/</span>Home</span><br><span class="line">Using <span class="string">CLASSPATH:</span>       <span class="regexp">/Library/</span>Tomcat8524<span class="regexp">/bin/</span>bootstrap.<span class="string">jar:</span><span class="regexp">/Library/</span>Tomcat8524<span class="regexp">/bin/</span>tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure></p>
<p>打开浏览器输入网址验证：<code>http://localhost:8080</code></p>
<p>关闭 Tomcat：<code>./shutdown.sh</code></p>
<h3>参考</h3>
<ul>
<li><a href="http://www.jb51.net/article/94201.htm" target="_blank" rel="noopener">Mac环境下配置tomcat的步骤详解</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/avatar.png" alt="独木舟的木">
            
              <p class="site-author-name" itemprop="name">独木舟的木</p>
              <div class="site-description motion-element" itemprop="description">有时候阳光很好 有时候阳光很暗</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">316</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Andy0570" title="GitHub &rarr; https://github.com/Andy0570" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:andywhm@163.com" title="E-Mail &rarr; mailto:andywhm@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">独木舟的木</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">2.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">32:53</span>
  
</div>



  <span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
  <span class="post-meta-divider">|</span>

  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





  



  






  



  
    
    
      
    
  
  <script color="17,119,176" opacity="0.5" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>













  
  <script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/fastclick@1/lib/fastclick.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/jquery-lazyload@1/jquery.lazyload.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  
  
  
    
  

  
    
      
    
  

  
  
  
    <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
    <script>
      
        window.addEventListener('load', () => {
      
        quicklink({
          timeout: 3000,
          priority: true,
          ignores: [uri => uri.includes('#'),uri => uri == 'https://andy0570.com/page/12/',]
        });
      
        });
      
    </script>
  


  



  



  
  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">

  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.js"></script>
  

  <script src="/js/algolia-search.js?v=7.1.0"></script>



  

  

  

  

  

  

  

  

  

  
  
  
    
  
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script>pangu.spacingPage();</script>


  
  
  
    
  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-bookmark@1/bookmark.min.js"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script>


  

  

  
  
</body>
</html>
